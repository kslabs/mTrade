# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–ì–ê –° –†–£–ß–ù–û–ô –ü–†–û–î–ê–ñ–ï–ô

## –ü–†–û–ë–õ–ï–ú–ê
–ü–æ—Å–ª–µ —Ä—É—á–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ —Å–µ—Ä–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø–æ–∫—É–ø–æ–∫.

### –ü—Ä–∏—á–∏–Ω–∞
–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–ª –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë":
1. ‚úÖ –°–æ–∑–¥–∞–≤–∞–ª—Å—è –æ—Ä–¥–µ—Ä –Ω–∞ –ø—Ä–æ–¥–∞–∂—É
2. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–ª–∞—Å—å –ø—Ä–æ–¥–∞–∂–∞ –≤ —Ñ–∞–π–ª
3. ‚ùå **–ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è —Ü–∏–∫–ª –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä–∞** ‚Üí –æ—Å—Ç–∞–≤–∞–ª—Å—è –≤ state=ACTIVE

–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä –¥—É–º–∞–ª, —á—Ç–æ —Ü–∏–∫–ª –≤—Å—ë –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω, –∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å—Ä–∞–∑—É –ø—ã—Ç–∞–ª—Å—è –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–∫—É–ø–∫—É (—Ç–∞–∫ –∫–∞–∫ –±–∞–ª–∞–Ω—Å –±–∞–∑–æ–≤–æ–π –≤–∞–ª—é—Ç—ã —Å—Ç–∞–ª 0).

## –†–ï–®–ï–ù–ò–ï

### 1. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `force_reset_cycle` –≤ `autotrader_v2.py`
```python
def force_reset_cycle(self, base: str, reason: str = "manual_action"):
    """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —Ü–∏–∫–ª–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–π –ø—Ä–æ–¥–∞–∂–µ"""
    lock = self._get_lock(base)
    with lock:
        self._ensure_cycle(base)
        cycle = self.cycles[base]
        
        if cycle.is_active():
            print(f"[{base}] üî¥ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–´–ô –°–ë–†–û–° –¶–ò–ö–õ–ê (–ø—Ä–∏—á–∏–Ω–∞: {reason})")
            print(f"[{base}]   –¶–∏–∫–ª ID: {cycle.cycle_id}")
            print(f"[{base}]   –ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: {cycle.total_invested_usd} USDT")
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–∏–∫–ª (manual=False —á—Ç–æ–±—ã –ù–ï –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç)
        cycle.reset(manual=False)
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–¥–∞–∂–∏
        # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—É—é –Ω–æ–≤—É—é –ø–æ–∫—É–ø–∫—É
        cycle.last_sell_at = time.time()
        
        print(f"[{base}] ‚úÖ –¶–∏–∫–ª —Å–±—Ä–æ—à–µ–Ω, last_sell_at={cycle.last_sell_at}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        self._save_state(base)
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `handle_sell_all` –≤ `quick_trade_handler.py`
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤:
```python
# üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –°–±—Ä–æ—Å–∏—Ç—å —Ü–∏–∫–ª –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä–∞ –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏!
try:
    from mTrade import AUTO_TRADER
    if AUTO_TRADER:
        print(f"[INFO] quick_sell_all: –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–∏–∫–ª –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä–∞ –¥–ª—è {base_currency}...")
        AUTO_TRADER.force_reset_cycle(base_currency, reason="manual_sell")
        print(f"[INFO] quick_sell_all: –¶–∏–∫–ª –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä–∞ —Å–±—Ä–æ—à–µ–Ω")
except Exception as reset_error:
    print(f"[WARNING] quick_sell_all: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å —Ü–∏–∫–ª –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä–∞: {reset_error}")
```

## –†–ï–ó–£–õ–¨–¢–ê–¢
–¢–µ–ø–µ—Ä—å –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏:
1. ‚úÖ –°–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ä–¥–µ—Ä –Ω–∞ –ø—Ä–æ–¥–∞–∂—É
2. ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ–¥–∞–∂–∞ –≤ —Ñ–∞–π–ª
3. ‚úÖ **–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è —Ü–∏–∫–ª –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä–∞** (state ‚Üí IDLE)
4. ‚úÖ **–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ last_sell_at**
5. ‚úÖ **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Ñ–∞–π–ª**

–ê–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –¥—É–º–∞—Ç—å, —á—Ç–æ —Ü–∏–∫–ª –∞–∫—Ç–∏–≤–µ–Ω, –∏ –Ω–µ –Ω–∞—á–Ω—ë—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—É—é –Ω–æ–≤—É—é –ø–æ–∫—É–ø–∫—É.

## –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç–æ–º
2. –î–æ–∂–¥–∞—Ç—å—Å—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø–æ–∫—É–ø–∫–∏ (–∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é)
3. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë" –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "üî¥ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–´–ô –°–ë–†–û–° –¶–ò–ö–õ–ê (–ø—Ä–∏—á–∏–Ω–∞: manual_sell)"
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "‚úÖ –¶–∏–∫–ª —Å–±—Ä–æ—à–µ–Ω, last_sell_at=..."
5. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ—Ä–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫
6. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–ª–µ–¥—É—é—â–∞—è –ø–æ–∫—É–ø–∫–∞ –Ω–∞—á–Ω—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω AUTO_SYNC)

## –§–ê–ô–õ–´ –ò–ó–ú–ï–ù–ï–ù–´
- `autotrader_v2.py`: –¥–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `force_reset_cycle`
- `quick_trade_handler.py`: –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `force_reset_cycle` –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏
