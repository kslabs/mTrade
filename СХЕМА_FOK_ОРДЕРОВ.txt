╔══════════════════════════════════════════════════════════════════════════════╗
║                    БЛОК-СХЕМА: FOK-ОРДЕР В АВТОТРЕЙДЕРЕ                      ║
╚══════════════════════════════════════════════════════════════════════════════╝


                        ┌────────────────────────────┐
                        │   НАЧАЛО ПРОВЕРКИ ЦИКЛА    │
                        │   (каждые 10 секунд)       │
                        └─────────────┬──────────────┘
                                      │
                                      ▼
                        ┌────────────────────────────┐
                        │  Текущая цена достигла     │
                        │  целевой дельты?           │
                        │                            │
                        │  current_price >=          │
                        │  target_sell_price         │
                        └─────────┬──────────┬───────┘
                                  │          │
                            ❌ НЕТ│          │ ДА ✅
                                  │          │
                                  ▼          ▼
                    ┌──────────────────┐  ┌──────────────────────────┐
                    │  Ждём роста цены │  │  🎯 ПРИНЯТИЕ РЕШЕНИЯ     │
                    │                  │  │  О ПРОДАЖЕ               │
                    │  Следующая       │  │                          │
                    │  проверка через  │  │  Логирование:            │
                    │  10 секунд       │  │  • Текущая цена          │
                    └──────────────────┘  │  • Целевая цена          │
                                          │  • РЕШЕНИЕ: ПРОДАВАТЬ    │
                                          └─────────────┬────────────┘
                                                        │
                                                        ▼
                                          ┌──────────────────────────┐
                                          │  📊 ПОДГОТОВКА ПАРАМЕТРОВ│
                                          │                          │
                                          │  • amount = весь баланс  │
                                          │  • price = target_price  │
                                          │  • Целевая дельта        │
                                          │                          │
                                          │  Логирование полных      │
                                          │  параметров запроса      │
                                          └─────────────┬────────────┘
                                                        │
                                                        ▼
                                          ┌──────────────────────────┐
                                          │  🟢 СОЗДАНИЕ FOK-ОРДЕРА  │
                                          │                          │
                                          │  create_spot_order(      │
                                          │    order_type='limit',   │
                                          │    time_in_force='fok',  │
                                          │    price=target_price,   │
                                          │    amount=balance        │
                                          │  )                       │
                                          │                          │
                                          │  Order ID: 123456789     │
                                          └─────────────┬────────────┘
                                                        │
                                                        ▼
                        ┌───────────────────────────────────────────────────┐
                        │  ⏳ ПРОВЕРКА СТАТУСА FOK-ОРДЕРА                   │
                        │                                                   │
                        │  Цикл: 3 попытки × 1 секунда                      │
                        │                                                   │
                        │  for attempt in range(1, 4):                      │
                        │      sleep(1.0)                                    │
                        │      status = get_spot_order(order_id)            │
                        │                                                   │
                        │      if status in ['closed', 'cancelled']:        │
                        │          break                                     │
                        │                                                   │
                        │  Логирование каждой попытки                       │
                        └─────────────────────┬─────────────────────────────┘
                                              │
                                              ▼
                        ┌────────────────────────────────────────┐
                        │  Какой статус получен?                 │
                        └──┬──────────────┬──────────────┬────────┘
                           │              │              │
                    CLOSED │              │ CANCELLED    │ UNKNOWN
                       ✅  │              │ ❌           │ ⚠️
                           │              │              │
                           ▼              ▼              ▼
        ┌────────────────────────┐ ┌────────────────┐ ┌──────────────────┐
        │  ✅ ОРДЕР ИСПОЛНЕН     │ │  ❌ ОРДЕР      │ │  ⚠️ ПРОВЕРКА     │
        │                        │ │  ОТМЕНЁН       │ │  БАЛАНСА         │
        │  FOK нашёл достаточно  │ │                │ │                  │
        │  покупателей ≥ цены    │ │  Недостаточно  │ │  old_balance -   │
        │                        │ │  ликвидности   │ │  new_balance     │
        │  • Баланс = 0          │ │                │ └────┬────────┬────┘
        │  • Получена выручка    │ │  • Баланс НЕ   │      │        │
        └───────────┬────────────┘ │    изменился   │ ≥90% │        │ <90%
                    │              │  • Монеты      │      │        │
                    │              │    остались    │      ▼        ▼
                    │              └────────┬───────┘   Исполнен  Отменён
                    │                       │              │        │
                    ▼                       │              ▼        │
        ┌────────────────────────┐          │         (как CLOSED) │
        │  📊 ФИНАНСОВЫЕ         │          │              │        │
        │  ПОКАЗАТЕЛИ            │          │              └────────┘
        │                        │          │                   │
        │  • Объём продано       │          │                   ▼
        │  • Цена исполнения     │          │         ┌──────────────────┐
        │  • Получено USDT       │          │         │  ❌ ЦИКЛ         │
        │  • Прибыль (+/-)       │          │         │  НЕ ЗАВЕРШАЕТСЯ  │
        │  • Прибыль (%)         │          │         │                  │
        │                        │          │         │  • state: ACTIVE │
        │  Проверка:             │          │         │  • Снять флаг    │
        │  executed_price >=     │          │         │  • Повторить при │
        │  target_sell_price ✅  │          │         │    следующей     │
        └───────────┬────────────┘          │         │    проверке      │
                    │                       │         └──────────────────┘
                    ▼                       │
        ┌────────────────────────┐          │
        │  ✅ ЗАВЕРШЕНИЕ ЦИКЛА   │          │
        │                        │          │
        │  _complete_cycle(base) │          │
        │                        │          │
        │  • state: ACTIVE→IDLE  │          │
        │  • cycle_id: +1        │          │
        │  • total_cycles: +1    │          │
        │  • Сброс параметров    │          │
        │                        │          │
        │  Логирование:          │          │
        │  "Цикл #42 ЗАВЕРШЁН    │          │
        │   УСПЕШНО"             │          │
        └───────────┬────────────┘          │
                    │                       │
                    ▼                       │
        ┌────────────────────────┐          │
        │  🎉 МОЖНО НАЧИНАТЬ     │          │
        │  НОВЫЙ ЦИКЛ            │          │
        └────────────────────────┘          │
                                            │
                    ┌───────────────────────┘
                    │
                    ▼
        ┌────────────────────────┐
        │  ⏳ ОЖИДАНИЕ           │
        │  СЛЕДУЮЩЕЙ ПРОВЕРКИ    │
        │                        │
        │  Через 10 секунд       │
        │  повторим попытку FOK  │
        └────────────────────────┘


╔══════════════════════════════════════════════════════════════════════════════╗
║                        ДЕТАЛЬНАЯ ДИАГРАММА FOK-ОРДЕРА                        ║
╚══════════════════════════════════════════════════════════════════════════════╝


        АВТОТРЕЙДЕР                        GATE.IO БИРЖА
             │                                      │
             │ 1. POST /spot/orders                 │
             │    {                                 │
             │      currency_pair: "WLD_USDT",      │
             │      side: "sell",                   │
             │      type: "limit",                  │
             │      amount: "100.0",                │
             │      price: "2.5000",                │
             │      time_in_force: "fok" ◄══════════╣  🔑 Ключевой параметр!
             │    }                                 │
             ├──────────────────────────────────────►
             │                                      │
             │                                      │  🔍 Биржа проверяет
             │                                      │  книгу заявок:
             │                                      │
             │                                      │  Есть ли 100 WLD
             │                                      │  ≥ 2.5000 USDT?
             │                                      │
             │                                      ├─── ДА ──┐
             │                                      │         ▼
             │ 2a. Response (success)               │  ✅ Исполнить
             │    {                                 │  полностью
             │      id: "123456789",                │
             │      status: "open"  ◄───────────────┤
             │    }                                 │
             │◄──────────────────────────────────────
             │                                      │
             │                                      │
             │  ⏱️ Ждём 1 секунду                   │  ⏱️ Ордер исполняется
             │                                      │
             │                                      │
             │ 3. GET /spot/orders/123456789        │
             ├──────────────────────────────────────►
             │                                      │
             │ 4. Response                          │
             │    {                                 │
             │      id: "123456789",                │
             │      status: "closed",  ◄────────────┤  ✅ Исполнен
             │      avg_deal_price: "2.50123456",   │
             │      filled_amount: "100.0",         │
             │      filled_total: "250.1235"        │
             │    }                                 │
             │◄──────────────────────────────────────
             │                                      │
             │                                      │
             │  ✅ Завершить цикл                   │
             │                                      │


        АВТОТРЕЙДЕР                        GATE.IO БИРЖА
             │                                      │
             │ 1. POST /spot/orders                 │
             │    {                                 │
             │      currency_pair: "XRP_USDT",      │
             │      side: "sell",                   │
             │      type: "limit",                  │
             │      amount: "200.0",                │
             │      price: "2.0000",                │
             │      time_in_force: "fok" ◄══════════╣  🔑 Ключевой параметр!
             │    }                                 │
             ├──────────────────────────────────────►
             │                                      │
             │                                      │  🔍 Биржа проверяет
             │                                      │  книгу заявок:
             │                                      │
             │                                      │  Есть ли 200 XRP
             │                                      │  ≥ 2.0000 USDT?
             │                                      │
             │                                      ├─── НЕТ ──┐
             │                                      │          ▼
             │ 2b. Response (success)               │  ❌ Отменить
             │    {                                 │  автоматически
             │      id: "987654321",                │
             │      status: "open"  ◄───────────────┤
             │    }                                 │
             │◄──────────────────────────────────────
             │                                      │
             │                                      │
             │  ⏱️ Ждём 1 секунду                   │  ⏱️ Ордер отменяется
             │                                      │
             │                                      │
             │ 3. GET /spot/orders/987654321        │
             ├──────────────────────────────────────►
             │                                      │
             │ 4. Response                          │
             │    {                                 │
             │      id: "987654321",                │
             │      status: "cancelled",  ◄─────────┤  ❌ Отменён
             │      avg_deal_price: "0",            │
             │      filled_amount: "0",             │
             │      filled_total: "0"               │
             │    }                                 │
             │◄──────────────────────────────────────
             │                                      │
             │                                      │
             │  ❌ НЕ завершать цикл                │
             │  ⏳ Повторить при следующей проверке │
             │                                      │


╔══════════════════════════════════════════════════════════════════════════════╗
║                    СРАВНЕНИЕ: GTC vs FOK vs IOC                              ║
╚══════════════════════════════════════════════════════════════════════════════╝


┌─────────────────────────────────────────────────────────────────────────────┐
│  GTC (Good-Til-Cancelled) - НЕ ИСПОЛЬЗУЕТСЯ                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    АВТОТРЕЙДЕР                        GATE.IO БИРЖА
         │                                      │
         │ 1. Создать ордер (GTC)               │
         ├──────────────────────────────────────►
         │                                      │
         │ 2. Response: status="open"           │  📚 Ордер в книге заявок
         │◄──────────────────────────────────────
         │                                      │
         │  ⏱️ Ждём 0.5 сек                     │
         │                                      │
         │ 3. Проверка статуса                  │
         ├──────────────────────────────────────►
         │                                      │
         │ 4. Response: status="open"           │  📚 Всё ещё в книге
         │◄──────────────────────────────────────
         │                                      │
         │  ❌ "Ордер не исполнен"              │
         │  ❌ Больше не проверяем!             │  ⚠️ Но ордер остался!
         │                                      │
         │  ... 2 часа спустя ...               │
         │                                      │  ✅ Ордер исполнился!
         │  ❌ Автотрейдер не знает!            │
         │  ❌ Цикл "зависает"                  │
         │  ❌ Баланс = 0, но state=ACTIVE      │


┌─────────────────────────────────────────────────────────────────────────────┐
│  FOK (Fill-Or-Kill) - ✅ ИСПОЛЬЗУЕТСЯ                                       │
└─────────────────────────────────────────────────────────────────────────────┘

    АВТОТРЕЙДЕР                        GATE.IO БИРЖА
         │                                      │
         │ 1. Создать ордер (FOK)               │
         ├──────────────────────────────────────►
         │                                      │  🔍 Проверка СРАЗУ:
         │                                      │  Можно исполнить?
         │                                      │
         │                                      ├─ ДА  → closed
         │                                      ├─ НЕТ → cancelled
         │                                      │
         │ 2. Response: status="open"           │  ⏱️ 1-2 секунды
         │◄──────────────────────────────────────
         │                                      │
         │  ⏱️ Ждём 1 сек × 3                   │
         │                                      │
         │ 3. Проверка статуса                  │
         ├──────────────────────────────────────►
         │                                      │
         │ 4. Response: status="closed"         │  ✅ Готово!
         │    или status="cancelled"            │
         │◄──────────────────────────────────────
         │                                      │
         │  ✅ Результат ИЗВЕСТЕН!              │
         │  ✅ Никаких сюрпризов!               │


┌─────────────────────────────────────────────────────────────────────────────┐
│  IOC (Immediate-Or-Cancel) - НЕ ИСПОЛЬЗУЕТСЯ                                │
└─────────────────────────────────────────────────────────────────────────────┘

    АВТОТРЕЙДЕР                        GATE.IO БИРЖА
         │                                      │
         │ 1. Создать ордер (IOC)               │
         │    Продать: 100 WLD                  │
         ├──────────────────────────────────────►
         │                                      │  🔍 Проверка:
         │                                      │  Есть 100 WLD? НЕТ
         │                                      │  Есть 80 WLD? ДА
         │                                      │
         │                                      │  ✅ Исполнить 80
         │                                      │  ❌ Отменить 20
         │                                      │
         │ 2. Response: status="closed"         │
         │    filled_amount: "80.0"  ◄──────────┤  ⚠️ Частичное
         │◄──────────────────────────────────────     исполнение!
         │                                      │
         │  ⚠️ Что делать с остатком?           │
         │  ⚠️ Цикл завершён или нет?           │
         │  ⚠️ Усложняет логику!                │


╔══════════════════════════════════════════════════════════════════════════════╗
║                              ИТОГОВАЯ ТАБЛИЦА                                ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌────────────────────────────────────────────────────────────────────────────┐
│  Параметр           │  GTC           │  FOK ✅        │  IOC              │
├─────────────────────┼────────────────┼────────────────┼───────────────────┤
│  Исполнение         │  Полное        │  Полное или    │  Частичное или    │
│                     │                │  отмена        │  полное           │
├─────────────────────┼────────────────┼────────────────┼───────────────────┤
│  Время              │  Секунды-дни   │  1-3 секунды   │  1-3 секунды      │
├─────────────────────┼────────────────┼────────────────┼───────────────────┤
│  Остаётся в книге?  │  ✅ Да         │  ❌ Нет        │  ❌ Нет           │
├─────────────────────┼────────────────┼────────────────┼───────────────────┤
│  Результат известен │  ❌ Нет        │  ✅ Да         │  ✅ Да            │
│  сразу              │                │                │                   │
├─────────────────────┼────────────────┼────────────────┼───────────────────┤
│  Риск "зависания"   │  ✅ Высокий    │  ❌ Нулевой    │  ❌ Нулевой       │
│  цикла              │                │                │                   │
├─────────────────────┼────────────────┼────────────────┼───────────────────┤
│  Обработка остатка  │  N/A           │  N/A           │  ⚠️ Требуется     │
├─────────────────────┼────────────────┼────────────────┼───────────────────┤
│  Подходит для       │  ❌ Нет        │  ✅ ДА!        │  ⚠️ Усложняет     │
│  автотрейдера?      │                │                │                   │
└────────────────────────────────────────────────────────────────────────────┘


╔══════════════════════════════════════════════════════════════════════════════╗
║                            ФИНАЛЬНЫЙ ВЫВОД                                   ║
╚══════════════════════════════════════════════════════════════════════════════╝

    ┌─────────────────────────────────────────────────────────────┐
    │                                                             │
    │  FOK-ОРДЕРА — ИДЕАЛЬНОЕ РЕШЕНИЕ ДЛЯ АВТОТРЕЙДЕРА!          │
    │                                                             │
    │  ✅ Результат известен через 1-3 секунды                    │
    │  ✅ Либо исполнен полностью, либо отменён                   │
    │  ✅ Никаких "зависших" ордеров                              │
    │  ✅ Простая логика обработки (2 ветки)                      │
    │  ✅ Цикл всегда в корректном состоянии                      │
    │                                                             │
    │  🎯 РЕАЛИЗОВАНО В autotrader_v2.py                          │
    │  🎯 РАБОТАЕТ КОРРЕКТНО                                      │
    │  🎯 ГОТОВО К ИСПОЛЬЗОВАНИЮ                                  │
    │                                                             │
    └─────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════

Дата: 2024-12-09
Версия: 1.0
