# üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¢—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –§–ª–∞–≥ –°–æ—Å—Ç–æ—è–Ω–∏—è –¶–∏–∫–ª–∞

**–í–µ—Ä—Å–∏—è:** 1.5.3  
**–î–∞—Ç–∞:** 6 –¥–µ–∫–∞–±—Ä—è 2025  
**–§–∞–π–ª:** `autotrader.py`

---

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê

–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∏ –¥–∞–∂–µ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —É—Å–ø–µ—à–Ω–æ–π –ø–æ–∫—É–ø–∫–∏:

```
[07:47:37] Sell (—Ü–∏–∫–ª –∑–∞–∫—Ä—ã—Ç)
[07:47:39] Buy #1 (10.0285 USDT) ‚Üê –ü–ï–†–í–ê–Ø –ü–û–ö–£–ü–ö–ê
[07:47:41] Buy #2 (10.0267 USDT) ‚Üê –î–£–ë–õ–ò–ö–ê–¢!
```

**–ü—Ä–∏—á–∏–Ω–∞:**  
–ú–µ–∂–¥—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø–æ–∫—É–ø–∫–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π `active=True` –ø—Ä–æ—Ö–æ–¥–∏–ª–æ –≤—Ä–µ–º—è (–∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª, –ø–µ—Ä–µ—Å—á—ë—Ç —Ç–∞–±–ª–∏—Ü—ã, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ). –°–ª–µ–¥—É—é—â–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –Ω–µ –≤–∏–¥–µ–ª–∞, —á—Ç–æ –ø–æ–∫—É–ø–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.

---

## üîç –ê–ù–ê–õ–ò–ó

**–°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞:**

```python
if cycle.get('active'):
    return  # –ù–µ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Ü–∏–∫–ª

# ... –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–∫—É–ø–∫–∞ ...
cycle['active'] = True  # ‚Üê –ü–û–ó–î–ù–û! –î—Ä—É–≥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è —É–∂–µ –º–æ–≥–ª–∞ –Ω–∞—á–∞—Ç—å –ø–æ–∫—É–ø–∫—É
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π `active=False` –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π `active=True` –ø—Ä–æ—Ö–æ–¥–∏—Ç 2-5 —Å–µ–∫—É–Ω–¥:
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤ (1-3 —Å–µ–∫)
- –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª (`_save_cycles_state()`)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `state_manager`
- –ü–µ—Ä–µ—Å—á—ë—Ç —Ç–∞–±–ª–∏—Ü—ã (`calculate_breakeven_table()`)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞ —ç—Ç–æ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è (—á–µ—Ä–µ–∑ `sleep_interval=0.5s`) —É—Å–ø–µ–≤–∞–µ—Ç:
1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å `active=False`
2. –ù–∞—á–∞—Ç—å –í–¢–û–†–£–Æ –ø–æ–∫—É–ø–∫—É!

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

–í–≤–µ–¥—ë–Ω **—Ç—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ñ–ª–∞–≥ `cycle_start_state`:**

```python
cycle_start_state:
  0 = –ù–ï–¢ –¶–ò–ö–õ–ê (–º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–æ–∫—É–ø–∫—É)
  1 = –ü–û–ö–£–ü–ö–ê –í –ü–†–û–¶–ï–°–°–ï (–±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏)
  2 = –¶–ò–ö–õ –ê–ö–¢–ò–í–ï–ù (—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, active=True)
```

### –ê–ª–≥–æ—Ä–∏—Ç–º:

```python
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞: –º–æ–∂–Ω–æ –ª–∏ –Ω–∞—á–∏–Ω–∞—Ç—å –ø–æ–∫—É–ø–∫—É?
if cycle.get('cycle_start_state', 0) != 0:
    return  # –ù–ï–¢! 1=–ø–æ–∫—É–ø–∫–∞ –∏–¥—ë—Ç, 2=—Ü–∏–∫–ª –∞–∫—Ç–∏–≤–µ–Ω

# 2. –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê
cycle['cycle_start_state'] = 1  # –ü–û–ö–£–ü–ö–ê –í –ü–†–û–¶–ï–°–°–ï
self.cycles[base] = cycle
self._save_cycles_state()  # ‚Üê –°–û–•–†–ê–ù–ï–ù–ò–ï –í –§–ê–ô–õ –°–†–ê–ó–£!

# 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
order_res = ...  # –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 2-5 —Å–µ–∫

# 4. –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ü–∏–∫–ª–∞
cycle['cycle_start_state'] = 2  # –¶–ò–ö–õ –ê–ö–¢–ò–í–ï–ù
cycle['active'] = True
self._save_cycles_state()

# 5. –ü–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂–∏
cycle['cycle_start_state'] = 0  # –°–ë–†–û–° (–º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª)
```

---

## üìä –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê

| **–ü–∞—Ä–∞–º–µ—Ç—Ä** | **–î–æ** | **–ü–æ—Å–ª–µ** |
|---|---|---|
| –î—É–±–ª–∏—Ä—É—é—â–∏–µ –ø–æ–∫—É–ø–∫–∏ | ‚úÖ –í–æ–∑–º–æ–∂–Ω—ã (2-3 –∑–∞ —Ü–∏–∫–ª) | ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω—ã |
| Lock/threading | ‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è | ‚ùå –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è |
| –ó–∞–¥–µ—Ä–∂–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ | 2-5 —Å–µ–∫ | 0.1 —Å–µ–∫ |
| –°–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–¥–∞ | –í—ã—Å–æ–∫–∞—è (Lock, try/finally) | –ù–∏–∑–∫–∞—è (–ø—Ä–æ—Å—Ç–æ–π —Ñ–ª–∞–≥) |

---

## üß™ –û–ñ–ò–î–ê–ï–ú–û–ï –ü–û–í–ï–î–ï–ù–ò–ï

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
```
[07:47:37] [ETH] Sell (—Ü–∏–∫–ª –∑–∞–∫—Ä—ã—Ç, cycle_start_state=0)
[07:47:39] [ETH] cycle_start_state=0 ‚Üí –º–æ–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å
[07:47:39] [ETH] cycle_start_state=1 ‚Üí –ë–õ–û–ö–ò–†–û–í–ö–ê
[07:47:41] [ETH] Buy —É—Å–ø–µ—à–Ω–∞
[07:47:41] [ETH] cycle_start_state=2, active=True
[07:47:42] [ETH] –°–ª–µ–¥—É—é—â–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è: cycle_start_state=2 ‚Üí –ù–ï –ø–æ–∫—É–ø–∞–µ–º (—É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω)
```

### ‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
[07:47:39] [ETH] Buy #1
[07:47:41] [ETH] Buy #2 ‚Üê –î–£–ë–õ–ò–ö–ê–¢
```

---

## üöÄ –ü–†–û–í–ï–†–ö–ê

```powershell
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
.\restart_autotrader.bat

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
Select-String -Path system_trader.log -Pattern "cycle_start_state" | Select-Object -Last 20

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–µ–π
Select-String -Path system_trader.log -Pattern "Buy{" | 
    Group-Object { $_.Line -replace '.*\[(\w+)\].*', '$1' } |
    Where-Object { $_.Count -gt 1 } |
    ForEach-Object { "$($_.Name): $($_.Count) –ø–æ–∫—É–ø–æ–∫ - –ü–†–û–í–ï–†–ò–¢–¨!" }
```

---

## üìÅ –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´

- ‚úÖ `autotrader.py` ‚Üí –º–µ—Ç–æ–¥ `_try_start_cycle()`, `_try_start_cycle_impl()`, `_try_sell()`, `_ensure_cycle_struct()`
- ‚úÖ `CYCLE_START_STATE_FIX.md` ‚Üí —ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ `CYCLE_ACTIVATION_FIX_SUMMARY.txt` ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–≤–æ–¥–∫–∞

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –£–¥–∞–ª—ë–Ω –∫–æ–¥:
- ‚ùå `self._start_cycle_locks: Dict[str, Lock]` (Lock –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–ª—é—Ç—ã)
- ‚ùå `self._locks_creation_lock` (–º–∞—Å—Ç–µ—Ä-Lock)
- ‚ùå –í–µ—Å—å –±–ª–æ–∫ `with self._locks_creation_lock:`
- ‚ùå `acquired = self._start_cycle_locks[base].acquire(blocking=False)`
- ‚ùå `finally: self._start_cycle_locks[base].release()`

### –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–¥:
- ‚úÖ `'cycle_start_state': 0` –≤ `_ensure_cycle_struct()`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `if cycle.get('cycle_start_state', 0) != 0: return`
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `cycle['cycle_start_state'] = 1` –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `cycle['cycle_start_state'] = 2` –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏
- ‚úÖ –°–±—Ä–æ—Å `cycle['cycle_start_state'] = 0` –ø–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂–∏

---

## ‚úÖ –°–¢–ê–¢–£–°

**–ò–°–ü–†–ê–í–õ–ï–ù–û ‚úÖ**

- –°–∏–Ω—Ç–∞–∫—Å–∏—Å: ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω
- –õ–æ–≥–∏–∫–∞: ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ production)

---

## üìù –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø

1. **–£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–¥–∞:** –£–¥–∞–ª—ë–Ω –≤–µ—Å—å threading.Lock –∫–æ–¥ (–±–æ–ª–µ–µ 30 —Å—Ç—Ä–æ–∫)
2. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:** –§–ª–∞–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ñ–∞–π–ª –°–†–ê–ó–£, –±–ª–æ–∫–∏—Ä—É—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
3. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
4. **–û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ:** –ï—Å–ª–∏ –ø–æ–∫—É–ø–∫–∞ —É–ø–∞–ª–∞ —Å exception, —Ñ–ª–∞–≥ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 0

---

üéâ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–• –ü–û–ö–£–ü–û–ö –£–°–¢–†–ê–ù–Å–ù!**
