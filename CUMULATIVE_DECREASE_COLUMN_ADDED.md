# Добавлена колонка накопленного процента снижения ✅

## Дата выполнения
16 ноября 2025

## Описание изменений

### Новая структура таблицы безубыточности

Между колонками "Ст." и "Курс" теперь размещены **две колонки процентов**:

1. **↓, %** - Накопленная сумма процентов снижения
   - Показывает общее снижение от стартовой цены
   - Рассчитывается как сумма всех шагов снижения
   - Точность: 3 знака после запятой
   - Цвет: красный (для отрицательных значений)

2. **↓Δ,%** - Шаг процента снижения (было просто "↓, %")
   - Показывает снижение на текущем шаге
   - Формула: `-((# × Rk) + R)`
   - Точность: 3 знака после запятой
   - Цвет: светло-красный

### Пример расчёта

При параметрах: R = 3.650, Rk = 0.100

| # | ↓, % (накопл.) | ↓Δ,% (шаг) | Курс |
|---|----------------|------------|------|
| 0 | 0.000 | 0.000 | 100.000 |
| 1 | -3.750 | -3.750 | 96.250 |
| 2 | -7.600 | -3.850 | 92.400 |
| 3 | -11.550 | -3.950 | 88.450 |
| 4 | -15.600 | -4.050 | 84.400 |

**Объяснение:**
- Шаг 1: -3.750% (от R + Rk)
- Шаг 2: накопл. = -3.750 + (-3.850) = -7.600%
- Шаг 3: накопл. = -7.600 + (-3.950) = -11.550%

### Логика расчёта

**В Python (`breakeven_calculator.py`):**
```python
cumulative_decrease = 0.0  # Накопленная сумма

for step in range(steps + 1):
    # Шаг снижения
    decrease_step_pct = -((step * rk) + target_r) if step > 0 else 0.0
    
    # Накопление суммы
    if step > 0:
        cumulative_decrease += decrease_step_pct
    
    # Курс рассчитывается от накопленной суммы
    rate = start_price * (1 + cumulative_decrease / 100.0)
```

## Изменённые файлы

### 1. `breakeven_calculator.py`
- ✅ Добавлена переменная `cumulative_decrease` для накопления суммы
- ✅ Переименовано `decrease_pct` → `decrease_step_pct`
- ✅ Добавлено поле `cumulative_decrease_pct` в возвращаемый словарь
- ✅ Курс теперь рассчитывается от накопленной суммы
- ✅ Обновлены комментарии в docstring

### 2. `templates/index.html`
- ✅ Добавлена колонка "↓, %" с tooltip "Накопленная сумма процентов снижения"
- ✅ Переименована колонка в "↓Δ,%" с tooltip "Шаг процента снижения: -((# × Rk) + R)"
- ✅ Обновлено colspan в tbody с 9 на 10

### 3. `static/app.js`
- ✅ Добавлена переменная `cumulativeDecrease` для отображения накопленной суммы
- ✅ Переименована переменная `decrease` → `decreaseStep`
- ✅ Добавлены отдельные цвета для обеих колонок
- ✅ Добавлены tooltips для пояснения колонок
- ✅ Накопленная сумма выделена жирным шрифтом

## Преимущества

1. **Наглядность**: Теперь видно не только шаг изменения, но и общее снижение от стартовой цены
2. **Контроль**: Легко отследить, на сколько процентов упала цена от начала цикла
3. **Точность**: Обе колонки показывают 3 знака после запятой
4. **Визуальное различие**: Разные цвета и жирность шрифта помогают различать колонки

## Проверка
- ✅ Нет синтаксических ошибок
- ✅ Таблица расширена с 9 до 10 колонок
- ✅ Курс рассчитывается от накопленной суммы процентов
- ✅ Все комментарии на русском языке

## Статус
**ЗАВЕРШЕНО** ✅
