#!/usr/bin/env python3
"""
–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ü–µ–Ω—É –ø–æ–∫—É–ø–∫–∏
"""

import json
import os
import sys
from datetime import datetime

def check_breakeven_fix():
    print("=" * 80)
    print("–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –¢–ê–ë–õ–ò–¶–´ –ë–ï–ó–£–ë–´–¢–û–ß–ù–û–°–¢–ò")
    print("=" * 80)
    print()
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ app.js
    print("1Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –≤ static/app.js:")
    print("-" * 80)
    
    app_js_path = "static/app.js"
    if not os.path.exists(app_js_path):
        print("‚ùå –û–®–ò–ë–ö–ê: —Ñ–∞–π–ª static/app.js –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return False
    
    with open(app_js_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    checks = [
        ("–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Ü–∏–∫–ª–∞", "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Ü–∏–∫–ª–∞"),
        ("cycle.active && cycle.table", "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã"),
        ("/api/trade/indicators", "–ó–∞–ø—Ä–æ—Å –∫ /api/indicators –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Ü–∏–∫–ª–∞"),
        ("renderBreakEvenTable(cycle.table)", "–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã"),
    ]
    
    all_checks_passed = True
    for check_text, description in checks:
        if check_text in content:
            print(f"‚úÖ {description}")
        else:
            print(f"‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢: {description}")
            all_checks_passed = False
    
    if not all_checks_passed:
        print("\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í –∫–æ–¥–µ app.js –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è!")
        print("   –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –±—ã–ª –∏–∑–º–µ–Ω—ë–Ω –∏–ª–∏ –æ—Ç–∫–∞—Ç–∏–ª—Å—è –∫ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏.")
        return False
    
    print("\n‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –∫–æ–¥–µ app.js")
    print()
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ü–∏–∫–ª–æ–≤
    print("2Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ü–∏–∫–ª–æ–≤ (autotrader_cycles_state.json):")
    print("-" * 80)
    
    state_path = "autotrader_cycles_state.json"
    if not os.path.exists(state_path):
        print("‚ö†Ô∏è  –§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω (—Ü–∏–∫–ª –Ω–µ –∑–∞–ø—É—â–µ–Ω)")
        print()
        return True  # –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ü–∏–∫–ª –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
    
    try:
        with open(state_path, 'r', encoding='utf-8') as f:
            state = json.load(f)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ü–∏–∫–ª–æ–≤
        if not state or 'cycles' not in state or not state['cycles']:
            print("‚ö†Ô∏è  –í —Ñ–∞–π–ª–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤")
            print()
            return True
        
        # –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ü–∏–∫–ª—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π
        active_cycles_found = False
        for currency, cycle_data in state['cycles'].items():
            if not cycle_data.get('active', False):
                continue
            
            active_cycles_found = True
            print(f"\nüìä –í–∞–ª—é—Ç–∞: {currency}")
            print(f"   –°—Ç–∞—Ç—É—Å: {'üü¢ –ê–ö–¢–ò–í–ï–ù' if cycle_data.get('active') else 'üî¥ –ù–ï–ê–ö–¢–ò–í–ï–ù'}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã
            if 'table' not in cycle_data or not cycle_data['table']:
                print(f"   ‚ö†Ô∏è  –¢–∞–±–ª–∏—Ü–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ü–∏–∫–ª–µ!")
                continue
            
            table = cycle_data['table']
            print(f"   ‚úÖ –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç ({len(table)} —à–∞–≥–æ–≤)")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º P0 (—Ü–µ–Ω–∞ –Ω–∞ —à–∞–≥–µ 0)
            if len(table) > 0 and 'rate' in table[0]:
                p0 = table[0]['rate']
                print(f"   üìç P0 (—Ü–µ–Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø–æ–∫—É–ø–∫–∏): {p0}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—É–ø–∫–∞—Ö
                if 'buys' in cycle_data and cycle_data['buys']:
                    last_buy = cycle_data['buys'][-1]
                    buy_price = last_buy.get('price', 'N/A')
                    print(f"   üí∞ –¶–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏: {buy_price}")
                    
                    if isinstance(buy_price, (int, float)) and abs(buy_price - p0) < 0.0001:
                        print(f"   ‚úÖ P0 —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ü–µ–Ω–æ–π –ø–æ–∫—É–ø–∫–∏!")
                    else:
                        print(f"   ‚ö†Ô∏è  P0 –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ü–µ–Ω—ã –ø–æ–∫—É–ø–∫–∏")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º step (—Ç–µ–∫—É—â–∏–π —à–∞–≥)
            current_step = cycle_data.get('step', 0)
            print(f"   üìä –¢–µ–∫—É—â–∏–π —à–∞–≥: {current_step}")
        
        if not active_cycles_found:
            print("‚ö†Ô∏è  –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è: {e}")
        return False
    
    print()
    
    # 3. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    print("3Ô∏è‚É£  –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –ù–ê –í–ï–ë-–°–¢–†–ê–ù–ò–¶–ï:")
    print("-" * 80)
    print("""
–ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. üîÑ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ñ–Å–°–¢–ö–£–Æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã:
   ‚Ä¢ Chrome/Edge: Ctrl + F5 –∏–ª–∏ Ctrl + Shift + R
   ‚Ä¢ Firefox: Ctrl + F5 –∏–ª–∏ Ctrl + Shift + R
   
2. üîç –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (F12 ‚Üí Console)

3. üëÄ –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ü–∏–∫–ª–µ –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
   [BREAKEVEN] ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Ü–∏–∫–ª–∞ (X —à–∞–≥–æ–≤, P0=Y)
   
4. üìä –í —Ç–∞–±–ª–∏—Ü–µ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏:
   ‚Ä¢ P0 (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞) –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ü–µ–Ω—É —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø–æ–∫—É–ø–∫–∏
   ‚Ä¢ P0 –ù–ï –¥–æ–ª–∂–µ–Ω –º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   ‚Ä¢ P0 –ù–ï –¥–æ–ª–∂–µ–Ω –º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä—Å–∞
   
5. üî¥ –ï—Å–ª–∏ —Ü–∏–∫–ª –ù–ï –∞–∫—Ç–∏–≤–µ–Ω, –≤—ã —É–≤–∏–¥–∏—Ç–µ:
   [BREAKEVEN] –¶–∏–∫–ª –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω –∏–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å —Ç–µ–∫—É—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
   –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - —Ç–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —Å —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–æ–π.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
‚Ä¢ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ—á–∏—Å—Ç–∫–æ–π –∫—ç—à–∞ (Ctrl+F5)!
‚Ä¢ –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É!
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π [BREAKEVEN]
""")
    
    print()
    print("=" * 80)
    print("‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê")
    print("=" * 80)
    
    return True

if __name__ == '__main__':
    try:
        check_breakeven_fix()
    except Exception as e:
        print(f"\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
