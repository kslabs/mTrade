# –ö–†–ò–¢–ò–ß–ù–´–ô –ë–ê–ì–ò –° LOCK - –ò–°–ü–†–ê–í–õ–ï–ù

## –î–∞—Ç–∞: 6 –¥–µ–∫–∞–±—Ä—è 2024
## –ü—Ä–æ–±–ª–µ–º–∞: 503 –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ reset/resume —Ü–∏–∫–ª–∞

---

## üî¥ –ß–¢–û –ë–´–õ–û –ù–ê–ô–î–ï–ù–û

–í —Ñ–∞–π–ª–µ `autotrader_v2.py` –±—ã–ª–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ **–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ lock**:

```python
# –û–ü–ê–°–ù–´–ô –ö–û–î (–±—ã–ª –≤ –º–µ—Ç–æ–¥–µ _try_start_cycle):
lock.acquire()
try:
    # ... –∫–æ–¥ ...
    if some_condition:
        lock.release()  # ‚ùå –û–ü–ê–°–ù–û: —Ä–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥
        return
    # ... –∫–æ–¥ ...
finally:
    if lock.locked():  # ‚ùå –ö–†–ò–¢–ò–ß–ù–û –û–ü–ê–°–ù–û!
        lock.release()
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –æ–ø–∞—Å–Ω–æ?

1. **`if lock.locked(): lock.release()`** - —ç—Ç–æ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –æ–ø–∞—Å–Ω—ã–π –∫–æ–¥**!
   - `lock.locked()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ lock **–∫–µ–º —É–≥–æ–¥–Ω–æ** (–ª—é–±—ã–º –ø–æ—Ç–æ–∫–æ–º)
   - –ï—Å–ª–∏ lock –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω **–¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º** (–Ω–∞–ø—Ä–∏–º–µ—Ä, API endpoint), —Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫ **–Ω–µ –≤–ª–∞–¥–µ–µ—Ç lock**
   - –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–∑–≤–∞—Ç—å `lock.release()` –æ—Ç –ø–æ—Ç–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –≤–ª–∞–¥–µ–µ—Ç lock, –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫:
     - RuntimeError: "cannot release un-acquired lock"
     - –ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é
     - Deadlock (lock –≤–∏—Å–∏—Ç –Ω–∞–≤—Å–µ–≥–¥–∞)

2. **–†–∞–Ω–Ω–∏–π `lock.release()` –≤–Ω—É—Ç—Ä–∏ try-–±–ª–æ–∫–∞** - –æ—à–∏–±–∫–æ–æ–ø–∞—Å–Ω–æ:
   - –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ä–∞–Ω–Ω–µ–≥–æ `release()` –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ–¥ –ø–æ–ø–∞–¥—ë—Ç –≤ `finally`, –≥–¥–µ —Å–Ω–æ–≤–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è `release()`
   - –≠—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ RuntimeError

3. **–°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Ç–æ—á–µ–∫ –≤—ã—Ö–æ–¥–∞** - —Ç—Ä—É–¥–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –≥–¥–µ lock –∑–∞—Ö–≤–∞—á–µ–Ω, –≥–¥–µ –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω

---

## ‚úÖ –ß–¢–û –ë–´–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–û

–í—Å–µ –º–µ—Å—Ç–∞ –≤ `autotrader_v2.py`, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å `lock.acquire()` / `lock.release()`, –±—ã–ª–∏ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ **–±–µ–∑–æ–ø–∞—Å–Ω—ã–π `with lock:`**:

```python
# –ü–†–ê–í–ò–õ–¨–ù–´–ô –ö–û–î:
with lock:
    # ... –∫–æ–¥ ...
    # lock –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –±–ª–æ–∫–∞
    # –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ!
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

1. **–ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª** (`_main_loop`):
   ```python
   # –ë—ã–ª–æ:
   lock.acquire()
   try:
       # ... –∫–æ–¥ ...
   finally:
       lock.release()
   
   # –°—Ç–∞–ª–æ:
   with lock:
       # ... –∫–æ–¥ ...
   ```

2. **`_check_and_reset_if_empty`** - —Å–±—Ä–æ—Å —Ü–∏–∫–ª–∞ –ø—Ä–∏ –ø—É—Å—Ç–æ–º –±–∞–ª–∞–Ω—Å–µ
3. **`_try_start_cycle`** - —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø–æ–∫—É–ø–∫–∏ (—Å–∞–º—ã–π –∫—Ä–∏—Ç–∏—á–Ω—ã–π!)
4. **`_clear_buying_flag`** - —Å–Ω—è—Ç–∏–µ —Ñ–ª–∞–≥–∞ "–ø–æ–∫—É–ø–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ"

### –ü–æ—á–µ–º—É `with lock:` –ª—É—á—à–µ?

‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ lock** –¥–∞–∂–µ –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö
‚úÖ **–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–±—ã—Ç—å –≤—ã–∑–≤–∞—Ç—å `release()`**
‚úÖ **–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–∑–≤–∞—Ç—å `release()` –¥–≤–∞–∂–¥—ã**
‚úÖ **–ü—Ä–æ—Å—Ç–æ–π, –ø–æ–Ω—è—Ç–Ω—ã–π, –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–¥**
‚úÖ **Python –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç lock —á–µ—Ä–µ–∑ context manager**

---

## üîß –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
   ```bash
   python mTrade.py
   ```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç:
   ```bash
   python test_reset_resume.py
   ```

3. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   - ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã reset/resume –¥–æ–ª–∂–Ω—ã –æ—Ç–≤–µ—á–∞—Ç—å **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ** (< 0.1 —Å–µ–∫)
   - ‚úÖ **–ù–ï–¢ 503 –æ—à–∏–±–æ–∫**
   - ‚úÖ **–ù–ï–¢ —Ç–∞–π–º–∞—É—Ç–æ–≤**
   - ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è **–≤—Å–µ—Ö** –≤–∞–ª—é—Ç

---

## üìä –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

```
API ENDPOINT (reset_cycle)
    ‚Üì
with lock:                    ‚Üê Lock –¥–µ—Ä–∂–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ë–´–°–¢–†–û–ô –æ–ø–µ—Ä–∞—Ü–∏–∏
    cycle.reset()             ‚Üê –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ (~0.0001 —Å–µ–∫)
    
MAIN LOOP (autotrader_v2)
    ‚Üì
with lock:                    ‚Üê Lock –¥–µ—Ä–∂–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ß–¢–ï–ù–ò–Ø —Å–æ—Å—Ç–æ—è–Ω–∏—è
    state = cycle.state       ‚Üê –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ (~0.0001 —Å–µ–∫)
    
–ë–ï–ó lock:                     ‚Üê –í—Å–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ë–ï–ó lock
    price = api.get_price()   ‚Üê API –∑–∞–ø—Ä–æ—Å (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å —Å–µ–∫—É–Ω–¥—ã)
    balance = api.get_balance()
    order = api.create_order()
    
with lock:                    ‚Üê Lock —Ç–æ–ª—å–∫–æ –¥–ª—è –ó–ê–ü–ò–°–ò —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    cycle.activate(...)       ‚Üê –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ (~0.0001 —Å–µ–∫)
```

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:

1. **Lock –¥–µ—Ä–∂–∏—Ç—Å—è –ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ï –≤—Ä–µ–º—è** - —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è in-memory —Å–æ—Å—Ç–æ—è–Ω–∏—è
2. **–í—Å–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (API) - –ë–ï–ó lock**
3. **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `with lock:` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**
4. **–ù–µ—Ç deadlock, –Ω–µ—Ç race conditions, –Ω–µ—Ç 503 –æ—à–∏–±–æ–∫**

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

- ‚ùå **–ë–´–õ–û**: 503 –æ—à–∏–±–∫–∏, —Ç–∞–π–º–∞—É—Ç—ã, deadlock
- ‚úÖ **–°–¢–ê–õ–û**: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è, —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –≤–∞–ª—é—Ç

**–≠—Ç–æ –Ω–µ "–∫–æ—Å—Ç—ã–ª—å" - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞!**

---

## üìù –í–ê–ñ–ù–û

–ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –±—É–¥–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `lock`, **–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `with lock:`**:

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
with lock:
    # ... –∫–æ–¥ ...

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–æ–ø–∞—Å–Ω–æ!):
lock.acquire()
try:
    # ... –∫–æ–¥ ...
finally:
    lock.release()
```

**–ü—Ä–∞–≤–∏–ª–æ**: –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å lock - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `with lock:`. –í—Å–µ–≥–¥–∞. –ë–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
