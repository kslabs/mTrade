# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∞–ª—é—Ç

## üéØ –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∞–ª—é—Ç –Ω–∞ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–∏ –ø–æ–º–æ—â–∏ –≤–∫–ª–∞–¥–æ–∫:
- –î–æ–ª–≥–æ –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è
- –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–Ω–æ–≥–æ —Ä–∞–∑ —Ç—É–¥–∞-—Å—é–¥–∞
- –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, —Å –∫–∞–∫–æ–π –≤–∞–ª—é—Ç–æ–π –∏–¥–µ—Ç —Ä–∞–±–æ—Ç–∞

## üîç –ü—Ä–∏—á–∏–Ω–∞
–í —Ñ—É–Ω–∫—Ü–∏–∏ `switchBaseCurrency()` –≤—ã–ø–æ–ª–Ω—è–ª–æ—Å—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö** –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏:
```javascript
await subscribeToPairData(...);
await new Promise(resolve => setTimeout(resolve, 500)); // ‚ùå 500ms –∑–∞–¥–µ—Ä–∂–∫–∞!
await loadMarketData(true);
await loadPairBalances();
await loadPairParams(true);
await loadTradeParams();
await loadBreakEvenTable();
await updateSessionProfit();
await UIStateManager.savePartial(...);
```

–ü—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–∫–∞—Ö –ø–æ –≤–∫–ª–∞–¥–∫–∞–º –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ** –≤—ã–∑–æ–≤—ã `switchBaseCurrency()`, –∫–æ—Ç–æ—Ä—ã–µ:
- –ú–µ—à–∞–ª–∏ –¥—Ä—É–≥ –¥—Ä—É–≥—É
- –ó–∞–≥—Ä—É–∂–∞–ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≤–∞–ª—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –°–æ–∑–¥–∞–≤–∞–ª–∏ race conditions (–ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π != –≤—ã–±—Ä–∞–Ω–Ω—ã–π)

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1Ô∏è‚É£ –ú–µ—Ö–∞–Ω–∏–∑–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
```javascript
let isSwitchingCurrency = false;
let pendingSwitchCurrency = null;

async function switchBaseCurrency(code) {
  // –ï—Å–ª–∏ —É–∂–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º - –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å
  if (isSwitchingCurrency) {
    pendingSwitchCurrency = requestedCurrency;
    return;
  }
  
  // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—É—é –≤–∞–ª—é—Ç—É - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
  if (requestedCurrency === currentBaseCurrency) {
    return;
  }
  
  isSwitchingCurrency = true; // üîí –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
  
  try {
    // ... –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ ...
  } finally {
    isSwitchingCurrency = false; // üîì –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º
    
    // –ï—Å–ª–∏ –±—ã–ª –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å - –≤—ã–ø–æ–ª–Ω—è–µ–º –µ–≥–æ
    if (pendingSwitchCurrency && pendingSwitchCurrency !== currentBaseCurrency) {
      const nextCurrency = pendingSwitchCurrency;
      pendingSwitchCurrency = null;
      setTimeout(() => switchBaseCurrency(nextCurrency), 0);
    }
  }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã race conditions

### 2Ô∏è‚É£ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
–ó–∞–º–µ–Ω–∏–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ `await` –Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ `Promise.all()`:
```javascript
// ‚ùå –ë–´–õ–û (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –º–µ–¥–ª–µ–Ω–Ω–æ):
await loadMarketData(true);
await loadPairBalances();
await loadPairParams(true);
await loadTradeParams();
await loadBreakEvenTable();

// ‚úÖ –°–¢–ê–õ–û (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –±—ã—Å—Ç—Ä–æ):
await Promise.all([
  loadMarketData(true).catch(e => console.error(...)),
  loadPairBalances().catch(e => console.error(...)),
  loadPairParams(true).catch(e => console.error(...)),
  loadTradeParams().catch(e => console.error(...)),
  loadBreakEvenTable().catch(e => console.error(...))
]);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ **3-5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ**
- ‚úÖ –û—à–∏–±–∫–∏ –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –¥—Ä—É–≥–∏–µ (`.catch()`)

### 3Ô∏è‚É£ –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
–î–æ–±–∞–≤–ª–µ–Ω CSS –∫–ª–∞—Å—Å `.switching` —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π:
```css
.base-currency-tabs .tab-item.switching {
    opacity: 0.6;
    pointer-events: none;
    animation: pulse-border 1s ease-in-out infinite;
}
@keyframes pulse-border {
    0%, 100% { border-color: #4CAF50; }
    50% { border-color: #81C784; }
}
```

–ö–ª–∞—Å—Å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –≤–∫–ª–∞–¥–∫–µ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è:
```javascript
const targetTab = cont.querySelector(`.tab-item[data-code="${requestedCurrency}"]`);
if(targetTab) {
  targetTab.classList.add('switching'); // ‚è≥ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
}

try {
  // ... –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ ...
} finally {
  if(targetTab) {
    targetTab.classList.remove('switching'); // ‚úÖ –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é
  }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
- ‚úÖ –í–∫–ª–∞–¥–∫–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
- ‚úÖ –í–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–∫–∞—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É –Ω–µ–ª—å–∑—è (`pointer-events: none`)

### 4Ô∏è‚É£ –£–¥–∞–ª–µ–Ω–∞ –ª–∏—à–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞
–£–±—Ä–∞–Ω–∞ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 500ms:
```javascript
// ‚ùå –ë–´–õ–û:
await subscribeToPairData(currentBaseCurrency, currentQuoteCurrency);
await new Promise(resolve => setTimeout(resolve, 500)); // ‚ùå –ù–µ–Ω—É–∂–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞!
await loadMarketData(true);

// ‚úÖ –°–¢–ê–õ–û:
await subscribeToPairData(currentBaseCurrency, currentQuoteCurrency);
await Promise.all([...]);  // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
```

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚è±Ô∏è –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ: **~2-3 —Å–µ–∫—É–Ω–¥—ã**
- ‚ùå –ü—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–∫–∞—Ö: —Ö–∞–æ—Ç–∏—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç—É–¥–∞-—Å—é–¥–∞
- ‚ùå –ù–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
- ‚ùå –í–æ–∑–º–æ–∂–Ω—ã race conditions

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ö° –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ: **~300-500 –º—Å** (–≤ 5-6 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!)
- ‚úÖ –ü—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–∫–∞—Ö: –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è (–ø—É–ª—å—Å–∏—Ä—É—é—â–∞—è —Ä–∞–º–∫–∞)
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã race conditions
- ‚úÖ –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI (–Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—ã, –≤–∫–ª–∞–¥–∫–∏)

## üìù –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **static/app.js**:
   - –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–ª–∞–≥–∏ `isSwitchingCurrency` –∏ `pendingSwitchCurrency`
   - –ü–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `switchBaseCurrency()` —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å `switching`

2. **static/style.css**:
   - –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å `.switching` —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π `pulse-border`
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–ª–∏–∫–æ–≤ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (http://localhost:5000)
2. –ë—ã—Å—Ç—Ä–æ –∫–ª–∏–∫–∞–π—Ç–µ –ø–æ —Ä–∞–∑–Ω—ã–º –≤–∫–ª–∞–¥–∫–∞–º –≤–∞–ª—é—Ç
3. –ù–∞–±–ª—é–¥–∞–π—Ç–µ:
   - ‚úÖ –í–∫–ª–∞–¥–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π
   - ‚úÖ –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø—É–ª—å—Å–∏—Ä—É—é—â–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Ä–∞–º–∫–∏
   - ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–ª–∞–≤–Ω–æ –∏ –±—ã—Å—Ç—Ä–æ
   - ‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∏–∫ –≤—Å–µ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 18 –¥–µ–∫–∞–±—Ä—è 2025 –≥.  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
