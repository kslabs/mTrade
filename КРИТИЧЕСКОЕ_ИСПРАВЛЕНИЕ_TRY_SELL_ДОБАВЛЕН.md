# üîß –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è _try_sell

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–∫—É–ø–∫–∏ (`_try_rebuy`) –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä –ø–µ—Ä–µ—Å—Ç–∞–ª —Ç–æ—Ä–≥–æ–≤–∞—Ç—å:
- –ê–∫—Ç–∏–≤–Ω—ã–π —Ü–∏–∫–ª –µ—Å—Ç—å
- –ù–æ —Å—Ç–∞—Ç—É—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "‚è∏Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ"
- **–ü—Ä–∏—á–∏–Ω–∞**: —Ñ—É–Ω–∫—Ü–∏—è `_try_sell` **–ù–ï –û–ü–†–ï–î–ï–õ–ï–ù–ê** –≤ `autotrader_v2.py`!

### –í—ã–∑–æ–≤ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏

–í —Ñ–∞–π–ª–µ `autotrader_v2.py` (—Å—Ç—Ä–æ–∫–∞ 489) –µ—Å—Ç—å –≤—ã–∑–æ–≤:
```python
self._try_sell(base, quote, market_price, orderbook_price)
```

–ù–æ —Ñ—É–Ω–∫—Ü–∏—è `_try_sell` **–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** –≤ —Ñ–∞–π–ª–µ!

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

1. **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_try_sell`** –≤ `autotrader_v2.py`
   - –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∏–∑ `autotrader.py`
   - –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∫ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ AutoTraderV2
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã: `_ensure_cycle`, `_get_lock`, `_save_state`

2. **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ª–∏–º–∏—Ç–Ω—ã–µ FOK –æ—Ä–¥–µ—Ä–∞**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `orderbook_price` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–¥–µ—Ä–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `market_price` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏—è –ø—Ä–æ–¥–∞–∂–∏
   - FOK (Fill-Or-Kill): –æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–ª–∏ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è

3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**
   - –§–ª–∞–≥ `_selling_in_progress` (–∫–∞–∫ –≤ –¥–æ–∫—É–ø–∫–µ)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö SELL –æ—Ä–¥–µ—Ä–æ–≤
   - –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥ lock

4. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç PnL**
   - `pnl = (executed_price - avg_invest_price) * filled_amount`
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ `logger.log_sell()`
   - **–ë–ï–ó –ù–ê–ö–û–ü–õ–ï–ù–ò–Ø** –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏

5. **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_clear_selling_flag`**
   - –°–Ω–∏–º–∞–µ—Ç —Ñ–ª–∞–≥ `_selling_in_progress` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `_clear_rebuy_flag` –∏ `_clear_buying_flag`

### –°–∏–≥–Ω–∞—Ç—É—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏

```python
def _try_sell(self, base: str, quote: str, market_price: float, orderbook_price: float):
    """
    –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ breakeven.
    
    –ê–õ–ì–û–†–ò–¢–ú:
    1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ: market_price >= start_price * (1 + breakeven_pct / 100)
    2. –ò—Å–ø–æ–ª—å–∑—É–µ–º orderbook_price –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏–º–∏—Ç–Ω–æ–≥–æ FOK –æ—Ä–¥–µ—Ä–∞
    3. –ï—Å–ª–∏ –æ—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ü–∏–∫–ª, –ª–æ–≥–∏—Ä—É–µ–º PnL
    4. –ï—Å–ª–∏ –æ—Ä–¥–µ—Ä –Ω–µ –∏—Å–ø–æ–ª–Ω–µ–Ω ‚Üí –ø–æ–≤—Ç–æ—Ä–∏–º –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
    
    –ó–ê–©–ò–¢–ê –û–¢ –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø:
    - –§–ª–∞–≥ _selling_in_progress
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö SELL –æ—Ä–¥–µ—Ä–æ–≤
    
    Args:
        base: –ë–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ETH)
        quote: –í–∞–ª—é—Ç–∞ –∫–æ—Ç–∏—Ä–æ–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, USDT)
        market_price: –¢–µ–∫—É—â–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏—è)
        orderbook_price: –¶–µ–Ω–∞ –∏–∑ orderbook (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–¥–µ—Ä–∞)
    """
```

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

```
–®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–æ–¥ lock)
‚îú‚îÄ –¶–∏–∫–ª –∞–∫—Ç–∏–≤–µ–Ω?
‚îú‚îÄ –ï—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞?
‚îú‚îÄ –ü—Ä–æ–¥–∞–∂–∞ —É–∂–µ –∏–¥—ë—Ç?
‚îî‚îÄ –ö–æ–ø–∏—Ä—É–µ–º: start_price, active_step, base_volume

–®–ê–ì 2: –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ë–ï–ó lock)
‚îî‚îÄ breakeven_pct –∏–∑ —Ç–∞–±–ª–∏—Ü—ã

–®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ –ø—Ä–æ–¥–∞–∂–∏
‚îú‚îÄ current_growth_pct = ((market_price - start_price) / start_price) * 100
‚îî‚îÄ –ï—Å–ª–∏ current_growth_pct < required_growth_pct ‚Üí SKIP

–®–ê–ì 4: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ (–ø–æ–¥ lock, –∞—Ç–æ–º–∞—Ä–Ω–æ)
‚îî‚îÄ cycle._selling_in_progress = True

–®–ê–ì 5: API –∑–∞–ø—Ä–æ—Å—ã (–ë–ï–ó lock)
‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ SELL –æ—Ä–¥–µ—Ä–∞
‚îú‚îÄ –°–æ–∑–¥–∞—ë–º LIMIT FOK SELL –æ—Ä–¥–µ—Ä
‚îÇ  - amount = base_volume
‚îÇ  - price = orderbook_price
‚îÇ  - time_in_force = 'fok'
‚îî‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ (0.5s –∑–∞–¥–µ—Ä–∂–∫–∞)

–®–ê–ì 6: –ï—Å–ª–∏ –ø—Ä–æ–¥–∞–∂–∞ —É—Å–ø–µ—à–Ω–∞ (–ø–æ–¥ lock)
‚îú‚îÄ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º PnL = (exec_price - avg_price) * volume
‚îú‚îÄ –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ü–∏–∫–ª:
‚îÇ  - active_step = -1
‚îÇ  - start_price = 0
‚îÇ  - total_invested_usd = 0
‚îÇ  - base_volume = 0
‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (_save_state)

–®–ê–ì 7: –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–¥–∞–∂—É (–ë–ï–ó lock)
‚îî‚îÄ logger.log_sell(base, volume, price, growth_pct, pnl)
```

## üìã –ü–†–û–í–ï–†–ö–ê

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å
```bash
python -m py_compile autotrader_v2.py
# ‚úÖ –£—Å–ø–µ—à–Ω–æ (–±–µ–∑ –æ—à–∏–±–æ–∫)
```

### –õ–æ–≥–∏–∫–∞
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `_try_sell` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
- ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: `self._try_sell(base, quote, market_price, orderbook_price)`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (lock –¥–ª—è state, –ë–ï–ó lock –¥–ª—è API)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è (—Ñ–ª–∞–≥ `_selling_in_progress`)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç PnL (–ë–ï–ó –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `trade_logger.py`

## üéØ –ò–¢–û–ì

**–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê!**

–¢–µ–ø–µ—Ä—å –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä V2 –º–æ–∂–µ—Ç:
1. ‚úÖ **–ü–æ–∫—É–ø–∞—Ç—å** (—Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞)
2. ‚úÖ **–î–æ–∫—É–ø–∞—Ç—å** (–ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ —Ü–µ–Ω—ã –Ω–∞ `rebuy_trigger_pct`)
3. ‚úÖ **–ü—Ä–æ–¥–∞–≤–∞—Ç—å** (–ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ `breakeven_pct`)

–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥ lock (–±—ã—Å—Ç—Ä–æ)
- API –∑–∞–ø—Ä–æ—Å—ã –ë–ï–ó lock (–º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥ lock (–∞—Ç–æ–º–∞—Ä–Ω–æ)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–ï–ó lock

**–ê–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É!**

---

–°–æ–∑–¥–∞–Ω–æ: 2025-01-XX
–§–∞–π–ª: `autotrader_v2.py`
–°—Ç–∞—Ç—É—Å: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
