# 📊 ВИЗУАЛЬНАЯ ДИАГРАММА: Проверки докупки

```
┌─────────────────────────────────────────────────────────────────┐
│                    ФУНКЦИЯ _try_rebuy                           │
│                    (autotrader_v2.py)                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ Цикл активен?    │
                    └────────┬─────────┘
                             │ ❌ → ВЫХОД
                             ▼ ✅
                    ┌──────────────────┐
                    │ Есть таблица?    │
                    └────────┬─────────┘
                             │ ❌ → [SKIP] Нет таблицы
                             ▼ ✅
                    ┌──────────────────┐
                    │ Есть следующий   │
                    │ шаг в таблице?   │
                    └────────┬─────────┘
                             │ ❌ → [SKIP] Нет следующего шага
                             ▼ ✅
                    ┌──────────────────┐
                    │ Докупка уже в    │
                    │ процессе?        │
                    └────────┬─────────┘
                             │ ✅ → [SKIP] Докупка уже в процессе
                             ▼ ❌
                    ┌──────────────────┐
                    │ Задержка < 5с?   │
                    └────────┬─────────┘
                             │ ✅ → [SKIP] Задержка
                             ▼ ❌
        ┌────────────────────────────────────────────┐
        │ 🔍 ДИАГНОСТИКА ДОКУПКИ                     │
        │                                            │
        │  • Текущая цена (ticker.last)              │
        │  • Start price (P0)                        │
        │  • Предыдущая цена покупки (last_buy)      │
        │  • Табличная цена докупки (rate)           │
        │  • Требуемое падение (%)                   │
        └────────────────────────────────────────────┘
                              │
                              ▼
        ┌────────────────────────────────────────────┐
        │ УСЛОВИЕ 1: Цена достигла табличной?        │
        │                                            │
        │  price < tabular_rate ?                    │
        └────────┬───────────────────────────────────┘
                 │ ❌ → [BLOCK_1] Цена НЕ достигла табличной
                 ▼ ✅
        ┌────────────────────────────────────────────┐
        │ УСЛОВИЕ 2: Реальное падение достаточно?    │
        │                                            │
        │  price < last_buy * (1 + decrease_pct/100) │
        └────────┬───────────────────────────────────┘
                 │ ❌ → [BLOCK_2] Падение недостаточно
                 ▼ ✅
        ┌────────────────────────────────────────────┐
        │ Получить цену из стакана (orderbook)       │
        │                                            │
        │  asks[orderbook_level][0]                  │
        └────────┬───────────────────────────────────┘
                 │ ❌ → [BLOCK_3] Не удалось получить
                 ▼ ✅
        ┌────────────────────────────────────────────┐
        │ УСЛОВИЕ 3: Цена стакана <= табличной?      │
        │                                            │
        │  orderbook_price <= tabular_rate ?         │
        └────────┬───────────────────────────────────┘
                 │ ❌ → [BLOCK_4] Цена стакана выше табличной
                 ▼ ✅
        ┌────────────────────────────────────────────┐
        │ УСЛОВИЕ 4: Падение от стакана достаточно?  │
        │                                            │
        │  orderbook_price < last_buy * (1 + ...)    │
        └────────┬───────────────────────────────────┘
                 │ ❌ → [BLOCK_5] Падение недостаточно
                 ▼ ✅
        ┌────────────────────────────────────────────┐
        │ 🎯 ВСЕ УСЛОВИЯ ВЫПОЛНЕНЫ!                  │
        │                                            │
        │  Начинаем докупку...                       │
        └────────┬───────────────────────────────────┘
                 │
                 ▼
        ┌────────────────────────────────────────────┐
        │ Установить флаг _rebuy_in_progress         │
        │ Проверить открытые BUY ордера              │
        │ Проверить баланс USDT                      │
        │ Создать MARKET BUY ордер                   │
        │ Обновить состояние (шаг, инвестиции)       │
        │ Пересчитать таблицу                        │
        │ Сохранить состояние                        │
        └────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  ✅ ДОКУПКА      │
                    │  ЗАВЕРШЕНА       │
                    └──────────────────┘
```

---

## 🎯 Ключевые точки проверки

### 1️⃣ Функция вызывается?
```
[XRP] 🔄 _try_rebuy вызвана, цена=12.91700000
```
✅ Да → Идём дальше  
❌ Нет → Проблема в главном цикле

---

### 2️⃣ Ранние выходы
```
[XRP] [SKIP] Нет таблицы
[XRP] [SKIP] Нет следующего шага
[XRP] [SKIP] Докупка уже в процессе
[XRP] [SKIP] Задержка после последней докупки
```
✅ Нет SKIP → Идём дальше  
❌ Есть SKIP → Проблема в состоянии цикла

---

### 3️⃣ Блокировка условием

#### [BLOCK_1]: Цена не достигла табличной
```
[XRP] ❌ [BLOCK_1] Цена НЕ достигла табличной!
[XRP]   13.20000000 >= 13.18016250
```
**Причина:** `tabular_rate` (из таблицы) больше текущей цены  
**Гипотеза:** Таблица рассчитана с неправильной ценой P0

---

#### [BLOCK_2]: Реальное падение недостаточно
```
[XRP] ❌ [BLOCK_2] Реальное падение недостаточно!
[XRP]   Текущее: -3.50% < Требуемое: -3.65%
```
**Причина:** `last_buy_price` слишком высокий  
**Гипотеза:** Предыдущая покупка была дороже ожидаемой

---

#### [BLOCK_3]: Не удалось получить цену из стакана
```
[XRP] ❌ [BLOCK_3] Не удалось получить цену из стакана
```
**Причина:** Gate.io API не вернул стакан  
**Гипотеза:** Проблема с WebSocket или REST API

---

#### [BLOCK_4]: Цена из стакана выше табличной
```
[XRP] ❌ [BLOCK_4] Цена из стакана выше табличной!
[XRP]   Цена стакана: 13.19000000 > табличная: 13.18016250
```
**Причина:** Лучшая цена продажи в стакане выше уровня докупки  
**Гипотеза:** Рынок не упал достаточно глубоко

---

#### [BLOCK_5]: Падение от стакана недостаточно
```
[XRP] ❌ [BLOCK_5] Падение от цены стакана недостаточно!
[XRP]   Падение от стакана: -3.50% < требуемое: -3.65%
```
**Причина:** Даже по цене стакана падение меньше требуемого  
**Гипотеза:** Комбинация высокого `last_buy_price` и цены стакана

---

### 4️⃣ Все условия выполнены
```
[XRP] 🎯 ВСЕ УСЛОВИЯ ВЫПОЛНЕНЫ! Начинаем докупку...
[XRP] [LOCK] Флаг _rebuy_in_progress установлен
[XRP] 📈 Создание MARKET BUY (докупка): 50.00 USDT
```
✅ **Успех!** Докупка происходит

---

## 🔍 Пример полного лога (успех)

```
[XRP] 🔄 _try_rebuy вызвана, цена=12.91700000
[XRP] 🔍 ДИАГНОСТИКА ДОКУПКИ (шаг 5):
[XRP]   Текущая цена (ticker.last): 12.91700000
[XRP]   Start price (P0): 13.70500000
[XRP]   Предыдущая цена покупки: 13.68000000
[XRP]   Табличная цена докупки (rate): 13.18016250
[XRP]   Требуемое падение (%): -3.65%
[XRP] ✅ Условие 1: Цена достигла табличной (12.91700000 < 13.18016250)
[XRP]   Минимум для реального падения: 13.18008000
[XRP]   Текущее реальное падение: -5.57%
[XRP] ✅ Условие 2: Реальное падение достаточно (-5.57% >= -3.65%)
[XRP]   Цена из стакана (asks[0]): 12.91600000
[XRP] ✅ Условие 3: Цена стакана <= табличная (12.91600000 <= 13.18016250)
[XRP] ✅ Условие 4: Падение от стакана достаточно (-5.58% >= -3.65%)
[XRP] 🎯 ВСЕ УСЛОВИЯ ВЫПОЛНЕНЫ! Начинаем докупку...
[XRP] [LOCK] Флаг _rebuy_in_progress установлен, начинаем докупку...
[XRP] 📈 Создание MARKET BUY (докупку): 50.00 USDT
[XRP] ✅ Докупка выполнена! Ордер: 12345
[XRP] ✅ Шаг: 4 → 5, инвестировано: 103.24 → 153.24
```

---

## 🔍 Пример полного лога (блокировка)

```
[XRP] 🔄 _try_rebuy вызвана, цена=13.20000000
[XRP] 🔍 ДИАГНОСТИКА ДОКУПКИ (шаг 5):
[XRP]   Текущая цена (ticker.last): 13.20000000
[XRP]   Start price (P0): 13.70500000
[XRP]   Предыдущая цена покупки: 13.68000000
[XRP]   Табличная цена докупки (rate): 13.18016250
[XRP]   Требуемое падение (%): -3.65%
[XRP] ❌ [BLOCK_1] Цена НЕ достигла табличной! Докупка ОТМЕНЕНА
[XRP]   13.20000000 >= 13.18016250
[XRP]   Нужно: цена < 13.18016250
```

---

**Эта диаграмма поможет быстро понять, на каком этапе происходит блокировка!**
