<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- VERSION: 2025-11-10-21:00 - REFACT                    <button id="resetCycleBtn" class="server-btn-small" style="background:#ff9800;color:#fff;width:32px;height:32px;padding:0;font-size:16px;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="Сброс цикла">&#x23EE;</button>
                    <button id="resetSessionBtn" class="server-btn-small" style="background:#9c27b0;color:#fff;width:32px;height:32px;padding:0;font-size:16px;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="Сброс сессии (скоро)">&#x1F501;</button>CSS/JS SEPARATED) {{ cache_buster }} -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Gate.io Multi-Trading Platform [{{ cache_buster }}]</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-left"><div><h1>🚀 mTrade</h1><p>Gate.io Trading Platform</p></div></div>
        <div class="header-center">
            <div id="autoTradeSwitcher" class="autotrade-switch" title="Включить/выключить автоторговлю" onclick="toggleAutoTrade()">
                <span class="label-text">AutoTrade</span>
                <div class="mode-option" data-state="off">
                    OFF
                </div>
                <div class="mode-option active" data-state="on">
                    ON
                </div>
            </div>
            <div style="position:relative;display:inline-block;">
                <div id="networkSwitcher" class="network-switch" title="Переключить режим сети">
                    <div class="mode-option active" data-mode="work" onclick="switchNetworkMode('work')">
                        WORK
                    </div>
                    <div class="mode-option" data-mode="test" onclick="switchNetworkMode('test')">
                        TEST
                    </div>
                </div>
                <span id="networkConnStatus"></span>
            </div>
            <div id="tradingModeSwitcher" class="trading-mode-switch" title="Переключить режим торговли">
                <div class="mode-option active" data-mode="normal" onclick="switchTradingMode('normal')">
                    TRADE
                </div>
                <div class="mode-option" data-mode="copy" onclick="switchTradingMode('copy')">
                    COPY
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="server-status-inline"><div class="status-dot" id="statusDot"></div><span id="serverPID" style="color:#999;font-size:11px;">PID: ---</span></div>
            <div class="uptime-display" id="uptimeDisplay"><strong>00д 00:00:00</strong></div>
            <div class="server-controls-inline"><button class="server-btn-small restart" id="restartServerBtn">🔄</button><button class="server-btn-small shutdown" id="shutdownServerBtn">⏹️</button></div>
        </div>
    </div>

    <div class="base-currency-tabs" id="currencyTabsWrapper">
        <div style="display:flex;gap:8px;flex:1;overflow-x:auto;" id="currencyTabsContainer"><div class="loading" style="padding:10px;color:#666;font-size:12px;">Загрузка валют...</div></div>
        <button id="manageCurrenciesBtn" class="currency-gear-btn" title="Управление валютами" onclick="openCurrencyManager()">⚙️</button>
    </div>
    <!-- Модальное окно управления валютами -->
    <div id="currencyManagerModal" onclick="if(event.target===this)closeCurrencyManager()">
        <div class="modal-inner">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h4 style="margin:0;">⚙️ Управление базовыми валютами</h4>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="cm-btn" onclick="syncCurrenciesFromGateIO()" style="background:#17a2b8;padding:6px 12px;">
                        🔄 Синхронизация с Gate.io
                    </button>
                    <div id="syncInfo" style="font-size:11px;color:#888;"></div>
                </div>
            </div>
            <div id="currencyManagerRows"></div>
            <div class="cm-actions">
                <button class="cm-btn add" onclick="addCurrencyRow()">➕ Добавить</button>
                <button class="cm-btn save" onclick="saveCurrenciesList()">💾 Сохранить</button>
                <button class="cm-btn cancel" onclick="closeCurrencyManager()">✖ Отмена</button>
            </div>
            <div style="margin-top:10px;font-size:11px;color:#888;line-height:1.4">
                Данные сохраняются на сервере (currencies.json). Минимум 1 валюта, коды уникальны.<br>
                <strong>Синхронизация с Gate.io:</strong> загружает официальный список валют с их символами.
            </div>
        </div>
    </div>



    <div class="grid">
        <div class="card">
            <h3 style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                <span>📈 Рынок и стакан</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <button id="buyMinOrderBtn" class="server-btn-small" style="background:#28a745;color:#fff;width:32px;height:32px;padding:0;font-size:16px;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="Купить минимальный ордер">&#x1F6D2;</button>
                    <button id="sellAllBtn" class="server-btn-small" style="background:#dc3545;color:#fff;width:32px;height:32px;padding:0;font-size:16px;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="Продать всё">
                        💰
                    </button>
                    <button id="resetCycleBtn" class="server-btn-small" style="background:#ff9800;color:#fff;width:32px;height:32px;padding:0;font-size:16px;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="Сброс цикла">&#x23EE;</button>
                    <button id="resetSessionBtn" class="server-btn-small" style="background:#9c27b0;color:#fff;width:32px;height:32px;padding:0;font-size:16px;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="Сброс сессии (скоро)">&#x1F501;</button>
                    <span style="font-size:11px;color:#888;">Баланс:</span>
                    <span id="headerQuoteBalance" style="font-size:16px;color:#4a9eff;font-weight:700;min-width:60px;text-align:right;" title="Баланс котируемой валюты">0.00</span>
                    <select id="quoteCurrencySelect" style="background:#1a1a1a;color:#ccc;border:1px solid #3a3a3a;border-radius:4px;padding:6px 10px;font-size:13px;font-weight:600;cursor:pointer;outline:none;" onchange="switchQuoteCurrency(this.value)">
                        <option value="USDT">USDT</option>
                        <option value="USDC">USDC</option>
                        <option value="BTC">BTC</option>
                        <option value="ETH">ETH</option>
                    </select>
                </div>
            </h3>
            <div class="market-header"><div class="pair-name" id="currentPairName">BTC_USDT</div><div class="pair-price" id="currentPairPrice">$0.00</div></div>
            <div class="balances-grid">
                <div class="balance-item"><div class="balance-label">Баланс <span id="baseSymbol">BTC</span></div><div class="balance-value" id="baseBalance">0.00000000</div><div class="balance-usd" id="baseBalanceUSD">≈ $0.00</div></div>
                <div class="balance-item" id="pairParamsBlock"><div class="balance-label">Параметры пары</div><div style="display:grid;grid-template-columns:auto 1fr;row-gap:2px;column-gap:6px;font-size:10px;color:#ccc;"><div>Min Quote:</div><div id="minQuoteAmount">-</div><div>Min Base:</div><div id="minBaseAmount">-</div><div>Amt Prec:</div><div id="amountPrecision">-</div><div>Price Prec:</div><div id="pricePrecision">-</div></div></div>
            </div>
            <div class="orderbook-container">
                <div class="orderbook-header"><div>Цена (<span id="obQuoteSymbol">USDT</span>)</div><div>Кол-во</div><div>Сумма</div><div>Σ Накоп.</div></div>
                <div class="orderbook-asks" id="orderbookAsks"><div class="loading">Загрузка...</div></div>
                <div class="orderbook-spread"><span id="currentPrice">-</span><span><span style="margin-right:5px;">Спред:</span><span id="spreadValue">-</span></span></div>
                <div class="orderbook-bids" id="orderbookBids"><div class="loading">Загрузка...</div></div>
            </div>
            <div style="margin-top:10px;text-align:center;font-size:.85em;color:#888;"><span id="wsStatus">🔄 Подключение к WebSocket...</span></div>
        </div>
        <div class="card indicator-card" style="grid-column:2;display:flex;align-items:flex-end;justify-content:center;">
            <div id="indicatorScale" class="indicator-scale" aria-hidden="false">
                <div id="markerSell" class="indicator-marker marker-sell"><span class="label">Sell</span><div class="marker-tooltip">Sell: -</div></div>
                <div id="markerBE" class="indicator-marker marker-be"><span class="label">BE</span><div class="marker-tooltip">BE: -</div></div>
                <div id="markerLast" class="indicator-marker marker-last"><span class="label">Last</span><div class="marker-tooltip">Last: -</div></div>
                <div id="markerStart" class="indicator-marker marker-start"><span class="label">Start</span><div class="marker-tooltip">Start: -</div></div>
                <div id="markerBuy" class="indicator-marker marker-buy"><span class="label">Buy</span><div class="marker-tooltip">Buy: -</div></div>
                <div class="indicator-footer" id="indicatorFooter"><div class="row price"><div class="label">Price:</div><div class="value" id="indPrice">-</div></div><div class="row"><div class="label">Sell:</div><div class="value" id="indSell">-</div></div><div class="row"><div class="label">BE:</div><div class="value" id="indBE">-</div></div><div class="row"><div class="label">Last:</div><div class="value" id="indLast">-</div></div><div class="row"><div class="label">Start:</div><div class="value" id="indStart">-</div></div><div class="row"><div class="label">Buy:</div><div class="value" id="indBuy">-</div></div></div>
            </div>
        </div>
        <div class="card breakeven-table">
            <div class="params-header">
                <h3>📊 Таблица безубыточности</h3>
                <div class="params-header-actions">
                    <div id="paramsSaveStatus" class="params-save-status"></div>
                    <button id="saveParamsBtn" class="save-params-btn-compact">💾 Сохранить</button>
                </div>
            </div>
            
            <!-- Блок редактируемых параметров -->
            <div class="trade-params-editor">
                <!-- Первая строка параметров -->
                <div class="params-row">
                    <div class="param-field">
                        <label for="paramSteps" title="Определяет количество строк таблицы, вместе с нулевой строкой по которой делается стартовая покупка торгового цикла, который заканчивается продажей всего, кроме суммы Keep">Шагов:</label>
                        <input type="number" id="paramSteps" step="1" value="16" min="1" max="50" />
                    </div>
                    <div class="param-field">
                        <label for="paramStartVolume" title="Стартовый объём закупки в котируемой валюте">Старт, $:</label>
                        <input type="number" id="paramStartVolume" step="0.1" value="3" min="0.1" />
                    </div>
                    <div class="param-field">
                        <label for="paramStartPrice" title="Стартовая цена закупки, которая обновляется каждый раз, как только произошла стартовая покупка">Цена (P0):</label>
                        <input type="number" id="paramStartPrice" step="0.00000001" value="0" placeholder="Текущий курс" />
                    </div>
                    <div class="param-field">
                        <label for="paramPprof" title="Указывает какой профит должен быть на каком шаге цикла">Pprof, %:</label>
                        <input type="number" id="paramPprof" step="0.01" value="0.6" min="0.01" />
                    </div>
                    <div class="param-field">
                        <label for="paramKprof" title="Указывает сколько надо вычесть из Pprof на шаге цикла">Kprof:</label>
                        <input type="number" id="paramKprof" step="0.001" value="0.02" min="0" />
                    </div>
                </div>
                
                <!-- Вторая строка параметров -->
                <div class="params-row">
                    <div class="param-field">
                        <label for="paramTargetR" title="Шаг изменения процента закупки (используется в формуле: (# × Rk) + R)">R:</label>
                        <input type="number" id="paramTargetR" step="0.001" value="3.650" min="0" />
                    </div>
                    <div class="param-field">
                        <label for="paramRk" title="Коэффициент изменения шага процента закупки (используется в формуле: (# × Rk) + R)">Rk:</label>
                        <input type="number" id="paramRk" step="0.001" value="0.000" min="0" />
                    </div>
                    <div class="param-field">
                        <label for="paramGeomMultiplier" title="Определяет шаг геометрии объёмов закупок">Множитель геометрии:</label>
                        <input type="number" id="paramGeomMultiplier" step="0.1" value="2" min="1" />
                    </div>
                    <div class="param-field">
                        <label for="paramRebuyMode" title="Определяет режимы геометрии: линейный, геометрический, Мартингейла">Режим сумм докупок:</label>
                        <select id="paramRebuyMode">
                            <option value="fixed">Фиксированный</option>
                            <option value="geometric">Геометрический</option>
                            <option value="martingale">Мартингейл</option>
                        </select>
                    </div>
                    <div class="param-field">
                        <label for="paramKeep" title="Постоянная сумма на балансе, которая должна оставаться при продаже. Если не хватает объёма для продажи при окончании цикла, то всё равно заканчивать цикл фиктивной продажей, чтобы начать новый цикл">Keep:</label>
                        <input type="number" id="paramKeep" step="0.01" value="0" min="0" placeholder="Остаток" />
                    </div>
                    <div class="param-field">
                        <label for="paramOrderbookLevel" title="Определяет уровень стакана для быстрых сделок (1 = лучшая цена, 2 = второй уровень и т.д.)">Стакан:</label>
                        <input type="number" id="paramOrderbookLevel" step="0.1" value="1" min="0" />
                    </div>
                </div>
            </div>
            
            <div class="breakeven-table-content">
                <div id="breakEvenNote" style="font-size:11px;color:#999;margin-bottom:8px;">Таблица безубыточности для текущих параметров</div>
                <div style="overflow-x:auto;">
                    <table id="breakEvenTable" style="width:100%;border-collapse:collapse;font-size:11px;">
                    <thead>
                        <tr style="background:#1a1a1a;color:#ccc;text-align:right;border-bottom:1px solid #3a3a3a;">
                            <th style="padding:6px 8px;text-align:center;">#</th>
                            <th style="padding:6px 8px;text-align:center;" title="Уровень стакана для покупки: (# * Стакан) + 1">Ст.</th>
                            <th style="padding:6px 8px;">↓, %</th>
                            <th style="padding:6px 8px;">Курс</th>
                            <th style="padding:6px 8px;">Покупка, $</th>
                            <th style="padding:6px 8px;">Инв.Сумм,$</th>
                            <th style="padding:6px 8px;">Ц.БезУб,$</th>
                            <th style="padding:6px 8px;">↑ БезУб,%</th>
                            <th style="padding:6px 8px;">tΔPsell,%</th>
                        </tr>
                    </thead>
                    <tbody id="breakEvenBody">
                        <tr><td colspan="9" style="padding:12px;text-align:center;color:#999;">Загрузка данных...</td></tr>
                    </tbody>
                </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for copyable messages -->
<div id="messageModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:#1e1e1e;border:1px solid #444;border-radius:8px;max-width:600px;width:90%;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,0.5);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 id="messageModalTitle" style="margin:0;color:#fff;font-size:18px;">Сообщение</h3>
            <button onclick="closeMessageModal()" style="background:transparent;border:none;color:#aaa;font-size:24px;cursor:pointer;padding:0;line-height:1;">&times;</button>
        </div>
        <div style="background:#2d2d2d;border:1px solid #444;border-radius:4px;padding:12px;margin-bottom:16px;max-height:300px;overflow-y:auto;">
            <pre id="messageModalContent" style="margin:0;color:#e0e0e0;font-size:14px;white-space:pre-wrap;word-wrap:break-word;font-family:monospace;"></pre>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button onclick="copyMessageModalContent()" style="background:#4caf50;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;">📋 Копировать</button>
            <button onclick="closeMessageModal()" style="background:#666;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;">Закрыть</button>
        </div>
    </div>
</div>

<!-- External JavaScript -->
<script src="{{ url_for('static', filename='app.js') }}"></script>
<script src="{{ url_for('static', filename='trade-logs-manager.js') }}"></script>
</body>
</html>
