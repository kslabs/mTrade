<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- VERSION: 2025-11-10-21:00 - TRADE/COPY FIX + BREAKEVEN CURRENCY FIX {{ cache_buster }} -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Gate.io Multi-Trading Platform [{{ cache_buster }}]</title>
    <style>
        * {margin:0;padding:0;box-sizing:border-box}
        body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#1a1a1a;min-height:100vh;padding:20px;color:#e0e0e0}
        .container {max-width:1600px;margin:0 auto}
        .header {background:#2a2a2a;border-radius:8px;padding:12px 20px;margin-bottom:15px;box-shadow:0 2px 10px rgba(0,0,0,.3);border:1px solid #3a3a3a;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:20px}
        .header-left {display:flex;align-items:center;gap:15px;justify-self:start}
        .header-center {display:flex;align-items:center;gap:12px;justify-self:center}
        .header-right {display:flex;align-items:center;gap:20px;justify-self:end}
        .header h1 {color:#4CAF50;margin:0;font-size:18px;font-weight:600}
        .header p {color:#666;font-size:11px;margin:0}
        .mode-label {font-weight:500;color:#999;font-size:11px}
        .mode-label.active {color:#4CAF50}
        .server-status-inline {display:flex;align-items:center;gap:8px;padding:6px 12px;background:#1a1a1a;border-radius:6px;border:1px solid #3a3a3a;font-size:12px}
        .status-dot {width:8px;height:8px;border-radius:50%;background:#4CAF50;animation:pulse 2s infinite}
        .uptime-display {color:#999;font-size:12px;font-family:'Courier New',monospace}
        .server-controls-inline {display:flex;gap:8px}
        .server-btn-small {padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:500;transition:.2s}
        .server-btn-small.restart { /* 2x larger icon and centered */
            width:36px; height:36px; padding:0;
            font-size:22px; line-height:1;
            display:flex; align-items:center; justify-content:center;
        }
        .server-btn-small.restart {background:#FF9800;color:#fff}
        .server-btn-small.restart:hover {background:#F57C00}
        .server-btn-small.shutdown { /* 2x larger icon and centered */
            width:36px; height:36px; padding:0;
            font-size:22px; line-height:1;
            display:flex; align-items:center; justify-content:center;
        }
        .server-btn-small.shutdown {background:#f44336;color:#fff}
        .server-btn-small.shutdown:hover {background:#d32f2f}
        .toggle-switch {position:relative;width:60px;height:30px;background:#1a1a1a;border-radius:15px;cursor:pointer;transition:background .3s;border:2px solid #3a3a3a}
        .toggle-switch.active {background:#4CAF50}
        .toggle-slider {position:absolute;top:3px;left:3px;width:24px;height:24px;background:#fff;border-radius:50%;transition:transform .3s;box-shadow:0 2px 5px rgba(0,0,0,.4)}
        .toggle-switch.active .toggle-slider {transform:translateX(30px)}
        .grid {display:grid;grid-template-columns:1fr 80px 1fr;gap:15px;margin-bottom:15px}
        .indicator-card {display:flex;align-items:flex-end;justify-content:center;padding:8px 6px;height:100%}
        .indicator-scale {position:relative;width:56px;height:calc(100vh - 260px);background:linear-gradient(#0d0d0d,#111);border-radius:8px;border:1px solid #2a2a2a;box-shadow:inset 0 0 20px rgba(0,0,0,.7);display:block}
        .indicator-marker {position:absolute;left:50%;transform:translateX(-50%);width:90%;height:3px;border-radius:2px;box-shadow:0 1px 6px rgba(0,0,0,.6);transition:top .6s cubic-bezier(.22,1,.36,1),height .25s,box-shadow .25s,opacity .25s}
        .indicator-marker .label {position:absolute;left:100%;margin-left:8px;top:-8px;font-size:11px;color:#ccc;white-space:nowrap}
        .marker-tooltip {position:absolute;left:100%;top:-30px;margin-left:10px;background:rgba(0,0,0,.8);color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;white-space:nowrap;box-shadow:0 6px 18px rgba(0,0,0,.6);opacity:0;transform:translateY(6px);transition:.18s}
        .indicator-marker:hover .marker-tooltip {opacity:1;transform:translateY(0)}
        .card {background:#2a2a2a;border-radius:8px;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,.3);border:1px solid #3a3a3a}
        .card h3 {color:#4CAF50;margin-bottom:12px;font-size:14px;border-bottom:1px solid #3a3a3a;padding-bottom:8px;font-weight:600}
        .market-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:8px 10px;background:#1a1a1a;border-radius:6px;border:1px solid #3a3a3a}
        .pair-name {font-size:14px;font-weight:600;color:#4CAF50}
        .pair-price {font-size:16px;font-weight:700;color:#4CAF50}
        .balances-grid {display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
        .balance-item {background:#1a1a1a;border:1px solid #3a3a3a;border-radius:6px;padding:10px}
        .balance-label {font-size:11px;color:#999;margin-bottom:6px;font-weight:500}
        .balance-value {font-size:15px;font-weight:600;color:#4CAF50;margin-bottom:4px}
        .balance-usd {font-size:11px;color:#888}
        @keyframes pulse {0%,100%{opacity:1}50%{opacity:.6}}
        .orderbook-container {background:#1a1a1a;border-radius:8px;padding:10px;border:1px solid #3a3a3a}
        .orderbook-header {display:grid;grid-template-columns:1fr .9fr .9fr 1fr;gap:5px;padding:6px 5px;font-size:10px;font-weight:600;color:#666;border-bottom:1px solid #3a3a3a}
        .orderbook-asks,.orderbook-bids {max-height:250px;overflow-y:auto}
        .orderbook-row {display:grid;grid-template-columns:1fr .9fr .9fr 1fr;gap:5px;padding:2px 5px;font-size:11px;cursor:pointer}
        .orderbook-row:hover {background:#2a2a2a}
        .orderbook-asks .price {color:#f44336}
        .orderbook-bids .price {color:#4CAF50}
        .orderbook-row .amount,.orderbook-row .total {color:#999}
        .orderbook-row .cumulative {color:#888;font-weight:600;font-size:10px}
        .orderbook-spread {display:flex;justify-content:space-between;align-items:center;padding:6px 5px;font-size:11px;font-weight:600;color:#999;border-top:1px solid #3a3a3a;border-bottom:1px solid #3a3a3a;background:#252525}
        #currentPrice {color:#4CAF50;font-size:12px;font-weight:700}
        #spreadValue {color:#FF9800}
        /* Network mode toggle - dual button style */
        .network-switch {
            display:inline-flex;
            align-items:center;
            gap:2px;
            background:#1a1a1a;
            border:1px solid #3a3a3a;
            border-radius:8px;
            padding:2px;
            user-select:none;
        }
        .network-switch .mode-option {
            padding:4px 16px;
            font-size:11px;
            font-weight:500;
            color:#666;
            background:transparent;
            border:none;
            border-radius:6px;
            transition:all .3s cubic-bezier(.22,1,.36,1);
            cursor:pointer;
            position:relative;
            letter-spacing:0.5px;
            text-transform:uppercase;
            line-height:1.2;
        }
        .network-switch .mode-option:hover:not(.active) {
            background:#2a2a2a;
            color:#999;
        }
        /* –ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º: –∫—Ä—É–ø–Ω–µ–µ, –∂–∏—Ä–Ω–µ–µ –∏ —è—Ä—á–µ */
        .network-switch .mode-option.active {
            padding:5px 18px;
            font-size:14px;
            font-weight:700;
            transform:scale(1.08);
        }
        /* Work mode - –∑–µ–ª—ë–Ω—ã–π */
        .network-switch .mode-option[data-mode="work"].active {
            background:#4CAF50;
            color:#fff;
            box-shadow:0 3px 12px rgba(76,175,80,.6),inset 0 1px 0 rgba(255,255,255,.25);
        }
        /* Test mode - —Å–∏–Ω–∏–π */
        .network-switch .mode-option[data-mode="test"].active {
            background:#2196F3;
            color:#fff;
            box-shadow:0 3px 12px rgba(33,150,243,.6),inset 0 1px 0 rgba(255,255,255,.25);
        }
        .network-switch.pending {
            opacity:0.7;
        }
        .network-switch.error {
            border-color:#f44336;
            animation:pulse-error .6s ease-in-out 2;
        }
        @keyframes pulse-error {
            0%, 100% { border-color:#f44336; }
            50% { border-color:#ff5252; }
        }
        #networkConnStatus {
            font-size:9px;
            color:#999;
            position:absolute;
            bottom:-14px;
            left:50%;
            transform:translateX(-50%);
            white-space:nowrap;
        }
        /* Trading mode toggle - dual button style (Trade/Copy) */
        .trading-mode-switch {
            display:inline-flex;
            align-items:center;
            gap:2px;
            background:#1a1a1a;
            border:1px solid #3a3a3a;
            border-radius:8px;
            padding:2px;
            user-select:none;
        }
        .trading-mode-switch .mode-option {
            padding:4px 16px;
            font-size:11px;
            font-weight:500;
            color:#666;
            background:transparent;
            border:none;
            border-radius:6px;
            transition:all .3s cubic-bezier(.22,1,.36,1);
            cursor:pointer;
            position:relative;
            letter-spacing:0.5px;
            text-transform:uppercase;
            line-height:1.2;
        }
        .trading-mode-switch .mode-option:hover:not(.active) {
            background:#2a2a2a;
            color:#999;
        }
        /* –ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º: –∫—Ä—É–ø–Ω–µ–µ, –∂–∏—Ä–Ω–µ–µ –∏ —è—Ä—á–µ */
        .trading-mode-switch .mode-option.active {
            padding:5px 18px;
            font-size:14px;
            font-weight:700;
            transform:scale(1.08);
        }
        /* Normal/Trade mode - –∑–µ–ª—ë–Ω—ã–π */
        .trading-mode-switch .mode-option[data-mode="normal"].active {
            background:#4CAF50;
            color:#fff;
            box-shadow:0 3px 12px rgba(76,175,80,.6),inset 0 1px 0 rgba(255,255,255,.25);
        }
        /* Copy mode - –æ—Ä–∞–Ω–∂–µ–≤—ã–π */
        .trading-mode-switch .mode-option[data-mode="copy"].active {
            background:#FF9800;
            color:#fff;
            box-shadow:0 3px 12px rgba(255,152,0,.6),inset 0 1px 0 rgba(255,255,255,.25);
        }
        .trading-mode-switch.pending {
            opacity:0.7;
        }
        /* AutoTrade toggle button */
        .autotrade-switch {
            display:inline-flex;
            align-items:center;
            gap:2px;
            background:#1a1a1a;
            border:1px solid #3a3a3a;
            border-radius:8px;
            padding:2px;
            user-select:none;
            cursor:pointer;
            transition:all .3s ease;
        }
        .autotrade-switch .mode-option {
            padding:4px 14px;
            font-size:11px;
            font-weight:500;
            color:#666;
            background:transparent;
            border:none;
            border-radius:6px;
            transition:all .3s cubic-bezier(.22,1,.36,1);
            position:relative;
            letter-spacing:0.5px;
            text-transform:uppercase;
            line-height:1.2;
        }
        .autotrade-switch .mode-option.active {
            padding:5px 16px;
            font-size:13px;
            font-weight:700;
            transform:scale(1.08);
        }
        /* AutoTrade OFF - –∫—Ä–∞—Å–Ω—ã–π */
        .autotrade-switch .mode-option[data-state="off"].active {
            background:#f44336;
            color:#fff;
            box-shadow:0 3px 12px rgba(244,67,54,.6),inset 0 1px 0 rgba(255,255,255,.25);
        }
        /* AutoTrade ON - –∑–µ–ª—ë–Ω—ã–π */
        .autotrade-switch .mode-option[data-state="on"].active {
            background:#4CAF50;
            color:#fff;
            box-shadow:0 3px 12px rgba(76,175,80,.6),inset 0 1px 0 rgba(255,255,255,.25);
        }
        .autotrade-switch .label-text {
            font-size:10px;
            color:#999;
            margin-right:8px;
            text-transform:uppercase;
            letter-spacing:0.5px;
            font-weight:600;
        }
        .perm-toggle {display:inline-block;width:14px;height:14px;border-radius:50%;margin-left:6px;position:relative;cursor:pointer;box-shadow:0 0 0 1px #555,inset 0 0 4px rgba(0,0,0,.6)}
        .perm-toggle.on {background:#4CAF50}
        .perm-toggle.off {background:#f44336}
        .base-currency-tabs {background:#2a2a2a;border-radius:8px;padding:10px;margin-bottom:15px;box-shadow:0 2px 10px rgba(0,0,0,.3);border:1px solid #3a3a3a;display:flex;gap:8px;overflow-x:auto}
        .base-currency-tabs {padding:8px 10px} /* –º–µ–Ω—å—à–µ –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        .tab-item { /* —É–ø–ª–æ—Ç–Ω–µ–Ω–æ + –º–µ—Å—Ç–æ –ø–æ–¥ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è */
            padding:4px 18px 4px 10px;
            line-height:1.05;
            min-height:auto;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:4px;
            position:relative; /* –Ω—É–∂–Ω–æ –¥–ª—è –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ */
        }
        .tab-item .code-label {display:inline;font-weight:600}
        .tab-item .symbol-label {display:inline;margin:0;font-size:11px;color:#bbb;font-weight:500;line-height:1;position:static}
        .currency-gear-btn {padding:8px 12px;background:#1a1a1a;border:1px solid #3a3a3a;color:#ccc;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
        .currency-gear-btn:hover {background:#2f2f2f;color:#fff}
        .perm-indicator {width:10px;height:10px;border-radius:50%;position:absolute;top:4px;right:4px;box-shadow:0 0 0 1px #222,inset 0 0 4px rgba(0,0,0,.6);cursor:pointer}
        .perm-indicator.on {background:#4CAF50}
        .perm-indicator.off {background:#f44336}
        #currencyManagerModal {position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:1000}
        #currencyManagerModal .modal-inner {background:#222;border:1px solid #3a3a3a;border-radius:10px;padding:18px;max-width:580px;width:92%;max-height:80vh;overflow:auto;box-shadow:0 6px 24px rgba(0,0,0,.6)}
        #currencyManagerModal h4 {margin:0 0 12px;font-size:15px;color:#4CAF50;font-weight:600}
        .cm-row {display:grid;grid-template-columns:70px 70px 1fr auto;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid #2e2e2e;font-size:12px}
        .cm-row input {background:#111;border:1px solid #333;border-radius:4px;padding:6px;color:#eee;font-size:12px}
        .cm-row.disabled {opacity:.5}
        .cm-actions {display:flex;gap:8px;margin-top:14px}
        .cm-btn {padding:8px 14px;border:none;border-radius:6px;background:#3a3a3a;color:#ddd;font-size:12px;font-weight:600;cursor:pointer}
        .cm-btn.save {background:#4CAF50;color:#fff}
        .cm-btn.add {background:#2196F3;color:#fff}
        .cm-btn.cancel {background:#757575;color:#fff}
        .cm-btn.delete {background:#f44336;color:#fff}
        .cm-btn:hover {filter:brightness(1.15)}
        .tab-item .code-label {font-weight:600}
        .tab-item .symbol-label {font-size:11px;color:#bbb;display:block;margin-top:3px;font-weight:500}
        /* --- Compact tabs final overrides (placed last to win specificity) --- */
        .base-currency-tabs{align-items:center;gap:8px}
        .currency-gear-btn{padding:6px 10px}
        .base-currency-tabs .tab-item{
            padding:4px 18px 4px 10px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            line-height:1;
            min-height:auto;
            position:relative;
        }
        .base-currency-tabs .tab-item .code-label{font-weight:600}
        .base-currency-tabs .tab-item .symbol-label{display:inline!important;margin:0!important;font-size:11px;color:#bbb;font-weight:500}
        .base-currency-tabs .tab-item .symbol-label:empty{display:none!important}
        .base-currency-tabs .tab-item .perm-indicator{right:4px;top:4px;z-index:2}
        /* –ê–∫—Ü–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è */
        .base-currency-tabs .tab-item.active {background:#4CAF50!important;color:#fff!important}
        .base-currency-tabs .tab-item.active .symbol-label {color:#eaffea!important}
        .base-currency-tabs .tab-item .perm-indicator {border:1px solid #111}
        .base-currency-tabs .tab-item.active .perm-indicator.on {box-shadow:0 0 0 1px #0d3,inset 0 0 4px rgba(0,0,0,.4)}
        /* –£—Å–∏–ª–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –≤–∞–ª—é—Ç—ã */
        .base-currency-tabs .tab-item {background:#1a1a1a;border:1px solid #3a3a3a;color:#ccc;font-weight:600;min-width:64px;border-radius:6px;cursor:pointer;user-select:none}
        .base-currency-tabs .tab-item:hover {background:#2f2f2f;color:#fff}
        .base-currency-tabs .tab-item.active {background:#4CAF50!important;color:#fff!important}
        /* --- Server controls overrides --- */
        .server-btn-small.restart { /* 2x larger icon and centered */
            width:36px; height:36px; padding:0;
            font-size:22px; line-height:1;
            display:flex; align-items:center; justify-content:center;
        }
        .server-btn-small.shutdown { /* 2x larger icon and centered */
            width:36px; height:36px; padding:0;
            font-size:22px; line-height:1;
            display:flex; align-items:center; justify-content:center;
        }
        /* Trade parameters editor */
        .params-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:12px;
            padding-bottom:8px;
            border-bottom:1px solid #3a3a3a;
        }
        .params-header h3 {
            margin:0;
            color:#4CAF50;
            font-size:14px;
            font-weight:600;
            border:none;
            padding:0;
        }
        .params-header-actions {
            display:flex;
            align-items:center;
            gap:10px;
        }
        .save-params-btn-compact {
            padding:6px 12px;
            background:#4CAF50;
            color:#fff;
            border:none;
            border-radius:6px;
            font-size:11px;
            font-weight:600;
            cursor:pointer;
            transition:all 0.2s;
            white-space:nowrap;
        }
        .save-params-btn-compact:hover {
            background:#45a049;
            transform:translateY(-1px);
        }
        .save-params-btn-compact:active {
            transform:translateY(0);
        }
        .trade-params-editor {
            background:#1a1a1a;
            border:1px solid #3a3a3a;
            border-radius:8px;
            padding:12px;
            margin-bottom:15px;
        }
        .params-grid {
            display:grid;
            grid-template-columns:repeat(4,1fr);
            gap:8px 10px;
        }
        .param-field {
            display:flex;
            flex-direction:column;
            gap:3px;
        }
        .param-field label {
            font-size:10px;
            color:#999;
            font-weight:500;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }
        .param-field input,
        .param-field select {
            background:#0d0d0d;
            border:1px solid #333;
            border-radius:4px;
            padding:5px 6px;
            color:#e0e0e0;
            font-size:11px;
            font-weight:500;
            width:100%;
        }
        .param-field input:focus,
        .param-field select:focus {
            outline:none;
            border-color:#4CAF50;
            box-shadow:0 0 0 2px rgba(76,175,80,0.2);
        }
        .params-save-status {
            font-size:10px;
            color:#4CAF50;
            white-space:nowrap;
        }
        .params-save-status.error {
            color:#f44336;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-left"><div><h1>üöÄ mTrade</h1><p>Gate.io Trading Platform</p></div></div>
        <div class="header-center">
            <div id="autoTradeSwitcher" class="autotrade-switch" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Ç–æ—Ä–≥–æ–≤–ª—é" onclick="toggleAutoTrade()">
                <span class="label-text">AutoTrade</span>
                <div class="mode-option" data-state="off">
                    OFF
                </div>
                <div class="mode-option active" data-state="on">
                    ON
                </div>
            </div>
            <div style="position:relative;display:inline-block;">
                <div id="networkSwitcher" class="network-switch" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Å–µ—Ç–∏">
                    <div class="mode-option active" data-mode="work" onclick="switchNetworkMode('work')">
                        WORK
                    </div>
                    <div class="mode-option" data-mode="test" onclick="switchNetworkMode('test')">
                        TEST
                    </div>
                </div>
                <span id="networkConnStatus"></span>
            </div>
            <div id="tradingModeSwitcher" class="trading-mode-switch" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏">
                <div class="mode-option active" data-mode="normal" onclick="switchTradingMode('normal')">
                    TRADE
                </div>
                <div class="mode-option" data-mode="copy" onclick="switchTradingMode('copy')">
                    COPY
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="server-status-inline"><div class="status-dot" id="statusDot"></div><span id="serverPID" style="color:#999;font-size:11px;">PID: ---</span></div>
            <div class="uptime-display" id="uptimeDisplay"><strong>00–¥ 00:00:00</strong></div>
            <div class="server-controls-inline"><button class="server-btn-small restart" id="restartServerBtn">üîÑ</button><button class="server-btn-small shutdown" id="shutdownServerBtn">‚èπÔ∏è</button></div>
        </div>
    </div>

    <div class="base-currency-tabs" id="currencyTabsWrapper">
        <div style="display:flex;gap:8px;flex:1;overflow-x:auto;" id="currencyTabsContainer"><div class="loading" style="padding:10px;color:#666;font-size:12px;">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–ª—é—Ç...</div></div>
        <button id="manageCurrenciesBtn" class="currency-gear-btn" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª—é—Ç–∞–º–∏" onclick="openCurrencyManager()">‚öôÔ∏è</button>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞–ª—é—Ç–∞–º–∏ -->
    <div id="currencyManagerModal" onclick="if(event.target===this)closeCurrencyManager()">
        <div class="modal-inner">
            <h4>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã–º–∏ –≤–∞–ª—é—Ç–∞–º–∏</h4>
            <div id="currencyManagerRows"></div>
            <div class="cm-actions">
                <button class="cm-btn add" onclick="addCurrencyRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="cm-btn save" onclick="saveCurrenciesList()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="cm-btn cancel" onclick="closeCurrencyManager()">‚úñ –û—Ç–º–µ–Ω–∞</button>
            </div>
            <div style="margin-top:10px;font-size:11px;color:#888;line-height:1.4">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (currencies.json). –ú–∏–Ω–∏–º—É–º 1 –≤–∞–ª—é—Ç–∞, –∫–æ–¥—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã.</div>
        </div>
    </div>



    <div class="grid">
        <div class="card">
            <h3 style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                <span>üìà –†—ã–Ω–æ–∫ –∏ —Å—Ç–∞–∫–∞–Ω</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:11px;color:#888;">–ë–∞–ª–∞–Ω—Å:</span>
                    <span id="headerQuoteBalance" style="font-size:16px;color:#4a9eff;font-weight:700;" onclick="editQuoteBalance()" title="–ö–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">0.00</span>
                    <select id="quoteCurrencySelect" style="background:#1a1a1a;color:#ccc;border:1px solid #3a3a3a;border-radius:4px;padding:6px 10px;font-size:13px;font-weight:600;cursor:pointer;outline:none;" onchange="switchQuoteCurrency(this.value)">
                        <option value="USDT">USDT</option>
                        <option value="USDC">USDC</option>
                        <option value="BTC">BTC</option>
                        <option value="ETH">ETH</option>
                    </select>
                </div>
            </h3>
            <div class="market-header"><div class="pair-name" id="currentPairName">BTC_USDT</div><div class="pair-price" id="currentPairPrice">$0.00</div></div>
            <div class="balances-grid">
                <div class="balance-item"><div class="balance-label">–ë–∞–ª–∞–Ω—Å <span id="baseSymbol">BTC</span></div><div class="balance-value" id="baseBalance">0.00000000</div><div class="balance-usd" id="baseBalanceUSD">‚âà $0.00</div></div>
                <div class="balance-item" id="pairParamsBlock"><div class="balance-label">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Ä—ã</div><div style="display:grid;grid-template-columns:auto 1fr;row-gap:2px;column-gap:6px;font-size:10px;color:#ccc;"><div>Min Quote:</div><div id="minQuoteAmount">-</div><div>Min Base:</div><div id="minBaseAmount">-</div><div>Amt Prec:</div><div id="amountPrecision">-</div><div>Price Prec:</div><div id="pricePrecision">-</div></div></div>
            </div>
            <div class="orderbook-container">
                <div class="orderbook-header"><div>–¶–µ–Ω–∞ (<span id="obQuoteSymbol">USDT</span>)</div><div>–ö–æ–ª-–≤–æ</div><div>–°—É–º–º–∞</div><div>Œ£ –ù–∞–∫–æ–ø.</div></div>
                <div class="orderbook-asks" id="orderbookAsks"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
                <div class="orderbook-spread"><span id="currentPrice">-</span><span><span style="margin-right:5px;">–°–ø—Ä–µ–¥:</span><span id="spreadValue">-</span></span></div>
                <div class="orderbook-bids" id="orderbookBids"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
            </div>
            <div style="margin-top:10px;text-align:center;font-size:.85em;color:#888;"><span id="wsStatus">üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...</span></div>
        </div>
        <div class="card indicator-card" style="grid-column:2;display:flex;align-items:flex-end;justify-content:center;">
            <div id="indicatorScale" class="indicator-scale" aria-hidden="false">
                <div id="markerSell" class="indicator-marker marker-sell"><span class="label">Sell</span><div class="marker-tooltip">Sell: -</div></div>
                <div id="markerBE" class="indicator-marker marker-be"><span class="label">BE</span><div class="marker-tooltip">BE: -</div></div>
                <div id="markerLast" class="indicator-marker marker-last"><span class="label">Last</span><div class="marker-tooltip">Last: -</div></div>
                <div id="markerStart" class="indicator-marker marker-start"><span class="label">Start</span><div class="marker-tooltip">Start: -</div></div>
                <div id="markerBuy" class="indicator-marker marker-buy"><span class="label">Buy</span><div class="marker-tooltip">Buy: -</div></div>
                <div class="indicator-footer" id="indicatorFooter"><div class="row price"><div class="label">Price:</div><div class="value" id="indPrice">-</div></div><div class="row"><div class="label">Sell:</div><div class="value" id="indSell">-</div></div><div class="row"><div class="label">BE:</div><div class="value" id="indBE">-</div></div><div class="row"><div class="label">Last:</div><div class="value" id="indLast">-</div></div><div class="row"><div class="label">Start:</div><div class="value" id="indStart">-</div></div><div class="row"><div class="label">Buy:</div><div class="value" id="indBuy">-</div></div></div>
            </div>
        </div>
        <div class="card">
            <div class="params-header">
                <h3>üìä –¢–∞–±–ª–∏—Ü–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏</h3>
                <div class="params-header-actions">
                    <div id="paramsSaveStatus" class="params-save-status"></div>
                    <button id="saveParamsBtn" class="save-params-btn-compact">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
            
            <!-- –ë–ª–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
            <div class="trade-params-editor">
                <div class="params-grid">
                    <div class="param-field">
                        <label for="paramSteps">–ß–∏—Å–ª–æ —à–∞–≥–æ–≤ (–≤–∫–ª. 0):</label>
                        <input type="number" id="paramSteps" step="1" value="16" min="1" max="50" />
                    </div>
                    <div class="param-field">
                        <label for="paramStartVolume">–°—Ç–∞—Ä—Ç–æ–≤—ã–π –æ–±—ä—ë–º:</label>
                        <input type="number" id="paramStartVolume" step="0.1" value="3" min="0.1" />
                    </div>
                    <div class="param-field">
                        <label for="paramStartPrice">–ù–∞—á–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (P0):</label>
                        <input type="number" id="paramStartPrice" step="0.00000001" value="0" placeholder="–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å" />
                    </div>
                    <div class="param-field">
                        <label for="paramPprof">Pprof, %:</label>
                        <input type="number" id="paramPprof" step="0.01" value="0.6" min="0.01" />
                    </div>
                    <div class="param-field">
                        <label for="paramKprof">Kprof:</label>
                        <input type="number" id="paramKprof" step="0.001" value="0.02" min="0" />
                    </div>
                    <div class="param-field">
                        <label for="paramTargetR">‚Üë –ë–µ–∑–£–±, % (—Ü–µ–ª—å R):</label>
                        <input type="number" id="paramTargetR" step="0.01" value="3.65" min="0.01" />
                    </div>
                    <div class="param-field">
                        <label for="paramGeomMultiplier">–ú–Ω–æ–∂–∏—Ç–µ–ª—å –≥–µ–æ–º–µ—Ç—Ä–∏–∏:</label>
                        <input type="number" id="paramGeomMultiplier" step="0.1" value="2" min="1" />
                    </div>
                    <div class="param-field">
                        <label for="paramRebuyMode">–†–µ–∂–∏–º —Å—É–º–º –¥–æ–∫—É–ø–æ–∫:</label>
                        <select id="paramRebuyMode">
                            <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</option>
                            <option value="geometric">–ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π</option>
                            <option value="martingale">–ú–∞—Ä—Ç–∏–Ω–≥–µ–π–ª</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="breakEvenNote" style="font-size:11px;color:#999;margin-bottom:8px;">–¢–∞–±–ª–∏—Ü–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</div>
            <div style="overflow-x:auto;">
                <table id="breakEvenTable" style="width:100%;border-collapse:collapse;font-size:11px;">
                    <thead>
                        <tr style="background:#1a1a1a;color:#ccc;text-align:right;border-bottom:1px solid #3a3a3a;">
                            <th style="padding:6px 8px;text-align:center;">#</th>
                            <th style="padding:6px 8px;">‚Üì, %</th>
                            <th style="padding:6px 8px;">–ö—É—Ä—Å</th>
                            <th style="padding:6px 8px;">–ü–æ–∫—É–ø–∫–∞, $</th>
                            <th style="padding:6px 8px;">–ò–Ω–≤.–°—É–º–º,$</th>
                            <th style="padding:6px 8px;">–¶.–ë–µ–∑–£–±,$</th>
                            <th style="padding:6px 8px;">‚Üë –ë–µ–∑–£–±,%</th>
                            <th style="padding:6px 8px;">tŒîPsell,%</th>
                        </tr>
                    </thead>
                    <tbody id="breakEvenBody">
                        <tr><td colspan="8" style="padding:12px;text-align:center;color:#999;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
window.__diagLogs=[];
function logDbg(m){
  try{
    __diagLogs.push(Date.now()+': '+m);
    if(__diagLogs.length>200) __diagLogs.shift();
  }catch(_){/* noop */}
  console.log('[DBG]',m);
}
const $=id=>document.getElementById(id);
let currentNetworkMode='work';
let currentBaseCurrency=null; // –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ currencies
let currentQuoteCurrency='USDT';
let currenciesList=[];
let autoTradeActive=false;
let tradingPermissions = {}; // —Å—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Ç–æ—Ä–≥–æ–≤–ª–∏

// UI State Manager - –ø—Ä–æ—Å—Ç–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è UI
const UIStateManager = {
  async savePartial(updates) {
    try {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–ª—é—á–∏ –≤ —Ñ–æ—Ä–º–∞—Ç, –æ–∂–∏–¥–∞–µ–º—ã–π —Å–µ—Ä–≤–µ—Ä–æ–º
      const stateUpdates = {};
      if (updates.baseCurrency) stateUpdates.active_base_currency = updates.baseCurrency;
      if (updates.quoteCurrency) stateUpdates.active_quote_currency = updates.quoteCurrency;
      if (updates.autoTradeEnabled !== undefined) stateUpdates.auto_trade_enabled = updates.autoTradeEnabled;
      if (updates.networkMode) stateUpdates.network_mode = updates.networkMode;
      
      const response = await fetch('/api/ui/state/partial', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(stateUpdates)
      });
      const result = await response.json();
      if (result.success) {
        logDbg('UI State: —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ - ' + JSON.stringify(stateUpdates));
      } else {
        logDbg('UI State: –æ—à–∏–±–∫–∞ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è - ' + (result.error || 'unknown'));
      }
      return result;
    } catch (error) {
      logDbg('UI State: –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ - ' + error);
      return {success: false, error: String(error)};
    }
  }
};

function formatPrice(v){
  const n=parseFloat(v);
  if(isNaN(n)) return '-';
  if(n<0.0001 && n>0) return n.toExponential(4);
  if(n>=1000) return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:8});
  return n.toFixed(8).replace(/\.0+$/,'').replace(/0+$/,'')
}
function updateTradeIndicators(d){
  d=d||{};
  const priceEl=$('indPrice');
  if(priceEl&&d.price) priceEl.textContent=formatPrice(d.price);
  ['sell','be','last','start','buy'].forEach(k=>{
    const el=$('ind'+k.charAt(0).toUpperCase()+k.slice(1));
    if(el&&d[k]!==undefined){
      const v=d[k];
      el.textContent=(v===null||v===undefined)?'-':formatPrice(v)
    }
  })
}
function updateNetworkUI(){
  const sw=$('networkSwitcher');
  if(!sw) return;
  sw.classList.remove('work','test');
  sw.classList.add(currentNetworkMode==='test'?'test':'work');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
  const workBtn = sw.querySelector('[data-mode="work"]');
  const testBtn = sw.querySelector('[data-mode="test"]');
  if(workBtn && testBtn){
    workBtn.classList.toggle('active', currentNetworkMode==='work');
    testBtn.classList.toggle('active', currentNetworkMode==='test');
  }
}
function setNetworkConnectionState(st){
  const sw=$('networkSwitcher');
  const cs=$('networkConnStatus');
  if(!sw) return;
  sw.classList.remove('pending','error');
  if(st==='pending'){
    sw.classList.add('pending');
    if(cs) cs.textContent='–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
  }else if(st==='error'){
    sw.classList.add('error');
    if(cs) cs.textContent='–æ—à–∏–±–∫–∞';
  }else{
    if(cs) cs.textContent='';
  }
}
async function loadNetworkMode(){
  try{
    const r=await fetch('/api/network');
    const d=await r.json();
    if(d.success){
      currentNetworkMode=d.mode;
      updateNetworkUI();
      logDbg('network mode='+currentNetworkMode);
    }
  }catch(e){ logDbg('loadNetworkMode err '+e) }
}
async function loadCurrenciesFromServer(){
  try{
    const r=await fetch('/api/currencies');
    const d=await r.json();
    if(d.success&&Array.isArray(d.currencies)){
      currenciesList=d.currencies;
      renderCurrencyTabs(currenciesList);
    } else {
      logDbg('loadCurrencies fail');
    }
  }catch(e){ logDbg('loadCurrencies exc '+e) }
}
function renderCurrencyTabs(list){
  const cont=$('currencyTabsContainer');
  if(!cont) return;
  cont.innerHTML='';
  const arr=Array.isArray(list)?list:[];
  logDbg('renderCurrencyTabs raw len='+(arr.length));
  let norm=arr.map(c=>{if(typeof c==='string')return {code:c.toUpperCase(),symbol:''};return {code:(c.code||'').toUpperCase(),symbol:(c.symbol||'').trim()};}).filter(o=>o.code);
  // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äì –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
  if(!norm.length){
    logDbg('—Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äì –¥–æ–±–∞–≤–ª—è—é –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ');
    norm=['BTC','ETH','SOL','BNB','XRP','ADA','AVAX','DOT','MATIC','LINK'].map(c=>({code:c,symbol:''}));
  }
  // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∞–ª—é—Ç—É: –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ - –æ—Å—Ç–∞–≤–ª—è–µ–º, –∏–Ω–∞—á–µ - –ø–µ—Ä–≤–∞—è –∏–∑ —Å–ø–∏—Å–∫–∞
  const codes=new Set(norm.map(o=>o.code));
  if(!currentBaseCurrency || !codes.has(currentBaseCurrency)){
    currentBaseCurrency=norm[0].code;
    logDbg('—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞: '+currentBaseCurrency);
  }
  norm.forEach(cur=>{
    const el=document.createElement('div');
    el.className='tab-item'+(cur.code===currentBaseCurrency?' active':'');
    el.dataset.code=cur.code;
    el.innerHTML=`<span class='code-label'>${cur.code}</span>${cur.symbol?`<span class='symbol-label'>${cur.symbol}</span>`:''}`;
    el.onclick=()=>switchBaseCurrency(cur.code);
    cont.appendChild(el);
  });
  updatePairNameUI();
  updateTabsPermissionsUI();
}
function updatePairNameUI(){
  const pair=`${currentBaseCurrency}_${currentQuoteCurrency}`;
  const nameEl=$('currentPairName');
  const baseSym=$('baseSymbol');
  const quoteSym=$('quoteSymbol');
  const obQuote=$('obQuoteSymbol');
  if(nameEl){ nameEl.childNodes[0].nodeValue=pair+' '; }
  if(baseSym) baseSym.textContent=currentBaseCurrency;
  if(quoteSym) quoteSym.textContent=currentQuoteCurrency;
  if(obQuote) obQuote.textContent=currentQuoteCurrency;
}
async function switchBaseCurrency(code){
  currentBaseCurrency=code.toUpperCase();
  const cont=$('currencyTabsContainer');
  if(cont){
    [...cont.querySelectorAll('.tab-item')].forEach(n=>n.classList.toggle('active',n.dataset.code===currentBaseCurrency));
  }
  updatePairNameUI();
  logDbg(`switchBaseCurrency -> ${currentBaseCurrency}_${currentQuoteCurrency}`);
  await subscribeToPairData(currentBaseCurrency,currentQuoteCurrency);
  // –î–∞—ë–º –≤—Ä–µ–º—è WebSocket –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö —Å force=true
  await new Promise(resolve => setTimeout(resolve, 1000));
  await loadMarketData(true);  // force refresh
  await loadPairBalances();
  await loadPairParams(true);
  await loadTradeParams();  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ –¥–ª—è –Ω–æ–≤–æ–π –≤–∞–ª—é—Ç—ã
  await loadBreakEvenTable();  // –¢–∞–±–ª–∏—Ü–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –±–∞–∑–æ–≤–æ–π –≤–∞–ª—é—Ç—ã –≤ UI state
  await UIStateManager.savePartial({baseCurrency: currentBaseCurrency});
}
async function changeQuoteCurrency(){
  const sel=document.querySelector('#quoteCurrency');
  if(!sel) return;
  currentQuoteCurrency=sel.value.toUpperCase();
  updatePairNameUI();
  logDbg(`changeQuoteCurrency -> ${currentBaseCurrency}_${currentQuoteCurrency}`);
  await subscribeToPairData(currentBaseCurrency,currentQuoteCurrency);
  // –î–∞—ë–º –≤—Ä–µ–º—è WebSocket –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö —Å force=true
  await new Promise(resolve => setTimeout(resolve, 1000));
  await loadMarketData(true);  // force refresh
  await loadPairBalances();
  await loadPairParams(true);
  await loadTradeParams();  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
  await loadBreakEvenTable();
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∫–æ—Ç–∏—Ä—É–µ–º–æ–π –≤–∞–ª—é—Ç—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ "–†—ã–Ω–æ–∫ –∏ —Å—Ç–∞–∫–∞–Ω"
async function switchQuoteCurrency(newQuote){
  if(!newQuote) return;
  currentQuoteCurrency=newQuote.toUpperCase();
  
  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ–±–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞, –µ—Å–ª–∏ —Å—Ç–∞—Ä—ã–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  const oldSel=document.querySelector('#quoteCurrency');
  if(oldSel && oldSel.value!==currentQuoteCurrency){
    oldSel.value=currentQuoteCurrency;
  }
  
  updatePairNameUI();
  logDbg(`switchQuoteCurrency -> ${currentBaseCurrency}_${currentQuoteCurrency}`);
  await subscribeToPairData(currentBaseCurrency,currentQuoteCurrency);
  // –î–∞—ë–º –≤—Ä–µ–º—è WebSocket –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö —Å force=true
  await new Promise(resolve => setTimeout(resolve, 1000));
  await loadMarketData(true);  // force refresh
  await loadPairBalances();
  await loadPairParams(true);
  await loadTradeParams();  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∞–ª—é—Ç—ã
  await loadBreakEvenTable();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –∫–æ—Ç–∏—Ä—É–µ–º–æ–π –≤–∞–ª—é—Ç—ã –≤ UI state
  await UIStateManager.savePartial({quoteCurrency: currentQuoteCurrency});
}
async function loadPairParams(force){
  try{
    const r=await fetch(`/api/pair/info?base_currency=${currentBaseCurrency}&quote_currency=${currentQuoteCurrency}${force?'&force=1':''}`);
    const d=await r.json();
    if(d.success){
      const info=d.data||{};
      if($('minQuoteAmount')) $('minQuoteAmount').textContent=info.min_quote_amount!=null?String(info.min_quote_amount):'-';
      if($('minBaseAmount')) $('minBaseAmount').textContent=info.min_base_amount!=null?String(info.min_base_amount):'-';
      if($('amountPrecision')) $('amountPrecision').textContent=info.amount_precision!=null?String(info.amount_precision):'-';
      if($('pricePrecision')) $('pricePrecision').textContent=info.price_precision!=null?String(info.price_precision):'-';
    }
  }catch(e){ logDbg('loadPairParams exc '+e) }
}
async function subscribeToPairData(base,quote){
  try{
    logDbg(`subscribeToPairData ${base}_${quote}`);
    setNetworkConnectionState('pending');
    const wsStatus=$('wsStatus');
    if(wsStatus){ wsStatus.textContent='üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'; wsStatus.style.color='#ffa500'; }
    const resp=await fetch('/api/pair/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({base_currency:base,quote_currency:quote})});
    const data=await resp.json();
    if(data.success){
      if(wsStatus){ wsStatus.textContent='‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω'; wsStatus.style.color='#4caf50'; }
      setNetworkConnectionState('connected');
      setTimeout(()=>{
        try{
          loadMarketData();
          loadPairBalances();
          loadPairParams(true);
        }catch(e){ logDbg('post-subscribe load err '+e); }
      },800);
    }else{
      logDbg('subscribe error '+data.error);
      if(wsStatus){ wsStatus.textContent='‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'; wsStatus.style.color='#f44336'; }
      setNetworkConnectionState('error');
    }
  }catch(e){
    logDbg('subscribe exception '+e);
    const wsStatus=$('wsStatus');
    if(wsStatus){ wsStatus.textContent='‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'; wsStatus.style.color='#f44336'; }
    setNetworkConnectionState('error');
  }
}
async function loadMarketData(forceRefresh=false){
  try{
    const forceParam = forceRefresh ? '&force=1' : '';
    const r=await fetch(`/api/pair/data?base_currency=${currentBaseCurrency}&quote_currency=${currentQuoteCurrency}${forceParam}`);
    const d=await r.json();
    if(!d.success){ logDbg('loadMarketData fail '+(d.error||'')); return; }
    // –î–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –≤ d.data
    const ob=d.data?.orderbook;
    const ticker=d.data?.ticker;
    if(ob && ob.asks && ob.bids) { 
      updateOrderBook(ob); 
      logDbg(`orderbook updated: ${ob.asks.length} asks, ${ob.bids.length} bids`);
    } else {
      logDbg('orderbook missing or empty');
    }
    if(ticker){
      const last=parseFloat(ticker.last||ticker.last_price||ticker.close||ticker.price||0);
      const priceStr=formatPrice(last);
      const cp=$('currentPrice'); if(cp) cp.textContent=priceStr;
      // –¶–µ–Ω–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ "–†—ã–Ω–æ–∫ –∏ —Å—Ç–∞–∫–∞–Ω" —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é 2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
      const pp=$('currentPairPrice'); 
      if(pp) pp.textContent='$'+(isNaN(last) ? '0.00' : last.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}));
      const sell=parseFloat(ticker.lowest_ask||ticker.ask||0);
      const bid=parseFloat(ticker.highest_bid||ticker.bid||0);
      const spread=(isFinite(sell)&&isFinite(bid)&&sell>0)?((sell-bid)/sell*100):null;
      const sv=$('spreadValue'); if(sv) sv.textContent=spread==null?'-':spread.toFixed(3)+'%';
      updateTradeIndicators({price:last});
    }
    loadPerBaseIndicators();
  }catch(e){ logDbg('loadMarketData exc '+e) }
}



// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–æ—Ç–∏—Ä—É–µ–º–æ–π –≤–∞–ª—é—Ç—ã (—Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ)
async function editQuoteBalance(){
  if(currentNetworkMode!=='test'){
    alert('‚ö†Ô∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ');
    return;
  }
  
  const balanceEl=$('headerQuoteBalance');
  if(!balanceEl) return;
  
  const currentValue=balanceEl.textContent;
  const input=prompt(`üí∞ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ ${currentQuoteCurrency}:\n\n(–ë—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –º–µ–∂–¥—É –≤—Å–µ–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏)\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É:`, currentValue);
  
  if(input===null) return; // –û—Ç–º–µ–Ω–µ–Ω–æ
  
  try{
    const newBalance=parseFloat(input);
    
    if(isNaN(newBalance)||newBalance<0){
      alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —á–∏—Å–ª–∞');
      return;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ API
    const response = await fetch('/api/test/balance', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        currency: currentQuoteCurrency,
        balance: newBalance
      })
    });
    
    const data = await response.json();
    
    if(data.success){
      logDbg(`Test balance set on server: ${newBalance} ${currentQuoteCurrency}`);
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å—ã
      loadPairBalances();
    }else{
      alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
    
  }catch(e){
    alert('‚ùå –û—à–∏–±–∫–∞: '+e);
    logDbg('editQuoteBalance error: '+e);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è test —Ä–µ–∂–∏–º–∞)
async function loadTestBalance(currency){
  if(currentNetworkMode!=='test') return null;
  
  try{
    const response = await fetch(`/api/test/balance?currency=${currency}`);
    const data = await response.json();
    
    if(data.success && data.balance > 0){
      return data.balance;
    }
  }catch(e){
    logDbg('loadTestBalance error: '+e);
  }
  
  // –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å–∞ –Ω–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –±–∞–ª–∞–Ω—Å –∏–∑ Gate.io API)
  return null;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
function updateHeaderQuoteBalance(balance){
  const balanceEl=$('headerQuoteBalance');
  if(balanceEl){
    const bal=parseFloat(balance)||0;
    balanceEl.textContent=bal.toFixed(2);
    
    // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –¥–µ–ª–∞–µ–º –±–∞–ª–∞–Ω—Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º
    if(currentNetworkMode==='test'){
      balanceEl.style.cursor='pointer';
      balanceEl.title='üñ±Ô∏è –ö–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¢–ï–°–¢–û–í–´–ô —Ä–µ–∂–∏–º)';
    }else{
      balanceEl.style.cursor='default';
      balanceEl.title='–ë–∞–ª–∞–Ω—Å –∫–æ—Ç–∏—Ä—É–µ–º–æ–π –≤–∞–ª—é—Ç—ã –∏–∑ API';
    }
  }
}

function updateOrderBook(ob){
  try{
    if(!ob||!ob.asks||!ob.bids) return;
    const asksEl=$('orderbookAsks');
    const bidsEl=$('orderbookBids');
    if(asksEl) asksEl.innerHTML='';
    if(bidsEl) bidsEl.innerHTML='';
    
    // Asks (–ø—Ä–æ–¥–∞–∂–∏, –∫—Ä–∞—Å–Ω—ã–µ): —Å—É–º–º–∏—Ä—É–µ–º –°–ù–ò–ó–£ –í–í–ï–†–• (–æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –∫ –≤–µ—Ä—Ö—É)
    // –ù—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ —Å—É–º–º—ã –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    const asksSlice = ob.asks.slice(0,20);
    const asksCumulative = [];
    let cumA = 0;
    
    // –°—É–º–º–∏—Ä—É–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö)
    for(let i = asksSlice.length - 1; i >= 0; i--) {
      cumA += parseFloat(asksSlice[i][1]);
      asksCumulative[i] = cumA;
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑), –Ω–æ —Å –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏ —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö
    asksSlice.forEach((r, idx) => {
      const p=parseFloat(r[0]);
      const a=parseFloat(r[1]);
      const t=p*a;
      const div=document.createElement('div');
      div.className='orderbook-row';
      div.innerHTML=`<div class='price'>${formatPrice(p)}</div><div class='amount'>${a.toFixed(6)}</div><div class='total'>${t.toFixed(6)}</div><div class='cumulative'>${asksCumulative[idx].toFixed(4)}</div>`;
      if(asksEl) asksEl.appendChild(div);
    });
    
    // Bids (–ø–æ–∫—É–ø–∫–∏, –∑–µ–ª–µ–Ω—ã–µ): —Å—É–º–º–∏—Ä—É–µ–º –°–í–ï–†–•–£ –í–ù–ò–ó (–æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –≤–Ω–∏–∑) - –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
    let cumB=0;
    ob.bids.slice(0,20).forEach(r=>{
      const p=parseFloat(r[0]);
      const a=parseFloat(r[1]);
      const t=p*a; cumB+=a;
      const div=document.createElement('div');
      div.className='orderbook-row';
      div.innerHTML=`<div class='price'>${formatPrice(p)}</div><div class='amount'>${a.toFixed(6)}</div><div class='total'>${t.toFixed(6)}</div><div class='cumulative'>${cumB.toFixed(4)}</div>`;
      if(bidsEl) bidsEl.appendChild(div);
    });
  }catch(e){ logDbg('updateOrderBook err '+e) }
}
async function loadPerBaseIndicators(){
  try{
    const r=await fetch(`/api/trade/indicators?base_currency=${currentBaseCurrency}&quote_currency=${currentQuoteCurrency}`);
    const d=await r.json();
    if(d.success&&d.indicators){ updateTradeIndicators(d.indicators); }
  }catch(e){ logDbg('loadPerBaseIndicators err '+e) }
}
async function loadPairBalances(){
  if(!currentBaseCurrency||!currentQuoteCurrency) return;
  try{
    const r=await fetch(`/api/pair/balances?base_currency=${currentBaseCurrency}&quote_currency=${currentQuoteCurrency}`);
    const d=await r.json();
    if(d.success){
      const baseBalEl=document.getElementById('baseBalance');
      const baseUsdEl=document.getElementById('baseBalanceUSD');
      const quoteBalEl=document.getElementById('quoteBalance');
      const quoteSymEl=document.getElementById('quoteSymbol');
      const inlineEl=document.getElementById('quoteBalanceInline');
      
      let baseAvail=parseFloat(d.balances?.base?.available||'0');
      const baseEq=d.base_equivalent||0;
      let quoteAvail=parseFloat(d.balances?.quote?.available||'0');
      
      // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –±–∞–ª–∞–Ω—Å—ã
      if(currentNetworkMode==='test'){
        const testBase=await loadTestBalance(currentBaseCurrency);
        const testQuote=await loadTestBalance(currentQuoteCurrency);
        if(testBase!==null) baseAvail=testBase;
        if(testQuote!==null) quoteAvail=testQuote;
      }
      
      if(baseBalEl) baseBalEl.textContent=(isFinite(baseAvail)?baseAvail:0).toFixed(8);
      if(baseUsdEl) baseUsdEl.textContent=`‚âà $${(isFinite(baseEq)?baseEq:0).toFixed(2)}`;
      if(quoteBalEl) quoteBalEl.textContent=(isFinite(quoteAvail)?quoteAvail:0).toFixed(8);
      if(quoteSymEl) quoteSymEl.textContent=currentQuoteCurrency;
      if(inlineEl) inlineEl.textContent=`–ë–∞–ª–∞–Ω—Å: ${(isFinite(baseAvail)?baseAvail:0).toFixed(8)} ${currentBaseCurrency} ‚âà $${(isFinite(baseEq)?baseEq:0).toFixed(2)}`;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
      updateHeaderQuoteBalance(quoteAvail);
    }
  }catch(e){ logDbg('loadPairBalances err '+e) }
}
function renderBreakEvenTable(tableData){
  console.log('[BREAKEVEN] === –ù–ê–ß–ê–õ–û –û–¢–†–ò–°–û–í–ö–ò –¢–ê–ë–õ–ò–¶–´ ===');
  console.log('[BREAKEVEN] –ü–æ–ª—É—á–µ–Ω–æ —Å—Ç—Ä–æ–∫:', tableData ? tableData.length : 'null');
  
  const body=$('breakEvenBody');
  console.log('[BREAKEVEN] –≠–ª–µ–º–µ–Ω—Ç #breakEvenBody:', body ? '–Ω–∞–π–¥–µ–Ω ‚úÖ' : '–ù–ï –ù–ê–ô–î–ï–ù ‚ùå');
  
  if(!body){
    console.error('[BREAKEVEN] ‚ùå –≠–ª–µ–º–µ–Ω—Ç breakEvenBody –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM');
    console.error('[BREAKEVEN] –ü—Ä–æ–≤–µ—Ä–∫–∞ document.getElementById:', document.getElementById('breakEvenBody'));
    return;
  }
  
  console.log('[BREAKEVEN] –û—á–∏—Å—Ç–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ tbody...');
  body.innerHTML='';
  
  if(!Array.isArray(tableData)||tableData.length===0){
    console.warn('[BREAKEVEN] ‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
    body.innerHTML=`<tr><td colspan="8" style='padding:12px;text-align:center;color:#999;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    console.log('[BREAKEVEN] === –ö–û–ù–ï–¶ –û–¢–†–ò–°–û–í–ö–ò (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö) ===');
    return;
  }
  
  console.log('[BREAKEVEN] üé® –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã, —Å—Ç—Ä–æ–∫:', tableData.length);
  
  tableData.forEach((row,idx)=>{
    const tr=document.createElement('tr');
    tr.style.background = idx===0 ? '#1f2f1f' : (idx%2===0?'#1a1a1a':'transparent');
    tr.style.borderBottom = '1px solid #2a2a2a';
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
    const stepNum = row.step !== undefined ? row.step : idx;
    const decrease = row.decrease_pct !== undefined ? row.decrease_pct.toFixed(2) : '‚Äî';
    const rate = row.rate !== undefined ? row.rate.toFixed(8) : '‚Äî';
    const purchase = row.purchase_usd !== undefined ? row.purchase_usd.toFixed(2) : '‚Äî';
    const totalInv = row.total_invested !== undefined ? row.total_invested.toFixed(2) : '‚Äî';
    const breakEvenPrice = row.breakeven_price !== undefined ? row.breakeven_price.toFixed(8) : '‚Äî';
    const breakEvenPct = row.breakeven_pct !== undefined ? row.breakeven_pct.toFixed(2) : '‚Äî';
    const targetDelta = row.target_delta_pct !== undefined ? row.target_delta_pct.toFixed(2) : '‚Äî';
    
    // –¶–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
    const decreaseColor = row.decrease_pct < 0 ? '#f44336' : '#999';
    const breakEvenColor = row.breakeven_pct > 0 ? '#4CAF50' : '#999';
    const targetColor = row.target_delta_pct > 0 ? '#4CAF50' : (row.target_delta_pct < 0 ? '#f44336' : '#999');
    
    tr.innerHTML = `
      <td style='padding:6px 8px;text-align:center;color:#e0e0e0;font-weight:600;'>${stepNum}</td>
      <td style='padding:6px 8px;text-align:right;color:${decreaseColor};'>${decrease}</td>
      <td style='padding:6px 8px;text-align:right;color:#e0e0e0;font-family:monospace;'>${rate}</td>
      <td style='padding:6px 8px;text-align:right;color:#4CAF50;'>${purchase}</td>
      <td style='padding:6px 8px;text-align:right;color:#2196F3;font-weight:600;'>${totalInv}</td>
      <td style='padding:6px 8px;text-align:right;color:#FF9800;font-family:monospace;'>${breakEvenPrice}</td>
      <td style='padding:6px 8px;text-align:right;color:${breakEvenColor};'>${breakEvenPct}</td>
      <td style='padding:6px 8px;text-align:right;color:${targetColor};font-weight:600;'>${targetDelta}</td>
    `;
    body.appendChild(tr);
  });
  
  console.log('[BREAKEVEN] ‚úÖ –í—Å–µ —Å—Ç—Ä–æ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ DOM');
  console.log('[BREAKEVEN] –ò—Ç–æ–≥–æ —Å—Ç—Ä–æ–∫ –≤ tbody:', body.children.length);
  console.log('[BREAKEVEN] === –ö–û–ù–ï–¶ –û–¢–†–ò–°–û–í–ö–ò ===');
}
async function loadBreakEvenTable(){
  console.log('[BREAKEVEN] === –ù–ê–ß–ê–õ–û –ó–ê–ì–†–£–ó–ö–ò –¢–ê–ë–õ–ò–¶–´ ===');
  console.log('[BREAKEVEN] currentBaseCurrency =', currentBaseCurrency);
  
  try{
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    if(!currentBaseCurrency){
      console.warn('[BREAKEVEN] ‚ùå –ë–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É');
      console.warn('[BREAKEVEN] –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –≤–∞–ª—é—Ç—É WLD');
      currentBaseCurrency = 'WLD'; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –≤–∞–ª—é—Ç—ã
    }
    
    // –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã (–¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
    const currentParams = {
      steps: parseInt($('paramSteps')?.value) || 16,
      start_volume: parseFloat($('paramStartVolume')?.value) || 3,
      start_price: parseFloat($('paramStartPrice')?.value) || 0,
      pprof: parseFloat($('paramPprof')?.value) || 0.6,
      kprof: parseFloat($('paramKprof')?.value) || 0.02,
      target_r: parseFloat($('paramTargetR')?.value) || 3.65,
      geom_multiplier: parseFloat($('paramGeomMultiplier')?.value) || 2,
      rebuy_mode: $('paramRebuyMode')?.value || 'geometric'
    };
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ —Ñ–æ—Ä–º—ã
    const params = new URLSearchParams({
      base_currency: currentBaseCurrency,
      steps: currentParams.steps,
      start_volume: currentParams.start_volume,
      start_price: currentParams.start_price,
      pprof: currentParams.pprof,
      kprof: currentParams.kprof,
      target_r: currentParams.target_r,
      geom_multiplier: currentParams.geom_multiplier,
      rebuy_mode: currentParams.rebuy_mode
    });
    
    const url = `/api/breakeven/table?${params.toString()}`;
    console.log('[BREAKEVEN] üì° –ó–∞–ø—Ä–æ—Å:', url);
    console.log('[BREAKEVEN] üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', currentParams);
    
    const r = await fetch(url);
    console.log('[BREAKEVEN] üì• –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', r.status, r.statusText);
    
    const d = await r.json();
    console.log('[BREAKEVEN] üì¶ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', {
      success: d.success,
      currency: d.currency,
      table_length: d.table ? d.table.length : 0,
      current_price: d.current_price,
      legacy: d.legacy
    });
    
    if(d.success && d.table){
      console.log('[BREAKEVEN] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—É—á–µ–Ω–∞, —Å—Ç—Ä–æ–∫:', d.table.length);
      console.log('[BREAKEVEN] –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞:', d.table[0]);
      console.log('[BREAKEVEN] –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞:', d.table[d.table.length - 1]);
      console.log('[BREAKEVEN] üé® –í—ã–∑–æ–≤ renderBreakEvenTable...');
      renderBreakEvenTable(d.table);
      console.log('[BREAKEVEN] ‚úÖ renderBreakEvenTable –∑–∞–≤–µ—Ä—à–µ–Ω');
    }else{
      console.error('[BREAKEVEN] ‚ùå –û—à–∏–±–∫–∞:', d.error);
      logDbg('loadBreakEvenTable fail '+(d.error||''));
      renderBreakEvenTable([]);
    }
  }catch(e){ 
    console.error('[BREAKEVEN] ‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ:', e);
    console.error('[BREAKEVEN] Stack trace:', e.stack);
    logDbg('loadBreakEvenTable err '+e);
    renderBreakEvenTable([]);
  }
  
  console.log('[BREAKEVEN] === –ö–û–ù–ï–¶ –ó–ê–ì–†–£–ó–ö–ò –¢–ê–ë–õ–ò–¶–´ ===');
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏
async function loadTradeParams(){
  try{
    console.log('[PARAMS] === –ó–ê–ì–†–£–ó–ö–ê –ü–ê–†–ê–ú–ï–¢–†–û–í ===');
    console.log('[PARAMS] currentBaseCurrency =', currentBaseCurrency);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–∞–ª—é—Ç—ã (per-currency)
    const url = currentBaseCurrency 
      ? `/api/trade/params?base_currency=${currentBaseCurrency}` 
      : '/api/trade/params';
    
    console.log('[PARAMS] üì° –ó–∞–ø—Ä–æ—Å:', url);
    
    const r=await fetch(url);
    const d=await r.json();
    
    console.log('[PARAMS] üì¶ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', d);
    
    if(d.success && d.params){
      $('paramSteps').value = d.params.steps || 16;
      $('paramStartVolume').value = d.params.start_volume || 3;
      $('paramStartPrice').value = d.params.start_price || 0;
      $('paramPprof').value = d.params.pprof || 0.6;
      $('paramKprof').value = d.params.kprof || 0.02;
      $('paramTargetR').value = d.params.target_r || 3.65;
      $('paramGeomMultiplier').value = d.params.geom_multiplier || 2;
      $('paramRebuyMode').value = d.params.rebuy_mode || 'geometric';
      console.log('[PARAMS] ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è', d.currency || 'LEGACY');
    } else {
      console.warn('[PARAMS] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã');
    }
  }catch(e){ 
    console.error('[PARAMS] ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
    logDbg('loadTradeParams err '+e);
  }
}

async function saveTradeParams(){
  const statusEl = $('paramsSaveStatus');
  try{
    console.log('[PARAMS] === –ù–ê–ß–ê–õ–û –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–ê–†–ê–ú–ï–¢–†–û–í ===');
    console.log('[PARAMS] currentBaseCurrency =', currentBaseCurrency);
    
    const params = {
      base_currency: currentBaseCurrency, // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –≤–∞–ª—é—Ç—É
      steps: parseInt($('paramSteps').value) || 16,
      start_volume: parseFloat($('paramStartVolume').value) || 3,
      start_price: parseFloat($('paramStartPrice').value) || 0,
      pprof: parseFloat($('paramPprof').value) || 0.6,
      kprof: parseFloat($('paramKprof').value) || 0.02,
      target_r: parseFloat($('paramTargetR').value) || 3.65,
      geom_multiplier: parseFloat($('paramGeomMultiplier').value) || 2,
      rebuy_mode: $('paramRebuyMode').value || 'geometric'
    };
    
    console.log('[PARAMS] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', params);
    
    statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    statusEl.className = 'params-save-status';
    
    const r = await fetch('/api/trade/params', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(params)
    });
    
    const d = await r.json();
    console.log('[PARAMS] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', d);
    
    if(d.success){
      statusEl.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
      statusEl.className = 'params-save-status';
      setTimeout(()=>{ statusEl.textContent = ''; }, 3000);
      console.log('[PARAMS] ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã...');
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É break-even –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      await loadBreakEvenTable();
      console.log('[PARAMS] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    }else{
      statusEl.textContent = '‚úó ' + (d.error || '–û—à–∏–±–∫–∞');
      statusEl.className = 'params-save-status error';
      console.error('[PARAMS] ‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', d.error);
    }
  }catch(e){ 
    statusEl.textContent = '‚úó ' + e.message;
    statusEl.className = 'params-save-status error';
    console.error('[PARAMS] ‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ:', e);
    logDbg('saveTradeParams err '+e);
  }
  console.log('[PARAMS] === –ö–û–ù–ï–¶ –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–ê–†–ê–ú–ï–¢–†–û–í ===');
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º
async function switchNetworkMode(targetMode){
  if(!targetMode || !['work','test'].includes(targetMode)) return;
  if(currentNetworkMode === targetMode) return; // —É–∂–µ –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ
  
  logDbg('switchNetworkMode -> '+targetMode);
  try{
    const resp=await fetch('/api/network',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:targetMode})});
    const data=await resp.json();
    logDbg('network POST resp '+JSON.stringify(data));
    if(data.success){
      currentNetworkMode=data.mode;
      updateNetworkUI();
      setNetworkConnectionState('pending');
      await loadCurrenciesFromServer();
      // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –í–°–ï –≤–∞–ª—é—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞
      await subscribeToAllCurrencies();
      setTimeout(()=>{
        loadMarketData();
        loadPairBalances();
        loadPairParams(true);
        loadBreakEvenTable();
      },1500);
    }else{
      logDbg('network switch fail '+(data.error||''));
      setNetworkConnectionState('error');
    }
  }catch(e){
    logDbg('switchNetworkMode exception '+e);
    setNetworkConnectionState('error');
  }
}

// –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (toggle –º–µ–∂–¥—É work/test)
async function toggleNetworkMode(){
  const next=currentNetworkMode==='work'?'test':'work';
  await switchNetworkMode(next);
}

// === Trading mode switcher (normal/copy) ===
let currentTradingMode = 'normal';

async function switchTradingMode(targetMode){
  if(!targetMode || !['normal','copy'].includes(targetMode)) return;
  if(currentTradingMode === targetMode) {
    console.log('[TRADE MODE] –£–∂–µ –≤ —Ä–µ–∂–∏–º–µ:', targetMode);
    return; // —É–∂–µ –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ
  }
  
  console.log('[TRADE MODE] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:', currentTradingMode, '->', targetMode);
  logDbg('switchTradingMode -> '+targetMode);
  try{
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 'normal' -> 'trade' –¥–ª—è API
    const apiMode = targetMode === 'normal' ? 'trade' : targetMode;
    console.log('[TRADE MODE] –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', apiMode);
    const resp=await fetch('/api/mode',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:apiMode})});
    const data=await resp.json();
    console.log('[TRADE MODE] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
    logDbg('trading mode POST resp '+JSON.stringify(data));
    if(data.success){
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 'trade' -> 'normal' –¥–ª—è UI
      currentTradingMode = data.mode === 'trade' ? 'normal' : data.mode;
      console.log('[TRADE MODE] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π):', currentTradingMode);
      updateTradingModeUI();
    }else{
      console.error('[TRADE MODE] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è:', data.error);
      logDbg('trading mode switch fail '+(data.error||''));
    }
  }catch(e){
    console.error('[TRADE MODE] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ:', e);
    logDbg('switchTradingMode exception '+e);
  }
}

function updateTradingModeUI(){
  const sw=$('tradingModeSwitcher');
  if(!sw) return;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
  const normalBtn = sw.querySelector('[data-mode="normal"]');
  const copyBtn = sw.querySelector('[data-mode="copy"]');
  if(normalBtn && copyBtn){
    // –Ø–≤–Ω–æ —É–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å active —É –æ–±–µ–∏—Ö –∫–Ω–æ–ø–æ–∫
    normalBtn.classList.remove('active');
    copyBtn.classList.remove('active');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–µ
    if(currentTradingMode==='normal' || currentTradingMode==='trade'){
      normalBtn.classList.add('active');
    }else if(currentTradingMode==='copy'){
      copyBtn.classList.add('active');
    }
    
    logDbg('Trading mode UI updated: ' + currentTradingMode);
  }
}
async function loadTradingMode(){
  try{
    const r=await fetch('/api/mode');
    const d=await r.json();
    console.log('[TRADE MODE] –ó–∞–≥—Ä—É–∂–µ–Ω —Ä–µ–∂–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞:', d);
    if(d.mode){
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 'trade' -> 'normal' –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å UI
      currentTradingMode = d.mode === 'trade' ? 'normal' : d.mode;
      updateTradingModeUI();
      console.log('[TRADE MODE] –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π):', currentTradingMode);
      logDbg('trading mode='+currentTradingMode);
    }
  }catch(e){ 
    console.error('[TRADE MODE] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
    logDbg('loadTradingMode err '+e);
  }
}

// === AutoTrade switcher ===
let autoTradeEnabled = true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ (ON)

async function toggleAutoTrade(){
  autoTradeEnabled = !autoTradeEnabled;
  updateAutoTradeUI();
  logDbg('AutoTrade toggled: ' + (autoTradeEnabled ? 'ON' : 'OFF'));
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  try {
    const endpoint = autoTradeEnabled ? '/api/autotrade/start' : '/api/autotrade/stop';
    const response = await fetch(endpoint, { method: 'POST' });
    const result = await response.json();
    if (result.success) {
      logDbg('AutoTrade: ' + (autoTradeEnabled ? '–∑–∞–ø—É—â–µ–Ω' : '–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'));
    } else {
      logDbg('AutoTrade: –æ—à–∏–±–∫–∞ - ' + (result.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      autoTradeEnabled = !autoTradeEnabled;
      updateAutoTradeUI();
    }
  } catch (error) {
    logDbg('AutoTrade: –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ - ' + error);
    // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    autoTradeEnabled = !autoTradeEnabled;
    updateAutoTradeUI();
  }
}

function updateAutoTradeUI(){
  const sw=$('autoTradeSwitcher');
  if(!sw) return;
  
  const offBtn = sw.querySelector('[data-state="off"]');
  const onBtn = sw.querySelector('[data-state="on"]');
  if(offBtn && onBtn){
    offBtn.classList.toggle('active', !autoTradeEnabled);
    onBtn.classList.toggle('active', autoTradeEnabled);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è UI —Å —Å–µ—Ä–≤–µ—Ä–∞
async function loadUIState() {
  try {
    const response = await fetch('/api/ui/state');
    const result = await response.json();
    if (result.success && result.state) {
      const state = result.state;
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–∏–Ω–≥–∞
      if (typeof state.auto_trade_enabled === 'boolean') {
        autoTradeEnabled = state.auto_trade_enabled;
        updateAutoTradeUI();
        logDbg('UI State: –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–∏–Ω–≥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - ' + (autoTradeEnabled ? 'ON' : 'OFF'));
      }
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –¥–ª—è –≤–∞–ª—é—Ç
      if (state.enabled_currencies && typeof state.enabled_currencies === 'object') {
        Object.assign(tradingPermissions, state.enabled_currencies);
        updateTabsPermissionsUI();
        logDbg('UI State: —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
      }
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∞–ª—é—Ç–Ω—É—é –ø–∞—Ä—É
      if (state.active_base_currency) {
        currentBaseCurrency = state.active_base_currency;
        logDbg('UI State: –±–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ - ' + currentBaseCurrency);
      }
      if (state.active_quote_currency) {
        currentQuoteCurrency = state.active_quote_currency;
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∫–æ—Ç–∏—Ä—É–µ–º–æ–π –≤–∞–ª—é—Ç—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        const quoteSel = document.querySelector('#quoteCurrencySelect');
        if (quoteSel) quoteSel.value = currentQuoteCurrency;
        logDbg('UI State: –∫–æ—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è –≤–∞–ª—é—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ - ' + currentQuoteCurrency);
      }
      
      logDbg('UI State: —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
    }
  } catch (error) {
    logDbg('UI State: –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ - ' + error);
  }
}

function openCurrencyManager(){buildCurrencyManagerRows();$('currencyManagerModal').style.display='flex';}
function closeCurrencyManager(){$('currencyManagerModal').style.display='none';}
function buildCurrencyManagerRows(){const rows=$('currencyManagerRows');if(!rows)return;rows.innerHTML='';const arr=Array.isArray(currenciesList)?currenciesList:[];arr.forEach((c,i)=>{const code=(c.code||c||'').toUpperCase();const symbol=(c.symbol||c.code||c||'');const row=document.createElement('div');row.className='cm-row';row.dataset.index=i;row.innerHTML=`<input type='text' class='cm-code' value='${code}' placeholder='–ö–æ–¥'><input type='text' class='cm-symbol' value='${symbol}' placeholder='–°–∏–º–≤–æ–ª'><div style='color:#888;font-size:11px;'>${tradingPermissions[code]!==false?'–¢–æ—Ä–≥–æ–≤–ª—è: ‚úÖ':'–¢–æ—Ä–≥–æ–≤–ª—è: ‚ùå'}</div><button class='cm-btn delete' onclick='deleteCurrencyRow(${i})'>üóëÔ∏è</button>`;rows.appendChild(row)});}
function addCurrencyRow(){const rows=$('currencyManagerRows');const i=rows.querySelectorAll('.cm-row').length;const row=document.createElement('div');row.className='cm-row';row.dataset.index=i;row.innerHTML=`<input type='text' class='cm-code' value='' placeholder='–ö–æ–¥'><input type='text' class='cm-symbol' value='' placeholder='–°–∏–º–≤–æ–ª'><div style='color:#888;font-size:11px;'>–ù–æ–≤–∞—è</div><button class='cm-btn delete' onclick='deleteCurrencyRow(${i})'>üóëÔ∏è</button>`;rows.appendChild(row);}
function deleteCurrencyRow(idx){const rows=$('currencyManagerRows');const row=[...rows.querySelectorAll('.cm-row')].find(r=>r.dataset.index==idx);if(row)row.remove();}
function saveCurrenciesList(){const rows=$('currencyManagerRows');const items=[...rows.querySelectorAll('.cm-row')].map(r=>({code:r.querySelector('.cm-code').value.trim().toUpperCase(),symbol:r.querySelector('.cm-symbol').value.trim()})).filter(o=>o.code);if(!items.length){alert('–ù—É–∂–Ω–∞ –º–∏–Ω–∏–º—É–º 1 –≤–∞–ª—é—Ç–∞');return;}const codes=items.map(i=>i.code);const dup=codes.filter((c,i)=>codes.indexOf(c)!==i);if(dup.length){alert('–î—É–±–ª–∏–∫–∞—Ç—ã: '+dup.join(','));return;}fetch('/api/currencies',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({currencies:items})}).then(r=>r.json()).then(d=>{if(d.success){currenciesList=items;renderCurrencyTabs(currenciesList);closeCurrencyManager();logDbg('currencies saved');}else alert('–û—à–∏–±–∫–∞: '+(d.error||'fail'))}).catch(e=>alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+e));}



// === Subscribe to all currencies ===
async function subscribeToAllCurrencies(){
  if(!Array.isArray(currenciesList) || currenciesList.length===0){
    logDbg('subscribeToAllCurrencies: –Ω–µ—Ç –≤–∞–ª—é—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏');
    return;
  }
  logDbg(`subscribeToAllCurrencies: –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ ${currenciesList.length} –≤–∞–ª—é—Ç —Å ${currentQuoteCurrency}`);
  for(const cur of currenciesList){
    const code = typeof cur==='string' ? cur : cur.code;
    if(code){
      try{
        await subscribeToPairData(code.toUpperCase(), currentQuoteCurrency);
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
        await new Promise(resolve => setTimeout(resolve, 300));
      }catch(e){
        logDbg(`subscribeToAllCurrencies: –æ—à–∏–±–∫–∞ –¥–ª—è ${code}: ${e}`);
      }
    }
  }
  logDbg('subscribeToAllCurrencies: –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
}

async function initApp(){
  try{
    console.log('[INIT] –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
    await loadNetworkMode();
    await loadTradingMode();
    await loadUIState(); // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è UI
    updateAutoTradeUI(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è AutoTrade
    const sel=document.querySelector('#quoteCurrency');
    if(sel) currentQuoteCurrency=sel.value.toUpperCase();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞–ª—é—Ç—ã –∏ –∂–¥–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ currentBaseCurrency
    await loadCurrenciesFromServer();
    console.log('[INIT] –í–∞–ª—é—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã, —Ç–µ–∫—É—â–∞—è:', currentBaseCurrency);
    
    await loadTradingPermissions();
    
    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –í–°–ï –≤–∞–ª—é—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—É—é
    await subscribeToAllCurrencies();
    
    // –¢–µ–ø–µ—Ä—å currentBaseCurrency —Ç–æ—á–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    await Promise.all([
      loadMarketData(),
      loadPairBalances(),
      loadPairParams(true),
      loadBreakEvenTable(), // –¢–µ–ø–µ—Ä—å currentBaseCurrency —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
      loadTradingPermissions()
    ]);
    
    console.log('[INIT] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∑–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤');
    setInterval(loadMarketData,5000);
    setInterval(loadPairBalances,15000);
    setInterval(loadBreakEvenTable,6000);
    setInterval(loadPerBaseIndicators,7000);
    setInterval(loadTradingPermissions,20000);
  }catch(e){
    console.error('[INIT] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
    logDbg('initApp exc '+e);
  }
}
// === Trading permissions (–≤–∫–ª–∞–¥–∫–∏) ===
function loadTradingPermissions(){return fetch('/api/trade/permissions').then(r=>r.json()).then(d=>{if(d.success){tradingPermissions=d.permissions||{};updateTabsPermissionsUI();}else logDbg('perm load fail')}).catch(e=>logDbg('perm exc '+e));}
function updateTabsPermissionsUI(){const cont=$('currencyTabsContainer');if(!cont)return;[...cont.querySelectorAll('.tab-item')].forEach(el=>{const code=el.dataset.code;let ind=el.querySelector('.perm-indicator');if(!ind){ind=document.createElement('div');ind.className='perm-indicator';el.appendChild(ind);}const enabled=tradingPermissions[code]!==false;ind.classList.toggle('on',enabled);ind.classList.toggle('off',!enabled);ind.title=enabled?'–¢–æ—Ä–≥–æ–≤–ª—è –≤–∫–ª—é—á–µ–Ω–∞':'–¢–æ—Ä–≥–æ–≤–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∞';ind.onclick=(ev)=>{ev.stopPropagation();toggleTradingPermission(code,enabled)};});}
function toggleTradingPermission(code,current){const next=!current;fetch('/api/trade/permission',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({base_currency:code,enabled:next})}).then(r=>r.json()).then(d=>{if(d.success){tradingPermissions[code]=next;updateTabsPermissionsUI();logDbg('perm '+code+' -> '+next)}else logDbg('perm set fail '+(d.error||''))}).catch(e=>logDbg('perm set exc '+e));}

// === Server controls ===
async function handleServerRestart(){
  const btn=$('restartServerBtn');
  if(!btn) return;
  const prev=btn.textContent;
  try{
    btn.disabled=true; btn.textContent='‚è≥';
    const r=await fetch('/api/server/restart',{method:'POST'});
    let msg='–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...';
    try{ const d=await r.json(); if(d && d.message) msg=d.message; }catch(_){/* ignore */}
    alert(msg);
    setTimeout(()=>{ try{ location.reload(); }catch(_){/* noop */} }, 5000);
  }catch(e){
    alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: '+e);
  }finally{
    btn.textContent=prev; btn.disabled=false;
  }
}
async function handleServerShutdown(){
  const btn=$('shutdownServerBtn');
  if(!btn) return;
  if(!confirm('–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä?')) return;
  try{
    btn.disabled=true;
    const r=await fetch('/api/server/shutdown',{method:'POST'});
    let msg='–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...';
    try{ const d=await r.json(); if(d && d.message) msg=d.message; }catch(_){/* ignore */}
    alert(msg);
  }catch(e){
    alert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: '+e);
  }finally{
    btn.disabled=false;
  }
}

// === UPTIME (—Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞) ===
let __uptimeSeconds = 0;
let __uptimeLastSync = 0;
function formatUptime(sec){
  sec = Math.max(0, Math.floor(sec));
  const d = Math.floor(sec / 86400); sec -= d*86400;
  const h = Math.floor(sec / 3600); sec -= h*3600;
  const m = Math.floor(sec / 60); sec -= m*60;
  const s = sec;
  const pad = v=>String(v).padStart(2,'0');
  return `${pad(d)}–¥ ${pad(h)}:${pad(m)}:${pad(s)}`;
}
function renderUptime(){
  const el = $('uptimeDisplay');
  if(!el) return;
  el.innerHTML = `<strong>${formatUptime(__uptimeSeconds)}</strong>`;
}
function tickUptime(){
  if(__uptimeLastSync>0){
    __uptimeSeconds += 1;
    renderUptime();
  }
}
async function loadServerStatus(){
  try{
    const r = await fetch('/api/server/status');
    const d = await r.json();
    if(d && d.uptime!=null){
      __uptimeSeconds = Math.floor(d.uptime);
      __uptimeLastSync = Date.now();
      renderUptime();
    }
    if(d && d.pid){
      const pidEl = $('serverPID');
      if(pidEl){ pidEl.textContent = `PID: ${d.pid}`; }
    }
  }catch(e){ logDbg('loadServerStatus err '+e); }
}
// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
function startUptimeLoops(){
  loadServerStatus();
  setInterval(loadServerStatus, 15000); // –∫–∞–∂–¥—ã–µ 15—Å —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  setInterval(tickUptime, 1000); // –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç–∏–∫ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
}

// DOMContentLoaded
document.addEventListener('DOMContentLoaded',()=>{ 
  initApp(); 
  startUptimeLoops();
  loadTradeParams(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ—Ä–≥–æ–≤–ª–∏
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º
  const rb=$('restartServerBtn'); if(rb){ rb.title='–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'; rb.addEventListener('click', (ev)=>{ ev.preventDefault(); handleServerRestart(); }); }
  const sb=$('shutdownServerBtn'); if(sb){ sb.title='–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä'; sb.addEventListener('click', (ev)=>{ ev.preventDefault(); handleServerShutdown(); }); }
  const spb=$('saveParamsBtn'); if(spb){ spb.addEventListener('click', (ev)=>{ ev.preventDefault(); saveTradeParams(); }); }
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (—Å debounce)
  let paramsUpdateTimeout = null;
  const paramsInputIds = ['paramSteps', 'paramStartVolume', 'paramStartPrice', 'paramPprof', 'paramKprof', 'paramTargetR', 'paramGeomMultiplier', 'paramRebuyMode'];
  
  paramsInputIds.forEach(id => {
    const input = $(id);
    if(input) {
      input.addEventListener('input', () => {
        console.log('[PARAMS] –ü–∞—Ä–∞–º–µ—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω:', id);
        // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
        if(paramsUpdateTimeout) clearTimeout(paramsUpdateTimeout);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–∂–∏–¥–∞–Ω–∏—è
        const statusEl = $('paramsSaveStatus');
        if(statusEl) {
          statusEl.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
          statusEl.className = 'params-save-status';
        }
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 500–º—Å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
        paramsUpdateTimeout = setTimeout(async () => {
          console.log('[PARAMS] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤');
          try {
            await loadBreakEvenTable();
            if(statusEl) {
              statusEl.textContent = '‚úì –û–±–Ω–æ–≤–ª–µ–Ω–æ';
              setTimeout(() => { statusEl.textContent = ''; }, 2000);
            }
          } catch(e) {
            console.error('[PARAMS] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:', e);
            if(statusEl) statusEl.textContent = '‚úó –û—à–∏–±–∫–∞';
          }
        }, 500);
      });
    }
  });
  
  console.log('[INIT] –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
});
</script>
</body>
</html>
