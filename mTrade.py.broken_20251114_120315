"""
Gate.io Multi-Trading Application
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ —Ç—Ä–µ–π–¥–∏–Ω–≥–∞ –∏ –∫–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥–∞
–ê–≤—Ç–æ—Ä: –í–∞—à–µ –∏–º—è
–î–∞—Ç–∞: 4 –Ω–æ—è–±—Ä—è 2025
"""

import os
import sys
import json
import time
import hmac
import hashlib
import signal
import atexit
import random  # –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä–∞
from datetime import datetime
from flask import Flask, render_template, request, jsonify, session
import requests
from threading import Thread
from typing import Dict, List, Optional
from data_limits import DataLimits

# –ò–º–ø–æ—Ä—Ç WebSocket –º–æ–¥—É–ª—è
from gateio_websocket import init_websocket_manager, get_websocket_manager
# –ò–º–ø–æ—Ä—Ç State Manager
from state_manager import get_state_manager
# –ò–º–ø–æ—Ä—Ç Trade Logger
from trade_logger import get_trade_logger

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Flask
app = Flask(__name__)
app.secret_key = os.urandom(24)
# –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤/—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏ ETag
app.config['TEMPLATES_AUTO_RELOAD'] = True
app.config['SEND_FILE_MAX_AGE_DEFAULT'] = 0
app.config['ETAG_DISABLED'] = True

# –û—Ç–∫–ª—é—á–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤
@app.after_request
def add_header(response):
    """–î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–µ—à–∞"""
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate, max-age=0'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    # –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å mtime —à–∞–±–ª–æ–Ω–∞ index.html
    try:
        template_path = os.path.join(app.root_path, 'templates', 'index.html')
        if os.path.exists(template_path):
            response.headers['X-Template-MTime'] = str(os.path.getmtime(template_path))
    except Exception:
        pass
    return response

# =============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# =============================================================================

class Config:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    
    # API Gate.io
    API_HOST = "https://api.gateio.ws"
    API_PREFIX = "/api/v4"
    
    # –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã
    MODE_NORMAL = "normal"  # –û–±—ã—á–Ω—ã–π —Ç—Ä–µ–π–¥–∏–Ω–≥
    MODE_COPY = "copy"      # –ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    DEFAULT_MODE = MODE_NORMAL
    DEFAULT_MARKET = "spot"  # spot, futures
    
    # –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    CONFIG_FILE = "config.json"
    ACCOUNTS_FILE = "accounts.json"
    # –ü–µ—Ä–µ–Ω–æ—Å —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ø–∞–ø–∫—É config/
    SECRETS_FILE = os.path.join('config', 'secrets.json')
    CURRENCIES_FILE = "currencies.json"
    WORK_SECRETS_FILE = os.path.join('config', 'secrets.json')        # —Ä–∞–±–æ—á–∞—è —Å–µ—Ç—å
    TEST_SECRETS_FILE = os.path.join('config', 'secrets_test.json')   # —Ç–µ—Å—Ç–æ–≤–∞—è —Å–µ—Ç—å
    TEST_API_HOST = "https://api-testnet.gateapi.io"  # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏ Gate.io
    NETWORK_CONFIG_FILE = "network_mode.json"

    @staticmethod
    def load_network_mode() -> str:
        try:
            if os.path.exists(Config.NETWORK_CONFIG_FILE):
                with open(Config.NETWORK_CONFIG_FILE, 'r', encoding='utf-8') as f:
                    js = json.load(f)
                    m = str(js.get('mode', 'work')).lower()
                    return 'test' if m == 'test' else 'work'
        except Exception:
            pass
        return 'work'

    @staticmethod
    def save_network_mode(mode: str) -> bool:
        try:
            if mode not in ('work','test'): return False
            with open(Config.NETWORK_CONFIG_FILE, 'w', encoding='utf-8') as f:
                json.dump({'mode': mode, 'saved_at': time.time()}, f, ensure_ascii=False, indent=2)
            return True
        except Exception:
            return False

    @staticmethod
    def load_secrets():
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å API –∫–ª—é—á–∏ –∏–∑ secrets.json"""
        if os.path.exists(Config.SECRETS_FILE):
            try:
                with open(Config.SECRETS_FILE, 'r') as f:
                    secrets = json.load(f)
                    return secrets.get('GATEIO_API_KEY'), secrets.get('GATEIO_API_SECRET')
            except Exception as e:
                print(f"[ERROR] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ secrets.json: {e}")
        return None, None
    
    @staticmethod
    def load_secrets_by_mode(mode: str):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á–∏ –ø–æ —Ä–µ–∂–∏–º—É work|test, —É—á–∏—Ç—ã–≤–∞—è –Ω–æ–≤—ã–µ –ø—É—Ç–∏ config/ –∏ —Å—Ç–∞—Ä—ã–µ –∏–º–µ–Ω–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏."""
        candidates = []
        if mode == 'work':
            candidates = [
                Config.WORK_SECRETS_FILE,
                Config.SECRETS_FILE,
                'secret.json',           # —Å—Ç–∞—Ä–æ–µ –∏–º—è
                'secrets.json'           # –≤–æ–∑–º–æ–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
            ]
        else:
            candidates = [
                Config.TEST_SECRETS_FILE,
                'secret_test.json',      # —Å—Ç–∞—Ä–æ–µ –∏–º—è
                'secrets_test.json'      # –≤–æ–∑–º–æ–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
            ]
        for file in candidates:
            try:
                if os.path.exists(file):
                    with open(file,'r',encoding='utf-8') as f:
                        j = json.load(f)
                        ak = j.get('GATEIO_API_KEY')
                        sk = j.get('GATEIO_API_SECRET')
                        if ak and sk:
                            return ak, sk
            except Exception as e:
                print(f"[ERROR] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {file}: {e}")
        return None, None
    
    @staticmethod
    def load_currencies():
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–∞–∑–æ–≤—ã—Ö –≤–∞–ª—é—Ç –∏–∑ currencies.json"""
        default_currencies = [
            { "code": "WLD", "symbol": "üåê" },
            { "code": "BTC", "symbol": "‚Çø" },
            { "code": "ETH", "symbol": "Œû" },
            { "code": "SOL", "symbol": "‚óé" },
            { "code": "BNB", "symbol": "üî∂" },
            { "code": "XRP", "symbol": "‚úï" },
            { "code": "ADA", "symbol": "‚Ç≥" },
            { "code": "AVAX", "symbol": "üî∫" },
            { "code": "DOT", "symbol": "‚¨§" },
            { "code": "MATIC", "symbol": "üî∑" }
        ]
        
        if os.path.exists(Config.CURRENCIES_FILE):
            try:
                with open(Config.CURRENCIES_FILE, 'r', encoding='utf-8') as f:
                    currencies = json.load(f)
                    return currencies if currencies else default_currencies
            except Exception as e:
                print(f"[ERROR] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ currencies.json: {e}")
                return default_currencies
        else:
            # –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –≤–∞–ª—é—Ç–∞–º–∏
            Config.save_currencies(default_currencies)
            return default_currencies
    
    @staticmethod
    def save_currencies(currencies):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–∞–∑–æ–≤—ã—Ö –≤–∞–ª—é—Ç –≤ currencies.json"""
        try:
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–ª—é—Ç
            if len(currencies) > DataLimits.MAX_CURRENCIES:
                currencies = currencies[:DataLimits.MAX_CURRENCIES]
                print(f"[WARNING] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–ª—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –¥–æ {DataLimits.MAX_CURRENCIES}")
            
            with open(Config.CURRENCIES_FILE, 'w', encoding='utf-8') as f:
                json.dump(currencies, f, ensure_ascii=False, indent=2)
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
            file_size_kb = os.path.getsize(Config.CURRENCIES_FILE) / 1024
            if file_size_kb > DataLimits.MAX_CURRENCIES_FILE_SIZE_KB:
                print(f"[WARNING] –†–∞–∑–º–µ—Ä currencies.json ({file_size_kb:.2f} KB) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç")
            
            return True
        except Exception as e:
            print(f"[ERROR] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è currencies.json: {e}")
            return False


# =============================================================================
# PROCESS MANAGER (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º)
# =============================================================================

class ProcessManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–º —Å–µ—Ä–≤–µ—Ä–∞"""
    
    PID_FILE = "mtrade_server.pid"
    
    @staticmethod
    def write_pid():
        """–ó–∞–ø–∏—Å–∞—Ç—å PID —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞"""
        pid = os.getpid()
        with open(ProcessManager.PID_FILE, 'w') as f:
            f.write(str(pid))
        print(f"[PID] –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω —Å PID: {pid}")
        
    @staticmethod
    def read_pid():
        """–ü—Ä–æ—á–∏—Ç–∞—Ç—å PID –∏–∑ —Ñ–∞–π–ª–∞"""
        if os.path.exists(ProcessManager.PID_FILE):
            try:
                with open(ProcessManager.PID_FILE, 'r') as f:
                    return int(f.read().strip())
            except:
                return None
        return None
    
    @staticmethod
    def remove_pid():
        """–£–¥–∞–ª–∏—Ç—å PID —Ñ–∞–π–ª"""
        if os.path.exists(ProcessManager.PID_FILE):
            os.remove(ProcessManager.PID_FILE)
            print("[PID] PID —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω")
    
    @staticmethod
    def is_running():
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å"""
        pid = ProcessManager.read_pid()
        if pid is None:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
        try:
            # –ù–∞ Windows –∏—Å–ø–æ–ª—å–∑—É–µ–º tasklist
            import subprocess
            result = subprocess.run(
                ['tasklist', '/FI', f'PID eq {pid}'],
                capture_output=True,
                text=True
            )
            return str(pid) in result.stdout
        except:
            return False
    
    @staticmethod
    def kill_process(pid=None):
        """–£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –ø–æ PID"""
        if pid is None:
            pid = ProcessManager.read_pid()
        
        if pid is None:
            print("[PID] PID –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False
        
        try:
            import subprocess
            # –ù–∞ Windows –∏—Å–ø–æ–ª—å–∑—É–µ–º taskkill
            subprocess.run(['taskkill', '/F', '/PID', str(pid)], check=True)
            print(f"[PID] –ü—Ä–æ—Ü–µ—Å—Å {pid} –∑–∞–≤–µ—Ä—à–µ–Ω")
            ProcessManager.remove_pid()
            return True
        except Exception as e:
            print(f"[PID] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞: {e}")
            return False
    
    @staticmethod
    def setup_cleanup():
        """–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ"""
        atexit.register(ProcessManager.remove_pid)
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown
        def signal_handler(signum, frame):
            print("\n[SHUTDOWN] –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")
            ProcessManager.remove_pid()
            sys.exit(0)
        
        signal.signal(signal.SIGINT, signal_handler)
        signal.signal(signal.SIGTERM, signal_handler)


# =============================================================================
# GATE.IO API CLIENT
# =============================================================================

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–¥–µ—Å—å, –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Config
server_start_time = time.time()
PAIR_INFO_CACHE = {}
PAIR_INFO_CACHE_TTL = 3600  # 1 —á–∞—Å

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∂–∏–º —Å–µ—Ç–∏ –∏–∑ state_manager (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
state_mgr = get_state_manager()
CURRENT_NETWORK_MODE = state_mgr.get_network_mode()
print(f"[NETWORK] –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Å–µ—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ state_manager: {CURRENT_NETWORK_MODE}")

# --- –†–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ (work/test) ---
_ws_reinit_lock = None
try:
    from threading import Lock
    _ws_reinit_lock = Lock()
except Exception:
    pass

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ watchlist –¥–ª—è WebSocket (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π no-op –ø—Ä–∏ –æ—à–∏–±–∫–µ)
def _init_default_watchlist():
    try:
        ws_manager = get_websocket_manager()
        if not ws_manager:
            return
        # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–∞—Ä, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –ø–æ—è–≤–∏–ª–∏—Å—å —Å—Ä–∞–∑—É
        for pair in ('BTC_USDT', 'ETH_USDT'):
            try:
                ws_manager.create_connection(pair)
            except Exception:
                pass
    except Exception:
        pass

def _reinit_network_mode(new_mode: str) -> bool:
    """–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Å–µ—Ç–∏ —Å –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π WebSocket –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
    - –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º –Ω–∞ –¥–∏—Å–∫
    - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä —Å –∫–ª—é—á–∞–º–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å–µ—Ç–∏
    - –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –±–∞–∑–æ–≤—ã–π watchlist
    """
    global CURRENT_NETWORK_MODE
    new_mode = str(new_mode).lower()
    if new_mode not in ('work','test'):
        return False
    if new_mode == CURRENT_NETWORK_MODE:
        return True  # —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if _ws_reinit_lock:
        _ws_reinit_lock.acquire()
    try:
        print(f"[NETWORK] ========================================")
        print(f"[NETWORK] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞: {CURRENT_NETWORK_MODE} -> {new_mode}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–µ–∂–∏–º–∞
        Config.save_network_mode(new_mode)
        CURRENT_NETWORK_MODE = new_mode
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ö–æ—Å—Ç API –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
        api_host = Config.TEST_API_HOST if new_mode == 'test' else Config.API_HOST
        print(f"[NETWORK] API Host: {api_host}")
        
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ WS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        ws_manager = get_websocket_manager()
        if ws_manager:
            try:
                ws_manager.close_all()
                print(f"[NETWORK] WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç—ã")
            except Exception as e:
                print(f"[NETWORK] –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è WS: {e}")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        try:
            ak, sk = Config.load_secrets_by_mode(CURRENT_NETWORK_MODE)
            if ak and sk:
                print(f"[NETWORK] –ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–ª—é—á–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ '{new_mode}':")
                print(f"[NETWORK]   API Key: {ak}")
                print(f"[NETWORK]   –§–∞–π–ª: {Config.TEST_SECRETS_FILE if new_mode == 'test' else Config.WORK_SECRETS_FILE}")
            else:
                print(f"[NETWORK] ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ '{new_mode}'!")
            
            init_websocket_manager(ak, sk, CURRENT_NETWORK_MODE)
            _init_default_watchlist()
            print(f"[NETWORK] ‚úì WS –º–µ–Ω–µ–¥–∂–µ—Ä –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        except Exception as e:
            print(f"[NETWORK] ‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WS –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
        
        print(f"[NETWORK] ========================================")
        return True
    finally:
        if _ws_reinit_lock:
            _ws_reinit_lock.release()

# =============================================================================
# PROCESS MANAGER (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º)
# =============================================================================

class ProcessManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–º —Å–µ—Ä–≤–µ—Ä–∞"""
    
    PID_FILE = "mtrade_server.pid"
    
    @staticmethod
    def write_pid():
        """–ó–∞–ø–∏—Å–∞—Ç—å PID —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞"""
        pid = os.getpid()
        with open(ProcessManager.PID_FILE, 'w') as f:
            f.write(str(pid))
        print(f"[PID] –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω —Å PID: {pid}")
        
    @staticmethod
    def read_pid():
        """–ü—Ä–æ—á–∏—Ç–∞—Ç—å PID –∏–∑ —Ñ–∞–π–ª–∞"""
        if os.path.exists(ProcessManager.PID_FILE):
            try:
                with open(ProcessManager.PID_FILE, 'r') as f:
                    return int(f.read().strip())
            except:
                return None
        return None
    
    @staticmethod
    def remove_pid():
        """–£–¥–∞–ª–∏—Ç—å PID —Ñ–∞–π–ª"""
        if os.path.exists(ProcessManager.PID_FILE):
            os.remove(ProcessManager.PID_FILE)
            print("[PID] PID —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω")
    
    @staticmethod
    def is_running():
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å"""
        pid = ProcessManager.read_pid()
        if pid is None:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
        try:
            # –ù–∞ Windows –∏—Å–ø–æ–ª—å–∑—É–µ–º tasklist
            import subprocess
            result = subprocess.run(
                ['tasklist', '/FI', f'PID eq {pid}'],
                capture_output=True,
                text=True
            )
            return str(pid) in result.stdout
        except:
            return False
    
    @staticmethod
    def kill_process(pid=None):
        """–£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –ø–æ PID"""
        if pid is None:
            pid = ProcessManager.read_pid()
        
        if pid is None:
            print("[PID] PID –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False
        
        try:
            import subprocess
            # –ù–∞ Windows –∏—Å–ø–æ–ª—å–∑—É–µ–º taskkill
            subprocess.run(['taskkill', '/F', '/PID', str(pid)], check=True)
            print(f"[PID] –ü—Ä–æ—Ü–µ—Å—Å {pid} –∑–∞–≤–µ—Ä—à–µ–Ω")
            ProcessManager.remove_pid()
            return True
        except Exception as e:
            print(f"[PID] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞: {e}")
            return False
    
    @staticmethod
    def setup_cleanup():
        """–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ"""
        atexit.register(ProcessManager.remove_pid)
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown
        def signal_handler(signum, frame):
            print("\n[SHUTDOWN] –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")
            ProcessManager.remove_pid()
            sys.exit(0)
        
        signal.signal(signal.SIGINT, signal_handler)
        signal.signal(signal.SIGTERM, signal_handler)


# =============================================================================
# GATE.IO API CLIENT
# =============================================================================

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–¥–µ—Å—å, –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Config
server_start_time = time.time()
PAIR_INFO_CACHE = {}
PAIR_INFO_CACHE_TTL = 3600  # 1 —á–∞—Å

class GateAPIClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Gate.io API"""
    
    def __init__(self, api_key: str, api_secret: str, network_mode: str = 'work'):
        self.api_key = api_key
        self.api_secret = api_secret
        self.network_mode = network_mode
        # –í—ã–±–æ—Ä —Ö–æ—Å—Ç–∞ –ø–æ —Ä–µ–∂–∏–º—É
        self.host = Config.API_HOST if network_mode == 'work' else Config.TEST_API_HOST
        self.prefix = Config.API_PREFIX
    
    def _generate_sign(self, method: str, url: str, query_string: str = '', payload: str = ''):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è API –∑–∞–ø—Ä–æ—Å–∞"""
        t = str(int(time.time()))
        m = hashlib.sha512()
        m.update(payload.encode('utf-8'))
        hashed_payload = m.hexdigest()
        
        s = f"{method}\n{url}\n{query_string}\n{hashed_payload}\n{t}"
        sign = hmac.new(
            self.api_secret.encode('utf-8'),
            s.encode('utf-8'),
            hashlib.sha512
        ).hexdigest()
        
        return {
            'KEY': self.api_key,
            'Timestamp': t,
            'SIGN': sign
        }
    
    def _request(self, method: str, endpoint: str, params: dict = None, data: dict = None):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å–∞"""
        url = f"{self.prefix}{endpoint}"
        query_string = ''
        payload = ''
        if params:
            query_string = '&'.join([f"{k}={v}" for k, v in params.items()])
        if data:
            payload = json.dumps(data)
        headers = {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
        if self.api_key and self.api_secret:
            headers.update(self._generate_sign(method, url, query_string, payload))
        full_url = f"{self.host}{url}"
        if query_string:
            full_url += f"?{query_string}"
        if endpoint.startswith('/spot/accounts'):
            print(f"[API DEBUG] Balance request -> mode={self.network_mode}, host={self.host}, url={full_url}")
        if endpoint.startswith('/spot/orders'):
            print(f"[API DEBUG] Order request -> endpoint={endpoint}, payload={payload[:500]}")
        response = requests.request(method, full_url, headers=headers, data=payload if data else None)
        status = response.status_code
        text_raw = ''
        try:
            text_raw = response.text[:500]
        except Exception:
            pass
        try:
            js = response.json()
        except Exception as je:
            print(f"[API DEBUG] JSON parse error status={status} err={je} raw={text_raw}")
            js = {'error': 'json_parse_error', 'status': status, 'raw': text_raw}
        if endpoint.startswith('/spot/accounts'):
            if status != 200:
                print(f"[API DEBUG] NON-200 status={status} raw={text_raw}")
            else:
                # –°–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤
                if isinstance(js, list):
                    print(f"[API DEBUG] Balance list len={len(js)}")
                elif isinstance(js, dict):
                    print(f"[API DEBUG] Balance dict keys={list(js.keys())[:6]}")
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–Ω—É—Ç—Ä—å –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã —Ñ—Ä–æ–Ω—Ç –º–æ–≥ –µ–≥–æ —É–≤–∏–¥–µ—Ç—å
        if status != 200 and isinstance(js, dict) and 'status' not in js:
            js['status'] = status
        return js
    
    # -------------------------------------------------------------------------
    # SPOT TRADING (–û–±—ã—á–Ω—ã–π —Ç—Ä–µ–π–¥–∏–Ω–≥)
    # -------------------------------------------------------------------------
    
    def get_account_balance(self):
        """–ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å —Å–ø–æ—Ç —Å—á–µ—Ç–∞"""
        return self._request('GET', '/spot/accounts')
    
    def create_spot_order(self, currency_pair: str, side: str, amount: str, price: str = None, order_type: str = "limit"):
        """–°–æ–∑–¥–∞—Ç—å —Å–ø–æ—Ç–æ–≤—ã–π –æ—Ä–¥–µ—Ä"""
        order_data = {
            "currency_pair": currency_pair,
            "side": side,  # buy –∏–ª–∏ sell
            "amount": amount,
            "type": order_type  # limit –∏–ª–∏ market
        }
        
        if order_type == "market":
            # –î–ª—è market –æ—Ä–¥–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º time_in_force=ioc (Immediate Or Cancel)
            order_data["time_in_force"] = "ioc"
        elif price and order_type == "limit":
            order_data["price"] = price
        
        # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        print(f"[ORDER] Creating order: {order_data}")
        result = self._request('POST', '/spot/orders', data=order_data)
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        print(f"[ORDER] API response type={type(result).__name__}, data={str(result)[:300]}")
        return result
    
    def get_spot_orders(self, currency_pair: str, status: str = "open"):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ä–¥–µ—Ä–æ–≤"""
        params = {
            "currency_pair": currency_pair,
            "status": status
        }
        return self._request('GET', '/spot/orders', params=params)
    
    def cancel_spot_order(self, order_id: str, currency_pair: str):
        """–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä"""
        return self._request('DELETE', f'/spot/orders/{order_id}', params={"currency_pair": currency_pair})
    
    # -------------------------------------------------------------------------
    # FUTURES TRADING
    # -------------------------------------------------------------------------
    
    def get_futures_balance(self, settle: str = "usdt"):
        """–ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å —Ñ—å—é—á–µ—Ä—Å–Ω–æ–≥–æ —Å—á–µ—Ç–∞"""
        return self._request('GET', f'/futures/{settle}/accounts')
    
    def create_futures_order(self, contract: str, size: int, price: str = None, settle: str = "usdt"):
        """–°–æ–∑–¥–∞—Ç—å —Ñ—å—é—á–µ—Ä—Å–Ω—ã–π –æ—Ä–¥–µ—Ä"""
        order_data = {
            "contract": contract,
            "size": size,
        }
        
        if price:
            order_data["price"] = price
        
        return self._request('POST', f'/futures/{settle}/orders', data=order_data)
    
    # -------------------------------------------------------------------------
    # COPY TRADING (–ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥)
    # -------------------------------------------------------------------------
    
    def get_account_detail(self):
        """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ (–≤–∫–ª—é—á–∞—è copy_trading_role)"""
        return self._request('GET', '/account/detail')
    
    def transfer_to_copy_trading(self, currency: str, amount: str, direction: str = "to"):
        """
        –ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –≤/–∏–∑ –∫–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ –∞–∫–∫–∞—É–Ω—Ç–∞
        direction: 'to' - –≤ –∫–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥, 'from' - –∏–∑ –∫–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥–∞
        """
        # –î–ª—è —Ñ—å—é—á–µ—Ä—Å–Ω–æ–≥–æ –∫–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ endpoints
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Ç–æ—á–Ω—ã–π endpoint –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è, –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        transfer_data = {
            "currency": currency,
            "amount": amount,
            "from": "spot" if direction == "to" else "copy_trading",
            "to": "copy_trading" if direction == "to" else "spot"
        }
        return self._request('POST', '/wallet/transfers', data=transfer_data)
    
    def get_currency_pair_details_exact(self, currency_pair: str):
        """–¢–æ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –æ–¥–Ω–æ–π –ø–∞—Ä—ã —á–µ—Ä–µ–∑ endpoint /spot/currency_pairs/{pair}."""
        try:
            ep = f"/spot/currency_pairs/{currency_pair.upper()}"
            return self._request('GET', ep)
        except Exception as e:
            return {"error": str(e)}
    
    def get_currency_pair_details(self, currency_pair: str):
        """–°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫)."""
        try:
            params = {"currency_pair": currency_pair.upper()}
            return self._request('GET', '/spot/currency_pairs', params=params)
        except Exception as e:
            return {"error": str(e)}


# =============================================================================
# TRADING ENGINE
# =============================================================================

class TradingEngine:
    """–î–≤–∏–∂–æ–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–ª–µ–π"""
    
    def __init__(self, api_client: GateAPIClient, mode: str = Config.MODE_NORMAL):
        self.client = api_client
        self.mode = mode
        self.is_running = False
        self.active_orders = []
    
    def set_mode(self, mode: str):
        """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏"""
        if mode in [Config.MODE_NORMAL, Config.MODE_COPY]:
            self.mode = mode
            print(f"[INFO] –†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {mode}")
            return True
        return False
    
    def get_mode(self) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º"""
        return self.mode
    
    def start(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é"""
        self.is_running = True
        print(f"[INFO] –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ: {self.mode}")
    
    def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é"""
        self.is_running = False
        print(f"[INFO] –¢–æ—Ä–≥–æ–≤–ª—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
    
    def execute_trade(self, params: dict):
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É"""
        if self.mode == Config.MODE_NORMAL:
            return self._execute_normal_trade(params)
        elif self.mode == Config.MODE_COPY:
            return self._execute_copy_trade(params)
    
    def _execute_normal_trade(self, params: dict):
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±—ã—á–Ω—É—é —Å–¥–µ–ª–∫—É"""
        try:
            result = self.client.create_spot_order(
                currency_pair=params.get('currency_pair'),
                side=params.get('side'),
                amount=params.get('amount'),
                price=params.get('price'),
                order_type=params.get('type', 'limit')
            )
            return {"success": True, "data": result}
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    def _execute_copy_trade(self, params: dict):
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ —Å–¥–µ–ª–∫—É"""
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥–∞
        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        return {
            "success": True,
            "message": "Copy trading —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ",
            "mode": "copy_trading"
        }


# =============================================================================
# ACCOUNT MANAGER
# =============================================================================

class AccountManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏"""
    
    def __init__(self):
        self.accounts = self._load_accounts()
        self.active_account = None
        # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        try:
            self._auto_set_active_account()
        except Exception:
            pass
    
    def _load_accounts(self) -> dict:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã –∏–∑ —Ñ–∞–π–ª–∞"""
        if os.path.exists(Config.ACCOUNTS_FILE):
            with open(Config.ACCOUNTS_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        return {}
    
    def _save_accounts(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã –≤ —Ñ–∞–π–ª
        –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —ç–øhemeral-–∞–∫–∫–∞—É–Ω—Ç—ã (—Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–∑ config/secrets)"""
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        if len(self.accounts) > DataLimits.MAX_ACCOUNTS:
            print(f"[WARNING] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ ({len(self.accounts)}) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç {DataLimits.MAX_ACCOUNTS}")
            # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –∞–∫–∫–∞—É–Ω—Ç–æ–≤
            sorted_accounts = sorted(
                self.accounts.items(),
                key=lambda x: x[1].get('created_at', ''),
                reverse=True
            )
            self.accounts = dict(sorted_accounts[:DataLimits.MAX_ACCOUNTS])
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º —ç–øhemeral –∞–∫–∫–∞—É–Ω—Ç—ã –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        to_save = {k: v for k, v in self.accounts.items() if not v.get('ephemeral')}
        with open(Config.ACCOUNTS_FILE, 'w', encoding='utf-8') as f:
            json.dump(to_save, f, indent=2, ensure_ascii=False)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        file_size_kb = os.path.getsize(Config.ACCOUNTS_FILE) / 1024
        if file_size_kb > DataLimits.MAX_ACCOUNTS_FILE_SIZE_KB:
            print(f"[WARNING] –†–∞–∑–º–µ—Ä accounts.json ({file_size_kb:.2f} KB) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç")
    
    def add_account(self, name: str, api_key: str, api_secret: str):
        """–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
        if len(self.accounts) >= DataLimits.MAX_ACCOUNTS:
            return {
                "success": False,
                "error": f"–î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ ({DataLimits.MAX_ACCOUNTS})"
            }
        
        self.accounts[name] = {
            "api_key": api_key,
            "api_secret": api_secret,
            "created_at": datetime.now().isoformat()
        }
        self._save_accounts()
        return {"success": True}
    
    def get_account(self, name: str) -> Optional[dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –ø–æ –∏–º–µ–Ω–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç–øhemeral –∞–∫–∫–∞—É–Ω—Ç –∏–∑ config/secrets –ø—Ä–∏ –∏–º–µ–Ω–∏ '__secrets__'"""
        if name in self.accounts:
            return self.accounts.get(name)
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∏–º—è –∏ –≤ accounts –µ–≥–æ –Ω–µ—Ç ‚Äî –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ config
        if name == '__secrets__':
            ak, sk = Config.load_secrets_by_mode(CURRENT_NETWORK_MODE)
            if ak and sk:
                return { 'api_key': ak, 'api_secret': sk, 'created_at': datetime.now().isoformat(), 'ephemeral': True }
        return None
    
    def list_accounts(self) -> List[str]:
        """–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤"""
        return list(self.accounts.keys())
    
    def set_active_account(self, name: str):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç"""
        if name in self.accounts:
            self.active_account = name
            return True
        # –†–∞–∑—Ä–µ—à–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∏–∑ config
        if name == '__secrets__':
            ak, sk = Config.load_secrets_by_mode(CURRENT_NETWORK_MODE)
            if ak and sk:
                # —Å–æ–∑–¥–∞—ë–º –≤ –ø–∞–º—è—Ç–∏ —ç–øhemeral –∑–∞–ø–∏—Å—å, –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –¥–∏—Å–∫
                self.accounts[name] = { 'api_key': ak, 'api_secret': sk, 'created_at': datetime.now().isoformat(), 'ephemeral': True }
                self.active_account = name
                print(f"[ACCOUNTS] Active account set to ephemeral '{name}' from config secrets")
                return True
        return False
    
    def _auto_set_active_account(self):
        """–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å active_account:
        - –µ—Å–ª–∏ –≤ accounts —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω –∞–∫–∫–∞—É–Ω—Ç ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –µ–≥–æ
        - –∏–Ω–∞—á–µ, –µ—Å–ª–∏ –≤ config/secrets –µ—Å—Ç—å –∫–ª—é—á–∏ ‚Äî —Å–æ–∑–¥–∞—ë–º —ç–øhemeral-–∞–∫–∫–∞—É–Ω—Ç –∏ –≤—ã–±–∏—Ä–∞–µ–º –µ–≥–æ
        """
        if self.active_account:
            return
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if isinstance(self.accounts, dict) and len(self.accounts) == 1:
            only_name = list(self.accounts.keys())[0]
            self.active_account = only_name
            print(f"[ACCOUNTS] Auto-set active account to '{only_name}' (only one account present)")
            return

        # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á–∏ –∏–∑ config/secrets
        try:
            ak, sk = Config.load_secrets_by_mode(CURRENT_NETWORK_MODE)
            if ak and sk:
                name = '__secrets__'
                # –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã
                if name not in self.accounts:
                    self.accounts[name] = { 'api_key': ak, 'api_secret': sk, 'created_at': datetime.now().isoformat(), 'ephemeral': True }
                    print(f"[ACCOUNTS] Created ephemeral account '{name}' from config secrets")
                self.active_account = name
                print(f"[ACCOUNTS] Auto-set active account to ephemeral '{name}' (from config secrets)")
                return
        except Exception:
            pass

    def ensure_active_account(self) -> bool:
        """–í—ã–∑–≤–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É –∞–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ active_account –∏ –≤–µ—Ä–Ω—É—Ç—å True, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"""
        try:
            self._auto_set_active_account()
            return bool(self.active_account)
        except Exception:
            return False
    

# =============================================================================
# FLASK ROUTES (WEB INTERFACE)
# =============================================================================

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
account_manager = AccountManager()
trading_engines = {}
# –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä
from autotrader import AutoTrader
auto_trader = None

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    print('[ROUTE] GET / index served')
    import time, hashlib
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–∏
    template_path = os.path.join(app.root_path, 'templates', 'index.html')
    sig = ''
    try:
        with open(template_path, 'rb') as f:
            sig = hashlib.md5(f.read()).hexdigest()[:8]
    except Exception:
        sig = 'nosig'
    response = app.make_response(render_template('index.html', cache_buster=int(time.time()), tpl_sig=sig))
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate, max-age=0'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    response.headers['X-Template-Sig'] = sig
    return response

@app.route('/v2')
@app.route('/v2/')
def index_v2():
    """–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–¥–ª—è –æ–±—Ö–æ–¥–∞ –∫–µ—à–∞ –ø–æ –Ω–æ–≤–æ–º—É URL)"""
    print('[ROUTE] GET /v2 index served')
    import time
    response = app.make_response(render_template('index.html', cache_buster=int(time.time())))
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate, max-age=0'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    return response

@app.route('/version')
def version():
    """–í–µ—Ä—Å–∏—è –∏ –∞–ø—Ç–∞–π–º —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∫–µ—à–∞/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞."""
    return jsonify({
        "ok": True,
        "pid": os.getpid(),
        "server_start_time": server_start_time,
        "now": time.time()
    })

@app.route('/ping')
def ping():
    return 'pong', 200

@app.route('/favicon.ico')
def favicon():
    """–ì–ª—É—à–∏–º –∑–∞–ø—Ä–æ—Å favicon, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å 404 –≤ –∫–æ–Ω—Å–æ–ª–∏"""
    return ('', 204)

@app.route('/test')
def test_orderbook():
    """–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞–∫–∞–Ω–∞"""
    return render_template('test_orderbook.html')

@app.route('/api/accounts', methods=['GET'])
def get_accounts():
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤"""
    return jsonify({
        "accounts": account_manager.list_accounts(),
        "active": account_manager.active_account
    })

@app.route('/api/accounts', methods=['POST'])
def add_account():
    """–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç"""
    data = request.json
    account_manager.add_account(
        data['name'],
        data['api_key'],
        data['api_secret']
    )
    return jsonify({"success": True, "message": "–ê–∫–∫–∞—É–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω"})

@app.route('/api/mode', methods=['GET'])
def get_mode():
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º"""
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∂–∏–º –∏–∑ state_manager (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
    mode = state_mgr.get_trading_mode()
    return jsonify({"success": True, "mode": mode})

@app.route('/api/mode', methods=['POST'])
def set_mode():
    """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ç–æ—Ä–≥–æ–≤–ª–∏"""
    try:
        data = request.json or {}
        mode = str(data.get('mode', '')).lower()
        
        if mode not in ('trade', 'copy'):
            return jsonify({"success": False, "error": "mode must be trade or copy"}), 400
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –≤ state_manager
        if state_mgr.set_trading_mode(mode):
            print(f"[STATE] Trading mode —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {mode}")
            return jsonify({"success": True, "mode": mode})
        else:
            return jsonify({"success": False, "error": "Failed to save trading mode"}), 500
    except Exception as e:
        print(f"[ERROR] set_mode: {e}")
        return jsonify({"success": False, "error": str(e)}), 500

# =============================================================================
# CURRENCIES API (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª—é—Ç–∞–º–∏)
# =============================================================================

@app.route('/api/currencies', methods=['GET'])
def get_currencies():
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–∞–∑–æ–≤—ã—Ö –≤–∞–ª—é—Ç"""
    currencies = Config.load_currencies()
    return jsonify({"success": True, "currencies": currencies})

@app.route('/api/currencies', methods=['POST'])
def save_currencies():
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–∞–∑–æ–≤—ã—Ö –≤–∞–ª—é—Ç"""
    try:
        data = request.json
        currencies = data.get('currencies', [])
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not currencies or not isinstance(currencies, list):
            return jsonify({"success": False, "error": "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö"}), 400
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
        codes = [c.get('code') for c in currencies]
        if len(codes) != len(set(codes)):
            return jsonify({"success": False, "error": "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–æ–¥—ã –≤–∞–ª—é—Ç"}), 400
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        for currency in currencies:
            if not currency.get('code') or not isinstance(currency.get('code'), str):
                return jsonify({"success": False, "error": "–í—Å–µ –≤–∞–ª—é—Ç—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –∫–æ–¥"}), 400
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        if Config.save_currencies(currencies):
            return jsonify({"success": True, "message": "–í–∞–ª—é—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"})
        else:
            return jsonify({"success": False, "error": "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"}), 500
            
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500

@app.route('/api/currencies/sync', methods=['POST'])
def sync_currencies_from_gateio():
    """
    –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞–ª—é—Ç—ã —Å Gate.io API
    –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–∞–ª—é—Ç —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
    """
    try:
        from currency_sync import CurrencySync
        
        # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
        api_key = None
        api_secret = None
        
        account_manager.ensure_active_account()
        if account_manager.active_account:
            account = account_manager.get_account(account_manager.active_account)
            if account:
                api_key = account.get('api_key')
                api_secret = account.get('api_secret')
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
        sync = CurrencySync()
        result = sync.sync_from_gateio(
            api_key=api_key,
            api_secret=api_secret,
            network_mode=CURRENT_NETWORK_MODE
        )
        
        if result["success"]:
            return jsonify(result)
        else:
            return jsonify(result), 500
            
    except Exception as e:
        return jsonify({
            "success": False,
            "error": f"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {str(e)}",
            "added": 0,
            "updated": 0
        }), 500

@app.route('/api/currencies/sync-info', methods=['GET'])
def get_sync_info():
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–∞–ª—é—Ç"""
    try:
        from currency_sync import CurrencySync
        
        sync = CurrencySync()
        info = sync.get_sync_info()
        
        return jsonify({
            "success": True,
            "info": info
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

@app.route('/api/currencies/<code>/symbol', methods=['PUT'])
def update_currency_symbol(code):
    """
    –û–±–Ω–æ–≤–∏—Ç—å —Å–∏–º–≤–æ–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–∞–ª—é—Ç—ã
    Body: {"symbol": "‚Çø"}
    """
    try:
        from currency_sync import CurrencySync
        
        data = request.json
        symbol = data.get('symbol')
        
        if not symbol:
            return jsonify({
                "success": False,
                "error": "–ù–µ —É–∫–∞–∑–∞–Ω —Å–∏–º–≤–æ–ª"
            }), 400
        
        sync = CurrencySync()
        if sync.update_currency_symbol(code, symbol):
            return jsonify({
                "success": True,
                "message": f"–°–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã {code} –æ–±–Ω–æ–≤–ª—ë–Ω"
            })
        else:
            return jsonify({
                "success": False,
                "error": f"–í–∞–ª—é—Ç–∞ {code} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            }), 404
            
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500