# ‚úÖ –ê–¢–û–ú–ê–†–ù–ê–Ø –ó–ê–©–ò–¢–ê –û–¢ RACE CONDITION - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û

## üéØ –ü–†–û–ë–õ–ï–ú–ê
–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –≤–≤–µ–¥–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ `cycle_start_state` (0/1/2), –º–µ–∂–¥—É **–ø—Ä–æ–≤–µ—Ä–∫–æ–π** —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ **—É—Å—Ç–∞–Ω–æ–≤–∫–æ–π** —Ñ–ª–∞–≥–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª race condition:
- –î–≤–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –º–æ–≥–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `cycle_start_state=0`
- –û–±–µ —Å—á–∏—Ç–∞–ª–∏, —á—Ç–æ –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –ø–æ–∫—É–ø–∫—É
- –û–±–µ –≤—ã–∑—ã–≤–∞–ª–∏ `_try_start_cycle()` ‚Üí **–¥—É–±–ª–∏—Ä—É—é—â–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø–æ–∫—É–ø–∫–∏**

## üîß –†–ï–®–ï–ù–ò–ï: threading.Lock –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–ª—é—Ç—ã

### 1Ô∏è‚É£ –î–æ–±–∞–≤–ª–µ–Ω —Å–ª–æ–≤–∞—Ä—å Lock'–æ–≤ –≤ __init__
```python
# –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê: Lock –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cycle_start_state
self._cycle_locks: Dict[str, threading.Lock] = {}
```

### 2Ô∏è‚É£ –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª: –∞—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ + –≤—ã–∑–æ–≤
**–î–û** (race condition –≤–æ–∑–º–æ–∂–µ–Ω):
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –í–ù–ï Lock
cycle_start_state = cycle.get('cycle_start_state', 0)
if cycle_start_state == 0:
    # –î—Ä—É–≥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –∑–∞–π—Ç–∏ —Å—é–¥–∞ –î–û —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–ª–∞–≥–∞!
    self._try_start_cycle(base, quote)
```

**–ü–û–°–õ–ï** (–∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞—â–∏—Ç–∞):
```python
# –°–æ–∑–¥–∞—ë–º Lock –¥–ª—è –≤–∞–ª—é—Ç—ã, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if base not in self._cycle_locks:
    self._cycle_locks[base] = threading.Lock()

# –í–°–Ø –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è –í–ù–£–¢–†–ò Lock
with self._cycle_locks[base]:
    self._ensure_cycle_struct(base)
    cycle = self.cycles.get(base, {})
    
    cycle_start_state = cycle.get('cycle_start_state', 0)
    
    if cycle.get('active') or cycle_start_state == 2:
        self._try_sell(base, quote)
        self._try_rebuy(base, quote)
    elif cycle_start_state == 0:
        # –ê–¢–û–ú–ê–†–ù–û: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤—ã–∑–æ–≤ –≤ –æ–¥–Ω–æ–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏
        self._try_start_cycle(base, quote)
    # cycle_start_state=1 ‚Üí –ù–ò–ß–ï–ì–û –ù–ï –î–ï–õ–ê–ï–ú
```

### 3Ô∏è‚É£ _try_start_cycle: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –í–ù–£–¢–†–ò Lock
Lock —É–∂–µ –∑–∞—Ö–≤–∞—á–µ–Ω –≤ –≥–ª–∞–≤–Ω–æ–º —Ü–∏–∫–ª–µ, –ø–æ—ç—Ç–æ–º—É:
- –£–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `cycle_start_state`
- –û—Å—Ç–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞)
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ `cycle_start_state=1` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–∞—Ç–æ–º–∞—Ä–Ω–æ** –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –≥–ª–∞–≤–Ω–æ–º —Ü–∏–∫–ª–µ

```python
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–¥–ª—è –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞)
if cycle.get('cycle_start_state', 0) != 0:
    return

# –ê—Ç–æ–º–∞—Ä–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞
cycle['cycle_start_state'] = 1
self._save_cycles_state()
```

## üìä –ì–ê–†–ê–ù–¢–ò–ò

### ‚úÖ –ß—Ç–æ –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–û:
1. **–¢–æ–ª—å–∫–æ –æ–¥–Ω–∞** –∏—Ç–µ—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–æ–∫—É–ø–∫—É
2. **–¢–æ–ª—å–∫–æ –æ–¥–Ω–∞** —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞ –Ω–∞ —Ü–∏–∫–ª (MARKET –æ—Ä–¥–µ—Ä –Ω–∞ –≤—Å—é —Å—É–º–º—É)
3. **–ù–µ—Ç race condition** –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ñ–ª–∞–≥–∞
4. **–ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö** –æ—Ä–¥–µ—Ä–æ–≤ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏—Ç–µ—Ä–∞—Ü–∏—è—Ö
5. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏

### ‚öôÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
```
–ò—Ç–µ—Ä–∞—Ü–∏—è 1                    –ò—Ç–µ—Ä–∞—Ü–∏—è 2
-----------                   -----------
Lock.acquire() ‚úÖ             Lock.acquire() ‚è∏Ô∏è (–∂–¥—ë—Ç)
‚îÇ
‚îú‚îÄ cycle_start_state = 0 ‚úÖ
‚îú‚îÄ _try_start_cycle()
‚îÇ  ‚îî‚îÄ cycle_start_state = 1 ‚úÖ
‚îÇ     _save_cycles_state() ‚úÖ
‚îÇ
Lock.release() ‚úÖ             Lock.acquire() ‚úÖ
                              ‚îÇ
                              ‚îú‚îÄ cycle_start_state = 1 ‚ùå
                              ‚îî‚îÄ –ù–ò–ß–ï–ì–û –ù–ï –î–ï–õ–ê–ï–ú
                              
                              Lock.release() ‚úÖ
```

## üéØ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
1. –ü—Ä–æ–¥–∞–∂–∞ ‚Üí `cycle_start_state=0` + `active=False`
2. –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª: Lock ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ `=0` ‚Üí `_try_start_cycle()`
3. –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞: —Ñ–ª–∞–≥ `=1` ‚Üí MARKET –æ—Ä–¥–µ—Ä ‚Üí `=2` + `active=True`
4. –î—Ä—É–≥–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏: –≤–∏–¥—è—Ç `=2` ‚Üí —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ/–ø—Ä–æ–¥–∞–∂–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Race condition (—Ç–µ–ø–µ—Ä—å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â—ë–Ω!)
1. –ü—Ä–æ–¥–∞–∂–∞ ‚Üí `cycle_start_state=0`
2. –ò—Ç–µ—Ä–∞—Ü–∏—è A: Lock ‚úÖ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ `=0` ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–æ–∫—É–ø–∫—É
3. –ò—Ç–µ—Ä–∞—Ü–∏—è B: Lock ‚è∏Ô∏è (–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è) ‚Üí –∂–¥—ë—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
4. –ò—Ç–µ—Ä–∞—Ü–∏—è A: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `=1` ‚Üí Lock release ‚úÖ
5. –ò—Ç–µ—Ä–∞—Ü–∏—è B: Lock ‚úÖ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ `=1` ‚Üí **–ù–ò–ß–ï–ì–û –ù–ï –î–ï–õ–ê–ï–¢** ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ
1. –§–ª–∞–≥ `=1` ‚Üí –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–∫—É–ø–∫–∏ ‚Üí **–∏—Å–∫–ª—é—á–µ–Ω–∏–µ**
2. –ë–ª–æ–∫ `except`: —Ñ–ª–∞–≥ `=0` ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞

## üìù –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´

### c:\Users\–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä\Documents\bGate.mTrade\autotrader.py
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: `self._cycle_locks: Dict[str, threading.Lock] = {}`
- **–ò–∑–º–µ–Ω–µ–Ω–æ**: –≥–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª (_run) - –≤—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è –æ–±–µ—Ä–Ω—É—Ç–∞ –≤ Lock
- **–£–ø—Ä–æ—â–µ–Ω–æ**: _try_start_cycle - —É–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

## üöÄ –†–ê–ó–í–Å–†–¢–´–í–ê–ù–ò–ï

1. ‚úÖ –ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω
2. ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω: `python -m py_compile autotrader.py`
3. ‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞: `restart_server.bat`
4. ‚è≥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤
5. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤: –Ω–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –ø–æ–∫—É–ø–æ–∫

## üìå –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä** –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤**: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –û–î–ù–ê —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ**: `cycle_start_state` –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å 0‚Üí1‚Üí2 –±–µ–∑ –¥—É–±–ª–µ–π
4. **–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç**: —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥–∞–∂—É –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 2024-12-05  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ê–¢–û–ú–ê–†–ù–ê–Ø –ó–ê–©–ò–¢–ê –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –ò–°–ü–†–ê–í–õ–ï–ù
