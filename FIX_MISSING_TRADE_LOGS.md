# ИСПРАВЛЕНИЕ: Отсутствующие записи в trade_logs при ручной продаже

## Дата: 2024-01-XX

## ПРОБЛЕМА

При ручной продаже через веб-интерфейс (кнопка "Продать всё") записи в `trade_logs/*.jsonl` **НЕ создавались**, из-за чего:

1. ❌ Система не могла отследить, что цикл был завершён продажей
2. ❌ После ручной продажи происходила серия повторных стартовых покупок
3. ❌ В логах сделок отсутствовали важные записи о ручных продажах
4. ❌ Анализ истории торговли был неполным

### Пример проблемного поведения

```
# Лог без исправления:
2024-01-15 10:00:00 | BUY | BTC | step=0 | price=43000 | volume=0.001
[Пользователь продаёт через веб-интерфейс — НЕТ ЗАПИСИ В ЛОГЕ]
2024-01-15 10:01:00 | BUY | BTC | step=0 | price=43100 | volume=0.001  ❌ Повторная покупка!
2024-01-15 10:02:00 | BUY | BTC | step=0 | price=43200 | volume=0.001  ❌ Ещё одна!
```

## ПРИЧИНА

В файле `handlers/quick_trades.py` (функция `quick_sell_all_impl`), логирование происходило **только если `filled_base > 0`**:

```python
# СТАРЫЙ КОД (ПРОБЛЕМНЫЙ):
if filled_base and filled_base > 0:
    trade_logger = get_trade_logger()
    trade_logger.log_sell(currency=base_currency, volume=filled_base, price=best_bid, delta_percent=0.0, pnl=0.0)
else:
    # If nothing filled — do not log as a completed sell
    diagnostic_info['error_stage'] = 'not_filled'
```

**Проблема**: В тестовой сети или при рыночных ордерах `filled_base` мог быть 0, даже если ордер был успешно создан и исполнен. Это приводило к тому, что продажа НЕ логировалась.

## РЕШЕНИЕ

### 1. Исправлен файл `handlers/quick_trades.py`

**Изменения (строки ~485-497)**:

```python
# НОВЫЙ КОД (ИСПРАВЛЕННЫЙ):
# КРИТИЧНО: Всегда логируем продажу, даже если filled_base=0
# Используем amount (заказанный объем), если filled_base не определен
volume_to_log = filled_base if filled_base > 0 else amount
trade_logger = get_trade_logger()
trade_logger.log_sell(
    currency=base_currency, 
    volume=volume_to_log, 
    price=best_bid, 
    delta_percent=0.0, 
    pnl=0.0
)
print(f"[TRADE_LOG] Продажа залогирована: {base_currency}, volume={volume_to_log}, price={best_bid}")
```

**Ключевые изменения**:
- ✅ Логирование происходит **всегда** при успешном создании ордера
- ✅ Если `filled_base` не определён, используется `amount` (заказанный объём)
- ✅ Добавлено сообщение в консоль для отладки

### 2. Проверены другие места продажи

Выполнен аудит всех файлов на наличие других мест, где происходят продажи:

- ✅ `autotrader_v2.py` - продаж напрямую не делает
- ✅ `api_routes.py` - продаж напрямую не делает
- ✅ `handlers/quick_trades.py` - **единственное место ручной продажи** (исправлено)

## ТЕСТИРОВАНИЕ

### Шаг 1: Проверка логирования продажи

1. Запустите сервер
2. Выполните ручную продажу через веб-интерфейс (кнопка "Продать всё")
3. Проверьте консоль — должно быть сообщение:
   ```
   [TRADE_LOG] Продажа залогирована: BTC, volume=0.001, price=43000
   ```

### Шаг 2: Проверка файла логов

Откройте файл `trade_logs/{CURRENCY}_logs.jsonl` и убедитесь, что последняя строка содержит запись о продаже:

```json
{"action":"SELL","timestamp":"2024-01-15T10:00:00","price":43000,"volume":0.001,"delta_percent":0.0,"pnl":0.0}
```

### Шаг 3: Проверка отсутствия повторных покупок

После ручной продажи подождите 1-2 минуты и убедитесь, что:
- ❌ В консоли НЕТ сообщений о новых стартовых покупках
- ❌ В логах НЕТ новых записей BUY с `step=0`

### Шаг 4: Проверка сброса цикла

В консоли должно быть сообщение:
```
[MANUAL_SELL][BTC] Цикл сброшен после ручной продажи: active=False, last_sell_time=1234567890.123
[MANUAL_SELL][BTC] Состояние автотрейдера сохранено
```

## РЕЗУЛЬТАТ

### ДО исправления:
```
# trade_logs/BTC_logs.jsonl (пример без исправления):
{"action":"BUY","timestamp":"2024-01-15T10:00:00","step":0,"price":43000,"volume":0.001}
# [Пользователь продаёт — НЕТ ЗАПИСИ]
{"action":"BUY","timestamp":"2024-01-15T10:01:00","step":0,"price":43100,"volume":0.001}  ❌
{"action":"BUY","timestamp":"2024-01-15T10:02:00","step":0,"price":43200,"volume":0.001}  ❌
```

### ПОСЛЕ исправления:
```
# trade_logs/BTC_logs.jsonl (с исправлением):
{"action":"BUY","timestamp":"2024-01-15T10:00:00","step":0,"price":43000,"volume":0.001}
{"action":"SELL","timestamp":"2024-01-15T10:00:30","price":43000,"volume":0.001,"delta_percent":0.0,"pnl":0.0}  ✅
# [Дальше НЕТ повторных покупок — цикл корректно сброшен]
```

## СВЯЗАННЫЕ ИСПРАВЛЕНИЯ

Это исправление работает вместе с другими фиксами:

1. **TEST_MANUAL_SELL_FIX.md** - Добавлен метод `force_reset_cycle` для сброса цикла после ручной продажи
2. **FIX_MISSING_TRADE_LOGS.md** (этот файл) - Исправлено логирование продаж в trade_logs

**Вместе эти исправления полностью решают проблему повторных покупок после ручной продажи.**

## ПРОВЕРКА РАБОТЫ

### PowerShell команда для мониторинга:
```powershell
Get-Content -Path "trade_logs\BTC_logs.jsonl" -Tail 10 -Wait
```

### Что смотреть:
1. ✅ После ручной продажи появляется запись `"action":"SELL"`
2. ✅ В консоли есть `[TRADE_LOG] Продажа залогирована`
3. ✅ В консоли есть `[MANUAL_SELL][XXX] Цикл сброшен`
4. ❌ НЕТ повторных записей `"action":"BUY"` с `"step":0` после продажи

## ФАЙЛЫ ИЗМЕНЕНЫ

- ✅ `handlers/quick_trades.py` (строки ~485-497) - Исправлено логирование продаж

## СТАТУС: ✅ ИСПРАВЛЕНИЕ ПРИМЕНЕНО

Теперь все ручные продажи логируются в `trade_logs/*.jsonl`, и система корректно отслеживает завершение циклов.
