# Диагностика и исправление таблицы безубыточности

## Дата: 2025-01-10
## Статус: В процессе диагностики

---

## Проблема
Таблица безубыточности не отображается в веб-интерфейсе приложения mTrade.

---

## Проведенная диагностика

### 1. Проверка Backend API
✅ **API работает корректно**
- Endpoint: `/api/breakeven/table`
- Тесты показали, что API возвращает правильные данные
- Legacy режим (без параметров) работает
- Per-currency режим (с параметром `base_currency`) работает
- Данные корректно форматируются

**Примеры ответов:**
```
Legacy mode: 17 строк, валюта = LEGACY
BTC mode: 16 строк, current_price = 0.0
ETH mode: 17 строк, current_price = 3532.81
```

### 2. Проверка Frontend кода

#### HTML структура
✅ **Таблица присутствует в DOM**
- ID элемента: `breakEvenBody` (строка 582 в index.html)
- Таблица находится внутри блока "Таблица Безубыточности"
- Изначально отображается "Загрузка данных..."

#### JavaScript функции
✅ **Функции загрузки и отрисовки присутствуют**

**`loadBreakEvenTable()` (строка 1103):**
- Проверяет наличие `currentBaseCurrency`
- Делает запрос к `/api/breakeven/table?base_currency={currency}`
- Вызывает `renderBreakEvenTable()` с полученными данными
- Добавлено логирование с префиксом `[BREAKEVEN]`

**`renderBreakEvenTable()` (строка 1054):**
- Проверяет наличие элемента DOM `breakEvenBody`
- Очищает содержимое таблицы
- Создает строки с данными
- Форматирует числа и применяет цветовую раскраску

### 3. Инициализация приложения

✅ **Порядок инициализации правильный**
```javascript
async function initApp(){
  await loadNetworkMode();
  await loadTradingMode();
  await loadUIState();
  await loadCurrenciesFromServer();  // Устанавливает currentBaseCurrency
  await loadTradingPermissions();
  await subscribeToAllCurrencies();
  
  await Promise.all([
    loadMarketData(),
    loadPairBalances(),
    loadPairParams(true),
    loadBreakEvenTable(),  // Вызывается после установки currentBaseCurrency
    loadTradingPermissions()
  ]);
  
  // Интервалы обновления
  setInterval(loadBreakEvenTable, 6000);
}
```

### 4. Переключение валют

✅ **Функция switchBaseCurrency вызывает загрузку таблицы**
- Строка 749: `currentBaseCurrency = code.toUpperCase()`
- После переключения валюты вызывается `loadBreakEvenTable()` (строки 762, 779, 800)

---

## Возможные причины проблемы

### Гипотеза 1: Ошибка в консоли браузера
**Проверка:** Открыть DevTools (F12) → Console
**Что искать:**
- Ошибки при вызове `loadBreakEvenTable()`
- Ошибки при рендеринге таблицы
- Сообщения с префиксом `[BREAKEVEN]`

### Гипотеза 2: Элемент таблицы скрыт CSS
**Проверка:** DevTools → Elements → найти `#breakEvenBody`
**Что проверить:**
- Есть ли `display: none` на родительских элементах
- Применяется ли правильный CSS к таблице
- Видна ли таблица визуально

### Гипотеза 3: currentBaseCurrency не установлена
**Проверка:** В консоли браузера выполнить `console.log(currentBaseCurrency)`
**Ожидаемый результат:** Должна быть строка с кодом валюты (например, "BTC")
**Если null:** Проблема в инициализации валют

### Гипотеза 4: Данные не доходят до renderBreakEvenTable
**Проверка:** Логи в консоли браузера
**Что искать:**
- `[BREAKEVEN] Загрузка таблицы для валюты: ...`
- `[BREAKEVEN] Ответ сервера: ...`
- `[BREAKEVEN] Таблица получена, строк: ...`
- `[BREAKEVEN] Отрисовка таблицы, строк: ...`

---

## Инструкции по диагностике (для пользователя)

### Шаг 1: Откройте консоль браузера
1. Откройте приложение в браузере: http://localhost:5000
2. Нажмите F12 (или Ctrl+Shift+I)
3. Перейдите на вкладку Console

### Шаг 2: Проверьте логи загрузки
В консоли должны быть сообщения:
```
[INIT] Начало инициализации приложения
[INIT] Валюты загружены, текущая: BTC (или другая)
[BREAKEVEN] Загрузка таблицы для валюты: BTC
[BREAKEVEN] Ответ сервера: {success: true, table: Array(16), ...}
[BREAKEVEN] Таблица получена, строк: 16
[BREAKEVEN] Отрисовка таблицы, строк: 16
```

### Шаг 3: Проверьте currentBaseCurrency
В консоли выполните:
```javascript
console.log(currentBaseCurrency)
```
Должна быть строка типа "BTC", "ETH" и т.д.

### Шаг 4: Проверьте элемент DOM
1. В DevTools перейдите на вкладку Elements
2. Нажмите Ctrl+F и введите: `breakEvenBody`
3. Проверьте, что элемент существует и внутри есть строки `<tr>`

### Шаг 5: Принудительная загрузка
В консоли выполните:
```javascript
loadBreakEvenTable()
```
Наблюдайте за логами в консоли.

---

## Решения

### Если в консоли ошибка "breakEvenBody не найден"
**Проблема:** Элемент DOM недоступен
**Решение:** Проверить, что таблица не была удалена или переименована в HTML

### Если currentBaseCurrency = null
**Проблема:** Валюта не загружена
**Решение:** 
1. Проверить файл `currencies.json`
2. Проверить endpoint `/api/currencies`
3. В консоли выполнить `loadCurrenciesFromServer()` вручную

### Если данные не приходят с сервера
**Проблема:** API недоступен или возвращает ошибку
**Решение:**
1. Проверить логи сервера
2. Проверить работу API: `curl http://localhost:5000/api/breakeven/table?base_currency=BTC`

### Если таблица отрисовывается, но не видна
**Проблема:** CSS скрывает таблицу
**Решение:**
1. Проверить стили родительских элементов
2. Проверить, не свернут ли блок "Таблица Безубыточности"
3. Проверить z-index и overflow

---

## Тестовый скрипт

Создан файл `test_breakeven.py` для проверки API:
```bash
python test_breakeven.py
```

Этот скрипт проверяет:
- Legacy режим (без параметров)
- Per-currency режим (BTC, ETH)
- Корректность возвращаемых данных

---

## Следующие шаги

1. ✅ Проверить API backend - **РАБОТАЕТ**
2. ✅ Проверить frontend функции - **ПРИСУТСТВУЮТ**
3. ✅ Проверить инициализацию - **ПРАВИЛЬНАЯ**
4. ⏳ Проверить консоль браузера - **ТРЕБУЕТСЯ ТЕСТИРОВАНИЕ**
5. ⏳ Проверить элемент DOM - **ТРЕБУЕТСЯ ТЕСТИРОВАНИЕ**
6. ⏳ Найти реальную причину проблемы
7. ⏳ Исправить и протестировать

---

## Дополнительная информация

### Файлы для проверки
- Backend: `mTrade.py` (строки 1018-1066)
- Frontend: `templates/index.html` (строки 1054-1127)
- Калькулятор: `breakeven_calculator.py`

### Логирование
Все критические точки снабжены логированием с префиксом `[BREAKEVEN]`

### Интервал обновления
Таблица автоматически обновляется каждые 6 секунд.

---

**Статус:** Backend работает, требуется тестирование frontend в браузере
