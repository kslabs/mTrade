# ИСПРАВЛЕНИЕ: Расчёт целевой цены продажи

**Дата:** 8 декабря 2025  
**Статус:** ✅ ИСПРАВЛЕНО

## Проблема

Продажи происходили **с убытком**, когда цена **падала** ниже стартовой цены покупки:

```
[06:50:37] [XRP] Sell{9.9834; Курс:2.0790; ↑Δ%:-0.05; PnL:-0.0152; Профит:-0.0152}
[06:50:24] [XRP] Buy{9.9986; Курс:2.0800; ↓Δ%:0.00; ↓%:0.00; Инвест:9.9986}
```

- Покупка: 2.0800 → Продажа: 2.0790 ❌ (убыток -0.05%)
- Дельта отрицательная: `-0.05%`

## Причина

В методе `_try_sell` целевая цена продажи рассчитывалась **неправильно**:

```python
# ❌ НЕПРАВИЛЬНО (старый код)
target_sell_price = breakeven_price * (1 + target_delta_pct / 100.0)
```

**Проблема:** `target_delta_pct` рассчитан в `breakeven_calculator.py` **относительно `rate`** (расчётного курса на текущем шаге), а НЕ относительно `breakeven_price`!

### Как рассчитывается target_delta_pct в breakeven_calculator.py:

```python
# Строка 248 в breakeven_calculator.py
target_delta_pct = breakeven_pct + pprof - (step * kprof)
```

Где:
- `breakeven_pct = ((breakeven_price - rate) / rate) * 100` — процент роста **от rate** до безубыточности
- `pprof` — целевая прибыль (например, 0.15%)
- `kprof` — коэффициент уменьшения прибыли на каждом шаге

То есть `target_delta_pct` — это процент роста **от rate**, а не от breakeven_price!

## Решение

Исправлена формула расчёта целевой цены продажи:

```python
# ✅ ПРАВИЛЬНО (новый код)
target_sell_price = rate * (1 + target_delta_pct / 100.0)
```

Где `rate` — расчётный курс на текущем шаге из таблицы breakeven.

### Дополнительная защита

Добавлена проверка, чтобы не продавать ниже цены безубыточности:

```python
if target_sell_price < breakeven_price:
    print(f"[{base}] [WARN] Целевая цена ({target_sell_price}) ниже безубыточности ({breakeven_price}), используем безубыточность")
    target_sell_price = breakeven_price
```

## Изменённые файлы

- `c:\Users\Администратор\Documents\bGate.mTrade\autotrader_v2.py`
  - Метод `_try_sell`, строки ~798-822
  - Исправлена формула расчёта `target_sell_price`
  - Добавлена защита от продажи ниже безубыточности

## Результат

Теперь продажа будет происходить **только когда**:
1. Текущая цена >= `rate * (1 + target_delta_pct / 100)`
2. Целевая цена >= `breakeven_price` (защита от убытков)

Это гарантирует, что продажа произойдёт **только с прибылью** (или как минимум без убытка).

## Пример правильного расчёта

Допустим:
- Стартовая покупка: 2.0800 USDT
- Расчётный курс шага (rate): 2.0800 USDT
- Цена безубыточности (breakeven_price): 2.0810 USDT (с учётом средней)
- target_delta_pct: 0.15% (целевая прибыль)

**Старый (неправильный) расчёт:**
```
target_sell_price = 2.0810 * (1 + 0.15/100) = 2.0841 USDT
```

**Новый (правильный) расчёт:**
```
target_sell_price = 2.0800 * (1 + 0.15/100) = 2.0831 USDT
```

Но т.к. 2.0831 < 2.0810 (breakeven), применяется защита:
```
target_sell_price = max(2.0831, 2.0810) = 2.0831 USDT ✅
```

## Тестирование

После исправления необходимо:
1. ✅ Перезапустить автотрейдер
2. ✅ Дождаться стартовой покупки
3. ✅ Проверить логи продажи:
   - Дельта должна быть **положительной** (`↑Δ% > 0`)
   - PnL должен быть **положительным** (`PnL > 0`)
   - Цена продажи должна быть **выше** цены покупки

## Статус

✅ **ИСПРАВЛЕНО** — формула расчёта целевой цены продажи теперь корректная.
