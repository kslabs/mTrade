# ‚úÖ ASYNC START BUY - –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï RACE CONDITION

## üéØ –ü–†–û–ë–õ–ï–ú–ê (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)

**Lock –æ—Å–≤–æ–±–æ–∂–¥–∞–ª—Å—è –î–û –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è MARKET –æ—Ä–¥–µ—Ä–∞!**

```
–ò—Ç–µ—Ä–∞—Ü–∏—è 1                      –ò—Ç–µ—Ä–∞—Ü–∏—è 2
-----------                     -----------
Lock.acquire() ‚úÖ
‚îú‚îÄ cycle_start_state = 0 ‚úÖ
‚îú‚îÄ _try_start_cycle()
‚îÇ  ‚îú‚îÄ cycle_start_state = 1 ‚úÖ
‚îÇ  ‚îî‚îÄ MARKET –æ—Ä–¥–µ—Ä ‚è≥ (1-3 —Å–µ–∫)
Lock.release() ‚úÖ               Lock.acquire() ‚úÖ
‚îÇ                               ‚îú‚îÄ cycle_start_state = 1? –ù–ï–¢!
‚îÇ                               ‚îÇ  (—Ñ–∞–π–ª –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è)
‚îÇ                               ‚îú‚îÄ cycle_start_state = 0 ‚ùå
MARKET –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ              ‚îî‚îÄ –î–£–ë–õ–ò–†–£–Æ–©–ê–Ø –ü–û–ö–£–ü–ö–ê ‚ùå
cycle_start_state = 2 ‚úÖ
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ú–µ–∂–¥—É —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ñ–ª–∞–≥–∞ `=1` –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ —Ñ–∞–π–ª –ø—Ä–æ—Ö–æ–¥–∏—Ç 1-3 —Å–µ–∫—É–Ω–¥—ã (–≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è MARKET –æ—Ä–¥–µ—Ä–∞), –∏ –¥—Ä—É–≥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ–≤–∞–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `=0`!

## üîß –†–ï–®–ï–ù–ò–ï: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ

### 1Ô∏è‚É£ –§–ª–∞–≥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –°–†–ê–ó–£ (–ø–æ–¥ Lock)
```python
with self._cycle_locks[base]:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –ê–¢–û–ú–ê–†–ù–û
    if cycle_start_state == 0:
        cycle['cycle_start_state'] = 1  # –ù–ï–ú–ï–î–õ–ï–ù–ù–û!
        self._save_cycles_state()       # –°–û–•–†–ê–ù–ï–ù–û!
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∫—É–ø–∫—É –≤ –û–¢–î–ï–õ–¨–ù–û–ú –ü–û–¢–û–ö–ï
        thread = threading.Thread(target=self._start_buy_worker, ...)
        thread.start()
        
        # Lock –û–°–í–û–ë–û–ñ–î–ê–ï–¢–°–Ø (–ø–æ–∫—É–ø–∫–∞ –∏–¥—ë—Ç –≤ —Ñ–æ–Ω–µ)
```

### 2Ô∏è‚É£ Lock –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- –§–ª–∞–≥ `cycle_start_state=1` –£–ñ–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω
- Lock –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ ~10ms (–Ω–µ 1-3 —Å–µ–∫—É–Ω–¥—ã!)
- –î—Ä—É–≥–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥—è—Ç `=1` ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç

### 3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∫–∞–∂–¥—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é
```python
elif cycle_start_state == 1:
    # –ü–æ–∫—É–ø–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    result = cycle['start_buy_result']
    
    if result is None:
        # –ï—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å - –ü–†–û–ü–£–°–ö–ê–ï–ú
        return
    
    if result['status'] == 'error':
        # –û—à–∏–±–∫–∞ - –°–ë–†–ê–°–´–í–ê–ï–ú —Ñ–ª–∞–≥ –≤ 0
        cycle['cycle_start_state'] = 0
    
    if result['status'] == 'success':
        # –£—Å–ø–µ—Ö - –ê–ö–¢–ò–í–ò–†–£–ï–ú —Ü–∏–∫–ª (=2)
        cycle['cycle_start_state'] = 2
        cycle['active'] = True
```

## üìä –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª (_run)
```python
with self._cycle_locks[base]:
    cycle_start_state = cycle.get('cycle_start_state', 0)
    
    if cycle_start_state == 0:
        # –ù–ï–¢ –¶–ò–ö–õ–ê ‚Üí –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∫—É–ø–∫—É –ê–°–ò–ù–•–†–û–ù–ù–û
        self._start_cycle_async(base, quote)
    
    elif cycle_start_state == 1:
        # –ü–û–ö–£–ü–ö–ê –í –ü–†–û–¶–ï–°–°–ï ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        self._check_start_buy_result(base, quote)
    
    elif cycle_start_state == 2:
        # –¶–ò–ö–õ –ê–ö–¢–ò–í–ï–ù ‚Üí —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ/–ø—Ä–æ–¥–∞–∂–∞
        self._try_sell(base, quote)
        self._try_rebuy(base, quote)
```

### _start_cycle_async (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥ Lock)
```python
def _start_cycle_async(self, base, quote):
    # –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –§–õ–ê–ì (–ø–æ–¥ Lock!)
    cycle['cycle_start_state'] = 1
    cycle['start_buy_result'] = None
    self._save_cycles_state()  # –°–û–•–†–ê–ù–ï–ù–û!
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º worker-–ø–æ—Ç–æ–∫
    thread = threading.Thread(target=self._start_buy_worker, ...)
    thread.start()
    
    # Lock –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è (–ø–æ–∫—É–ø–∫–∞ –∏–¥—ë—Ç –≤ —Ñ–æ–Ω–µ)
```

### _start_buy_worker (–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫)
```python
def _start_buy_worker(self, base, quote):
    # –í—ã–ø–æ–ª–Ω—è–µ–º MARKET –æ—Ä–¥–µ—Ä (1-3 —Å–µ–∫)
    result = self._execute_start_buy(base, quote)
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    cycle['start_buy_result'] = result
    # {'status': 'success', 'filled': ..., 'price': ..., 'invested': ...}
    # –ò–õ–ò
    # {'status': 'error', 'error': ...}
```

### _check_start_buy_result (–∫–∞–∂–¥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è)
```python
def _check_start_buy_result(self, base, quote):
    result = cycle['start_buy_result']
    
    if result is None:
        # –ü–æ–∫—É–ø–∫–∞ –µ—â—ë –∏–¥—ë—Ç - –ü–†–û–ü–£–°–ö–ê–ï–ú
        return
    
    if result['status'] == 'error':
        # –û–®–ò–ë–ö–ê ‚Üí —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤ 0 (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–≤—Ç–æ—Ä)
        cycle['cycle_start_state'] = 0
        self._save_cycles_state()
    
    if result['status'] == 'success':
        # –£–°–ü–ï–• ‚Üí –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ü–∏–∫–ª
        cycle.update({
            'active': True,
            'cycle_start_state': 2,
            'last_buy_price': result['price'],
            'start_price': result['price'],
            'total_invested_usd': result['invested'],
            'base_volume': result['filled']
        })
        self._save_cycles_state()
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ state_manager, –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
```

## ‚úÖ –ì–ê–†–ê–ù–¢–ò–ò

### 1. –¢–æ–ª—å–∫–æ –û–î–ù–ê —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞
```
–ò—Ç–µ—Ä–∞—Ü–∏—è 1                      –ò—Ç–µ—Ä–∞—Ü–∏—è 2
-----------                     -----------
Lock.acquire() ‚úÖ
‚îú‚îÄ cycle_start_state = 0 ‚úÖ
‚îú‚îÄ cycle_start_state = 1 ‚úÖ
‚îú‚îÄ _save_cycles_state() ‚úÖ
‚îú‚îÄ thread.start() ‚úÖ
Lock.release() ‚úÖ               Lock.acquire() ‚úÖ
‚îÇ                               ‚îú‚îÄ cycle_start_state = 1 ‚úÖ
Worker: MARKET –æ—Ä–¥–µ—Ä ‚è≥         ‚îî‚îÄ –ü–†–û–ü–£–°–ö–ê–ï–ú ‚úÖ
‚îÇ                               Lock.release() ‚úÖ
Worker: result = success ‚úÖ
‚îÇ
–ò—Ç–µ—Ä–∞—Ü–∏—è 1 (—Å–ª–µ–¥—É—é—â–∞—è)
Lock.acquire() ‚úÖ
‚îú‚îÄ result = success ‚úÖ
‚îú‚îÄ cycle_start_state = 2 ‚úÖ
Lock.release() ‚úÖ
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–≤—Ç–æ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –û—à–∏–±–∫–∞ –≤ worker ‚Üí `result = {'status': 'error'}`
- –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª: `cycle_start_state = 0` ‚Üí –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫

### 3. –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
- Lock —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ~10ms (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ + –∑–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞)
- MARKET –æ—Ä–¥–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ (1-3 —Å–µ–∫)
- –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (–¥—Ä—É–≥–∏–µ –≤–∞–ª—é—Ç—ã, —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ, –ø—Ä–æ–¥–∞–∂–∏)

### 4. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¢–û–õ–¨–ö–û –ø—Ä–∏ `result['status'] == 'success'`
- –û–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –æ–¥–Ω—É –ø–æ–∫—É–ø–∫—É

## üîÑ –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ

```
0. –ù–ï–¢ –¶–ò–ö–õ–ê (cycle_start_state=0, active=False)
   ‚Üì
   –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª: _start_cycle_async()
   ‚Üì
1. –ü–û–ö–£–ü–ö–ê –í –ü–†–û–¶–ï–°–°–ï (cycle_start_state=1, start_buy_result=None)
   ‚Üì
   Worker: –≤—ã–ø–æ–ª–Ω—è–µ—Ç MARKET –æ—Ä–¥–µ—Ä (1-3 —Å–µ–∫)
   ‚Üì
   Worker: –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç result = {'status': 'success', ...}
   ‚Üì
   –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª: _check_start_buy_result()
   ‚Üì
2. –¶–ò–ö–õ –ê–ö–¢–ò–í–ï–ù (cycle_start_state=2, active=True)
   ‚Üì
   –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª: _try_sell(), _try_rebuy()
   ‚Üì
   –ü—Ä–æ–¥–∞–∂–∞ ‚Üí cycle_start_state=0, active=False
   ‚Üì
   (–ø–æ–≤—Ç–æ—Ä —Å —à–∞–≥–∞ 0)
```

## üìÅ –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´

### autotrader.py
- **–î–æ–±–∞–≤–ª–µ–Ω–æ** –≤ `_ensure_cycle_struct`:
  - `'start_buy_result': None`
  - `'start_buy_thread': None`

- **–ò–∑–º–µ–Ω–µ–Ω–æ** –≤ –≥–ª–∞–≤–Ω–æ–º —Ü–∏–∫–ª–µ `_run`:
  - `cycle_start_state == 0` ‚Üí `self._start_cycle_async()`
  - `cycle_start_state == 1` ‚Üí `self._check_start_buy_result()`
  - `cycle_start_state == 2` ‚Üí `self._try_sell()`, `self._try_rebuy()`

- **–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã**:
  - `_start_cycle_async(base, quote)` - –∑–∞–ø—É—Å–∫ –ø–æ–∫—É–ø–∫–∏ –≤ –ø–æ—Ç–æ–∫–µ
  - `_start_buy_worker(base, quote)` - worker-–ø–æ—Ç–æ–∫
  - `_execute_start_buy(base, quote)` - –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
  - `_check_start_buy_result(base, quote)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

## üöÄ –†–ê–ó–í–Å–†–¢–´–í–ê–ù–ò–ï

1. ‚úÖ –ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω
2. ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω
3. ‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞: `restart_server.bat`
4. ‚è≥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤: —Ç–æ–ª—å–∫–æ –û–î–ù–ê –ø–æ–∫—É–ø–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂–∏
5. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∏–Ω–≥–æ–≤: Lock —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è <50ms

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –õ–û–ì–ò

### –£—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞:
```
[START_ASYNC][ETH] ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–æ–∫—É–ø–∫—É –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ
[START_ASYNC][ETH] üîí cycle_start_state=1 –£–°–¢–ê–ù–û–í–õ–ï–ù –ò –°–û–•–†–ê–ù–Å–ù
[START_ASYNC][ETH] üöÄ –ü–æ—Ç–æ–∫ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø–æ–∫—É–ø–∫–∏ –∑–∞–ø—É—â–µ–Ω (Lock –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω)
[WORKER][ETH] üîÑ –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø–æ–∫—É–ø–∫–∏...
[WORKER][ETH] ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—Å–∞–Ω: success
[CHECK][ETH] ‚úÖ –ü–æ–∫—É–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ü–∏–∫–ª
[CHECK][ETH] üéØ –¶–∏–∫–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: price=3028.4300, volume=9.9926
[ETH] Buy{9.9926; –ö—É—Ä—Å:3028.0700; ‚ÜìŒî%:0.00; ‚Üì%:0.00; –ò–Ω–≤–µ—Å—Ç:9.9926}
```

### –î—Ä—É–≥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è (–≤–∏–¥–∏—Ç —Ñ–ª–∞–≥):
```
[MAIN] –ò—Ç–µ—Ä–∞—Ü–∏—è: ETH
[MAIN] cycle_start_state=1 ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
[CHECK][ETH] –ü–æ–∫—É–ø–∫–∞ –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å (result=None)
[MAIN] –ò—Ç–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
```

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 2024-12-06  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ ASYNC START BUY –†–ï–ê–õ–ò–ó–û–í–ê–ù–û  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî• –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï RACE CONDITION
