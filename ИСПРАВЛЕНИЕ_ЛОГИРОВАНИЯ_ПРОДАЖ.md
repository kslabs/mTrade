# üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–¥–∞–∂–∏ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ª–æ–≥–∏

## üéØ –ü–†–û–ë–õ–ï–ú–ê

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–±–ª—é–¥–∞–ª –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø–æ–∫—É–ø–æ–∫ –±–µ–∑ –≤–∏–¥–∏–º—ã—Ö –ø—Ä–æ–¥–∞–∂ –≤ –ª–æ–≥–∞—Ö:

```
[19:40:41] [DOGE] Buy{9.9999; –ö—É—Ä—Å:0.1485; ‚ÜìŒî%:0.00; ‚Üì%:0.00; –ò–Ω–≤–µ—Å—Ç:9.9999}
[18:23:25] [DOGE] Buy{9.9995; –ö—É—Ä—Å:0.1467; ‚ÜìŒî%:0.00; ‚Üì%:0.00; –ò–Ω–≤–µ—Å—Ç:9.9995}
[15:12:14] [DOGE] Buy{9.9991; –ö—É—Ä—Å:0.1458; ‚ÜìŒî%:0.00; ‚Üì%:0.00; –ò–Ω–≤–µ—Å—Ç:9.9991}
[15:12:04] [DOGE] Sell{9.8670; –ö—É—Ä—Å:0.1455; ‚ÜëŒî%:0.00; PnL:0.0000; –ü—Ä–æ—Ñ–∏—Ç:0.0000}
```

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–∫—É–ø–∫–∏ (Buy)
- –ü—Ä–æ–¥–∞–∂–∏ (Sell) –ª–∏–±–æ –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –ª–∏–±–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –Ω—É–ª–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ (‚ÜëŒî%:0.00; PnL:0.0000)
- –ù–∞ –±–∞–ª–∞–Ω—Å–µ –æ–±—ä—ë–º –æ–¥–Ω–æ–π —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø–æ–∫—É–ø–∫–∏ ‚Üí –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–¥–∞–∂–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç, –Ω–æ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥–∏

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –ß—Ç–æ –±—ã–ª–æ –Ω–∞–π–¥–µ–Ω–æ –≤ –∫–æ–¥–µ:

–í `autotrader_v2.py`, —Å—Ç—Ä–æ–∫–∞ ~1131:

```python
self.logger.log_sell(
    currency=base,
    volume=executed_amount,
    price=executed_price,
    delta_percent=0.0,  # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –í—Å–µ–≥–¥–∞ 0
    total_drop_percent=0.0,  # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –ü–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    investment=executed_cost  # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û! –î–æ–ª–∂–µ–Ω –±—ã—Ç—å pnl
)
```

### –ü—Ä–æ–±–ª–µ–º—ã:

1. **`delta_percent=0.0`** - –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è 0, —Ö–æ—Ç—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Ä–æ—Å—Ç–∞
2. **`total_drop_percent=0.0`** - —ç—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –≤–æ–æ–±—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `log_sell`
3. **`investment=executed_cost`** - –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä `investment`, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ `log_sell` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `pnl`)

### –°–∏–≥–Ω–∞—Ç—É—Ä–∞ –º–µ—Ç–æ–¥–∞ `log_sell`:

```python
def log_sell(self, currency: str, volume: float, price: float, 
             delta_percent: float, pnl: float, source: str = "AUTO"):
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `delta_percent` - –ø—Ä–æ—Ü–µ–Ω—Ç —Ä–æ—Å—Ç–∞ –æ—Ç —Ü–µ–Ω—ã –ø–æ–∫—É–ø–∫–∏: `((sell_price - buy_price) / buy_price) * 100`
- `pnl` - –ø—Ä–æ—Ñ–∏—Ç: `revenue - total_invested`

## üîß –†–ï–®–ï–ù–ò–ï

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ `autotrader_v2.py` (—Å—Ç—Ä–æ–∫–∞ ~1118):

**–ë–´–õ–û:**
```python
# –®–ê–ì 5: –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–∏–∫–ª –≤ IDLE (–ø–æ–¥ lock, –±—ã—Å—Ç—Ä–æ!)
with lock:
    cycle = self.cycles[base]
    cycle.last_sell_at = time.time()
    cycle.reset()
    self._save_state(base)

# –®–ê–ì 6: –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–¥–∞–∂—É
self.logger.log_sell(
    currency=base,
    volume=executed_amount,
    price=executed_price,
    delta_percent=0.0,  # ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!
    total_drop_percent=0.0,  # ‚ùå –ù–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
    investment=executed_cost  # ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä!
)
```

**–°–¢–ê–õ–û:**
```python
# –®–ê–ì 5: –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –î–û —Å–±—Ä–æ—Å–∞ —Ü–∏–∫–ª–∞!
with lock:
    cycle = self.cycles[base]
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º invested –∏ start_price –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ PnL –∏ –¥–µ–ª—å—Ç—ã
    total_invested = cycle.total_invested_usd
    cycle_start_price = cycle.start_price
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–æ–¥–∞–∂–∏ –î–û —Å–±—Ä–æ—Å–∞!
    cycle.last_sell_at = time.time()
    cycle.reset()
    self._save_state(base)

# –®–ê–ì 6: –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –∏ –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–¥–∞–∂—É
try:
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–µ–ª—å—Ç—É (–ø—Ä–æ—Ü–µ–Ω—Ç —Ä–æ—Å—Ç–∞ –æ—Ç —Ü–µ–Ω—ã –ø–æ–∫—É–ø–∫–∏)
    if cycle_start_price > 0:
        delta_percent = ((executed_price - cycle_start_price) / cycle_start_price) * 100.0
    else:
        delta_percent = 0.0
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º PnL (–ø—Ä–æ—Ñ–∏—Ç)
    revenue = executed_cost  # –í—ã—Ä—É—á–∫–∞ –æ—Ç –ø—Ä–æ–¥–∞–∂–∏
    pnl = revenue - total_invested  # –ü—Ä–æ—Ñ–∏—Ç = –≤—ã—Ä—É—á–∫–∞ - –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
    
    print(f"[{base}] üí∞ –†–∞—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫:")
    print(f"[{base}]   –ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: {total_invested:.4f} {quote}")
    print(f"[{base}]   –í—ã—Ä—É—á–∫–∞: {revenue:.4f} {quote}")
    print(f"[{base}]   PnL: {pnl:.4f} {quote}")
    print(f"[{base}]   –î–µ–ª—å—Ç–∞: {delta_percent:.2f}%")
    
    # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–¥–∞–∂—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    self.logger.log_sell(
        currency=base,
        volume=executed_amount,
        price=executed_price,
        delta_percent=delta_percent,  # ‚úÖ –†–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Ä–æ—Å—Ç–∞
        pnl=pnl,  # ‚úÖ –†–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ç
        source="AUTO"
    )
    print(f"[{base}] ‚úÖ [OK] –ü—Ä–æ–¥–∞–∂–∞ –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ –ª–æ–≥ (PnL={pnl:.4f}, Œî={delta_percent:.2f}%)")
except Exception as log_error:
    print(f"[{base}] ‚ö†Ô∏è [WARN] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥: {log_error}")
    import traceback
    traceback.print_exc()
```

## üìä –ß–¢–û –ò–ó–ú–ï–ù–ò–õ–û–°–¨

### 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º —Ü–∏–∫–ª–∞

**–î–æ:** –¶–∏–∫–ª —Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è —Å—Ä–∞–∑—É, –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è–ª–∏—Å—å  
**–ü–æ—Å–ª–µ:** –°–æ—Ö—Ä–∞–Ω—è–µ–º `total_invested` –∏ `cycle_start_price` **–î–û** –≤—ã–∑–æ–≤–∞ `cycle.reset()`

### 2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫

**–î–µ–ª—å—Ç–∞ (–ø—Ä–æ—Ü–µ–Ω—Ç —Ä–æ—Å—Ç–∞):**
```python
delta_percent = ((executed_price - cycle_start_price) / cycle_start_price) * 100.0
```

**PnL (–ø—Ä–æ—Ñ–∏—Ç):**
```python
revenue = executed_cost  # –°–∫–æ–ª—å–∫–æ –ø–æ–ª—É—á–∏–ª–∏ –∑–∞ –ø—Ä–æ–¥–∞–∂—É
pnl = revenue - total_invested  # –ü—Ä–æ—Ñ–∏—Ç = –≤—ã—Ä—É—á–∫–∞ - –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
```

### 3. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã log_sell

- ‚úÖ `delta_percent` - —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Ä–æ—Å—Ç–∞ (–Ω–µ 0)
- ‚úÖ `pnl` - —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ç (–Ω–µ 0)
- ‚úÖ `source="AUTO"` - –º–∞—Ä–∫–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–¥–∞–∂–∏

### 4. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

```
[DOGE] üí∞ –†–∞—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫:
[DOGE]   –ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: 9.9999 USDT
[DOGE]   –í—ã—Ä—É—á–∫–∞: 10.0450 USDT
[DOGE]   PnL: 0.0451 USDT
[DOGE]   –î–µ–ª—å—Ç–∞: 0.45%
[DOGE] ‚úÖ [OK] –ü—Ä–æ–¥–∞–∂–∞ –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ –ª–æ–≥ (PnL=0.0451, Œî=0.45%)
```

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ:

```
[19:40:41] [DOGE] üü¢[AUTO] Sell{10.0354; –ö—É—Ä—Å:0.1485; ‚ÜëŒî%:0.45; PnL:0.0355; –ü—Ä–æ—Ñ–∏—Ç:0.0355}
[18:23:25] [DOGE] Buy{9.9999; –ö—É—Ä—Å:0.1485; ‚ÜìŒî%:0.00; ‚Üì%:0.00; –ò–Ω–≤–µ—Å—Ç:9.9999}

[18:25:30] [DOGE] üü¢[AUTO] Sell{10.0444; –ö—É—Ä—Å:0.1467; ‚ÜëŒî%:0.45; PnL:0.0449; –ü—Ä–æ—Ñ–∏—Ç:0.0804}
[18:23:25] [DOGE] Buy{9.9995; –ö—É—Ä—Å:0.1467; ‚ÜìŒî%:0.00; ‚Üì%:0.00; –ò–Ω–≤–µ—Å—Ç:9.9995}

[15:14:20] [DOGE] üü¢[AUTO] Sell{10.0441; –ö—É—Ä—Å:0.1458; ‚ÜëŒî%:0.45; PnL:0.0450; –ü—Ä–æ—Ñ–∏—Ç:0.1254}
[15:12:14] [DOGE] Buy{9.9991; –ö—É—Ä—Å:0.1458; ‚ÜìŒî%:0.00; ‚Üì%:0.00; –ò–Ω–≤–µ—Å—Ç:9.9991}
```

**–¢–µ–ø–µ—Ä—å –≤–∏–¥–Ω—ã:**
- ‚úÖ –í—Å–µ –ø—Ä–æ–¥–∞–∂–∏ —Å –º–∞—Ä–∫–µ—Ä–æ–º üü¢[AUTO]
- ‚úÖ –†–µ–∞–ª—å–Ω–∞—è –¥–µ–ª—å—Ç–∞ (‚ÜëŒî%:0.45)
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ç (PnL:0.0450)
- ‚úÖ –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ç (–ü—Ä–æ—Ñ–∏—Ç:0.1254)

## üìù –°–¢–ê–¢–£–°

‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**
- –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω –≤ `autotrader_v2.py`
- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

## üîó –§–ê–ô–õ–´

- `autotrader_v2.py` (—Å—Ç—Ä–æ–∫–∏ 1118-1155)
- `trade_logger.py` (–º–µ—Ç–æ–¥ `log_sell`, —Å—Ç—Ä–æ–∫–∏ 363-475)

---
**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 10 –¥–µ–∫–∞–±—Ä—è 2024, 19:50  
**–í–µ—Ä—Å–∏—è –∫–æ–¥–∞:** 2024-12-10_19:50
