# Динамический процент закупки - Завершено ✅

## Дата выполнения
16 ноября 2025

## Выполненные задачи

### 1. Переименование параметра
- **Было**: "БезУб, % (цель R)" 
- **Стало**: "R" - шаг изменения процента закупки

### 2. Добавлен новый параметр
- **Rk** - коэффициент изменения шага процента закупки
- Точность: 3 знака после запятой (step="0.001")
- Минимум: 0

### 3. Формула расчёта процента в колонке "↓, %"
```
decrease_pct = -((# × Rk) + R)
```
Где:
- `#` - номер строки (шаг цикла)
- `Rk` - коэффициент изменения (параметр)
- `R` - базовый шаг процента (параметр)

### 4. Точность отображения
- **Процент в колонке "↓, %"**: 3 знака после запятой (было 2)
- **Параметры R и Rk**: 3 знака после запятой

## Изменённые файлы

### 1. `templates/index.html`
- Переименован параметр "БезУб, % (цель R)" → "R"
- Добавлен параметр "Rk" с tooltip-подсказкой
- Обновлены title-атрибуты для пояснения формулы

### 2. `static/app.js`
- ✅ Добавлена загрузка параметра `rk` при получении параметров (строка 695)
- ✅ Добавлена загрузка параметра `rk` при восстановлении параметров (строка 1022)
- ✅ Изменена точность отображения процента: `toFixed(2)` → `toFixed(3)` (строка 560)
- Параметр `rk` передаётся в API-запросы (строки 611, 626, 723)

### 3. `breakeven_calculator.py`
- Реализована формула: `decrease_pct = -((step * rk) + target_r)`
- Добавлен параметр `rk` в функции
- Обновлены комментарии с описанием формулы

### 4. `mTrade.py`
- Добавлена поддержка параметра `rk` в API

## Примеры использования

### Линейное снижение (Rk = 0)
- R = 3.650, Rk = 0.000
- Шаг 1: -3.650%
- Шаг 2: -3.650%
- Шаг 3: -3.650%

### Прогрессивное снижение (Rk > 0)
- R = 3.650, Rk = 0.100
- Шаг 1: -(1×0.100 + 3.650) = -3.750%
- Шаг 2: -(2×0.100 + 3.650) = -3.850%
- Шаг 3: -(3×0.100 + 3.650) = -3.950%

### Регрессивное снижение (Rk < 0, если R достаточно большой)
- R = 5.000, Rk = -0.200
- Шаг 1: -(1×(-0.200) + 5.000) = -4.800%
- Шаг 2: -(2×(-0.200) + 5.000) = -4.600%
- Шаг 3: -(3×(-0.200) + 5.000) = -4.400%

## Проверка
- ✅ Все файлы без ошибок
- ✅ Параметр `rk` загружается корректно
- ✅ Параметр `rk` сохраняется в API
- ✅ Формула применяется в расчётах
- ✅ Точность отображения: 3 знака после запятой
- ✅ Все комментарии на русском языке

## Статус
**ЗАВЕРШЕНО** ✅

Все изменения реализованы, протестированы и готовы к коммиту.
