# Сохранение состояния UI - Руководство

## Дата: 12 ноября 2025 г.

## Что было сделано

### Проблема
Все кнопки и параметры не сохранялись на сервере и не восстанавливались после перезагрузки сервера или страницы.

### Решение
Реализован полный механизм сохранения и восстановления состояния UI.

## Реализованные изменения

### 1. Серверная часть (`server_control_routes.py`)

#### Добавлен новый API endpoint:
```
POST /api/ui/state/partial
```

**Принимает:**
- `active_base_currency` - активная базовая валюта
- `active_quote_currency` - активная котировочная валюта
- `auto_trade_enabled` - включен ли автотрейдинг
- `network_mode` - режим сети (work/test)
- `trading_mode` - режим торговли (trade/copy)
- `breakeven_params` - параметры безубыточности

**Возвращает:**
```json
{
  "success": true,
  "message": "Состояние частично сохранено",
  "updated": ["active_base_currency=BTC", "auto_trade_enabled=true"]
}
```

### 2. State Manager (`state_manager.py`)

#### Добавлены методы:
- `get_active_base_currency()` - получить активную базовую валюту
- `set_active_base_currency(currency)` - установить активную базовую валюту
- `get_active_quote_currency()` - получить активную котировочную валюту
- `set_active_quote_currency(currency)` - установить активную котировочную валюту

### 3. Клиентская часть (`static/app.js`)

#### Расширен UIStateManager:
```javascript
UIStateManager.savePartial({
  baseCurrency: 'BTC',
  quoteCurrency: 'USDT',
  autoTradeEnabled: true,
  networkMode: 'test',
  tradingMode: 'trade',
  breakeven_params: { currency: 'BTC', steps: 16, ... }
})
```

#### Добавлено автосохранение для:
1. **Переключение базовой валюты** (`switchBaseCurrency`)
2. **Переключение котировочной валюты** (`switchQuoteCurrency`)
3. **Включение/выключение AutoTrade** (`toggleAutoTrade`)
4. **Переключение режима торговли** (`switchTradingMode`)
5. **Сохранение параметров безубыточности** (`saveTradeParams`)

#### Добавлено восстановление при загрузке (`loadUIState`):
- Автотрейдинг (вкл/выкл)
- Разрешения торговли для валют
- Активная базовая валюта
- Активная котировочная валюта
- Режим торговли (TRADE/COPY)
- Параметры безубыточности для каждой валюты

## Что теперь сохраняется

### ✅ Переключатели в header:
- **AutoTrade** (ON/OFF)
- **Network Mode** (WORK/TEST)
- **Trading Mode** (TRADE/COPY)

### ✅ Валютные пары:
- Активная базовая валюта (BTC, ETH, SOL, ...)
- Активная котировочная валюта (USDT, USDC, BTC, ETH)

### ✅ Параметры безубыточности (для каждой валюты отдельно):
- Число шагов
- Стартовый объём
- Начальная цена (P0)
- Pprof, %
- Kprof
- ↑ БезУб, % (цель R)
- Множитель геометрии
- Режим сумм докупок

### ✅ Разрешения торговли:
- Для каждой валюты отдельно (индикаторы на вкладках)

## Как это работает

### Последовательность при изменении:

1. **Пользователь изменяет параметр** (например, переключает AutoTrade)
2. **Отправляется запрос на сервер** (например, `/api/autotrade/start`)
3. **При успехе вызывается** `UIStateManager.savePartial()` с новым значением
4. **Сервер сохраняет** изменение в `app_state.json`

### Последовательность при загрузке:

1. **При загрузке страницы** вызывается `loadUIState()`
2. **Запрашивается** `GET /api/ui/state`
3. **Сервер возвращает** полное состояние из `app_state.json`
4. **Клиент восстанавливает** все параметры и положения переключателей

### Последовательность при переключении валюты:

1. **Пользователь выбирает** другую базовую валюту (например, ETH)
2. **Вызывается** `switchBaseCurrency('ETH')`
3. **Загружаются параметры** для ETH из state
4. **Восстанавливаются** сохраненные ранее параметры безубыточности для ETH

## Файлы с состоянием

### app_state.json
Главный файл состояния приложения:
```json
{
  "trading_mode": "trade",
  "auto_trade_enabled": true,
  "trading_permissions": {
    "BTC": true,
    "ETH": false,
    "SOL": true
  },
  "network_mode": "test",
  "active_base_currency": "BTC",
  "active_quote_currency": "USDT",
  "breakeven_params": {
    "BTC": {
      "steps": 16,
      "start_volume": 3.0,
      "start_price": 0.0,
      "pprof": 0.6,
      "kprof": 0.02,
      "target_r": 3.65,
      "geom_multiplier": 2.0,
      "rebuy_mode": "geometric"
    },
    "ETH": {
      "steps": 20,
      "start_volume": 5.0,
      ...
    }
  }
}
```

### ui_state.json (legacy, не используется)
Старый файл, можно удалить. Теперь всё в `app_state.json`.

## Тестирование

### Тест 1: Переключатель AutoTrade
1. Откройте приложение
2. Переключите AutoTrade в ON
3. Перезагрузите страницу (F5)
4. ✅ AutoTrade должен остаться в ON

### Тест 2: Режим сети
1. Переключите на TEST
2. Перезагрузите страницу
3. ✅ Должен остаться TEST

### Тест 3: Режим торговли
1. Переключите на COPY
2. Перезагрузите страницу
3. ✅ Должен остаться COPY

### Тест 4: Валютная пара
1. Выберите ETH
2. Выберите USDC в котировочной валюте
3. Перезагрузите страницу
4. ✅ Должна быть пара ETH/USDC

### Тест 5: Параметры безубыточности
1. Выберите BTC
2. Измените "Число шагов" на 20
3. Измените "Стартовый объём" на 5
4. Нажмите "Сохранить"
5. Перезагрузите страницу
6. ✅ Параметры должны остаться: шагов=20, объём=5
7. Переключитесь на ETH
8. ✅ У ETH должны быть свои параметры
9. Вернитесь на BTC
10. ✅ У BTC должны быть шагов=20, объём=5

### Тест 6: Перезапуск сервера
1. Установите любые параметры
2. Остановите сервер: `python stop.py`
3. Запустите сервер: `python start.py`
4. Откройте приложение
5. ✅ Все параметры должны восстановиться

### Тест 7: Разрешения торговли
1. Кликните на индикатор разрешения у валюты (точка на вкладке)
2. Отключите торговлю для BTC
3. Перезагрузите страницу
4. ✅ Торговля для BTC должна быть отключена

## Отладка

### Проверка сохранения (консоль браузера):
После каждого изменения параметра должно появляться:
```
[DBG] UI State: частичное сохранение успешно - {"active_base_currency":"BTC"}
```

### Проверка загрузки (консоль браузера):
При загрузке страницы:
```
[DBG] UI State: базовая валюта восстановлена - BTC
[DBG] UI State: котировочная валюта восстановлена - USDT
[DBG] UI State: автотрейдинг восстановлен - true
[DBG] UI State: режим торговли восстановлен - normal
[DBG] UI State: параметры безубыточности восстановлены для BTC
[DBG] UI State: состояние успешно загружено
```

### Проверка файла состояния:
```powershell
# Посмотреть текущее состояние
Get-Content app_state.json | ConvertFrom-Json | ConvertTo-Json -Depth 10
```

### Проверка API:
```powershell
# Получить состояние
curl http://localhost:5000/api/ui/state

# Сохранить частично
curl -X POST http://localhost:5000/api/ui/state/partial `
  -H "Content-Type: application/json" `
  -d '{"active_base_currency":"ETH"}'
```

## Известные особенности

### 1. Параметры для каждой валюты
Параметры безубыточности сохраняются **отдельно для каждой валюты**.
При переключении валюты автоматически загружаются её параметры.

### 2. Режимы торговли
- В UI используется: `normal` / `copy`
- В API используется: `trade` / `copy`
- Преобразование происходит автоматически

### 3. Автоматическое сохранение
Все изменения сохраняются **автоматически**, кнопка "Сохранить" нужна только для параметров безубыточности.

### 4. Приоритет загрузки
При конфликте данных приоритет имеет `app_state.json` на сервере.

## Устранение проблем

### Проблема: Параметры не восстанавливаются

**Решение 1:** Проверьте консоль браузера на ошибки
```javascript
// Откройте DevTools (F12)
// Посмотрите вкладку Console
```

**Решение 2:** Проверьте файл состояния
```powershell
# Файл должен существовать и быть валидным JSON
Test-Path app_state.json
Get-Content app_state.json
```

**Решение 3:** Очистите кеш браузера
```
Ctrl+Shift+R (hard refresh)
```

**Решение 4:** Пересоздайте файл состояния
```powershell
# Удалите старый файл
Remove-Item app_state.json
# Перезапустите сервер
python stop.py
python start.py
# Файл будет создан с параметрами по умолчанию
```

### Проблема: После перезагрузки все сбрасывается

**Причина:** Файл `app_state.json` не существует или повреждён

**Решение:**
1. Проверьте существование файла
2. Проверьте права на запись
3. Посмотрите логи сервера на ошибки сохранения

### Проблема: Параметры одной валюты перезаписывают другую

**Это не должно происходить!** Каждая валюта имеет свои параметры.

**Если происходит:**
1. Проверьте консоль на ошибки
2. Проверьте структуру `breakeven_params` в `app_state.json`
3. Пересоздайте файл состояния

## Заключение

Теперь **все настройки сохраняются** и восстанавливаются после:
- ✅ Перезагрузки страницы
- ✅ Перезапуска сервера
- ✅ Переключения между валютами
- ✅ Закрытия и открытия браузера

Каждая валюта хранит свои собственные параметры безубыточности!
