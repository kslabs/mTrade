# 📊 Оптимизация mTrade: Визуализация

## Архитектура кэширования балансов

```
┌─────────────────────────────────────────────────────────────────┐
│                     АВТОТРЕЙДЕР (autotrader.py)                  │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  │ _get_account_balance()
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                   КЭШИРОВАНИЕ (balance_cache.py)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Проверка кэша (threading.Lock)                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                   │                          │                   │
│                   │ Кэш пуст?                │ Кэш есть?         │
│                   │ Устарел (TTL)?           │ Свежий?           │
│                   │                          │                   │
│        ┌──────────▼──────────┐    ┌─────────▼──────────┐        │
│        │   MISS: Обновить    │    │   HIT: Вернуть     │        │
│        └─────────────────────┘    └────────────────────┘        │
│                   │                          │                   │
│                   │                          │                   │
└───────────────────┼──────────────────────────┼───────────────────┘
                    │                          │
                    │                          │ Возврат из кэша
                    │                          └──────────────────►
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                        GATE.IO API                               │
├─────────────────────────────────────────────────────────────────┤
│  list_spot_accounts() → Получить ВСЕ балансы одним запросом     │
│  (1 запрос вместо 10-40 отдельных)                              │
└─────────────────────────────────────────────────────────────────┘
                    │
                    │ Пакетное обновление
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    КЭШИРОВАНИЕ (память)                          │
├─────────────────────────────────────────────────────────────────┤
│  {                                                                │
│    'XRP': {'available': 1000, 'total': 1000, 'time': 12:34:56}, │
│    'BTC': {'available': 0.05, 'total': 0.05, 'time': 12:34:56}, │
│    'USDT': {'available': 500, 'total': 500, 'time': 12:34:56},  │
│    ...                                                            │
│  }                                                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## Жизненный цикл кэша

```
ЗАПУСК АВТОТРЕЙДЕРА
        │
        ▼
┌───────────────────┐
│ Инициализация     │
│ balance_cache     │
└───────────────────┘
        │
        ▼
┌───────────────────┐
│ Первый запрос     │
│ get_balance('XRP')│
└───────────────────┘
        │
        ▼
┌───────────────────┐      ┌──────────────────┐
│ Кэш пуст          │ ───► │ API: Получить    │
│ (MISS)            │      │ все балансы      │
└───────────────────┘      └──────────────────┘
        │                           │
        │                           │
        │      ┌────────────────────┘
        │      │
        ▼      ▼
┌───────────────────┐
│ Сохранить в кэш   │
│ TTL: 5 секунд     │
└───────────────────┘
        │
        ▼
    ┌───────┐
    │ ЦИКЛ  │
    └───────┘
        │
        ├──► get_balance('XRP')  ──► HIT (из кэша, <0.001с)
        ├──► get_balance('BTC')  ──► HIT (из кэша, <0.001с)
        ├──► get_balance('USDT') ──► HIT (из кэша, <0.001с)
        │
        ▼
┌───────────────────┐
│ Торговая операция │
│ (buy/sell)        │
└───────────────────┘
        │
        ▼
┌───────────────────┐
│ ИНВАЛИДАЦИЯ кэша  │
│ invalidate()      │
└───────────────────┘
        │
        ▼
    ┌───────┐
    │ ЦИКЛ  │
    └───────┘
        │
        ├──► get_balance('XRP')  ──► MISS (инвалидирован)
        │                              │
        │                              ▼
        │                        ┌──────────────────┐
        │                        │ API: Обновить    │
        │                        │ все балансы      │
        │                        └──────────────────┘
        │                              │
        ├──► get_balance('BTC')  ─────┤
        ├──► get_balance('USDT') ─────┤
        │                              │
        │                              ▼
        │                        ┌──────────────────┐
        │                        │ Кэш обновлён     │
        │                        └──────────────────┘
        │
        ▼
    (продолжается...)
```

---

## Сравнение производительности

### БЕЗ КЭША:
```
Цикл обработки 10 валют:

XRP:  баланс (1с) → баланс (1с) → баланс (1с) → торговля (1с) = 4с
BTC:  баланс (1с) → баланс (1с) → баланс (1с) → торговля (1с) = 4с
ETH:  баланс (1с) → баланс (1с) → баланс (1с) → торговля (1с) = 4с
...
────────────────────────────────────────────────────────────────
ИТОГО: 10 валют × 4с = 40-60 секунд

Запросов к API: ~40-50 за цикл
```

### С КЭШЕМ:
```
Цикл обработки 10 валют:

[Первая валюта]
XRP:  кэш MISS → API (1с) → все балансы обновлены → торговля (1с) = 2с

[Остальные валюты]
BTC:  кэш HIT (<0.001с) → торговля (если нужно, 1с) = 1-2с
ETH:  кэш HIT (<0.001с) → торговля (если нужно, 1с) = 1-2с
...
────────────────────────────────────────────────────────────────
ИТОГО: 1 × 2с + 9 × 1с = 5-10 секунд

Запросов к API: 1-3 за цикл

УСКОРЕНИЕ: 6-8x быстрее! 🚀
```

---

## Метрики Hit Rate

```
Hit Rate = (Hits / (Hits + Misses)) × 100%

┌────────────────────────────────────────────────────────────┐
│  Hit Rate: 95%                                       ✅    │
├────────────────────────────────────────────────────────────┤
│  ████████████████████████████████████████████████░░░░░░    │
│  │                                                    │     │
│  150 hits                                        7 misses  │
│                                                             │
│  Запросов: 157                                             │
│  Инвалидаций: 5                                            │
│  Валют в кэше: 10                                          │
└────────────────────────────────────────────────────────────┘

Интерпретация:
✅ 90-100%: Отлично! Кэш работает эффективно
⚠️  75-90%:  Хорошо, но можно увеличить TTL
⚠️  50-75%:  Средне, проверьте настройки
❌ <50%:     Плохо, требуется диагностика
```

---

## Инвалидация кэша

```
Триггеры инвалидации:

┌─────────────────────────────────────────────────────────────┐
│  ТОРГОВЫЕ ОПЕРАЦИИ                                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ✓ start_autotrade_for_currency()  → Начальная покупка     │
│  ✓ _execute_rebuy_order()          → Докупка               │
│  ✓ _handle_pending_rebuy()         → Отложенная докупка    │
│  ✓ _execute_sell_order()           → Продажа               │
│  ✓ _handle_pending_sell()          → Отложенная продажа    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  ИНВАЛИДАЦИЯ                                                │
├─────────────────────────────────────────────────────────────┤
│  self.balance_cache.invalidate(reason="buy_XRP_USDT")      │
│                                                              │
│  Действие:                                                  │
│  • Очистить кэш всех валют                                  │
│  • Следующий запрос → API                                   │
│  • Актуальность гарантирована ✅                            │
└─────────────────────────────────────────────────────────────┘
```

---

## Схема потоков

```
┌──────────────────────────────────────────────────────────────┐
│                   DUAL THREAD AUTOTRADER                     │
└──────────────────────────────────────────────────────────────┘
                 │                            │
                 │                            │
        ┌────────▼────────┐          ┌───────▼────────┐
        │  CYCLER THREAD  │          │ REACTOR THREAD │
        │  (цикл валют)   │          │ (WebSocket)    │
        └─────────────────┘          └────────────────┘
                 │                            │
                 │                            │
                 ├──► Валюта 1 ───┐          │
                 ├──► Валюта 2 ───┤          │
                 ├──► Валюта 3 ───┤          │
                 └──► ...         │          │
                                   │          │
                                   ▼          ▼
                      ┌──────────────────────────┐
                      │     AUTOTRADER           │
                      │  (торговая логика)       │
                      └──────────────────────────┘
                                   │
                                   │
                                   ▼
                      ┌──────────────────────────┐
                      │    BALANCE CACHE         │
                      │  (потокобезопасный)      │
                      └──────────────────────────┘
                                   │
                                   │
                                   ▼
                      ┌──────────────────────────┐
                      │      GATE.IO API         │
                      └──────────────────────────┘

Все потоки используют ОДИН кэш балансов!
Потокобезопасность: threading.Lock ✅
```

---

## Временная диаграмма

```
Время (секунды)
│
│  БЕЗ КЭША:
│  ═══════════════════════════════════════════════════════════
│  ├──API──┤├──API──┤├──API──┤├──API──┤ ... (40-50 запросов)
│  0       10       20       30       40       50       60
│                                                    ↑
│                                                Цикл: 60с
│
│  С КЭШЕМ:
│  ═══════════════════════════════════════════════════════════
│  ├API┤ cache  cache  cache  cache  cache  cache  cache ...
│  0   1  2  3  4  5  6  7  8  9  10
│           ↑
│       Цикл: 10с
│
│  УСКОРЕНИЕ: 6x! 🚀
│
└─────────────────────────────────────────────────────────────►
```

---

## Распределение запросов

### БЕЗ КЭША:
```
API запросы за минуту (10 валют, 1 цикл/мин):

Баланс XRP:  ████████  (8 запросов)
Баланс BTC:  ████████  (8 запросов)
Баланс ETH:  ████████  (8 запросов)
...
────────────────────────────────────
ИТОГО:       ████████████████████████████████████  (40 запросов/мин)

Rate limit: 300 req/min
Использовано: 13% (40/300)
```

### С КЭШЕМ:
```
API запросы за минуту (10 валют, 1 цикл/мин):

Баланс (все): █  (1 запрос на все валюты)
Инвалидация:  █  (1-2 дополнительных обновления)
────────────────────────────────────
ИТОГО:        ██  (2-3 запроса/мин)

Rate limit: 300 req/min
Использовано: 1% (2/300)

СНИЖЕНИЕ НАГРУЗКИ: 95%! 🎯
```

---

## Мониторинг в реальном времени

```bash
$ python monitor_cache_performance.py

════════════════════════════════════════════════════════════
📊 Статистика кэша балансов - 12:34:56
════════════════════════════════════════════════════════════
Попадания (hits):      150  (+10)
Промахи (misses):       12  (+1)
Hit Rate:              92.6% ✅
Инвалидации:            8   (+1)
Валют в кэше:           10

Всего запросов:        162
Статус:                ✅ ОТЛИЧНО
════════════════════════════════════════════════════════════

[Обновление каждые 10 секунд]
[Ctrl+C для выхода]
```

---

## Сводная таблица оптимизации

| Параметр | Без кэша | С кэшем | Улучшение |
|----------|----------|---------|-----------|
| **Запросов/цикл** | 40-50 | 2-5 | ↓ 90% |
| **Время цикла (10 валют)** | 40-60с | 5-10с | ↑ 6x |
| **Hit Rate** | - | 85-95% | - |
| **Нагрузка API** | 13% | 1% | ↓ 12x |
| **Задержка на валюту** | 4-6с | 0.5-1с | ↑ 6x |
| **Актуальность** | Высокая | Высокая | = |
| **Стабильность** | Средняя | Высокая | ↑ |

---

## Легенда

```
Символы:
  ✅  Выполнено / Работает отлично
  ⚠️   Требует внимания / Работает хорошо
  ❌  Проблема / Не работает
  🚀  Ускорение / Оптимизация
  🎯  Снижение нагрузки
  📊  Статистика / Метрики
  
Термины:
  HIT   - Попадание в кэш (данные найдены)
  MISS  - Промах кэша (данные отсутствуют/устарели)
  TTL   - Time To Live (время жизни кэша)
  API   - Запрос к Gate.io API
```

---

**Версия:** 1.0  
**Дата:** 2024-01-XX
