# 🎨 ВИЗУАЛИЗАЦИЯ: Как работает исправление

## 🔴 ПРОБЛЕМА: Race Condition при создании Lock'ов

```
БЫЛО (БАГ):
═══════════════════════════════════════════════════════════════

   Thread 1                Thread 2                Thread 3
      │                       │                       │
      ├─ Проверка:            ├─ Проверка:            ├─ Проверка:
      │  SOL в locks_dict?    │  SOL в locks_dict?    │  SOL в locks_dict?
      │  → НЕТ ✗              │  → НЕТ ✗              │  → НЕТ ✗
      │                       │                       │
      ├─ Создать Lock #1      ├─ Создать Lock #2      ├─ Создать Lock #3
      │  locks[SOL] = Lock1   │  locks[SOL] = Lock2   │  locks[SOL] = Lock3
      │                       │                       │
      ├─ Захватить Lock1      ├─ Захватить Lock2      ├─ Захватить Lock3
      │  → УСПЕХ ✅           │  → УСПЕХ ✅           │  → УСПЕХ ✅
      │                       │                       │
      ├─ Купить SOL           ├─ Купить SOL           ├─ Купить SOL
      │  💰 Покупка #1        │  💰 Покупка #2        │  💰 Покупка #3
      │                       │                       │
      ▼                       ▼                       ▼

РЕЗУЛЬТАТ: 3 покупки вместо 1! ❌
```

## ✅ РЕШЕНИЕ: Мастер-Lock для атомарного создания

```
СТАЛО (ИСПРАВЛЕНО):
═══════════════════════════════════════════════════════════════

   Thread 1                Thread 2                Thread 3
      │                       │                       │
      ├─ with master_lock:    │                       │
      │  ├─ Проверка:         │ ⏸️ ЖДЁТ              │ ⏸️ ЖДЁТ
      │  │  SOL в locks_dict? │                       │
      │  │  → НЕТ ✗           │                       │
      │  │                    │                       │
      │  ├─ Создать Lock #1   │                       │
      │  │  locks[SOL]=Lock1  │                       │
      │  │                    │                       │
      │  └─ master_lock снят  │                       │
      │                       │                       │
      │                       ├─ with master_lock:    │
      │                       │  ├─ Проверка:         │ ⏸️ ЖДЁТ
      │                       │  │  SOL в locks_dict? │
      │                       │  │  → ЕСТЬ ✓          │
      │                       │  │                    │
      │                       │  └─ Использовать      │
      │                       │     Lock1             │
      │                       │                       │
      │                       │                       ├─ with master_lock:
      │                       │                       │  ├─ Проверка:
      │                       │                       │  │  SOL в locks_dict?
      │                       │                       │  │  → ЕСТЬ ✓
      │                       │                       │  │
      │                       │                       │  └─ Использовать
      │                       │                       │     Lock1
      │                       │                       │
      ├─ Захватить Lock1      │                       │
      │  → УСПЕХ ✅           │ ⏸️ ЖДЁТ              │ ⏸️ ЖДЁТ
      │                       │                       │
      │                       ├─ Захватить Lock1      │
      │                       │  → ЗАНЯТ ❌           │ ⏸️ ЖДЁТ
      │                       │  ВЫХОД               │
      │                       │                       ├─ Захватить Lock1
      │                       │                       │  → ЗАНЯТ ❌
      │                       │                       │  ВЫХОД
      │                       │                       │
      ├─ Купить SOL           │                       │
      │  💰 Покупка #1        │                       │
      │                       │                       │
      ├─ Освободить Lock1     │                       │
      │                       │                       │
      ▼                       ▼                       ▼

РЕЗУЛЬТАТ: 1 покупка! ✅
```

## 📊 СРАВНЕНИЕ

```
┌────────────────────────────────────────────────────────────────┐
│                    БЕЗ МАСТЕР-LOCK'А                           │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Thread 1:  [Lock #1] ──→ ✅ Захвачен ──→ 💰 Покупка #1       │
│  Thread 2:  [Lock #2] ──→ ✅ Захвачен ──→ 💰 Покупка #2  ❌   │
│  Thread 3:  [Lock #3] ──→ ✅ Захвачен ──→ 💰 Покупка #3  ❌   │
│                                                                │
│  Создано Lock'ов: 3                                            │
│  Покупок: 3 ❌                                                  │
│                                                                │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│                    С МАСТЕР-LOCK'ОМ                            │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Thread 1:  [Lock #1] ──→ ✅ Захвачен ──→ 💰 Покупка #1       │
│  Thread 2:  [Lock #1] ──→ ❌ Занят    ──→ ⛔ Блокировка       │
│  Thread 3:  [Lock #1] ──→ ❌ Занят    ──→ ⛔ Блокировка       │
│                                                                │
│  Создано Lock'ов: 1 ✅                                          │
│  Покупок: 1 ✅                                                  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 🔒 УРОВНИ ЗАЩИТЫ (После исправления)

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПОПЫТКА СТАРТОВОЙ ПОКУПКИ                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌───────────────────────────────────────┐
        │   Уровень 1: Быстрые проверки        │
        │   ✓ active?                           │
        │   ✓ pending_start?                    │
        │   ✓ Баланс BASE > min?                │
        └───────────────────────────────────────┘
                              │ ПРОШЁЛ
                              ▼
        ┌───────────────────────────────────────┐
        │   Уровень 2: Мастер-Lock              │
        │   ✓ Атомарное создание Lock валюты    │
        │   ✓ Гарантия: только ОДИН Lock        │
        └───────────────────────────────────────┘
                              │ СОЗДАН/ПОЛУЧЕН
                              ▼
        ┌───────────────────────────────────────┐
        │   Уровень 3: Lock валюты              │
        │   ✓ acquire(blocking=False)           │
        │   ✓ Только ОДИН поток захватит        │
        └───────────────────────────────────────┘
                              │ ЗАХВАЧЕН
                              ▼
        ┌───────────────────────────────────────┐
        │   Уровень 4: Double-check             │
        │   ✓ active? (повторная)               │
        │   ✓ pending_start? (повторная)        │
        │   ✓ Баланс BASE (повторная)           │
        └───────────────────────────────────────┘
                              │ ПРОШЁЛ
                              ▼
        ┌───────────────────────────────────────┐
        │   Уровень 5: Установка флага          │
        │   pending_start = True                │
        │   Сохранение в файл                   │
        └───────────────────────────────────────┘
                              │ УСТАНОВЛЕН
                              ▼
        ┌───────────────────────────────────────┐
        │   Уровень 6: Проверка времени         │
        │   ✓ Прошло 5с после продажи?          │
        └───────────────────────────────────────┘
                              │ ПРОШЛО
                              ▼
        ┌───────────────────────────────────────┐
        │   Уровень 7: Финальная проверка       │
        │   ✓ Баланс BASE через API < 90%?      │
        └───────────────────────────────────────┘
                              │ ПРОШЁЛ
                              ▼
        ┌───────────────────────────────────────┐
        │           💰 ПОКУПКА РАЗРЕШЕНА         │
        │      Размещение market-ордера         │
        └───────────────────────────────────────┘
                              │ ВЫПОЛНЕНА
                              ▼
        ┌───────────────────────────────────────┐
        │       Активация цикла                 │
        │   active = True                       │
        │   pending_start = False               │
        │   Освобождение Lock                   │
        └───────────────────────────────────────┘
```

## 🎯 КЛЮЧЕВЫЕ МОМЕНТЫ

### 1. Мастер-Lock - это НЕ то же самое, что Lock валюты

```
Мастер-Lock (_locks_creation_lock):
├─ Защищает СОЗДАНИЕ Lock'ов для валют
├─ Захватывается на 1-2 миллисекунды
├─ Общий для ВСЕХ валют
└─ Используется ТОЛЬКО при создании

Lock валюты (_start_cycle_locks[base]):
├─ Защищает ПОКУПКУ конкретной валюты
├─ Захватывается на всё время покупки (1-5 секунд)
├─ Свой для КАЖДОЙ валюты
└─ Используется при КАЖДОЙ попытке старта
```

### 2. Почему Lock() создаёт НОВЫЙ объект

```python
# Это НЕ singleton!
lock1 = threading.Lock()  # Создаётся объект A
lock2 = threading.Lock()  # Создаётся объект B
lock1 is lock2  # False - это РАЗНЫЕ объекты!

# Поэтому без синхронизации:
# Thread 1: locks[SOL] = threading.Lock()  # Объект A
# Thread 2: locks[SOL] = threading.Lock()  # Объект B (перезаписывает!)
# Результат: locks[SOL] содержит объект B, но Thread 1 захватил A!
```

### 3. Паттерн Double-Checked Locking

```python
# Быстрая проверка без блокировки
if key not in dict:  # ← Оптимизация
    # Медленная проверка с блокировкой
    with master_lock:  # ← Защита
        if key not in dict:  # ← Двойная проверка
            dict[key] = create_resource()

# Используем гарантированно существующий ресурс
resource = dict[key]
```

Это оптимально:
- ✅ Блокировка только при первом создании
- ✅ Последующие обращения без блокировки
- ✅ Гарантия: только один ресурс создаётся

## 📈 СТАТИСТИКА

```
╔════════════════════════════════════════════════════════════╗
║              ВЕРОЯТНОСТЬ ДВОЙНОЙ ПОКУПКИ                   ║
╠════════════════════════════════════════════════════════════╣
║                                                            ║
║  БЕЗ ИСПРАВЛЕНИЯ:                                          ║
║  ┌─────────────────────────────────────────┐              ║
║  │ ████████████████████████████████ 95%    │  ❌ ВЫСОКАЯ  ║
║  └─────────────────────────────────────────┘              ║
║                                                            ║
║  С ИСПРАВЛЕНИЕМ:                                           ║
║  ┌─────────────────────────────────────────┐              ║
║  │  0%                                     │  ✅ НУЛЕВАЯ  ║
║  └─────────────────────────────────────────┘              ║
║                                                            ║
╚════════════════════════════════════════════════════════════╝

Объяснение:
- БЕЗ: race condition в 95% случаев при параллельных запросах
- С: race condition НЕВОЗМОЖНА (гарантируется примитивом Lock)
```

---

**Эта визуализация поможет понять:**
1. Почему была проблема (3 разных Lock'а)
2. Как она решена (1 общий Lock через мастер-Lock)
3. Как работают все уровни защиты
4. Почему это гарантирует решение

**Используйте эту схему при объяснении коллегам или в документации.**
