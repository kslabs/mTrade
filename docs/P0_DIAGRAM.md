# 📊 Диаграмма обновления P0 (start_price)

## 🔄 Жизненный цикл P0

```
┌──────────────────────────────────────────────────────────────────┐
│                      ИНИЦИАЛИЗАЦИЯ                                │
│                                                                   │
│  _recalc_table_if_needed()                                       │
│  ├─ Пересчёт таблицы                                             │
│  └─ cycle['start_price'] = table[0]['rate']  ✅ P0 = первый шаг  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                   СТАРТОВАЯ ПОКУПКА (Step 0)                      │
│                                                                   │
│  _try_start_cycle()                                              │
│  ├─ Покупка по цене buy_price                                    │
│  ├─ cycle['start_price'] = buy_price  ✅ P0 = цена покупки       │
│  └─ state_manager: start_price = buy_price  ✅ Сохранено         │
│                                                                   │
│  РЕЗУЛЬТАТ: P0 установлено                                        │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                  ДОКУПКА/УСРЕДНЕНИЕ (Step 1+)                     │
│                                                                   │
│  _try_rebuy()                                                    │
│  ├─ Покупка по цене level_price                                  │
│  ├─ cycle['active_step'] += 1  ✅ Шаг увеличился                │
│  ├─ cycle['last_buy_price'] = level_price  ✅ Последняя цена     │
│  ├─ cycle['total_invested_usd'] += invest  ✅ Инвестиции         │
│  ├─ cycle['base_volume'] += filled  ✅ Объём                     │
│  └─ cycle['start_price'] ❌ НЕ ТРОГАЕТСЯ                         │
│                                                                   │
│  РЕЗУЛЬТАТ: P0 НЕ изменилось                                      │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                        ПРОДАЖА (Sell)                             │
│                                                                   │
│  _try_sell()                                                     │
│  ├─ Продажа всего объёма                                         │
│  ├─ cycle['active'] = False  ✅ Цикл завершён                   │
│  └─ cycle['start_price'] ❌ Сохраняется до нового цикла          │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                      НОВЫЙ ЦИКЛ (Step 0)                          │
│                                                                   │
│  _try_start_cycle()                                              │
│  ├─ Новая стартовая покупка                                      │
│  ├─ cycle['start_price'] = new_buy_price  ✅ P0 обновлено        │
│  └─ state_manager: start_price = new_buy_price  ✅ Сохранено     │
│                                                                   │
│  РЕЗУЛЬТАТ: P0 установлено для нового цикла                       │
└──────────────────────────────────────────────────────────────────┘
```

---

## 📈 Таблица обновлений P0

| Действие | Функция | P0 обновляется? | Что обновляется |
|----------|---------|----------------|----------------|
| **Инициализация** | `_recalc_table_if_needed()` | ✅ ДА | `cycle['start_price']` = первая строка таблицы |
| **Стартовая покупка** | `_try_start_cycle()` | ✅ ДА | `cycle['start_price']` = цена покупки<br>`state_manager` обновлён |
| **Докупка** | `_try_rebuy()` | ❌ НЕТ | `active_step`, `last_buy_price`, `total_invested_usd`, `base_volume` |
| **Продажа** | `_try_sell()` | ❌ НЕТ | `active` = False, баланс обнуляется |
| **Новый цикл** | `_try_start_cycle()` | ✅ ДА | `cycle['start_price']` = цена новой покупки |

---

## 🔍 Детали обновления

### 1. Стартовая покупка (Step 0)

**Код:** `autotrader.py`, строки 465, 473

```python
# Шаг 1: Обновление цикла
cycle.update({
    'active': True,
    'active_step': 0,
    'last_buy_price': buy_price,
    'start_price': buy_price,  # ✅ P0 = цена покупки
    'total_invested_usd': invest,
    'base_volume': filled
})

# Шаг 2: Сохранение в state_manager
current_params = self.state_manager.get_breakeven_params(base)
current_params['start_price'] = buy_price  # ✅ P0 сохранено
self.state_manager.update_breakeven_params(base, current_params)
```

### 2. Докупка (Step 1+)

**Код:** `autotrader.py`, строки 546-549

```python
# Обновляем цикл БЕЗ изменения start_price
cycle['active_step'] = next_step           # ✅ Шаг +1
cycle['last_buy_price'] = level_price      # ✅ Цена докупки
cycle['total_invested_usd'] += invest      # ✅ Инвестиции +
cycle['base_volume'] += filled             # ✅ Объём +
# cycle['start_price'] ❌ НЕ ТРОГАЕТСЯ!
```

---

## 🎯 Проверка в интерфейсе

### Индикатор (футер):

```
┌─────────────────────────────────────┐
│  Price:  0.00123456  (жёлтый)       │
│  Sell:   0.00125000  (зелёный)      │
│  BE:     0.00124000  (синий) ← ✅   │
│  Last:   0.00123000  (оранжевый)    │
│  Start:  0.00122000  (фиолетовый)   │ ← ✅ P0
│  Buy:    0.00121000  (красный)      │
└─────────────────────────────────────┘
```

### Таблица безубыточности:

```
┌─────┬──────────┬─────────┬──────────┬──────────┐
│ № │  Rate    │ Volume  │ Invested │ BE       │
├─────┼──────────┼─────────┼──────────┼──────────┤
│ 0*  │ 0.001220 │ 100.00  │ 122.00   │ 0.001220 │ ← ✅ P0 (Start)
│ 1   │ 0.001200 │ 105.00  │ 248.00   │ 0.001240 │ ← ✅ BE (после докупки)
│ 2   │ 0.001180 │ 110.25  │ 378.10   │ 0.001260 │
└─────┴──────────┴─────────┴──────────┴──────────┘
* - текущий шаг
```

**Пример:**
1. Стартовая покупка: P0 = 0.001220 ✅
2. Докупка Step 1: P0 = 0.001220 (не изменилось) ✅
3. BE обновился: 0.001220 → 0.001240 ✅

---

## ✅ Итог

**Логика P0 работает ПРАВИЛЬНО:**
- P0 устанавливается только при стартовой покупке
- P0 НЕ изменяется при докупках
- P0 обновляется при новом цикле

**BE отображается КОРРЕКТНО:**
- BE виден в индикаторе (синий цвет)
- BE обновляется для каждого шага
- BE рассчитывается от P0

---

**Файлы:**
- `autotrader.py` - основная логика
- `mTrade.py` - серверная часть
- `static/app.js` - клиентская часть
- `templates/index.html` - HTML индикатора

**Статус:** ✅ ПРОВЕРЕНО И РАБОТАЕТ
