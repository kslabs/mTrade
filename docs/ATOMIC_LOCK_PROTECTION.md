# üîí –ê–¢–û–ú–ê–†–ù–ê–Ø –ó–ê–©–ò–¢–ê: Threading.Lock –ø—Ä–æ—Ç–∏–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –§–ª–∞–≥ `pending_start` –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!

**–ü–æ—á–µ–º—É:** Race condition (—Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏)

```python
# –ü–æ—Ç–æ–∫ 1:
if cycle.get('pending_start'):  # False ‚úÖ
    return
cycle['pending_start'] = True   # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º

# –ü–æ—Ç–æ–∫ 2 (–û–î–ù–û–í–†–ï–ú–ï–ù–ù–û):
if cycle.get('pending_start'):  # False ‚úÖ (–µ—â—ë –Ω–µ —É—Å–ø–µ–ª –ø—Ä–æ—á–∏—Ç–∞—Ç—å –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!)
    return
cycle['pending_start'] = True   # –¢–æ–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º

# –†–ï–ó–£–õ–¨–¢–ê–¢: –û–±–∞ –ø–æ—Ç–æ–∫–∞ –ø—Ä–æ—à–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç –ø–æ–∫—É–ø–∫—É!
```

### –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–∫–∞–∑—ã–≤–∞—é—Ç —ç—Ç–æ:

```
20:10:48 SELL 1039.55 XRP5L
20:10:50 BUY   102.1 XRP5L   ‚Üê –ü–æ—Ç–æ–∫ 1 –Ω–∞—á–∞–ª
20:10:51 BUY    99.99 XRP5L  ‚Üê –ü–æ—Ç–æ–∫ 2 —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É!
```

**–ò–Ω—Ç–µ—Ä–≤–∞–ª 1 —Å–µ–∫—É–Ω–¥–∞** - —ç—Ç–æ —Ç–∏–ø–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ –Ω–∞ –±–∏—Ä–∂–µ. –ü–æ–∫–∞ –ü–æ—Ç–æ–∫ 1 –≤—ã–ø–æ–ª–Ω—è–ª –æ—Ä–¥–µ—Ä, –ü–æ—Ç–æ–∫ 2 –ø—Ä–æ—à—ë–ª –ø—Ä–æ–≤–µ—Ä–∫—É –∏ —Ç–æ–∂–µ –Ω–∞—á–∞–ª –ø–æ–∫—É–ø–∫—É!

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: Threading.Lock

### –ß—Ç–æ —Ç–∞–∫–æ–µ Lock?

**Lock (–º—å—é—Ç–µ–∫—Å)** - —ç—Ç–æ –ø—Ä–∏–º–∏—Ç–∏–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç–æ–ª—å–∫–æ **–û–î–ò–ù** –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—á–∞—Å—Ç–æ–∫ –∫–æ–¥–∞.

```python
lock.acquire()  # –ó–∞—Ö–≤–∞—Ç–∏—Ç—å Lock (–±–ª–æ–∫–∏—Ä—É–µ—Ç –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏)
try:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–¥ (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –∑–¥–µ—Å—å)
    ...
finally:
    lock.release()  # –û—Å–≤–æ–±–æ–¥–∏—Ç—å Lock (—Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–∞–º)
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ autotrader

**1. –°–æ–∑–¥–∞–Ω–∏–µ Lock –≤ `__init__`:**

```python
def __init__(self, ...):
    # ...
    from threading import Lock
    self._start_cycle_locks: Dict[str, Lock] = {}  # Lock –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–ª—é—Ç—ã
```

**2. –û–±—ë—Ä—Ç–∫–∞ `_try_start_cycle` —Å Lock:**

```python
def _try_start_cycle(self, base: str, quote: str):
    # –°–æ–∑–¥–∞—ë–º Lock –¥–ª—è –≤–∞–ª—é—Ç—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if base not in self._start_cycle_locks:
        from threading import Lock
        self._start_cycle_locks[base] = Lock()
    
    # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å Lock (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞)
    acquired = self._start_cycle_locks[base].acquire(blocking=False)
    if not acquired:
        # –î—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∫—É–ø–∫—É - –≤—ã—Ö–æ–¥–∏–º
        print(f"[LOCK_PROTECTION][{base}] –ë–õ–û–ö–ò–†–û–í–ö–ê: –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∫—É–ø–∫—É")
        return
    
    try:
        # Lock –∑–∞—Ö–≤–∞—á–µ–Ω - –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∫—É–ø–∫—É
        self._try_start_cycle_impl(base, quote)
    finally:
        # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º Lock
        self._start_cycle_locks[base].release()
```

**3. –í—Å—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ `_try_start_cycle_impl`:**

```python
def _try_start_cycle_impl(self, base: str, quote: str):
    # –í—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∞—è –ª–æ–≥–∏–∫–∞ –∑–¥–µ—Å—å
    self._ensure_cycle_struct(base)
    cycle = self.cycles[base]
    # ... –∏ —Ç.–¥.
```

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–¥–∏–Ω –ø–æ—Ç–æ–∫

```
–ü–æ—Ç–æ–∫ 1: _try_start_cycle –≤—ã–∑–≤–∞–Ω
–ü–æ—Ç–æ–∫ 1: lock.acquire(blocking=False) ‚Üí True ‚úÖ
–ü–æ—Ç–æ–∫ 1: –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∫—É–ø–∫—É...
–ü–æ—Ç–æ–∫ 1: lock.release() ‚Üí Lock –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –î–≤–∞ –ø–æ—Ç–æ–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

```
–ü–æ—Ç–æ–∫ 1: _try_start_cycle –≤—ã–∑–≤–∞–Ω
–ü–æ—Ç–æ–∫ 1: lock.acquire(blocking=False) ‚Üí True ‚úÖ (–ø–µ—Ä–≤—ã–π –∑–∞—Ö–≤–∞—Ç–∏–ª)
–ü–æ—Ç–æ–∫ 1: –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∫—É–ø–∫—É...

–ü–æ—Ç–æ–∫ 2: _try_start_cycle –≤—ã–∑–≤–∞–Ω (–û–î–ù–û–í–†–ï–ú–ï–ù–ù–û)
–ü–æ—Ç–æ–∫ 2: lock.acquire(blocking=False) ‚Üí False ‚ùå (Lock –∑–∞–Ω—è—Ç!)
–ü–æ—Ç–æ–∫ 2: print("[LOCK_PROTECTION] –ë–õ–û–ö–ò–†–û–í–ö–ê")
–ü–æ—Ç–æ–∫ 2: return (–≤—ã—Ö–æ–¥ –±–µ–∑ –ø–æ–∫—É–ø–∫–∏)

–ü–æ—Ç–æ–∫ 1: lock.release() ‚Üí Lock –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –¢—Ä–∏ –ø–æ—Ç–æ–∫–∞

```
–ü–æ—Ç–æ–∫ 1: Lock –∑–∞—Ö–≤–∞—á–µ–Ω, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∫—É–ø–∫—É
–ü–æ—Ç–æ–∫ 2: Lock –∑–∞–Ω—è—Ç ‚Üí –ë–õ–û–ö–ò–†–û–í–ö–ê ‚Üí –≤—ã—Ö–æ–¥
–ü–æ—Ç–æ–∫ 3: Lock –∑–∞–Ω—è—Ç ‚Üí –ë–õ–û–ö–ò–†–û–í–ö–ê ‚Üí –≤—ã—Ö–æ–¥

–ü–æ—Ç–æ–∫ 1: –ó–∞–≤–µ—Ä—à–∏–ª ‚Üí Lock –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–æ–ª—å–∫–æ **–û–î–ù–ê** –ø–æ–∫—É–ø–∫–∞, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã!

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –∑–∞—â–∏—Ç—ã

| –ú–µ—Ç–æ–¥ | –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å | –ü—Ä–æ–±–ª–µ–º—ã |
|-------|------------|----------|
| –§–ª–∞–≥ `pending_start` | ‚ùå –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç | Race condition |
| –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ | ‚ùå –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç | –ü–æ—Ç–æ–∫–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ `active` | ‚ùå –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç | –ü–æ—Ç–æ–∫–∏ –≤–∏–¥—è—Ç –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ |
| **Threading.Lock** | ‚úÖ **–†–ê–ë–û–¢–ê–ï–¢** | **–ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è** |

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ—è–≤–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ:

```
[LOCK_PROTECTION][XRP5L] –ë–õ–û–ö–ò–†–û–í–ö–ê: –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–æ–∫—É–ø–∫—É
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
20:10:48 SELL 1039.55 XRP5L
20:10:50 BUY   102.1 XRP5L    ‚Üê –ü–æ—Ç–æ–∫ 1 (Lock –∑–∞—Ö–≤–∞—á–µ–Ω)

[LOCK_PROTECTION][XRP5L] –ë–õ–û–ö–ò–†–û–í–ö–ê: –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∫—É–ø–∫—É
[LOCK_PROTECTION][XRP5L] –ë–õ–û–ö–ò–†–û–í–ö–ê: –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∫—É–ø–∫—É
[LOCK_PROTECTION][XRP5L] –ë–õ–û–ö–ò–†–û–í–ö–ê: –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∫—É–ø–∫—É

(–¢–æ–ª—å–∫–æ –û–î–ù–ê –ø–æ–∫—É–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!)
```

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û

### –ü–ï–†–ï–ó–ê–ü–£–°–ö –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù!

```powershell
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –í–°–ï –ø—Ä–æ—Ü–µ—Å—Å—ã
Stop-Process -Name python -Force

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
python autotrader.py
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:

1. **–î–æ–∂–¥–∞—Ç—å—Å—è –ø—Ä–æ–¥–∞–∂–∏**
2. **–î–æ–∂–¥–∞—Ç—å—Å—è –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏**
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å** –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
   ```
   [LOCK_PROTECTION][XRP5L] –ë–õ–û–ö–ò–†–û–í–ö–ê: –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫...
   ```
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å **—Ç–æ–ª—å–∫–æ –û–î–ù–ê** —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞

## üéì –ü–æ—á–µ–º—É Lock —Ä–∞–±–æ—Ç–∞–µ—Ç, –∞ —Ñ–ª–∞–≥ –Ω–µ—Ç?

### –§–ª–∞–≥ (–ù–ï –∞—Ç–æ–º–∞—Ä–Ω–æ):

```python
# –®–ê–ì 1: –ß—Ç–µ–Ω–∏–µ
value = cycle.get('pending_start')  # –ú–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å—Å—è –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º!

# –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∞
if value:
    return

# –®–ê–ì 3: –ó–∞–ø–∏—Å—å
cycle['pending_start'] = True  # –î—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –º–æ–≥ —É–∂–µ –ø—Ä–æ–π—Ç–∏ –®–ê–ì 1!
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–∂–¥—É —á—Ç–µ–Ω–∏–µ–º –∏ –∑–∞–ø–∏—Å—å—é –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É—Å–ø–µ–≤–∞–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å **—Å—Ç–∞—Ä–æ–µ** –∑–Ω–∞—á–µ–Ω–∏–µ!

### Lock (–ê—Ç–æ–º–∞—Ä–Ω–æ):

```python
# –û–¥–Ω–∞ –Ω–µ–¥–µ–ª–∏–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
acquired = lock.acquire(blocking=False)

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# - True: Lock –∑–∞—Ö–≤–∞—á–µ–Ω, –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–∞—Ç False
# - False: Lock –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º
```

**–ì–∞—Ä–∞–Ω—Ç–∏—è:** –¢–æ–ª—å–∫–æ –û–î–ò–ù –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–∏—Ç `True`, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç `False`!

## üìù –†–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –°—Ç—Ä–æ–∫–∏ |
|------|-----------|--------|
| autotrader.py | –î–æ–±–∞–≤–ª–µ–Ω `_start_cycle_locks: Dict[str, Lock]` | ~168 |
| autotrader.py | –û–±—ë—Ä—Ç–∫–∞ `_try_start_cycle` —Å Lock | ~927-950 |
| autotrader.py | –õ–æ–≥–∏–∫–∞ –≤ `_try_start_cycle_impl` | ~951+ |

## üöÄ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
SELL ‚Üí 6 —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø–æ–∫—É–ø–æ–∫ –ø–æ–¥—Ä—è–¥ (–∑–∞ 7 –º–∏–Ω—É—Ç)
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
SELL ‚Üí 1 —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞
[LOCK_PROTECTION] –ë–õ–û–ö–ò–†–û–í–ö–ê (5 —Ä–∞–∑)
```

---

**–î–∞—Ç–∞:** 02.12.2025 20:15  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞—â–∏—Ç–∞  
**–¢—Ä–µ–±—É–µ—Ç—Å—è:** üö® –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ô –ü–ï–†–ï–ó–ê–ü–£–°–ö  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî• –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô
