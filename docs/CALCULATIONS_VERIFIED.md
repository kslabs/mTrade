# ✅ Проверка расчётов таблицы безубыточности

## Дата проверки
16 ноября 2025

## Проблема
Обнаружена ошибка в расчёте цены безубыточности: при подсчёте общего количества купленных монет (`total_coins`) использовалась старая формула с `step_decrease_pct` вместо накопленной суммы процентов.

## Исправление
В файле `breakeven_calculator.py` изменён расчёт `total_coins`:

### Было (неправильно):
```python
step_decrease_pct = -((s * rk) + target_r) if s > 0 else 0.0
step_rate = start_price * (1 + step_decrease_pct / 100.0)
```

### Стало (правильно):
```python
step_cumulative = 0.0  # Накопленная сумма для расчёта курсов покупки

for s in range(step + 1):
    step_decrease = -((s * rk) + target_r) if s > 0 else 0.0
    if s > 0:
        step_cumulative += step_decrease
    
    # Курс покупки на шаге s рассчитывается от накопленной суммы
    step_rate = start_price * (1 + step_cumulative / 100.0)
```

## Тестирование

### Тест 1: Базовая проверка (test_breakeven_calculations.py)
**Параметры:**
- Стартовая цена: $100
- Старт объём: $10
- R = 3.0%, Rk = 0.1%
- Геометрия: x2.0

**Результаты для шага 3:**
```
Шаг  | ↓,%      | ↓Δ,%     | Курс      | Покупка  | БезУб     | ↑БезУб,%
-----|----------|----------|-----------|----------|-----------|----------
0    | 0.000    | 0.000    | $100.00   | $10.00   | $100.00   | 0.00%
1    | -3.100   | -3.100   | $96.90    | $20.00   | $97.91    | 1.04%
2    | -6.300   | -3.200   | $93.70    | $40.00   | $95.46    | 1.88%
3    | -9.600   | -3.300   | $90.40    | $80.00   | $92.69    | 2.54%
```

**Ручная проверка шага 3:**
- Всего инвестировано: $150.00
- Всего монет: 1.618248
- Цена безубыточности: $150 / 1.618248 = $92.6928 ✅
- Разница с функцией: 0.000000 ✅

### Тест 2: Реальные параметры (test_real_params.py)
**Параметры по умолчанию:**
- BTC = $91,000
- Старт объём: $3
- R = 3.65%, Rk = 0.0%
- Геометрия: x2.0
- Шагов: 16

**Ключевые результаты:**

| Шаг | ↓,% (накопл.) | Курс BTC | Инвестировано | БезУб | ↑БезУб,% |
|-----|---------------|----------|---------------|-------|----------|
| 0 | 0.000% | $91,000 | $3 | $91,000 | 0.00% |
| 1 | -3.650% | $87,679 | $9 | $88,758 | 1.23% |
| 5 | -18.250% | $74,393 | $189 | $77,208 | 3.79% |
| 10 | -36.500% | $57,785 | $6,141 | $60,780 | 5.18% |
| 16 | -58.400% | $37,856 | $393,213 | $40,733 | 7.60% |

**Проверка:**
- ✅ Цена безубыточности всегда выше текущего курса
- ✅ Процент роста для безубытка увеличивается с каждым шагом
- ✅ Накопленное снижение корректно рассчитывается

### Тест 3: Прогрессивная стратегия (Rk = 0.1)
**С Rk = 0.1% шаг снижения увеличивается:**

| Шаг | ↓,% (накопл.) | ↓Δ,% (шаг) | Курс BTC |
|-----|---------------|------------|----------|
| 0 | 0.000% | 0.000% | $91,000 |
| 1 | -3.750% | -3.750% | $87,588 |
| 2 | -7.600% | -3.850% | $84,084 |
| 3 | -11.550% | -3.950% | $80,490 |
| 4 | -15.600% | -4.050% | $76,804 |
| 5 | -19.750% | -4.150% | $73,028 |

**Проверка:**
- ✅ Шаг увеличивается: -3.75% → -3.85% → -3.95% → -4.05% → -4.15%
- ✅ Накопленное снижение растёт быстрее, чем при Rk = 0

## Выводы

### ✅ Все расчёты работают корректно:
1. **Накопленное снижение** правильно суммируется
2. **Курс** рассчитывается от накопленной суммы процентов
3. **Цена безубыточности** корректно учитывает все покупки
4. **Процент роста для безубытка** логично увеличивается с каждым шагом
5. **Формула с Rk** работает для прогрессивных/регрессивных стратегий

### Почему процент безубыточной продажи увеличивается?
Это **нормально и ожидаемо**! Причины:

1. **Геометрическая прогрессия объёмов** (x2.0):
   - Шаг 0: $3
   - Шаг 1: $6
   - Шаг 10: $3,072
   - Шаг 16: $196,608

2. **Средневзвешенная цена**:
   - Чем больше покупок по низким ценам, тем выше средняя цена покупки
   - Цена безубыточности = Всего инвестировано / Всего монет

3. **Пример для шага 16**:
   - Курс упал на 58.4% до $37,856
   - Инвестировано: $393,213
   - Цена безубыточности: $40,733
   - Нужен рост на 7.60% для безубытка

Это означает, что несмотря на сильное падение (-58%), благодаря докупкам по низким ценам, для безубытка нужен рост всего на 7.6%!

## Статус
**✅ ВСЕ РАСЧЁТЫ ПРОВЕРЕНЫ И РАБОТАЮТ КОРРЕКТНО**

Изменения:
- breakeven_calculator.py: исправлен расчёт total_coins
- Созданы тесты: test_breakeven_calculations.py, test_real_params.py
