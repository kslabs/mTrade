# Исправление множественных стартовых покупок после продажи

**Дата**: 3 декабря 2025  
**Проблема**: После ручной продажи (sell all) автотрейдер делал несколько стартовых покупок подряд

## Анализ проблемы

### Симптомы

Из логов:
```
[11:19:32] [SOL] Sell{10.0685; Курс:141.8100; ...}
[11:19:36] [SOL] Buy{9.9554; Курс:142.2200; ...}   # +4 секунды
[11:19:37] [SOL] Buy{10.0827; Курс:142.0100; ...}   # +5 секунд (повторная!)
```

### Найденные причины

1. **Продажа НЕ устанавливала метку времени `last_sell_time`**
   - После продажи не было задержки перед новым стартом
   - Автотрейдер мог сразу начать новый цикл

2. **Продажа НЕ сбрасывала флаг `pending_start`**
   - Если покупка была в процессе, флаг оставался `True`
   - Это могло привести к неконсистентному состоянию

3. **Недостаточная защита по времени**
   - Минимальная задержка 3 секунды была недостаточной
   - За это время успевали выполниться 2 покупки

## Исправления

### 1. Файл `handlers/quick_trades.py`

**Изменено**: Метод обработки ручной продажи (sell all)

**Добавлено**:
```python
# Критичные изменения при сбросе цикла после продажи:
current_time = time_module.time()

at.cycles[b].update({
    'active': False,
    'active_step': -1,
    'last_buy_price': 0.0,
    'start_price': 0.0,
    'total_invested_usd': 0.0,
    'base_volume': 0.0,
    'pending_start': False,        # ← НОВОЕ: Сбрасываем флаг
    'last_sell_time': current_time, # ← НОВОЕ: Метка времени продажи
    'last_start_attempt': 0         # ← НОВОЕ: Сброс метки попыток
})
```

**Результат**:
- ✅ После продажи все флаги защиты сбрасываются
- ✅ Устанавливается метка времени последней продажи
- ✅ Добавлена диагностика с выводом в консоль

### 2. Файл `autotrader.py`

**Изменено**: Метод `_try_start_cycle`

**Добавлена проверка**:
```python
# ПРОВЕРКА ВРЕМЕНИ ПОСЛЕ ПОСЛЕДНЕЙ ПРОДАЖИ
last_sell_time = cycle.get('last_sell_time', 0)
if last_sell_time > 0:
    elapsed = time.time() - last_sell_time
    if elapsed < 5:  # Минимум 5 секунд!
        print(f"[PROTECTION][{base}] ОТКАЗ: прошло {elapsed:.1f}с после продажи (минимум 5с)")
        return
```

**Результат**:
- ✅ Новый цикл НЕ запустится раньше чем через 5 секунд после продажи
- ✅ Время достаточно для:
  - Обновления балансов на бирже
  - Синхронизации состояния
  - Предотвращения повторных стартов

### 3. Добавлен импорт `traceback`

Для лучшей диагностики ошибок в методе `_try_start_cycle`.

## Логика защиты (теперь)

### До стартовой покупки проверяется:

1. **`active == False`** - цикл не активен
2. **`pending_start == False`** - покупка не в процессе
3. **Lock захвачен** - только один поток может выполнить покупку
4. **Баланс BASE < минимального ордера** - нет активных монет
5. **`last_sell_time` > 5 секунд** - прошло достаточно времени после продажи

### После продажи устанавливается:

1. **`active = False`** - цикл завершён
2. **`pending_start = False`** - флаг сброшен
3. **`last_sell_time = <время>`** - метка для защиты
4. **`last_start_attempt = 0`** - сброс метки попыток
5. **Все объёмы = 0** - чистое состояние

## Тестирование

### Сценарий 1: Ручная продажа
```
1. Купить монеты вручную
2. Продать через "Sell All"
3. Проверить логи:
   - Должна быть строка "[MANUAL_SELL][XXX] Цикл сброшен"
   - НЕ должно быть покупок в течение 5 секунд
```

### Сценарий 2: Автоматическая торговля
```
1. Включить автотрейдер
2. Дождаться стартовой покупки
3. Продать вручную через "Sell All"
4. Проверить:
   - Новый цикл НЕ начнётся раньше 5 секунд
   - После 5 секунд - один новый старт (не два!)
```

### Ожидаемые логи

**При продаже**:
```
[MANUAL_SELL][SOL] Цикл сброшен: active=False, last_sell_time=1234567890.123
[MANUAL_SELL][SOL] Состояние автотрейдера сохранено
```

**При попытке старта (< 5 сек)**:
```
[PROTECTION][SOL] ОТКАЗ стартовой покупки: прошло 2.3с после продажи (минимум 5с)
```

**При успешном старте (> 5 сек)**:
```
[START_CYCLE][SOL] Прошло 5.2с после продажи - разрешаем новый цикл
[START_CYCLE][SOL] Попытка стартовой покупки...
[PROTECTION][SOL] pending_start=True УСТАНОВЛЕН И СОХРАНЁН
```

## Дополнительные улучшения

1. **Увеличена задержка** с 3 до 5 секунд
   - Больше времени на обновление балансов
   - Меньше шансов на race condition

2. **Добавлена диагностика**
   - Все защиты выводят сообщения в консоль
   - Легче отслеживать причины блокировок

3. **Улучшена обработка ошибок**
   - Добавлен `traceback.print_exc()`
   - Ошибки не молча игнорируются

## Проверочный список

- [x] Продажа сбрасывает `active = False`
- [x] Продажа сбрасывает `pending_start = False`
- [x] Продажа устанавливает `last_sell_time`
- [x] Продажа сбрасывает `last_start_attempt`
- [x] Стартовая покупка проверяет `last_sell_time`
- [x] Задержка увеличена до 5 секунд
- [x] Добавлена диагностика
- [x] Нет ошибок компиляции

## Файлы изменены

- `c:\Users\Администратор\Documents\bGate.mTrade\handlers\quick_trades.py`
- `c:\Users\Администратор\Documents\bGate.mTrade\autotrader.py`

## Примечание

Если множественные покупки всё ещё происходят:

1. Проверьте логи на строку `[MANUAL_SELL]` - срабатывает ли сброс?
2. Проверьте `autotrader_cycles_state.json` - сохраняется ли состояние?
3. Увеличьте задержку с 5 до 10 секунд если нужно
