# ‚ö° –ë–´–°–¢–†–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –¥–≤–æ–π–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫?

## üîß –®–ê–ì 1: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä (Ctrl+C –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–æ—Ü–µ—Å—Å)
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ:
python mTrade.py
```

## üß™ –®–ê–ì 2: –¢–µ—Å—Ç (5 –º–∏–Ω—É—Ç)

### –í–∞—Ä–∏–∞–Ω—Ç –ê: –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Ü–∏–∫–ª)

1. –û—Ç–∫—Ä—ã—Ç—å UI –∞–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä–∞
2. –í—ã–±—Ä–∞—Ç—å –ª—é–±—É—é –≤–∞–ª—é—Ç—É —Å –∞–∫—Ç–∏–≤–Ω—ã–º —Ü–∏–∫–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, SOL)
3. –ù–∞–∂–∞—Ç—å **"Sell All"** (–ø—Ä–æ–¥–∞—Ç—å –≤—Å—ë)
4. –ù–∞–∂–∞—Ç—å **"Reset Cycle"** (—Å–±—Ä–æ—Å —Ü–∏–∫–ª–∞)
5. –ü–æ–¥–æ–∂–¥–∞—Ç—å 10-30 —Å–µ–∫—É–Ω–¥
6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:** –°–∫–æ–ª—å–∫–æ –ø–æ–∫—É–ø–æ–∫ –ø—Ä–æ–∏–∑–æ—à–ª–æ?

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –û–î–ù–ê –ø–æ–∫—É–ø–∫–∞

### –í–∞—Ä–∏–∞–Ω—Ç –ë: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–±–µ–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
python diagnose_double_start_buy.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞—â–∏—Ç—ã –≤ –∫–æ–¥–µ
python diagnose_double_start_buy.py --check-protection

# –¢–µ—Å—Ç race condition (—Å–∏–º—É–ª—è—Ü–∏—è)
python diagnose_double_start_buy.py --test-lock-race
```

## üìä –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

### –ò—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö –∫–æ–Ω—Å–æ–ª–∏ –∏–ª–∏ trade_log_*.txt:

#### ‚úÖ –•–û–†–û–®–ò–ï –ø—Ä–∏–∑–Ω–∞–∫–∏ (–≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç):

```
[LOCK_INIT][SOL] –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π Lock –¥–ª—è –≤–∞–ª—é—Ç—ã
[PROTECTION][SOL] ‚ö†Ô∏è –§–õ–ê–ì pending_start=True –£–°–¢–ê–ù–û–í–õ–ï–ù –ò –°–û–•–†–ê–ù–Å–ù
[START_CYCLE][SOL] –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
```

–ï—Å–ª–∏ –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ –ø—ã—Ç–∞–ª–∏—Å—å –∫—É–ø–∏—Ç—å:
```
[LOCK_PROTECTION][SOL] –ë–õ–û–ö–ò–†–û–í–ö–ê: –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∫—É–ø–∫—É
```

#### ‚ùå –ü–õ–û–•–ò–ï –ø—Ä–∏–∑–Ω–∞–∫–∏ (–ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞):

```
[START_CYCLE][SOL] –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
[START_CYCLE][SOL] –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ  ‚Üê –î–£–ë–õ–¨!
[START_CYCLE][SOL] –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ  ‚Üê –¢–†–û–ô–ö–ê!
```

–ò–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ä–¥–µ—Ä–æ–≤ –Ω–∞ –ø–æ–∫—É–ø–∫—É –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è (< 1 –º–∏–Ω—É—Ç—ã).

## üéØ –ö–†–ò–¢–ï–†–ò–ô –£–°–ü–ï–•–ê

**‚úÖ –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê –µ—Å–ª–∏:**
- –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —Ü–∏–∫–ª–∞ –∏ —Ä—É—á–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¢–û–õ–¨–ö–û –û–î–ù–ê —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞
- –í –ª–æ–≥–∞—Ö –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è `[LOCK_INIT]` –∏ `[LOCK_PROTECTION]`
- –ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π `[START_CYCLE] ... —É—Å–ø–µ—à–Ω–æ`

**‚ùå –ü–†–û–ë–õ–ï–ú–ê –ù–ï –†–ï–®–ï–ù–ê –µ—Å–ª–∏:**
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç 2+ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø–æ–∫—É–ø–æ–∫ –ø–æ–¥—Ä—è–¥ –∑–∞ < 1 –º–∏–Ω—É—Ç—ã
- –í –ª–æ–≥–∞—Ö –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π `[LOCK_INIT]` –∏ `[LOCK_PROTECTION]`
- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ü–∏–∫–ª–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∫—É–ø–æ–∫ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º timestamp

## üö® –ï–°–õ–ò –ü–†–û–ë–õ–ï–ú–ê –ü–û–í–¢–û–†–Ø–ï–¢–°–Ø

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

```bash
python diagnose_double_start_buy.py --check-protection
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
```
‚úÖ Lock –¥–ª—è –≤–∞–ª—é—Ç—ã
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ pending_start –¥–æ Lock
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ active –¥–æ Lock
‚úÖ –í—Å–µ –∑–∞—â–∏—Ç—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –∫–æ–¥–µ!
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ü–∏–∫–ª–æ–≤:

```bash
python diagnose_double_start_buy.py --analyze-state
```

–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞:
- `pending_start` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `False` –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤)
- `base_volume` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0 –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤)
- `last_sell_time` (–≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–¥–∞–∂–∏)

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ autotrader.py:

–û—Ç–∫—Ä—ã—Ç—å `autotrader.py` –∏ –Ω–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫–∏ ~180 –∏ ~967:

```python
# –°—Ç—Ä–æ–∫–∞ ~180 –≤ __init__:
self._locks_creation_lock = Lock()  # ‚Üê –≠—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê

# –°—Ç—Ä–æ–∫–∏ ~967-972 –≤ _try_start_cycle:
with self._locks_creation_lock:  # ‚Üê –≠—Ç–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê
    if base not in self._start_cycle_locks:
        from threading import Lock
        self._start_cycle_locks[base] = Lock()
```

–ï—Å–ª–∏ —ç—Ç–∏—Ö —Å—Ç—Ä–æ–∫ –Ω–µ—Ç - –∑–Ω–∞—á–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å!

### 4. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:

- –õ–æ–≥–∏ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100-200 —Å—Ç—Ä–æ–∫ –≤–æ–∫—Ä—É–≥ –ø—Ä–æ–±–ª–µ–º—ã)
- –í—ã–≤–æ–¥ `python diagnose_double_start_buy.py --analyze-state --base <–í–ê–õ–Æ–¢–ê>`
- Timestamp –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫
- –í–∞–ª—é—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–æ–∏–∑–æ—à–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞

## üìã –ë–´–°–¢–†–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

```bash
# –í—Å—ë –≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ
python diagnose_double_start_buy.py --analyze-state --check-protection --test-lock-race
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
1. –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö —Ü–∏–∫–ª–æ–≤
2. ‚úÖ –í—Å–µ –∑–∞—â–∏—Ç—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –∫–æ–¥–µ!
3. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —Ä–∞–±–æ—Ç—ã –º–∞—Å—Ç–µ—Ä-Lock'–∞

---

**–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** 5-10 –º–∏–Ω—É—Ç  
**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** –¢–û–õ–¨–ö–û –û–î–ù–ê –ø–æ–∫—É–ø–∫–∞ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —Ü–∏–∫–ª–∞  
**–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö:** –ó–∞–ø—É—Å—Ç–∏—Ç—å `diagnose_double_start_buy.py` –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤—ã–≤–æ–¥
