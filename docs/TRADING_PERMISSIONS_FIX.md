# Исправление проблемы с перезаписью trading_permissions

**Дата:** 07.12.2024  
**Статус:** ✅ ИСПРАВЛЕНО

## Проблема

При перезапуске сервера разрешения на торговлю для валют (trading_permissions) сбрасывались к значениям по умолчанию (все валюты включены). Пользовательские настройки (например, отключенные валюты) не сохранялись.

## Причина

В файле `state_manager.py` метод `init_currency_permissions()` полностью перезаписывал разрешения на торговлю при каждом вызове:

```python
def init_currency_permissions(self, currencies: list) -> bool:
    """Инициализировать разрешения для валют (сбросить к списку currencies)"""
    perms = {}  # ← ПРОБЛЕМА: создавался новый пустой словарь
    for currency in currencies:
        code = currency.get('code', '').upper()
        if code:
            perms[code] = True  # ← Все валюты устанавливались в True
    return self.set("trading_permissions", perms)
```

Этот метод вызывался при старте сервера в `mTrade.py` (строка 1975):

```python
# Инициализация разрешений торговли для всех валют
currencies = Config.load_currencies()
state_manager.init_currency_permissions(currencies)  # ← Перезаписывал настройки!
```

## Решение

Изменен метод `init_currency_permissions()` так, чтобы он:
1. **Загружал существующие разрешения** из состояния
2. **Добавлял только новые валюты** (которых нет в списке)
3. **Не трогал существующие настройки** пользователя

### Исправленный код

```python
def init_currency_permissions(self, currencies: list) -> bool:
    """Инициализировать разрешения для новых валют (не перезаписывая существующие)"""
    # Получаем текущие разрешения
    perms = self.get_trading_permissions()
    
    # Добавляем только новые валюты (по умолчанию True)
    for currency in currencies:
        code = currency.get('code', '').upper()
        if code and code not in perms:
            perms[code] = True
    
    return self.set("trading_permissions", perms)
```

## Тестирование

Создан и успешно пройден тест `test_permissions_no_overwrite.py`:

### Результаты теста:
- ✅ Все валюты включены по умолчанию при первой инициализации
- ✅ Пользовательские изменения (отключение ETH) сохраняются
- ✅ Настройки сохраняются после перезагрузки StateManager
- ✅ Повторный вызов init_currency_permissions не перезаписывает настройки
- ✅ Новые валюты добавляются с разрешением True
- ✅ Файл app_state.json содержит корректные разрешения

### Вывод теста:
```
================================================================================
ВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО! ✓
init_currency_permissions теперь корректно работает:
  - Не перезаписывает существующие настройки пользователя
  - Добавляет только новые валюты с разрешением True
  - Сохраняет отключенные пользователем валюты
================================================================================
```

## Изменённые файлы

1. **state_manager.py** (строки 329-341)
   - Изменён метод `init_currency_permissions()`
   - Добавлена логика сохранения существующих разрешений

2. **test_permissions_no_overwrite.py** (новый файл)
   - Создан комплексный тест для проверки корректности исправления

## Поведение до и после

### До исправления:
1. Пользователь отключает ETH в UI
2. Настройка сохраняется в app_state.json: `"ETH": false`
3. Сервер перезапускается
4. ❌ При старте вызывается `init_currency_permissions()`
5. ❌ Все разрешения перезаписываются: `"ETH": true`
6. ❌ Автотрейдер запускается со всеми валютами включенными

### После исправления:
1. Пользователь отключает ETH в UI
2. Настройка сохраняется в app_state.json: `"ETH": false`
3. Сервер перезапускается
4. ✅ При старте вызывается `init_currency_permissions()`
5. ✅ Существующие разрешения загружаются и сохраняются
6. ✅ Добавляются только новые валюты (если есть)
7. ✅ Автотрейдер запускается с корректными разрешениями: `"ETH": false`

## Логика работы автотрейдера

При автостарте автотрейдера (строка 2024 в mTrade.py) используется фильтрация:

```python
currencies=[c['code'] for c in currencies if trading_permissions.get(c['code'], False)]
```

Теперь эта фильтрация корректно работает с сохранёнными пользовательскими настройками.

## Дополнительные преимущества

1. **Гибкость**: Можно добавлять новые валюты в `currencies.json` без сброса настроек
2. **Безопасность**: Пользовательские настройки защищены от случайной перезаписи
3. **Удобство**: Не нужно заново настраивать разрешения после каждого перезапуска

## Рекомендации

- После обновления необходимо перезапустить сервер для применения исправления
- Можно проверить корректность работы с помощью теста: `python test_permissions_no_overwrite.py`
- При добавлении новых валют в систему они автоматически получат разрешение `True`
- Чтобы отключить торговлю для валюты, используйте переключатель в UI (изменения сохраняются)

## Статус

✅ **ПРОБЛЕМА РЕШЕНА**

Механизм сохранения и восстановления разрешений на торговлю теперь работает корректно:
- Настройки сохраняются в файл app_state.json
- Настройки восстанавливаются при перезапуске сервера
- Пользовательские изменения не перезаписываются
- Автотрейдер корректно использует сохранённые разрешения
