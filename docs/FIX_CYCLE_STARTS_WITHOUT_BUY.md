# ✅ КРИТИЧЕСКАЯ ОШИБКА ИСПРАВЛЕНА: Цикл стартует без покупки

## Проблема
Цикл становился активным (`active = True`) **ДО выполнения стартовой покупки**. Если покупка не выполнялась (ошибка, недостаточно средств и т.д.), цикл оставался активным, но базовой валюты не было (`base_volume = 0`).

## Найденные зависшие циклы
В файле `autotrader_cycles_state.json` были найдены:
- **ETH**: `active: True`, но `base_volume: 0.00000000`
- **XRP**: `active: True`, но `base_volume: 0.00000000`

Это подтверждает проблему: цикл стартовал, но покупки не было.

## Причина
В коде `autotrader.py` (строка 1020) устанавливалось:
```python
cycle['active'] = True  # ← КРИТИЧНО: Устанавливаем СРАЗУ, до покупки!
cycle['active_step'] = 0
cycle['pending_start'] = True
```

Это делалось для защиты от двойных покупок, но приводило к "зависшим" циклам при ошибках.

## Исправление

### 1. autotrader.py (строка ~1017)
**БЫЛО:**
```python
# ====== КРИТИЧНО: УСТАНАВЛИВАЕМ active=True И pending_start=True НЕМЕДЛЕННО ======
cycle['pending_start'] = True
cycle['active'] = True  # ← Устанавливаем СРАЗУ, до покупки!
cycle['active_step'] = 0
```

**СТАЛО:**
```python
# ====== КРИТИЧНО: УСТАНАВЛИВАЕМ pending_start=True НЕМЕДЛЕННО ======
# НО НЕ УСТАНАВЛИВАЕМ active=True до успешной покупки!
cycle['pending_start'] = True
# active=False останется до успешной покупки
```

### 2. Исправление зависших циклов
Создан скрипт `fix_stuck_cycles.py`, который:
- Находит циклы с `active=True` но `base_volume=0`
- Сбрасывает их в корректное состояние
- Устанавливает защитные флаги (`last_sell_time`, `pending_start=False`)

**Результат:**
```
✅ ИСПРАВЛЕНО ЦИКЛОВ: 2
   - ETH: active: False, last_sell_time установлено
   - XRP: active: False, last_sell_time установлено
```

## Теперь логика работает правильно:

1. **При попытке стартовой покупки:**
   - Устанавливается только `pending_start = True` (блокирует повторные попытки)
   - `active` остаётся `False`

2. **После УСПЕШНОЙ покупки:**
   - Устанавливается `active = True`
   - Устанавливается `base_volume > 0`
   - Сбрасывается `pending_start = False`

3. **При ошибке покупки:**
   - Сбрасывается `pending_start = False`
   - `active` остаётся `False` ✅
   - Цикл НЕ становится "зависшим"

## Защита от двойных покупок сохранена
Флаг `pending_start = True` всё ещё блокирует повторные попытки стартовой покупки, пока идёт текущая попытка. Но теперь цикл не станет активным до успешного завершения покупки.

## Что дальше?

### 1. Перезапуск сервера (ОБЯЗАТЕЛЬНО!)
```powershell
# Остановить
python stop.py
# Или принудительно
taskkill /F /IM python.exe

# Запустить заново
python mTrade.py
```

### 2. Проверка
После перезапуска убедитесь, что:
- Новые циклы НЕ стартуют без покупки
- В логах видно: `[START_CYCLE][валюта] ✅ УСПЕШНАЯ ПОКУПКА` → `active=True`
- Если покупка не удалась → `active` остаётся `False`

### 3. Диагностика
```powershell
python diagnose_double_buy.py
```
Не должно быть циклов с `active=True` и `base_volume=0`

## Итог
Критическая ошибка исправлена:
- ✅ `active = True` устанавливается ТОЛЬКО после успешной покупки
- ✅ При ошибках покупки цикл НЕ становится активным
- ✅ Защита от двойных покупок сохранена через флаг `pending_start`
- ✅ Зависшие циклы (ETH, XRP) исправлены

Теперь автотрейдер работает корректно: цикл стартует ТОЛЬКО если покупка прошла успешно!
