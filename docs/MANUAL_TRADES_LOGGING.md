# 📝 Логирование ручных торговых операций

**Дата**: 14 ноября 2025, 10:45  
**Версия**: 1.8.3

---

## ✅ Выполнено

Добавлено автоматическое логирование для **ручных** покупок и продаж через веб-интерфейс.

---

## 🔧 Что изменилось

### Файл: `mTrade.py`

**Endpoint**: `/api/trade/order` (POST)

**Добавлено**:
- Автоматическое логирование после успешного создания ордера
- Извлечение цены исполнения из ответа API или WebSocket данных
- Вызов `trade_logger.log_buy()` для покупок
- Вызов `trade_logger.log_sell()` для продаж

---

## 📊 Как работает логирование

### 1. **Покупка (Buy)**

При нажатии кнопки **"🛒 Купить минимально"**:

```
┌─────────────────────────────────────────────────┐
│ Пользователь нажимает "Купить минимально"       │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ Frontend отправляет POST /api/trade/order       │
│ {                                                │
│   "side": "buy",                                 │
│   "amount": 0.001234,                            │
│   "base_currency": "BTC",                        │
│   "quote_currency": "USDT"                       │
│ }                                                │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ Backend создаёт ордер через Gate.io API         │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ ✅ Ордер успешно создан                         │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 📝 trade_logger.log_buy()                       │
│    - currency: BTC                               │
│    - volume: 0.001234                            │
│    - price: 50000.0                              │
│    - investment: 61.7                            │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 💾 Запись в trade_logs.jsonl                    │
│ {"timestamp": "...", "type": "buy", ...}        │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 🔄 Frontend автоматически обновит логи          │
│    (через 5 секунд или при переключении)        │
└─────────────────────────────────────────────────┘
```

### 2. **Продажа (Sell)**

При нажатии кнопки **"💰 Продать всё"**:

```
┌─────────────────────────────────────────────────┐
│ Пользователь нажимает "Продать всё"             │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ Frontend отправляет POST /api/trade/order       │
│ {                                                │
│   "side": "sell",                                │
│   "amount": 0.005000,                            │
│   "base_currency": "BTC",                        │
│   "quote_currency": "USDT"                       │
│ }                                                │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ Backend создаёт ордер через Gate.io API         │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ ✅ Ордер успешно создан                         │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 📝 trade_logger.log_sell()                      │
│    - currency: BTC                               │
│    - volume: 0.005000                            │
│    - price: 51000.0                              │
│    - pnl: 50.0                                   │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 💾 Запись в trade_logs.jsonl                    │
│ {"timestamp": "...", "type": "sell", ...}       │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 🔄 Frontend автоматически обновит логи          │
└─────────────────────────────────────────────────┘
```

---

## 📋 Извлечение цены исполнения

Система пытается получить реальную цену исполнения в следующем порядке:

### 1. **Из ответа Gate.io API**
```python
if 'price' in result and result['price']:
    exec_price = float(result['price'])
```

### 2. **Из средней цены исполнения**
```python
elif 'fill_price' in result and result['fill_price']:
    exec_price = float(result['fill_price'])
elif 'avg_deal_price' in result and result['avg_deal_price']:
    exec_price = float(result['avg_deal_price'])
```

### 3. **Из WebSocket данных (текущая рыночная цена)**
```python
if not exec_price:
    ws_mgr = get_websocket_manager()
    if ws_mgr:
        pair_data = ws_mgr.get_data(currency_pair)
        if pair_data and pair_data.get('ticker'):
            exec_price = float(pair_data['ticker'].get('last', 0))
```

### 4. **Из запроса (для limit ордеров)**
```python
if not exec_price and price:
    exec_price = float(price)
```

---

## 🧪 Как протестировать

### 1. Откройте веб-интерфейс
```
http://localhost:5000
```

### 2. Выберите валютную пару
Например: **BTC / USDT**

### 3. Нажмите "🛒 Купить минимально"
- Подтвердите покупку
- Дождитесь сообщения об успехе

### 4. Переключитесь на логи
- Кликните на кнопку **"Логи"** в заголовке таблицы безубыточности

### 5. Проверьте запись
Должна появиться новая запись:
```
🟢 [10:45:23] Buy{Объем:0.001234; Курс:50000.00; ↓Δ%:0.00; ↓%:0.00; Инвест:61.70$}
```

### 6. Нажмите "💰 Продать всё"
- Подтвердите продажу
- Дождитесь сообщения об успехе

### 7. Проверьте запись продажи
```
🔴 [10:46:15] Sell{Объем:0.001234; Курс:51000.00; ↑Δ%:0.00; PnL:1.23$}
```

---

## 📝 Формат записей в логах

### Покупка (Buy):
```
[HH:MM:SS] Buy{Объем:X.XXXX; Курс:X.XXXX; ↓Δ%:0.00; ↓%:0.00; Инвест:X.XX$}
```

**Примечание**: Для ручных покупок:
- `↓Δ%` и `↓%` всегда `0.00` (не вычисляются)
- Цена берётся из реального исполнения ордера

### Продажа (Sell):
```
[HH:MM:SS] Sell{Объем:X.XXXX; Курс:X.XXXX; ↑Δ%:0.00; PnL:0.00$}
```

**Примечание**: Для ручных продаж:
- `↑Δ%` и `PnL` всегда `0.00` (не вычисляются)
- Цена берётся из реального исполнения ордера

---

## 🔍 Диагностика

### Проверить, что логирование работает

**1. В консоли сервера должны появиться сообщения:**
```
[TRADE_LOG] Manual buy logged: BTC, V=0.001234, P=50000.0
```
или
```
[TRADE_LOG] Manual sell logged: BTC, V=0.001234, P=51000.0
```

**2. Проверить файл логов напрямую:**
```powershell
Get-Content trade_logs.jsonl -Tail 5
```

**3. Проверить через API:**
```powershell
Invoke-WebRequest -Uri "http://localhost:5000/api/trade/logs?limit=5&formatted=1" -UseBasicParsing | Select-Object -ExpandProperty Content
```

---

## 🛠️ Обработка ошибок

Если логирование не удаётся, система:
- ✅ **НЕ прерывает** выполнение ордера
- ✅ **Выводит ошибку** в консоль сервера
- ✅ **Продолжает работу** приложения

Пример вывода при ошибке:
```
[TRADE_LOG] Ошибка логирования ручной операции: [детали ошибки]
```

---

## 🎯 Следующие шаги

Теперь логируются:
- ✅ Ручные покупки через кнопку "Купить минимально"
- ✅ Ручные продажи через кнопку "Продать всё"
- ✅ Тестовые операции через `test_trade_logger.py`

**Осталось добавить**:
- 🔜 Логирование автоматических операций из `autotrader.py`
- 🔜 Вычисление реальных процентов профита/убытка для ручных операций
- 🔜 Отображение истории балансов

---

## 📚 Связанные файлы

- **Backend**: `mTrade.py` → `/api/trade/order`
- **Frontend**: `static/app.js` → `handleBuyMinOrder()`, `handleSellAll()`
- **Logger**: `trade_logger.py` → `log_buy()`, `log_sell()`
- **Logs file**: `trade_logs.jsonl`

---

## ✅ Чеклист проверки

- [x] Сервер перезапущен с новым кодом
- [x] Endpoint `/api/trade/order` обновлён
- [x] Логирование добавлено для buy и sell
- [x] Обработка ошибок логирования добавлена
- [ ] **→ Протестировать ручную покупку**
- [ ] **→ Проверить запись в логах**
- [ ] **→ Протестировать ручную продажу**
- [ ] **→ Проверить запись в логах**

---

**Статус**: ✅ Готово к тестированию  
**Требуется**: Протестировать ручные операции в веб-интерфейсе

---

## 💡 Совет

После совершения ручной покупки или продажи:
1. Подождите 3-5 секунд
2. Переключитесь на вкладку **"Логи"**
3. Проверьте, что новая запись появилась

Если записи нет - проверьте консоль браузера (`F12`) и консоль сервера на наличие ошибок.
