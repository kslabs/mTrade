# üìç –†–ê–°–ü–û–õ–û–ñ–ï–ù–ò–ï –¶–ò–ö–õ–ê –ü–ï–†–ï–ë–û–†–ê –í–ê–õ–Æ–¢

**–§–∞–π–ª:** `autotrader.py`  
**–§—É–Ω–∫—Ü–∏—è:** `_run()`  
**–°—Ç—Ä–æ–∫–∏:** 2243-2323 (–≤–µ—Å—å –º–µ—Ç–æ–¥)  
**–¶–∏–∫–ª –ø–µ—Ä–µ–±–æ—Ä–∞ –≤–∞–ª—é—Ç:** –°—Ç—Ä–æ–∫–∏ 2273-2310

---

## üîç –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

```python
def _run(self):
    quote = self.state_manager.get_active_quote_currency()  # –°—Ç—Ä–æ–∫–∞ 2244 - –ø–æ–ª—É—á–∞–µ–º USDT
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
    if not hasattr(self, '_api_checked'):
        api_client = self.api_client_provider()
        self._api_checked = True
    
    # === –ì–õ–ê–í–ù–´–ô –ë–ï–°–ö–û–ù–ï–ß–ù–´–ô –¶–ò–ö–õ ===
    while self.running:                                      # –°—Ç—Ä–æ–∫–∞ 2254
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ –∞–≤—Ç–æ—Ç–æ—Ä–≥–æ–≤–ª—è
            if not self.state_manager.get_auto_trade_enabled():
                time.sleep(self._sleep_interval)
                continue
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –≤–∞–ª—é—Ç
            perms = self.state_manager.get_trading_permissions()  # –°—Ç—Ä–æ–∫–∞ 2259
            
            if not perms:
                time.sleep(self._sleep_interval)
                continue
            
            # ============================================
            # === –í–û–¢ –ó–î–ï–°–¨: –¶–ò–ö–õ –ü–ï–†–ï–ë–û–†–ê –í–ê–õ–Æ–¢ ===
            # ============================================
            for base in perms:                               # –°—Ç—Ä–æ–∫–∞ 2273
                try:
                    # 1. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ WebSocket
                    self._ensure_ws_subscription(base, quote)
                    
                    # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
                    price = self._get_market_price(base, quote)
                    
                    if not price or price <= 0:
                        continue
                    
                    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ü–∏–∫–ª–∞
                    self._ensure_cycle_struct(base)
                    cycle = self.cycles.get(base, {})
                    
                    # 4. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –í–ê–õ–Æ–¢–´
                    if cycle.get('active'):
                        # –¶–∏–∫–ª –ê–ö–¢–ò–í–ï–ù - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–¥–∞–∂—É –∏ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ
                        self._try_sell(base, quote)    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –ø—Ä–æ–¥–∞–∂–∏
                        self._try_rebuy(base, quote)   # –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
                    else:
                        # –¶–∏–∫–ª –ù–ï –∞–∫—Ç–∏–≤–µ–Ω - –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª
                        self._try_start_cycle(base, quote)
                
                except Exception:
                    pass  # –û—à–∏–±–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è!
            
            # –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–µ—Ä–µ–±–æ—Ä–∞ –≤–∞–ª—é—Ç (—Å—Ç—Ä–æ–∫–∞ 2310)
        
        except Exception:
            pass  # –û—à–∏–±–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è!
        
        # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–µ–π
        time.sleep(self._sleep_interval)                     # –°—Ç—Ä–æ–∫–∞ 2318
```

---

## üìù –ì–¥–µ –∏–º–µ–Ω–Ω–æ –¥–µ–ª–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∞–ª—é—Ç

### –í–∞—Ä–∏–∞–Ω—Ç 1: –í–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ `for base in perms:` (—Å—Ç—Ä–æ–∫–∞ 2273)

**–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
for base in perms:                                    # –°—Ç—Ä–æ–∫–∞ 2273
    try:
        # 1. –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ WebSocket (—Å—Ç—Ä–æ–∫–∞ 2276-2277)
        self._ensure_ws_subscription(base, quote)
        
        # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—ã (—Å—Ç—Ä–æ–∫–∞ 2279-2282)
        price = self._get_market_price(base, quote)
        if not price or price <= 0:
            continue
        
        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (—Å—Ç—Ä–æ–∫–∞ 2284-2286)
        self._ensure_cycle_struct(base)
        cycle = self.cycles.get(base, {})
        
        # 4. –ó–î–ï–°–¨ –ü–†–û–ò–°–•–û–î–ò–¢ –û–ë–†–ê–ë–û–¢–ö–ê –í–ê–õ–Æ–¢–´ (—Å—Ç—Ä–æ–∫–∞ 2298-2308)
        if cycle.get('active'):
            self._try_sell(base, quote)
            self._try_rebuy(base, quote)
        else:
            self._try_start_cycle(base, quote)
    
    except Exception:
        pass
```

---

## üéØ –¢–æ—á–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞

### 1Ô∏è‚É£ **–ü–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤–∞–ª—é—Ç—ã** (—Å—Ç—Ä–æ–∫–∞ ~2275)
```python
for base in perms:
    # === –í–ê–®–ê –û–ë–†–ê–ë–û–¢–ö–ê –î–û –û–°–ù–û–í–ù–û–ô –õ–û–ì–ò–ö–ò ===
    # –ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç.–¥.
    
    try:
        self._ensure_ws_subscription(base, quote)
        # ...
```

### 2Ô∏è‚É£ **–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã** (—Å—Ç—Ä–æ–∫–∞ ~2283)
```python
price = self._get_market_price(base, quote)
if not price or price <= 0:
    continue

# === –í–ê–®–ê –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–°–õ–ï –ü–û–õ–£–ß–ï–ù–ò–Ø –¶–ï–ù–´ ===
# –ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤, –∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ –∏ —Ç.–¥.

self._ensure_cycle_struct(base)
# ...
```

### 3Ô∏è‚É£ **–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–∏–∫–ª–∞, –ø–µ—Ä–µ–¥ —Ç–æ—Ä–≥–æ–≤—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏** (—Å—Ç—Ä–æ–∫–∞ ~2297)
```python
self._ensure_cycle_struct(base)
cycle = self.cycles.get(base, {})

# === –í–ê–®–ê –û–ë–†–ê–ë–û–¢–ö–ê –ü–ï–†–ï–î –¢–û–†–ì–û–í–´–ú–ò –†–ï–®–ï–ù–ò–Ø–ú–ò ===
# –ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

if cycle.get('active'):
    # ...
```

### 4Ô∏è‚É£ **–í–º–µ—Å—Ç–æ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏** (—Å—Ç—Ä–æ–∫–∞ 2298-2308)
–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É:
```python
# –ë—ã–ª–æ:
if cycle.get('active'):
    self._try_sell(base, quote)
    self._try_rebuy(base, quote)
else:
    self._try_start_cycle(base, quote)

# –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞:
# === –í–ê–®–ê –°–û–ë–°–¢–í–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò ===
self._your_custom_logic(base, quote, cycle, price)
```

### 5Ô∏è‚É£ **–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∞–ª—é—Ç—ã** (—Å—Ç—Ä–æ–∫–∞ ~2309)
```python
        else:
            self._try_start_cycle(base, quote)
        
        # === –í–ê–®–ê –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–°–õ–ï –û–°–ù–û–í–ù–û–ô –õ–û–ì–ò–ö–ò ===
        # –ù–∞–ø—Ä–∏–º–µ—Ä: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    
    except Exception:
        pass
```

---

## üìä –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ü–∏–∫–ª–∞

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–∏ `for base in perms:`:

- **`base`** - —Ç–µ–∫—É—â–∞—è –≤–∞–ª—é—Ç–∞ (str): `"SOL"`, `"ETH"`, `"BTC"` –∏ —Ç.–¥.
- **`quote`** - –∫–æ—Ç–∏—Ä—É–µ–º–∞—è –≤–∞–ª—é—Ç–∞ (str): `"USDT"` (–ø–æ–ª—É—á–µ–Ω–∞ –≤ —Å—Ç—Ä–æ–∫–µ 2244)
- **`price`** - —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (float): –ø–æ–ª—É—á–µ–Ω–∞ –∏–∑ `_get_market_price()`
- **`cycle`** - —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ü–∏–∫–ª–∞ (dict): `{'active': bool, 'active_step': int, ...}`
- **`self.cycles`** - –≤—Å–µ —Ü–∏–∫–ª—ã (dict): `{'SOL': {...}, 'ETH': {...}, ...}`
- **`self.state_manager`** - –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **`self.ws_manager`** - –º–µ–Ω–µ–¥–∂–µ—Ä WebSocket
- **`self.api_client_provider`** - –ø—Ä–æ–≤–∞–π–¥–µ—Ä API –∫–ª–∏–µ–Ω—Ç–∞

---

## ‚ö° –ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–≤–æ–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

```python
for base in perms:
    try:
        # === –í–ê–®–ê –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê ===
        print(f"[DEBUG] –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∞–ª—é—Ç—ã: {base}")
        
        # –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ WebSocket
        self._ensure_ws_subscription(base, quote)
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—ã
        price = self._get_market_price(base, quote)
        
        if not price or price <= 0:
            print(f"[DEBUG] {base}: –¶–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
            continue
        
        # === –í–ê–®–ê –ü–†–û–í–ï–†–ö–ê –¶–ï–ù–´ ===
        if price < 0.01 or price > 100000:
            print(f"[DEBUG] {base}: –¶–µ–Ω–∞ –≤–Ω–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: {price}")
            continue
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ü–∏–∫–ª–∞
        self._ensure_cycle_struct(base)
        cycle = self.cycles.get(base, {})
        
        # === –í–ê–®–ê –õ–û–ì–ò–ö–ê –†–ï–®–ï–ù–ò–ô ===
        if cycle.get('active'):
            print(f"[DEBUG] {base}: –¶–∏–∫–ª –∞–∫—Ç–∏–≤–µ–Ω, —à–∞–≥ {cycle.get('active_step')}")
            self._try_sell(base, quote)
            self._try_rebuy(base, quote)
        else:
            print(f"[DEBUG] {base}: –¶–∏–∫–ª –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, –ø–æ–ø—ã—Ç–∫–∞ —Å—Ç–∞—Ä—Ç–∞")
            self._try_start_cycle(base, quote)
        
        # === –í–ê–®–ê POST-–û–ë–†–ê–ë–û–¢–ö–ê ===
        print(f"[DEBUG] {base}: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
    
    except Exception as e:
        print(f"[ERROR] {base}: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {str(e)}")
        traceback.print_exc()
```

---

## üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. Exception handling
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ–∫—É—â–∏–π –∫–æ–¥ –ø—Ä–æ–≥–ª–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏:
```python
except Exception:
    pass  # –ù–∏—á–µ–≥–æ –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è!
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç–µ —Å–≤–æ–π –∫–æ–¥, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ª–æ–≥–∏—Ä—É–π—Ç–µ –æ—à–∏–±–∫–∏:
```python
except Exception as e:
    print(f"[ERROR][{base}] {str(e)}")
    traceback.print_exc()
```

### 2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
–¶–∏–∫–ª –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–∫–∞–∂–¥—ã–µ 0.5 —Å–µ–∫—É–Ω–¥—ã** –¥–ª—è **–≤—Å–µ—Ö –≤–∞–ª—é—Ç**.  
–ï—Å–ª–∏ –≤–∞—à–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–ª–≥–∞—è - —ç—Ç–æ –∑–∞–º–µ–¥–ª–∏—Ç –≤–µ—Å—å —Ü–∏–∫–ª.

### 3. –ü–æ—Ä—è–¥–æ–∫ –≤–∞–ª—é—Ç
–ü–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ–±–æ—Ä–∞ = –ø–æ—Ä—è–¥–æ–∫ –≤ —Å–ø–∏—Å–∫–µ `perms` (–ø–æ–ª—É—á–µ–Ω –∏–∑ `state_manager`).

### 4. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Ü–∏–∫–ª–∞
`continue` - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–∞–ª—é—Ç—É  
`break` - –ø—Ä–µ—Ä–≤–∞—Ç—å –≤–µ—Å—å —Ü–∏–∫–ª –ø–µ—Ä–µ–±–æ—Ä–∞ –≤–∞–ª—é—Ç

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã

### –í—ã–∑—ã–≤–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞:
- `_ensure_ws_subscription()` - —Å—Ç—Ä–æ–∫–∞ 2277
- `_get_market_price()` - —Å—Ç—Ä–æ–∫–∞ 2280
- `_ensure_cycle_struct()` - —Å—Ç—Ä–æ–∫–∞ 2298
- `_try_sell()` - —Å—Ç—Ä–æ–∫–∞ 2304
- `_try_rebuy()` - —Å—Ç—Ä–æ–∫–∞ 2305
- `_try_start_cycle()` - —Å—Ç—Ä–æ–∫–∞ 2308

---

**–ò—Ç–æ–≥–æ:** –¶–∏–∫–ª –ø–µ—Ä–µ–±–æ—Ä–∞ –≤–∞–ª—é—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ **—Å—Ç—Ä–æ–∫–∞—Ö 2273-2310** —Ñ–∞–π–ª–∞ `autotrader.py`.

**–°–æ–∑–¥–∞–Ω–æ:** 5 –¥–µ–∫–∞–±—Ä—è 2025 –≥., 13:30  
**–î–ª—è:** –ü–æ–Ω–∏–º–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–µ—Ä–µ–¥ –≤–Ω–µ—Å–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π
