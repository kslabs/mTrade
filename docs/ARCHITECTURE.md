# 🏗️ Архитектура mTrade Platform

## 📊 Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                    КЛИЕНТЫ (Устройства)                      │
│  💻 Компьютер  │  📱 Телефон  │  📱 Планшет  │  💻 Другой ПК │
└────────────────┬────────────────────────────────────────────┘
                 │
                 │ HTTP (Port 5000)
                 │
┌────────────────▼────────────────────────────────────────────┐
│                    FLASK WEB SERVER                          │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              ProcessManager                           │   │
│  │  - Создает PID файл (mtrade_server.pid)             │   │
│  │  - Graceful Shutdown                                 │   │
│  │  - Изолированное управление процессом               │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              REST API Endpoints                       │   │
│  │  /api/server/status      - Статус сервера           │   │
│  │  /api/server/restart     - Рестарт                  │   │
│  │  /api/server/shutdown    - Остановка                │   │
│  │  /api/accounts           - Управление аккаунтами    │   │
│  │  /api/mode               - Переключение режима      │   │
│  │  /api/balance            - Баланс                   │   │
│  │  /api/trade              - Торговля                 │   │
│  │  /api/orders             - Ордера                   │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Business Logic                           │   │
│  │  ┌──────────────┐  ┌──────────────┐                 │   │
│  │  │ Account      │  │ Trading      │                 │   │
│  │  │ Manager      │  │ Engine       │                 │   │
│  │  │              │  │              │                 │   │
│  │  │ - Add/List   │  │ - Normal     │                 │   │
│  │  │ - Switch     │  │ - Copy       │                 │   │
│  │  │ - Store      │  │ - Execute    │                 │   │
│  │  └──────────────┘  └──────────────┘                 │   │
│  │                                                       │   │
│  │  ┌────────────────────────────────┐                 │   │
│  │  │      GateAPIClient             │                 │   │
│  │  │                                │                 │   │
│  │  │  - Authentication              │                 │   │
│  │  │  - Signature generation        │                 │   │
│  │  │  - Spot trading                │                 │   │
│  │  │  - Futures trading             │                 │   │
│  │  │  - Copy trading                │                 │   │
│  │  └────────────────────────────────┘                 │   │
│  └──────────────────────────────────────────────────────┘   │
└────────────────┬────────────────────────────────────────────┘
                 │
                 │ HTTPS API Calls
                 │
┌────────────────▼────────────────────────────────────────────┐
│                    Gate.io API                               │
│            https://api.gateio.ws/api/v4                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 Управление процессом

```
┌──────────────────────────────────────────────────────────────┐
│                  УПРАВЛЕНИЕ СЕРВЕРОМ                          │
└──────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  START.bat  │    │  STOP.bat   │    │ RESTART.bat │
│     или     │    │     или     │    │     или     │
│  start.py   │    │   stop.py   │    │ restart.py  │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │
       │                  │                  │
       ▼                  ▼                  ▼
┌──────────────────────────────────────────────────────┐
│            ProcessManager (PID System)                │
│                                                       │
│  1. Проверяет mtrade_server.pid                     │
│  2. Управляет ТОЛЬКО процессом mTrade               │
│  3. НЕ трогает другие серверы/процессы              │
│  4. Graceful shutdown                                │
└──────────────────────────────────────────────────────┘
       │
       │  Управляет процессом
       │
       ▼
┌──────────────────────────────────────────────────────┐
│         mTrade.py (Flask Server Process)             │
│                  PID: xxxxx                          │
└──────────────────────────────────────────────────────┘
```

---

## 🔐 Безопасность и изоляция

```
┌─────────────────────────────────────────────────────────┐
│          КОМПЬЮТЕР (Несколько серверов)                  │
│                                                          │
│  ┌────────────────┐       ┌────────────────┐           │
│  │  Другой сервер │       │  mTrade Server │           │
│  │  (Port 8000)   │       │  (Port 5000)   │           │
│  │  PID: 1111     │       │  PID: 2222     │           │
│  │  other.pid     │       │  mtrade_       │           │
│  │                │       │  server.pid    │           │
│  └────────────────┘       └────────┬───────┘           │
│         ▲                          │                    │
│         │                          │                    │
│         │  НЕ ЗАТРАГИВАЕТСЯ!       │  УПРАВЛЯЕТСЯ      │
│         │                          │                    │
│  ┌──────┴──────────────────────────▼─────────┐         │
│  │      ProcessManager                        │         │
│  │  - Читает mtrade_server.pid               │         │
│  │  - Управляет ТОЛЬКО PID 2222              │         │
│  │  - Игнорирует все остальные процессы      │         │
│  └────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────┘
```

---

## 📂 Файловая структура

```
bGate.mTrade/
│
├── 🐍 Python Scripts
│   ├── mTrade.py          ← Главный сервер
│   ├── start.py           ← Запуск
│   ├── stop.py            ← Остановка
│   ├── restart.py         ← Перезапуск
│   └── status.py          ← Статус
│
├── 🪟 Windows BAT Files
│   ├── START.bat          ← Запуск (двойной клик)
│   ├── STOP.bat           ← Остановка
│   ├── RESTART.bat        ← Перезапуск
│   └── STATUS.bat         ← Статус
│
├── 🌐 Web Interface
│   └── templates/
│       └── index.html     ← Веб-интерфейс
│
├── ⚙️ Configuration
│   ├── requirements.txt   ← Зависимости
│   ├── config.json        ← Настройки (авто)
│   └── accounts.json      ← API ключи (авто)
│
├── 🔒 Process Control
│   └── mtrade_server.pid  ← PID файл (авто)
│
└── 📚 Documentation
    ├── README.md          ← Полная документация
    └── QUICKSTART.md      ← Быстрый старт
```

---

## 🔄 Жизненный цикл процесса

```
┌─────────────┐
│   START     │
└──────┬──────┘
       │
       │ 1. Проверка: не запущен ли уже?
       │    (mtrade_server.pid exists?)
       │
       ▼
┌──────────────────────────────┐
│  Создать PID файл            │
│  mtrade_server.pid = 12345   │
└──────┬───────────────────────┘
       │
       │ 2. Setup cleanup handlers
       │    (atexit, signal handlers)
       │
       ▼
┌──────────────────────────────┐
│  Запуск Flask сервера        │
│  host='0.0.0.0', port=5000   │
└──────┬───────────────────────┘
       │
       │ 3. Сервер работает
       │
       ▼
┌─────────────────────────────────────────┐
│  РАБОТА СЕРВЕРА                         │
│  - Обработка HTTP запросов              │
│  - Торговля через Gate.io API           │
│  - Управление аккаунтами                │
│  - Доступ с разных устройств            │
└──────┬──────────────────────────────────┘
       │
       │ 4. Получен сигнал остановки
       │    (Ctrl+C / STOP / Shutdown API)
       │
       ▼
┌──────────────────────────────┐
│  Graceful Shutdown           │
│  - Закрыть соединения        │
│  - Удалить PID файл          │
│  - Освободить ресурсы        │
└──────┬───────────────────────┘
       │
       ▼
┌─────────────┐
│   STOPPED   │
└─────────────┘
```

---

## 🌐 Доступ с разных устройств

```
┌────────────────────────────────────────────────────────┐
│              ДОМАШНЯЯ СЕТЬ (192.168.1.x)               │
│                                                         │
│  ┌──────────────────┐                                  │
│  │   Компьютер      │  ← Сервер запущен здесь         │
│  │   IP: 192.168    │     http://localhost:5000        │
│  │        .1.100    │                                  │
│  └────────┬─────────┘                                  │
│           │                                             │
│           │  Port 5000                                 │
│           │                                             │
│  ─────────┼───────────────────────────────────────     │
│           │   Локальная сеть                           │
│  ─────────┼───────────────────────────────────────     │
│           │                                             │
│     ┌─────┴────┬────────┬─────────┐                    │
│     │          │        │         │                     │
│  ┌──▼───┐  ┌──▼───┐ ┌──▼───┐  ┌──▼───┐               │
│  │ 📱   │  │ 💻   │ │ 📱   │  │ 💻   │               │
│  │Phone │  │Laptop│ │Tablet│  │  PC  │               │
│  │      │  │      │ │      │  │      │               │
│  └──────┘  └──────┘ └──────┘  └──────┘               │
│                                                         │
│  Все устройства открывают:                             │
│  http://192.168.1.100:5000                             │
└────────────────────────────────────────────────────────┘
```

---

## 🎨 Режимы торговли

```
┌─────────────────────────────────────────────────────┐
│              Trading Engine                          │
│                                                      │
│  ┌────────────────┐      ┌────────────────┐        │
│  │  Normal Mode   │      │   Copy Mode    │        │
│  │                │      │                │        │
│  │  • Manual      │      │  • Auto Copy   │        │
│  │  • Full Control│      │  • Follow      │        │
│  │  • Spot/Futures│◄────►│  • Futures     │        │
│  │                │ Toggle│                │        │
│  └────────┬───────┘      └────────┬───────┘        │
│           │                       │                 │
│           └───────────┬───────────┘                 │
│                       │                             │
│                       ▼                             │
│           ┌────────────────────┐                    │
│           │   GateAPIClient    │                    │
│           └────────┬───────────┘                    │
│                    │                                │
└────────────────────┼────────────────────────────────┘
                     │
                     ▼
              Gate.io Exchange
```

---

## 🔧 Технологический стек

```
┌───────────────────────────────────────┐
│          Frontend                      │
│  • HTML5                               │
│  • CSS3 (Modern UI)                    │
│  • Vanilla JavaScript                  │
│  • Fetch API                           │
└───────────────┬───────────────────────┘
                │
                │ HTTP/JSON
                │
┌───────────────▼───────────────────────┐
│          Backend                       │
│  • Python 3.x                          │
│  • Flask (Web Framework)               │
│  • Requests (HTTP Client)              │
│  • HMAC/SHA512 (Authentication)        │
└───────────────┬───────────────────────┘
                │
                │ HTTPS/REST
                │
┌───────────────▼───────────────────────┐
│       External Service                 │
│  • Gate.io API v4                      │
│  • Spot Trading                        │
│  • Futures Trading                     │
│  • Copy Trading                        │
└───────────────────────────────────────┘
```

---

**Версия:** 1.0.0  
**Дата:** 4 ноября 2025  
**Статус:** Production Ready ✅
