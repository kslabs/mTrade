# Удаление логики частичных покупок (pending)

**Дата:** 2024
**Версия:** Final

## Проблема

Код содержал обширную логику для обработки **частичных покупок** (`pending.start`, `pending.rebuy`, `pending.sell`), которая:

1. **Противоречила используемым FOK (Fill-Or-Kill) ордерам**
2. **Создавала потенциальные гонки** между потоками
3. **Усложняла код** без практической пользы
4. **Могла вызывать "ложные" покупки** для отключенных валют

## Решение

Полное удаление всей логики `pending` из кода, так как:

### FOK ордера гарантируют "все или ничего"

- **FOK** (Fill-Or-Kill) = ордер либо исполняется **полностью**, либо **отменяется**
- **Частичное исполнение невозможно** по определению FOK
- Вся логика `pending` была избыточной и мертвой

## Изменения в коде

### 1. Удалено поле `pending` из структуры цикла

**Было:**
```python
self.cycles[base] = {
    'active': False,
    'active_step': -1,
    'table': [],
    'last_buy_price': 0.0,
    'start_price': 0.0,
    'total_invested_usd': 0.0,
    'base_volume': 0.0,
    'pending': {},  # ❌ УДАЛЕНО
    'pending_start': False  # ❌ УДАЛЕНО
}
```

**Стало:**
```python
self.cycles[base] = {
    'active': False,
    'active_step': -1,
    'table': [],
    'last_buy_price': 0.0,
    'start_price': 0.0,
    'total_invested_usd': 0.0,
    'base_volume': 0.0
}
```

### 2. Удалена логика `pending.start` (частичная стартовая покупка)

**Удалено ~80 строк кода** обработки частичной стартовой покупки в `_try_start_cycle_impl()`:

- Проверка `pending.start`
- Докупка остатка через `pending.start.remaining`
- Активация цикла после завершения `pending.start`
- Сохранение `pending.start` при частичном исполнении

### 3. Удалена логика `pending.rebuy` (частичная докупка)

**Удалено ~70 строк кода** обработки частичной докупки в `_try_rebuy()`:

- Проверка `pending.rebuy`
- Докупка остатка через `pending.rebuy.remaining`
- Обновление шага после завершения `pending.rebuy`
- Сохранение `pending.rebuy` при частичном исполнении

### 4. Удалена логика `pending.sell` (частичная продажа)

**Удалено ~100 строк кода** обработки частичной продажи в `_try_sell()`:

- Проверка `pending.sell`
- Продажа остатка через `pending.sell.remaining`
- Закрытие цикла после завершения `pending.sell`
- Сохранение `pending.sell` при частичном исполнении

### 5. Удален флаг `pending_start`

**Удалено ~15 использований** флага `pending_start`:

- Проверка `if cycle.get('pending_start')` в `_try_start_cycle()`
- Установка `cycle['pending_start'] = True` перед покупкой
- Сброс `cycle['pending_start'] = False` после покупки/неудачи
- Сохранение `pending_start` в state

### 6. Упрощена логика save/restore циклов

**Было:**
```python
# Сохранение: проверка pending и сохранение циклов с pending
pending = cycle.get('pending') or {}
has_pending = False
for k, v in pending.items():
    if isinstance(v, dict) and float(v.get('remaining', 0) or 0) > 0:
        has_pending = True
        break

if cycle.get('active') or has_pending:
    state_to_save[base] = {
        'active': cycle.get('active', False),
        'pending': pending,  # ❌ УДАЛЕНО
        ...
    }
```

**Стало:**
```python
# Сохранение: только активные циклы
if cycle.get('active'):
    state_to_save[base] = {
        'active': cycle.get('active', False),
        ...
    }
```

### 7. Добавлены предупреждения о невозможности частичного исполнения

```python
# В _try_start_cycle_impl():
if filled_amt > 0:
    print(f"[WARNING][{base}] Частичное исполнение FOK ордера (filled={filled_amt:.8f})! Это не должно происходить!")

# В _try_sell():
if filled_amt > 0:
    print(f"[WARNING][{base}] Частичное исполнение FOK ордера продажи (filled={filled_amt:.8f})! Это не должно происходить!")
```

## Преимущества

### 1. Простота и понятность кода
- **Удалено ~250 строк** сложной логики
- **Линейный flow**: попытка → успех/неудача
- **Нет состояний "частично исполнено"**

### 2. Надежность
- **Невозможны гонки** через `pending` между потоками
- **Невозможны "ложные" покупки** через `pending.start`
- **Четкие границы**: цикл либо активен, либо нет

### 3. Соответствие FOK логике
- Код **полностью соответствует** поведению FOK ордеров
- **Нет противоречий** между типом ордера и логикой обработки

### 4. Защита от багов
- **Невозможна** покупка для отключенных валют через `pending`
- **Невозможно** частичное исполнение FOK ордера
- **Если частичное исполнение происходит** → warning в логах

## Тестирование

После удаления логики `pending`:

1. **Проверить синтаксис**: ✅ Нет ошибок
2. **Проверить торговлю**: 
   - Стартовая покупка работает (FOK)
   - Докупка работает (FOK)
   - Продажа работает (FOK)
3. **Проверить permissions**:
   - Отключенные валюты НЕ торгуются
   - НЕТ "ложных" покупок

## Итог

**Удаление логики `pending` сделало код:**
- ✅ **Проще** (−250 строк)
- ✅ **Надежнее** (нет гонок)
- ✅ **Правильнее** (соответствует FOK)
- ✅ **Безопаснее** (нет "ложных" покупок)

**Функциональность сохранена на 100%**, так как логика `pending` **никогда не использовалась** с FOK ордерами.
