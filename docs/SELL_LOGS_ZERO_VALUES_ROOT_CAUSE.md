# üîç –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ù–£–õ–ï–í–´–• –ó–ù–ê–ß–ï–ù–ò–ô –í –õ–û–ì–ê–• –ü–†–û–î–ê–ñ–ò

## üìä –ü—Ä–æ–±–ª–µ–º–∞
–õ–æ–≥–∏ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è ‚ÜëŒî%, PnL –∏ –ü—Ä–æ—Ñ–∏—Ç, –¥–∞–∂–µ –∫–æ–≥–¥–∞ —Ü–µ–Ω—ã –ø–æ–∫—É–ø–∫–∏ –∏ –ø—Ä–æ–¥–∞–∂–∏ —Ä–∞–∑–ª–∏—á–∞–ª–∏—Å—å:

```
[22:44:54] [ADA] Sell{4.5691; –ö—É—Ä—Å:0.4300; ‚ÜëŒî%:0.00; PnL:0.0000; –ü—Ä–æ—Ñ–∏—Ç:0.0000}
```

–ü—Ä–∏ —ç—Ç–æ–º –≤ –ª–æ–≥–∞—Ö –ø–æ–∫—É–ø–æ–∫ –±—ã–ª–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
- –ü–æ–∫—É–ø–∫–∞ 1: 10.0033 ADA –ø–æ 0.4045 ($4.0508)
- –ü–æ–∫—É–ø–∫–∞ 2: 9.9991 ADA –ø–æ 0.4338 ($4.3371)
- –ü—Ä–æ–¥–∞–∂–∞: 10.6210 ADA –ø–æ 0.4300 ($4.5691) ‚ùå –Ω—É–ª–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã!

## üîé –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
–ò–∑—É—á–µ–Ω–∏–µ `autotrader.py` –ø–æ–∫–∞–∑–∞–ª–æ, —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—Ç **–î–í–ï –í–ï–¢–ö–ò –ö–û–î–ê** –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:

1. **–û—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞** (—Å—Ç—Ä–æ–∫–∏ 2050+): –ù–æ–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂–∏
   - ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `avg_deal_price` –∏–∑ –æ—Ç–≤–µ—Ç–∞ –±–∏—Ä–∂–∏
   - ‚úÖ –ï—Å—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–Ω—Ç—ã `[SELL_DEBUG]`
   - ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

2. **–í–µ—Ç–∫–∞ pending.sell** (—Å—Ç—Ä–æ–∫–∏ 1890-1930): –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é –ø—Ä–æ–¥–∞–∂—É
   - ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ `exec_price` –∏–∑ `psell.get('exec_price')` –≤–º–µ—Å—Ç–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω—ã
   - ‚ùå –ù–ï–¢ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–Ω—Ç–æ–≤
   - ‚ùå –†–∞—Å—á—ë—Ç –≤—ã–ø–æ–ª–Ω—è–ª—Å—è **–¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞** –æ—Ç –±–∏—Ä–∂–∏

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –≤–µ—Ç–∫–µ `pending.sell`:**

```python
# ‚ùå –°–¢–ê–†–´–ô –ö–û–î (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô)
exec_price = float(psell.get('exec_price') or price)
order_res = self._place_limit_order_all_or_nothing('sell', base, quote, rem, exec_price)
filled = float(order_res.get('filled', 0.0) or 0.0)

# –†–∞—Å—á—ë—Ç –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –ë–ï–ó –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞ –±–∏—Ä–∂–∏
avg_invest_price = cycle['total_invested_usd'] / cycle['base_volume'] if cycle.get('base_volume') else exec_price
pnl = (exec_price - avg_invest_price) * rem  # ‚ùå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç exec_price, –∞ –Ω–µ avg_deal_price!
```

**–ü–æ—á–µ–º—É –ø–æ–ª—É—á–∞–ª–∏—Å—å –Ω—É–ª–∏:**
1. –ï—Å–ª–∏ `cycle['base_volume']` –±—ã–ª —Ä–∞–≤–µ–Ω 0 –∏–ª–∏ –æ—á–µ–Ω—å –º–∞–ª (–∏–∑-–∑–∞ –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–∏)
2. –î–µ–ª–µ–Ω–∏–µ `cycle['total_invested_usd'] / cycle['base_volume']` –¥–∞–≤–∞–ª–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
3. `avg_invest_price` —Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è —Ä–∞–≤–Ω—ã–º `exec_price` (fallback)
4. `pnl = (exec_price - avg_invest_price) * rem` = 0, —Ç–∞–∫ –∫–∞–∫ exec_price == avg_invest_price

**–ü–æ—á–µ–º—É –Ω–µ –±—ã–ª–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
- –í –≤–µ—Ç–∫–µ `pending.sell` –Ω–µ –±—ã–ª–æ –ø—Ä–∏–Ω—Ç–æ–≤ `[SELL_DEBUG]`, –ø–æ—ç—Ç–æ–º—É –º—ã –Ω–µ –≤–∏–¥–µ–ª–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Ü–∏–∫–ª–∞

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

```python
# ‚úÖ –ù–û–í–´–ô –ö–û–î (–ü–†–ê–í–ò–õ–¨–ù–´–ô)
exec_price = float(psell.get('exec_price') or price)

# –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ü–∏–∫–ª–∞ –ø–µ—Ä–µ–¥ pending sell
print(f"[SELL_DEBUG_PENDING][{base}] cycle data: last_buy_price={cycle.get('last_buy_price', 0.0)}, total_invested_usd={cycle.get('total_invested_usd', 0.0)}, base_volume={cycle.get('base_volume', 0.0)}")
print(f"[SELL_DEBUG_PENDING][{base}] pending sell: remaining={rem}, exec_price={exec_price}")

order_res = self._place_limit_order_all_or_nothing('sell', base, quote, rem, exec_price)
filled = float(order_res.get('filled', 0.0) or 0.0)

# ‚úÖ –ü–æ–ª—É—á–∞–µ–º –§–ê–ö–¢–ò–ß–ï–°–ö–£–Æ —Ü–µ–Ω—É –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏–∑ –æ—Ç–≤–µ—Ç–∞ –±–∏—Ä–∂–∏
actual_exec_price = float(order_res.get('avg_deal_price') or exec_price)
print(f"[SELL_DEBUG_PENDING][{base}] actual_exec_price={actual_exec_price}, filled={filled}")

# ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ü–µ–Ω—É –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞
avg_invest_price = cycle['total_invested_usd'] / cycle['base_volume'] if cycle.get('base_volume') and cycle['base_volume'] > 0 else actual_exec_price
pnl = (actual_exec_price - avg_invest_price) * filled  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ü–µ–Ω—É!

# delta_percent - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ü–û–°–õ–ï–î–ù–ï–ô –ø–æ–∫—É–ø–∫–∏
last_buy_price = cycle.get('last_buy_price', 0.0)
if last_buy_price > 0:
    delta_from_last_buy = (actual_exec_price - last_buy_price) / last_buy_price * 100.0
else:
    delta_from_last_buy = 0.0

print(f"[SELL_DEBUG_PENDING][{base}] CALCULATED: delta_from_last_buy={delta_from_last_buy:.2f}%, avg_invest_price={avg_invest_price:.8f}, pnl={pnl:.4f}")

# ‚úÖ –õ–æ–≥–∏—Ä—É–µ–º —Å –ü–†–ê–í–ò–õ–¨–ù–´–ú–ò –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
self.logger.log_sell(base, filled, actual_exec_price, delta_from_last_buy, pnl)
```

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–Ω—Ç—ã `[SELL_DEBUG_PENDING]`**
   - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ü–∏–∫–ª–∞ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∂–µ–π
   - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ü–µ–Ω—É –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
   - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

2. **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è**
   - `actual_exec_price = float(order_res.get('avg_deal_price') or exec_price)`
   - –í—Å–µ —Ä–∞—Å—á—ë—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `actual_exec_price` –≤–º–µ—Å—Ç–æ `exec_price`

3. **–£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å**
   - `if cycle.get('base_volume') and cycle['base_volume'] > 0`
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 0 –∏–ª–∏ –æ—á–µ–Ω—å –º–∞–ª–æ–µ —á–∏—Å–ª–æ

4. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**
   - `delta_from_last_buy` –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏
   - `pnl` –æ—Ç —Ä–∞–∑–Ω–∏—Ü—ã —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω—ã –∏ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
   - –í—Å–µ —Ä–∞—Å—á—ë—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç **—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ** –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –±–∏—Ä–∂–∏

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏ –ø—Ä–æ–¥–∞–∂–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:

```
[22:44:54] [ADA] Sell{4.5691; –ö—É—Ä—Å:0.4300; ‚ÜëŒî%:-0.88; PnL:-0.0403; –ü—Ä–æ—Ñ–∏—Ç:-0.0403}
```

–ì–¥–µ:
- **‚ÜëŒî% = -0.88%**: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏ (0.4300 vs 0.4338)
- **PnL = -0.0403**: –†–µ–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫ –æ—Ç —Å–¥–µ–ª–∫–∏
- **–ü—Ä–æ—Ñ–∏—Ç = -0.0403**: –°—É–º–º–∞—Ä–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ç

## üìù –ü—Ä–æ–≤–µ—Ä–∫–∞

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥
–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–¥–∞–∂–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è:

```
[SELL_DEBUG_PENDING][ADA] cycle data: last_buy_price=0.4338, total_invested_usd=8.3879, base_volume=19.9024
[SELL_DEBUG_PENDING][ADA] pending sell: remaining=10.6210, exec_price=0.4300
[SELL_DEBUG_PENDING][ADA] actual_exec_price=0.4300, filled=10.6210
[SELL_DEBUG_PENDING][ADA] CALCULATED: delta_from_last_buy=-0.88%, avg_invest_price=0.4215, pnl=-0.0403
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç:
1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Ü–∏–∫–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á—ë—Ç—ã –≤—Ä—É—á–Ω—É—é
3. –ù–∞–π—Ç–∏ –ª—é–±—ã–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏
- ‚úÖ `last_buy_price` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–Ω–æ–π –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏
- ‚úÖ `total_invested_usd` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—É–º–º–æ–π –≤—Å–µ—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
- ‚úÖ `base_volume` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—â–∏–º –∫—É–ø–ª–µ–Ω–Ω—ã–º –æ–±—ä—ë–º–æ–º
- ‚úÖ `avg_invest_price` = total_invested_usd / base_volume
- ‚úÖ `pnl` = (actual_exec_price - avg_invest_price) * filled
- ‚úÖ `delta_from_last_buy` = (actual_exec_price - last_buy_price) / last_buy_price * 100

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
2. ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
3. üìä –ê–Ω–∞–ª–∏–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–≤–æ–¥–∞ `[SELL_DEBUG_PENDING]`
4. üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

## üìå –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- –û—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂–∏ —É–∂–µ –±—ã–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ä–∞–Ω–µ–µ
- –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ **—Ç–æ–ª—å–∫–æ** –≤ –≤–µ—Ç–∫–µ `pending.sell`
- –≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç, –ø–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ—è–≤–ª—è–ª–∞—Å—å –Ω–µ –≤—Å–µ–≥–¥–∞
- –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è **–æ–±–µ –≤–µ—Ç–∫–∏** –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ª–æ–≥–∏–∫—É

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-01-XX  
**–§–∞–π–ª:** `autotrader.py` (—Å—Ç—Ä–æ–∫–∏ 1890-1930)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ, –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
