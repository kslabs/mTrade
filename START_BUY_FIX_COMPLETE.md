# ✅ START BUY FIX - Исправление стартовой покупки

## Проблема

**Симптомы:**
1. Бот делает стартовую покупку
2. Покупка НЕ записывается в лог
3. Цикл НЕ активируется (остается в IDLE)

**Причины:**
1. **Отсутствие логирования** - метод `_try_start_cycle` не записывал покупку в лог
2. **Отсутствие сохранения состояния** - после активации цикла состояние не сохранялось
3. **Преждевременная проверка баланса** - сразу после покупки система проверяла баланс, и если баланс еще не обновился на бирже, сбрасывала только что созданный цикл

## Решение

### 1. Добавлено логирование покупки

**В метод `_try_start_cycle` после активации цикла:**

```python
# ШАГ 4: Логируем покупку в файл
try:
    self.logger.log_action(
        base_currency=base,
        action_type='START_BUY',
        details={
            'cycle_id': cycle.cycle_id,
            'order_id': order_id,
            'price': executed_price,
            'amount': executed_amount,
            'cost_usd': executed_cost,
            'step': 0,
            'message': f'Стартовая покупка - начало цикла #{cycle.cycle_id}'
        }
    )
    print(f"[{base}] [OK] Покупка записана в лог")
except Exception as log_error:
    print(f"[{base}] [WARN] Ошибка записи в лог: {log_error}")

# ШАГ 5: Сохраняем состояние
self._save_state(base)
```

### 2. Добавлена защита от преждевременного сброса

**В метод `_check_and_reset_if_empty` добавлена проверка времени:**

```python
# ЗАЩИТА: Не проверяем баланс сразу после активации (даём время на обновление баланса)
lock = self._get_lock(base)
with lock:
    cycle = self.cycles.get(base)
    if cycle and cycle.is_active():
        time_since_activation = time.time() - cycle.cycle_started_at
        if time_since_activation < 5.0:  # 5 секунд защита
            print(f"[{base}] Цикл только что активирован ({time_since_activation:.1f}s назад), пропускаем проверку баланса")
            return False
```

**Почему это важно:**
- После покупки баланс на бирже обновляется не мгновенно
- Если проверить баланс сразу, система увидит, что монет нет
- И сбросит только что созданный цикл
- Защита в 5 секунд даёт время на обновление баланса

### 3. Добавлено логирование сброса цикла

**В метод `_check_and_reset_if_empty` при сбросе:**

```python
# Логируем сброс
try:
    self.logger.log_action(
        base_currency=base,
        action_type='CYCLE_RESET',
        details={
            'reason': 'insufficient_balance',
            'available': available_base,
            'required': min_base,
            'message': f'Цикл сброшен: недостаточно монет ({available_base} < {min_base})'
        }
    )
except Exception as log_error:
    print(f"[{base}] [WARN] Ошибка записи сброса в лог: {log_error}")

# Сохраняем состояние
self._save_state(base)
```

## Что изменилось

### До исправления:
```
1. Бот делает покупку
2. Баланс еще не обновился
3. Система проверяет баланс → видит 0 монет
4. Сбрасывает цикл
5. Покупка НЕ в логе, цикл НЕ активен
```

### После исправления:
```
1. Бот делает покупку
2. Активирует цикл
3. Записывает в лог: "START_BUY - начало цикла #N"
4. Сохраняет состояние
5. Защита: не проверяет баланс 5 секунд
6. Цикл активен, покупка в логе ✅
```

## Логи теперь показывают

### Стартовая покупка:
```json
{
  "timestamp": 1234567890,
  "base_currency": "ETH",
  "action_type": "START_BUY",
  "details": {
    "cycle_id": 1,
    "order_id": "123456789",
    "price": 2000.50,
    "amount": 0.005,
    "cost_usd": 10.0,
    "step": 0,
    "message": "Стартовая покупка - начало цикла #1"
  }
}
```

### Сброс цикла (если нужен):
```json
{
  "timestamp": 1234567890,
  "base_currency": "ETH",
  "action_type": "CYCLE_RESET",
  "details": {
    "reason": "insufficient_balance",
    "available": 0.0,
    "required": 0.005,
    "message": "Цикл сброшен: недостаточно монет (0.0 < 0.005)"
  }
}
```

## Проверка работы

### 1. Проверить логи
```bash
python check_autotrader_logs.py
```

Должны появиться записи `START_BUY` после покупок.

### 2. Проверить состояние цикла
```bash
python check_cycle_state.py
```

После покупки цикл должен быть `active: True`.

### 3. Проверить консоль
В консоли должны появиться сообщения:
```
[ETH] [OK] Ордер исполнен!
[ETH]   Объём: 0.005 ETH
[ETH]   Цена: 2000.50
[ETH]   Стоимость: 10.0025 USDT
[CYCLE] ✨ Новый цикл #1 активирован!
[ETH] [OK] ЦИКЛ ЗАПУЩЕН!
[ETH] [OK] Покупка записана в лог
[ETH] Цикл только что активирован (0.1s назад), пропускаем проверку баланса
```

## Файлы изменены

- **autotrader_v2.py**
  - Метод `_try_start_cycle`: добавлено логирование и сохранение
  - Метод `_check_and_reset_if_empty`: добавлена защита и логирование
- **check_autotrader_logs.py** (новый)
  - Утилита для проверки логов

## Совместимость

- ✅ Полностью обратно совместим
- ✅ Старые циклы продолжат работать
- ✅ Новые покупки будут логироваться

---

**Дата:** 2024-12-07  
**Статус:** ✅ ИСПРАВЛЕНО И ГОТОВО К ТЕСТИРОВАНИЮ
