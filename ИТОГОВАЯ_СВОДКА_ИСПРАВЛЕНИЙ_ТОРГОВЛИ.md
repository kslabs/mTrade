# –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú –° –¢–û–†–ì–û–í–õ–ï–ô

## üîç –ü–†–û–ë–õ–ï–ú–´, –ö–û–¢–û–†–´–ï –ë–´–õ–ò –û–ë–ù–ê–†–£–ñ–ï–ù–´

### 1. ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –¥–æ–∫—É–ø–∫–∏ (ETH, XRP, DOGE –∏ –¥—Ä.)
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ê–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä–æ–≥ `rebuy_trigger_pct = 2.0%`
- –í–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.73%)
- –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: 3185.16 (–ø—Ä–∞–≤–∏–ª—å–Ω–æ) vs 3144.41 (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

**–ü—Ä–∏—á–∏–Ω–∞:**
- –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä `rebuy_trigger_pct`
- –í–º–µ—Å—Ç–æ –Ω–µ–≥–æ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `decrease_step_pct` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã breakeven

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
rebuy_threshold = last_buy_price * (1.0 - rebuy_trigger_pct / 100.0)

# –°—Ç–∞–ª–æ (–ü–†–ê–í–ò–õ–¨–ù–û):
next_step = cycle.table[next_step_index]
decrease_step_pct = abs(float(next_step.get('decrease_step_pct', 0)))
rebuy_threshold = last_buy_price * (1.0 - decrease_step_pct / 100.0)
```

**–§–∞–π–ª:** `autotrader_v2.py`, —Ñ—É–Ω–∫—Ü–∏—è `_try_rebuy()`

---

### 2. ‚ùå Race condition –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–æ—Å–ª–µ –¥–æ–∫—É–ø–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–æ—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ETH –ø–æ–∫–∞–∑—ã–≤–∞–ª `active_step=-1` –≤–º–µ—Å—Ç–æ `active_step=1`
- –î–≤–∞ –ø–æ—Ç–æ–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª–∏ —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–ü—Ä–∏—á–∏–Ω–∞:**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Lock –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ `autotrader_cycles_state.json`
- –§—É–Ω–∫—Ü–∏—è `_save_state()` –º–æ–≥–ª–∞ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –î–æ–±–∞–≤–∏–ª–∏ Lock –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
self._save_state_lock = threading.Lock()

def _save_state(self, base: str = None):
    # üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: Lock –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race condition!
    with self._save_state_lock:
        # ... —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª
```

**–§–∞–π–ª:** `autotrader_v2.py`

---

### 3. ‚ùå –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (SOL, LINK, ICP)
**–ü—Ä–æ–±–ª–µ–º–∞:**
- `active=true`, –Ω–æ `active_step=-1` (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∫—É–ø–∫–∞—Ö)
- –¶–∏–∫–ª –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π, –Ω–æ —Ç–æ—Ä–≥–æ–≤–ª—è –Ω–µ –≤–µ–¥—ë—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:**
- –§—É–Ω–∫—Ü–∏—è `cycle.reset()` –≤ `_try_sell()` –Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–ª–∞ —Ñ–ª–∞–≥ `active`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –í _try_sell() –∑–∞–º–µ–Ω–∏–ª–∏ –æ–±–Ω—É–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –Ω–∞ –≤—ã–∑–æ–≤ reset()
# –ë—ã–ª–æ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
cycle.active_step = -1
cycle.last_buy_price = 0.0
cycle.start_price = 0.0
cycle.total_invested_usd = 0.0
cycle.base_volume = 0.0
cycle._selling_in_progress = False

# –°—Ç–∞–ª–æ (–ü–†–ê–í–ò–õ–¨–ù–û):
cycle._selling_in_progress = False
cycle.reset(manual=False)  # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ reset()
```

**–§–∞–π–ª:** `autotrader_v2.py`, —Ñ—É–Ω–∫—Ü–∏—è `_try_sell()`

---

## ‚úÖ –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á—ë—Ç –ø–æ—Ä–æ–≥–æ–≤ –¥–æ–∫—É–ø–∫–∏
- –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã breakeven
- –ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–µ–π

### 2. –î–æ–±–∞–≤–ª–µ–Ω Lock –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race condition –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
- –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–¥–∞–∂–∏
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —Ü–∏–∫–ª–∞ —á–µ—Ä–µ–∑ `cycle.reset()`
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–ª—è 4 –≤–∞–ª—é—Ç
- **ETH**: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –¥–æ–∫—É–ø–∫–∏
- **SOL, LINK, ICP**: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (active=false)

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –í–∞–ª—é—Ç—ã —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º:

| –í–∞–ª—é—Ç–∞ | –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|--------|----------|---------|--------|
| **ETH** | active_step=-1 –ø–æ—Å–ª–µ –¥–æ–∫—É–ø–∫–∏ | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ (step=1) | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û |
| **SOL** | active=true, –Ω–æ step=-1 | –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ active=false | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û |
| **LINK** | active=true, –Ω–æ step=-1 | –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ active=false | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û |
| **ICP** | active=true, –Ω–æ step=-1 | –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ active=false | ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û |

### –í–∞–ª—é—Ç—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º:

- **XRP**: active=true, step=1 ‚úÖ
- **DOGE**: active=true, step=1 ‚úÖ
- **ADA**: active=true, step=2 ‚úÖ
- **TAO**: active=true, step=2 ‚úÖ
- **LTC**: active=true, step=1 ‚úÖ
- **BNB**: active=true, step=1 ‚úÖ
- **WLD**: active=true, step=1 ‚úÖ
- **ANIME**: active=true, step=1 ‚úÖ
- **GT**: active=true, step=1 ‚úÖ
- **XRP5L**: active=true, step=3 ‚úÖ
- **BTC**: active=true, step=1 ‚úÖ
- **SUI**: active=true, step=1 ‚úÖ

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä** –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** - —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –¥–æ–∫—É–ø–∫–∏
3. **–°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ç–æ—Ä–≥–æ–≤–ª–µ–π** - –≤—Å–µ –≤–∞–ª—é—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:

```powershell
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
taskkill /F /IM python.exe

# –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
python mTrade.py
```

---

## üìù –§–ê–ô–õ–´, –ö–û–¢–û–†–´–ï –ë–´–õ–ò –ò–ó–ú–ï–ù–ï–ù–´

1. `autotrader_v2.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
2. `autotrader_cycles_state.json` - —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ)
3. `fix_eth_state.py` - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ETH
4. `fix_all_broken_states.py` - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è SOL, LINK, ICP

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø

1. **–§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è** —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â—ë–Ω –æ—Ç race condition
2. **–ü–æ—Ä–æ–≥–∏ –¥–æ–∫—É–ø–∫–∏** —Ç–µ–ø–µ—Ä—å –±–µ—Ä—É—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã breakeven (–∫–∞–∫ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å)
3. **–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ü–∏–∫–ª–æ–≤** —Ç–µ–ø–µ—Ä—å —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–µ—Ä–µ–∑ `reset()`
4. **–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è** –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã –∏ –Ω–µ —Å–ª–æ–º–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–æ—Ä–≥–æ–≤–ª—é

---

## üéØ –ò–¢–û–ì

‚úÖ **–í–°–ï –ü–†–û–ë–õ–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–´**  
‚úÖ **–ö–û–î –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù**  
‚úÖ **–°–û–°–¢–û–Ø–ù–ò–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û**  

–ê–≤—Ç–æ—Ç—Ä–µ–π–¥–µ—Ä —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è **–í–°–ï–•** –≤–∞–ª—é—Ç! üéâ
