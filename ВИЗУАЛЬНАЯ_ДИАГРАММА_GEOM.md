# 📊 ВИЗУАЛЬНАЯ ДИАГРАММА: Применение geom_multiplier

## 🔄 ЖИЗНЕННЫЙ ЦИКЛ ПАРАМЕТРА

```
┌─────────────────────────────────────────────────────────────────────┐
│                   НАЧАЛО: НЕТ АКТИВНЫХ ПОЗИЦИЙ                      │
│                         Volume = 0                                  │
└────────────────────────────┬────────────────────────────────────────┘
                             ↓
                    ┌────────────────────┐
                    │ Пользователь ставит│
                    │ geom_multiplier=2.0│
                    └─────────┬──────────┘
                              ↓
                    ┌────────────────────┐
                    │ ✅ Таблица рассчитана│
                    │   с geom=2.0       │
                    │                    │
                    │ Шаг 0: 0.001 BTC   │
                    │ Шаг 1: 0.002 BTC   │
                    │ Шаг 2: 0.004 BTC   │
                    └─────────┬──────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    ЦИКЛ АКТИВИРОВАН!                                │
│                   Volume > 0 (есть позиции)                         │
└────────────────────────────┬────────────────────────────────────────┘
                             ↓
          ┌──────────────────────────────────────┐
          │ Пользователь меняет параметр:        │
          │ geom_multiplier: 2.0 → 3.0           │
          └──────────────┬───────────────────────┘
                         ↓
          ┌─────────────────────────────────────┐
          │  ⚠️ СИСТЕМА ПРОВЕРЯЕТ СТАТУС         │
          │                                     │
          │  active_cycle = TRUE ?              │
          │       ↓                             │
          │      ДА!                            │
          └──────────────┬──────────────────────┘
                         ↓
          ┌─────────────────────────────────────┐
          │ 🔒 ЗАЩИТА АКТИВИРОВАНА!              │
          │                                     │
          │ • Параметр СОХРАНЁН в файл          │
          │ • Таблица НЕ ПЕРЕСЧИТАНА            │
          │ • Используется СТАРАЯ таблица       │
          │                                     │
          │ Таблица по-прежнему:                │
          │ Шаг 0: 0.001 BTC (geom=2.0)         │
          │ Шаг 1: 0.002 BTC (geom=2.0)         │
          │ Шаг 2: 0.004 BTC (geom=2.0)         │
          └──────────────┬──────────────────────┘
                         ↓
          ┌─────────────────────────────────────┐
          │  Торговля продолжается...           │
          │  (по СТАРОЙ таблице с geom=2.0)     │
          │                                     │
          │  • Докупка 1: 0.002 BTC             │
          │  • Докупка 2: 0.004 BTC             │
          │  • Цена растёт...                   │
          └──────────────┬──────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────────────┐
│                  ✅ ВСЕ ПОЗИЦИИ ПРОДАНЫ!                             │
│                     Volume = 0                                      │
│                   Цикл завершён                                     │
└────────────────────────────┬────────────────────────────────────────┘
                             ↓
          ┌─────────────────────────────────────┐
          │  🎯 МОМЕНТ ПРИМЕНЕНИЯ!              │
          │                                     │
          │  Система автоматически проверяет    │
          │  статус цикла (каждые 3 сек)       │
          └──────────────┬──────────────────────┘
                         ↓
          ┌─────────────────────────────────────┐
          │  СИСТЕМА ПРОВЕРЯЕТ СТАТУС           │
          │                                     │
          │  active_cycle = FALSE !             │
          │       ↓                             │
          │     НЕТ!                            │
          └──────────────┬──────────────────────┘
                         ↓
          ┌─────────────────────────────────────┐
          │ ✅ ПЕРЕСЧЁТ С НОВЫМ ПАРАМЕТРОМ!      │
          │                                     │
          │ Загружается geom_multiplier=3.0     │
          │ из сохранённого файла               │
          │                                     │
          │ Новая таблица:                      │
          │ Шаг 0: 0.001 BTC (geom=3.0) ✅      │
          │ Шаг 1: 0.003 BTC (geom=3.0) ✅      │
          │ Шаг 2: 0.009 BTC (geom=3.0) ✅      │
          └──────────────┬──────────────────────┘
                         ↓
          ┌─────────────────────────────────────┐
          │  Новый цикл начнётся с НОВЫМИ       │
          │  параметрами (geom=3.0)!            │
          └─────────────────────────────────────┘
```

---

## 🔍 ДЕТАЛЬНЫЙ ВЗГЛЯД: Логика принятия решения

```
ЗАПРОС НА ОБНОВЛЕНИЕ ТАБЛИЦЫ
         ↓
    ┌─────────┐
    │ Frontend│
    │ (app.js)│
    └────┬────┘
         ↓
    Отправляет запрос:
    GET /api/trade/indicators?include_table=1
         ↓
    ┌──────────────────────────┐
    │ ПОЛУЧЕН ОТВЕТ            │
    │                          │
    │ autotrade_levels: {      │
    │   active_cycle: true/false│
    │   table: [...]           │
    │   start_price: ...       │
    │ }                        │
    └─────────┬────────────────┘
              ↓
    ┌─────────────────────┐
    │ ПРОВЕРКА УСЛОВИЙ    │
    │                     │
    │ if (active_cycle &&  │
    │     table.length > 0)│
    └─────┬───────────┬───┘
          ↓           ↓
      ┌───┴──┐     ┌──┴───┐
      │ TRUE │     │FALSE │
      └───┬──┘     └──┬───┘
          ↓           ↓
    ┌──────────┐  ┌─────────────┐
    │ ЗАЩИТА   │  │ ОБНОВЛЕНИЕ  │
    │ АКТИВНА  │  │ РАЗРЕШЕНО   │
    └────┬─────┘  └──────┬──────┘
         ↓               ↓
    Используется    Запрос к API:
    сохранённая     GET /api/breakeven/table
    таблица из           ?geom_multiplier=X
    цикла                ?steps=16
         ↓               ?rebuy_mode=...
    renderBreakEvenTable         ↓
    (levels.table)      Backend пересчитывает
         ↓              таблицу с НОВЫМИ
    🔒 ПАРАМЕТР         параметрами
    НЕ ПРИМЕНЁН             ↓
                       renderBreakEvenTable
                       (новая таблица)
                            ↓
                       ✅ ПАРАМЕТР
                       ПРИМЕНЁН
```

---

## 🎬 СЦЕНАРИЙ: Два пользователя

### 👤 Пользователь А: БЕЗ активного цикла

```
Время | Действие                    | Результат
──────┼────────────────────────────┼──────────────────────────
10:00 │ Volume = 0                  │ Цикл неактивен
10:01 │ geom_multiplier: 2.0 → 3.0  │ ✅ Сохранено в файл
10:02 │ Нажал "Сохранить"           │ ✅ Таблица автоматически
      │                            │    пересчитана с geom=3.0
      │                            │ Шаг 0: 0.001 BTC
      │                            │ Шаг 1: 0.003 BTC ✅
      │                            │ Шаг 2: 0.009 BTC ✅
10:05 │ Начал торговлю              │ Цикл стартует с geom=3.0
```

### 👤 Пользователь Б: С активным циклом

```
Время | Действие                    | Результат
──────┼────────────────────────────┼──────────────────────────
10:00 │ Volume = 0.015 BTC          │ Цикл активен (3 докупки)
      │ (текущий geom=2.0)          │ Шаг 0: 0.001 BTC
      │                            │ Шаг 1: 0.002 BTC
      │                            │ Шаг 2: 0.004 BTC
──────┼────────────────────────────┼──────────────────────────
10:01 │ geom_multiplier: 2.0 → 5.0  │ ✅ Сохранено в файл
10:02 │ Нажал "Сохранить"           │ 🔒 Таблица НЕ изменилась!
      │                            │    (всё ещё geom=2.0)
      │                            │ Шаг 0: 0.001 BTC
      │                            │ Шаг 1: 0.002 BTC 🔒
      │                            │ Шаг 2: 0.004 BTC 🔒
──────┼────────────────────────────┼──────────────────────────
10:30 │ Цена растёт, продажи...     │ Торговля по СТАРОЙ таблице
11:00 │ Volume = 0 (все продано)    │ ✅ Цикл завершён
──────┼────────────────────────────┼──────────────────────────
11:01 │ Автоматическое обновление   │ ✅ Таблица пересчитана
      │ (каждые 3 сек)             │    с geom=5.0!
      │                            │ Шаг 0: 0.001 BTC
      │                            │ Шаг 1: 0.005 BTC ✅
      │                            │ Шаг 2: 0.025 BTC ✅
11:05 │ Новый цикл начнётся...      │ Будет использовать geom=5.0
```

---

## 🚨 КРИТИЧЕСКАЯ СИТУАЦИЯ: Что произойдёт, если игнорировать защиту?

### Сценарий БЕЗ защиты (гипотетический):

```
Время | Что происходит                           | Баланс
──────┼─────────────────────────────────────────┼──────────
10:00 │ Цикл начат с geom=2.0                    │
      │ Купил на шаге 0: 0.001 BTC @ $60,000    │ -$60
──────┼─────────────────────────────────────────┼──────────
10:15 │ Цена упала → $55,000                     │
      │ Купил на шаге 1: 0.002 BTC @ $55,000    │ -$170
      │ (итого: 0.003 BTC, avg: $56,666)         │
──────┼─────────────────────────────────────────┼──────────
10:20 │ 💥 ПОЛЬЗОВАТЕЛЬ СЛУЧАЙНО ИЗМЕНИЛ         │
      │    geom_multiplier: 2.0 → 5.0            │
      │                                         │
      │ 💥 ТАБЛИЦА ПЕРЕСЧИТАЛАСЬ БЕЗ ЗАЩИТЫ!    │
      │    Новые объёмы:                         │
      │    Шаг 0: 0.001 BTC (было правильно)     │
      │    Шаг 1: 0.005 BTC (было 0.002!)        │
      │    Шаг 2: 0.025 BTC (было 0.004!)        │
──────┼─────────────────────────────────────────┼──────────
10:30 │ Цена растёт → $58,000                    │
      │ Система пытается продать...              │
      │                                         │
      │ 💥 ОШИБКА! Цена продажи рассчитана для   │
      │    объёма 0.005 BTC (новая таблица),     │
      │    но реально куплено 0.002 BTC!         │
      │                                         │
      │ ВАРИАНТЫ:                                │
      │ A) Продажа в минус (цена неправильная)   │ -$50 💸
      │ B) Не хватает объёма (ордер отклонён)    │ Позиция
      │ C) Логика сломана (бот остановлен)       │ застряла
──────┼─────────────────────────────────────────┼──────────
ИТОГ  │ 💥 ПОТЕРИ ИЗ-ЗА ИЗМЕНЕНИЯ ПАРАМЕТРА      │ 💀
      │    ВО ВРЕМЯ АКТИВНОГО ЦИКЛА!             │
```

### Сценарий С защитой (реальная система):

```
Время | Что происходит                           | Баланс
──────┼─────────────────────────────────────────┼──────────
10:00 │ Цикл начат с geom=2.0                    │
      │ Купил на шаге 0: 0.001 BTC @ $60,000    │ -$60
──────┼─────────────────────────────────────────┼──────────
10:15 │ Цена упала → $55,000                     │
      │ Купил на шаге 1: 0.002 BTC @ $55,000    │ -$170
      │ (итого: 0.003 BTC, avg: $56,666)         │
──────┼─────────────────────────────────────────┼──────────
10:20 │ Пользователь изменил geom: 2.0 → 5.0    │
      │                                         │
      │ 🛡️ ЗАЩИТА АКТИВИРОВАНА!                 │
      │    • Параметр сохранён в файл            │
      │    • Таблица НЕ пересчитана              │
      │    • Цикл продолжает работу с geom=2.0   │
──────┼─────────────────────────────────────────┼──────────
10:30 │ Цена растёт → $58,000                    │
      │ Система продаёт по СТАРОЙ таблице        │
      │ (с правильными объёмами!)                │
      │                                         │
      │ ✅ Продано 0.003 BTC @ $58,500           │ +$175.5
      │    (цена продажи рассчитана правильно    │
      │     для объёма 0.003 BTC)                │
──────┼─────────────────────────────────────────┼──────────
ИТОГ  │ ✅ ПРИБЫЛЬ: $5.50                        │ +$5.50 ✅
      │    Защита сработала!                     │
──────┼─────────────────────────────────────────┼──────────
11:00 │ Новый цикл начнётся с geom=5.0           │
      │ (параметр применится безопасно)          │
```

---

## 📖 ДОПОЛНИТЕЛЬНЫЕ МАТЕРИАЛЫ

- **Полное объяснение**: `ПОЛНОЕ_ОБЪЯСНЕНИЕ_GEOM_MULTIPLIER.md`
- **Быстрая памятка**: `БЫСТРАЯ_ПАМЯТКА_GEOM.md`
- **Тестирование**: `ТЕСТИРОВАНИЕ_GEOM_MULTIPLIER.md`

---

**ВЕРСИЯ**: 1.0  
**ДАТА**: 2025-01-28  
**СОЗДАНО**: GitHub Copilot
