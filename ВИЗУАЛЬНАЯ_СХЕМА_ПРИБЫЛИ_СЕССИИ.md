# 📊 ВИЗУАЛЬНАЯ СХЕМА ПРИБЫЛИ СЕССИИ

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                      🚀 mTrade - Gate.io Trading Platform            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

┌─────────────────────────────────────────────────────────────────────┐
│ 📈 Рынок и стакан                                    BTC_USDT       │
│                                                                       │
│ [🛒] [💰] [▶] [⏮️] [🔄]  [USDT ▼]  Balance: 1234.56               │
│                          └─ Кнопка "Сброс сессии" (фиолетовая)      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ [Таблица безубыточности] / [Логи]       ┌──────────────────────────┐│
│                                          │ Прибыль:  +12.3456 🟢    ││
│                                          │           2д 5ч 23м      ││
│                                          └──────────────────────────┘│
│                                          └─ Прижато к правому краю   │
│                                             (две строки)             │
│                                                                       │
│  [Таблица безубыточности или Логи отображаются здесь]               │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🎨 Детальный вид блока прибыли

### **Положительная прибыль (зелёная)**
```
┌────────────────────────┐
│ Прибыль:  +12.3456 🟢 │  ← Зелёный цвет (#4CAF50)
│           2д 5ч 23м    │  ← Серый цвет (#999)
└────────────────────────┘
```

### **Отрицательная прибыль (красная)**
```
┌────────────────────────┐
│ Прибыль:   -5.6789 🔴 │  ← Красный цвет (#f44336)
│           2д 5ч 23м    │  ← Серый цвет (#999)
└────────────────────────┘
```

### **Нулевая прибыль (серая)**
```
┌────────────────────────┐
│ Прибыль:     0.00  ⚪  │  ← Серый цвет (#999)
│           0д 0ч 0м     │  ← Серый цвет (#999)
└────────────────────────┘
```

---

## 🔄 Поток данных (Data Flow)

```
┌─────────────────────────────────────────────────────────────────────┐
│                          FRONTEND (HTML/JS)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  1. При загрузке страницы:                                          │
│     updateSessionProfit()                                            │
│          │                                                            │
│          └─→ GET /api/session-profit?currency=BTC                   │
│                                                                       │
│  2. При смене валюты:                                               │
│     switchBaseCurrency('ETH')                                        │
│          │                                                            │
│          └─→ updateSessionProfit()                                   │
│                │                                                      │
│                └─→ GET /api/session-profit?currency=ETH             │
│                                                                       │
│  3. При нажатии "Сброс сессии":                                     │
│     resetSessionBtn.click()                                          │
│          │                                                            │
│          ├─→ Подтверждение пользователя                            │
│          │                                                            │
│          ├─→ POST /api/reset-session                                │
│          │                                                            │
│          └─→ updateSessionProfit()                                   │
│                                                                       │
│  4. Каждые 5 секунд:                                                │
│     setInterval(updateSessionProfit, 5000)                           │
│          │                                                            │
│          └─→ GET /api/session-profit?currency=BTC                   │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               │ HTTP Request
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         BACKEND (mTrade.py)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  Endpoint: GET /api/session-profit                                   │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 1. Получаем параметр currency из query string                  │ │
│  │ 2. Используем глобальную переменную SESSION_START_TIME         │ │
│  │ 3. Вызываем logger.get_session_profit(currency, session_start) │ │
│  │ 4. Возвращаем JSON с прибылью и временем старта сессии         │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                       │
│  Endpoint: POST /api/reset-session                                   │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 1. Устанавливаем SESSION_START_TIME = datetime.now()           │ │
│  │ 2. Логируем событие в консоль                                  │ │
│  │ 3. Возвращаем JSON с новым временем старта                     │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               │ Вызов метода
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     TRADE LOGGER (trade_logger.py)                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  Метод: get_session_profit(currency, session_start_time)            │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 1. Фильтруем логи по валюте (если currency указан)            │ │
│  │ 2. Фильтруем логи по времени (после session_start_time)       │ │
│  │ 3. Берём только продажи (type == 'sell')                      │ │
│  │ 4. Суммируем total_pnl из каждой сделки                       │ │
│  │ 5. Возвращаем Dict[currency, profit]                           │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔀 Логика фильтрации прибыли

```
┌─────────────────────────────────────────────────────────────────────┐
│                      ВСЕ ЛОГИ СДЕЛОК (trades.json)                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  BTC_USDT:                                                           │
│    ├─ 2025-01-10 10:00  |  buy   |  profit: N/A                    │
│    ├─ 2025-01-10 12:00  |  sell  |  profit: +5.00   ← учитывается  │
│    ├─ 2025-01-12 14:00  |  buy   |  profit: N/A                    │
│    └─ 2025-01-14 16:00  |  sell  |  profit: +7.34   ← учитывается  │
│                                                                       │
│  ETH_USDT:                                                           │
│    ├─ 2025-01-11 09:00  |  buy   |  profit: N/A                    │
│    └─ 2025-01-13 11:00  |  sell  |  profit: -2.15   ← учитывается  │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               │ Фильтрация
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  ФИЛЬТР 1: По времени (SESSION_START_TIME)           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  SESSION_START_TIME = 2025-01-14 12:00                              │
│                                                                       │
│  Логи после 2025-01-14 12:00:                                        │
│    └─ 2025-01-14 16:00  |  BTC_USDT  |  sell  |  profit: +7.34     │
│                                                                       │
│  (Все логи до 12:00 игнорируются!)                                  │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               │ Фильтрация
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  ФИЛЬТР 2: По валюте (currency)                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  Если currency = "BTC":                                              │
│    └─ Показываем только BTC_USDT                                    │
│       └─ Прибыль: +7.34                                              │
│                                                                       │
│  Если currency = "ETH":                                              │
│    └─ Показываем только ETH_USDT                                    │
│       └─ Прибыль: 0.00 (нет сделок после 12:00)                    │
│                                                                       │
│  Если currency = null:                                               │
│    └─ Показываем все валюты                                          │
│       └─ Прибыль: +7.34 (общая по всем)                             │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🎯 Интерактивная схема кнопки "Сброс сессии"

```
          ┌──────────────────────────┐
          │ Пользователь нажимает    │
          │   кнопку "Сброс сессии"  │
          │         🔄               │
          └────────────┬─────────────┘
                       │
                       ▼
          ┌──────────────────────────┐
          │ Показывается подтверждение│
          │ "Вы уверены, что хотите  │
          │  сбросить сессию?"       │
          └────────┬─────────┬────────┘
                   │         │
          ┌────────▼───┐ ┌──▼─────────┐
          │  Отмена    │ │ Подтверждаю│
          └────────────┘ └──┬─────────┘
                            │
                            ▼
          ┌──────────────────────────┐
          │ POST /api/reset-session  │
          └────────────┬─────────────┘
                       │
                       ▼
          ┌──────────────────────────┐
          │ Сервер:                  │
          │ SESSION_START_TIME =     │
          │    datetime.now()        │
          └────────────┬─────────────┘
                       │
                       ▼
          ┌──────────────────────────┐
          │ Фронтенд вызывает        │
          │ updateSessionProfit()    │
          └────────────┬─────────────┘
                       │
                       ▼
          ┌──────────────────────────┐
          │ Прибыль обнулена: 0.00   │
          │ Длительность: 0д 0ч 0м   │
          └──────────────────────────┘
```

---

## 📱 Адаптивный дизайн

### Desktop (широкий экран):
```
┌──────────────────────────────────────────────────────────────────────┐
│ [Таблица безубыточности] / [Логи]                Прибыль: +12.3456 🟢│
│                                                           2д 5ч 23м   │
└──────────────────────────────────────────────────────────────────────┘
```

### Mobile (узкий экран):
```
┌────────────────────────────────────┐
│ [Таблица] / [Логи]                 │
│                    Прибыль: +12.34 │
│                       2д 5ч 23м    │
└────────────────────────────────────┘
```

---

## 🎨 CSS стили (из index.html)

```css
#session-profit-display {
    display: flex;
    flex-direction: column;      /* Две строки */
    align-items: flex-end;       /* Прижато вправо */
    font-size: 12px;
    margin-left: auto;           /* Занимает всё доступное место слева */
    text-align: right;
}

/* Первая строка - прибыль */
.profit-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Вторая строка - длительность */
.duration-row {
    color: #999;
    font-size: 11px;
    margin-top: 2px;
}

/* Цвет прибыли (динамический) */
#session-total-profit {
    font-weight: bold;
    color: #4CAF50;  /* Зелёный (по умолчанию) */
}

/* Изменяется через JavaScript:
   - Зелёный (#4CAF50) для положительной
   - Красный (#f44336) для отрицательной
   - Серый (#999) для нулевой
*/
```

---

**Дата:** 2025-01-14  
**Версия:** 1.0  
**Автор:** GitHub Copilot
