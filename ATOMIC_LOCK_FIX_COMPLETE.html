<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ –ê–¢–û–ú–ê–†–ù–ê–Ø –ó–ê–©–ò–¢–ê - –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }
        .content {
            padding: 40px;
        }
        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section h3 {
            color: #764ba2;
            margin: 25px 0 15px 0;
            font-size: 1.4em;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.6;
        }
        .code-block .comment { color: #75715e; }
        .code-block .keyword { color: #66d9ef; }
        .code-block .string { color: #e6db74; }
        .highlight-box {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success-box {
            background: #d4edda;
            border-left: 5px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .error-box {
            background: #f8d7da;
            border-left: 5px solid #dc3545;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 12px 15px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .checklist li::before {
            content: "‚úÖ";
            font-size: 1.3em;
        }
        .checklist li.pending::before {
            content: "‚è≥";
        }
        .diagram {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
            border: 2px solid #667eea;
        }
        .footer {
            background: #2d3748;
            color: white;
            padding: 30px;
            text-align: center;
        }
        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin: 5px;
        }
        .badge-success { background: #28a745; color: white; }
        .badge-warning { background: #ffc107; color: #000; }
        .badge-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úÖ –ê–¢–û–ú–ê–†–ù–ê–Ø –ó–ê–©–ò–¢–ê –û–¢ RACE CONDITION</h1>
            <p>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã–º–∏ –ø–æ–∫—É–ø–∫–∞–º–∏</p>
            <div style="margin-top: 20px;">
                <span class="badge badge-success">–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –ò–°–ü–†–ê–í–õ–ï–ù</span>
                <span class="badge badge-success">–ê–¢–û–ú–ê–†–ù–ê–Ø –ó–ê–©–ò–¢–ê –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê</span>
            </div>
        </div>

        <div class="content">
            <!-- –ü–†–û–ë–õ–ï–ú–ê -->
            <div class="section">
                <h2>üéØ –ü–†–û–ë–õ–ï–ú–ê</h2>
                <div class="error-box">
                    <p><strong>Race Condition –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ñ–ª–∞–≥–∞:</strong></p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>–î–≤–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–ª–∏ <code>cycle_start_state=0</code></li>
                        <li>–û–±–µ —Å—á–∏—Ç–∞–ª–∏, —á—Ç–æ –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –ø–æ–∫—É–ø–∫—É</li>
                        <li>–û–±–µ –≤—ã–∑—ã–≤–∞–ª–∏ <code>_try_start_cycle()</code></li>
                        <li><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –¥—É–±–ª–∏—Ä—É—é—â–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø–æ–∫—É–ø–∫–∏ ‚ùå</li>
                    </ul>
                </div>
            </div>

            <!-- –†–ï–®–ï–ù–ò–ï -->
            <div class="section">
                <h2>üîß –†–ï–®–ï–ù–ò–ï</h2>
                <p><strong>threading.Lock –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–ª—é—Ç—ã –æ—Ç–¥–µ–ª—å–Ω–æ</strong></p>
                
                <h3>1Ô∏è‚É£ –î–æ–±–∞–≤–ª–µ–Ω —Å–ª–æ–≤–∞—Ä—å Lock'–æ–≤ –≤ __init__</h3>
                <div class="code-block">
<span class="comment"># –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê: Lock –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cycle_start_state</span>
<span class="keyword">self</span>._cycle_locks: Dict[str, threading.Lock] = {}
                </div>

                <h3>2Ô∏è‚É£ –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª: –∞—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ + –≤—ã–∑–æ–≤</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div>
                        <h4 style="color: #dc3545;">‚ùå –î–û (race condition –≤–æ–∑–º–æ–∂–µ–Ω):</h4>
                        <div class="code-block">
<span class="comment"># –ü—Ä–æ–≤–µ—Ä–∫–∞ –í–ù–ï Lock</span>
cycle_start_state = cycle.get(<span class="string">'cycle_start_state'</span>, 0)
<span class="keyword">if</span> cycle_start_state == 0:
    <span class="comment"># –î—Ä—É–≥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –∑–∞–π—Ç–∏ —Å—é–¥–∞!</span>
    <span class="keyword">self</span>._try_start_cycle(base, quote)
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #28a745;">‚úÖ –ü–û–°–õ–ï (–∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞—â–∏—Ç–∞):</h4>
                        <div class="code-block">
<span class="comment"># –°–æ–∑–¥–∞—ë–º Lock –¥–ª—è –≤–∞–ª—é—Ç—ã</span>
<span class="keyword">if</span> base <span class="keyword">not in</span> <span class="keyword">self</span>._cycle_locks:
    <span class="keyword">self</span>._cycle_locks[base] = threading.Lock()

<span class="comment"># –í–°–Ø –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è –í–ù–£–¢–†–ò Lock</span>
<span class="keyword">with</span> <span class="keyword">self</span>._cycle_locks[base]:
    cycle_start_state = cycle.get(<span class="string">'cycle_start_state'</span>, 0)
    
    <span class="keyword">if</span> cycle_start_state == 0:
        <span class="comment"># –ê–¢–û–ú–ê–†–ù–û!</span>
        <span class="keyword">self</span>._try_start_cycle(base, quote)
                        </div>
                    </div>
                </div>

                <h3>3Ô∏è‚É£ _try_start_cycle: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –í–ù–£–¢–†–ò Lock</h3>
                <div class="highlight-box">
                    <p><strong>Lock —É–∂–µ –∑–∞—Ö–≤–∞—á–µ–Ω</strong> –≤ –≥–ª–∞–≤–Ω–æ–º —Ü–∏–∫–ª–µ, –ø–æ—ç—Ç–æ–º—É:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>–£–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ <code>cycle_start_state</code></li>
                        <li>–û—Å—Ç–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞)</li>
                        <li>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç <strong>–∞—Ç–æ–º–∞—Ä–Ω–æ</strong> –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∏</li>
                    </ul>
                </div>
            </div>

            <!-- –ì–ê–†–ê–ù–¢–ò–ò -->
            <div class="section">
                <h2>üìä –ì–ê–†–ê–ù–¢–ò–ò</h2>
                
                <div class="success-box">
                    <h3>‚úÖ –ß—Ç–æ –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–û:</h3>
                    <ul class="checklist">
                        <li>–¢–æ–ª—å–∫–æ –û–î–ù–ê –∏—Ç–µ—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–æ–∫—É–ø–∫—É</li>
                        <li>–¢–æ–ª—å–∫–æ –û–î–ù–ê —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞ –Ω–∞ —Ü–∏–∫–ª (MARKET –æ—Ä–¥–µ—Ä –Ω–∞ –≤—Å—é —Å—É–º–º—É)</li>
                        <li>–ù–ï–¢ race condition –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ñ–ª–∞–≥–∞</li>
                        <li>–ù–ï–¢ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –æ—Ä–¥–µ—Ä–æ–≤ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏—Ç–µ—Ä–∞—Ü–∏—è—Ö</li>
                        <li>–ö–û–†–†–ï–ö–¢–ù–û–ï –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ - —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏</li>
                    </ul>
                </div>

                <h3>‚öôÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</h3>
                <div class="diagram">
–ò—Ç–µ—Ä–∞—Ü–∏—è 1                    –ò—Ç–µ—Ä–∞—Ü–∏—è 2
-----------                   -----------
Lock.acquire() ‚úÖ             Lock.acquire() ‚è∏Ô∏è (–∂–¥—ë—Ç)
‚îÇ
‚îú‚îÄ cycle_start_state = 0 ‚úÖ
‚îú‚îÄ _try_start_cycle()
‚îÇ  ‚îî‚îÄ cycle_start_state = 1 ‚úÖ
‚îÇ     _save_cycles_state() ‚úÖ
‚îÇ
Lock.release() ‚úÖ             Lock.acquire() ‚úÖ
                              ‚îÇ
                              ‚îú‚îÄ cycle_start_state = 1 ‚ùå
                              ‚îî‚îÄ –ù–ò–ß–ï–ì–û –ù–ï –î–ï–õ–ê–ï–ú
                              
                              Lock.release() ‚úÖ
                </div>
            </div>

            <!-- –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï -->
            <div class="section">
                <h2>üéØ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï</h2>
                
                <h3>–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞</h3>
                <ol style="margin-left: 20px;">
                    <li>–ü—Ä–æ–¥–∞–∂–∞ ‚Üí <code>cycle_start_state=0</code> + <code>active=False</code></li>
                    <li>–ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª: Lock ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ <code>=0</code> ‚Üí <code>_try_start_cycle()</code></li>
                    <li>–°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞: —Ñ–ª–∞–≥ <code>=1</code> ‚Üí MARKET –æ—Ä–¥–µ—Ä ‚Üí <code>=2</code> + <code>active=True</code></li>
                    <li>–î—Ä—É–≥–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏: –≤–∏–¥—è—Ç <code>=2</code> ‚Üí —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ/–ø—Ä–æ–¥–∞–∂–∞</li>
                </ol>

                <h3>–°—Ü–µ–Ω–∞—Ä–∏–π 2: Race condition (—Ç–µ–ø–µ—Ä—å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â—ë–Ω!)</h3>
                <ol style="margin-left: 20px;">
                    <li>–ü—Ä–æ–¥–∞–∂–∞ ‚Üí <code>cycle_start_state=0</code></li>
                    <li>–ò—Ç–µ—Ä–∞—Ü–∏—è A: Lock ‚úÖ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ <code>=0</code> ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–æ–∫—É–ø–∫—É</li>
                    <li>–ò—Ç–µ—Ä–∞—Ü–∏—è B: Lock ‚è∏Ô∏è (–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è) ‚Üí –∂–¥—ë—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è</li>
                    <li>–ò—Ç–µ—Ä–∞—Ü–∏—è A: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç <code>=1</code> ‚Üí Lock release ‚úÖ</li>
                    <li>–ò—Ç–µ—Ä–∞—Ü–∏—è B: Lock ‚úÖ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ <code>=1</code> ‚Üí <strong>–ù–ò–ß–ï–ì–û –ù–ï –î–ï–õ–ê–ï–¢</strong> ‚úÖ</li>
                </ol>

                <h3>–°—Ü–µ–Ω–∞—Ä–∏–π 3: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ</h3>
                <ol style="margin-left: 20px;">
                    <li>–§–ª–∞–≥ <code>=1</code> ‚Üí –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–∫—É–ø–∫–∏ ‚Üí <strong>–∏—Å–∫–ª—é—á–µ–Ω–∏–µ</strong></li>
                    <li>–ë–ª–æ–∫ <code>except</code>: —Ñ–ª–∞–≥ <code>=0</code> ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</li>
                </ol>
            </div>

            <!-- –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò -->
            <div class="section">
                <h2>üìå –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò</h2>
                <ul class="checklist">
                    <li>–ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω</li>
                    <li>–°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω: <code>python -m py_compile autotrader.py</code></li>
                    <li class="pending">–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞: <code>restart_server.bat</code></li>
                    <li class="pending">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤</li>
                    <li class="pending">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤: –Ω–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –ø–æ–∫—É–ø–æ–∫</li>
                </ul>

                <div class="highlight-box" style="margin-top: 30px;">
                    <h3 style="margin: 0 0 15px 0;">üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</h3>
                    <ol style="margin-left: 20px;">
                        <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ <strong>restart_server.bat</strong></li>
                        <li>–î–æ–∂–¥–∏—Ç–µ—Å—å –ø—Ä–æ–¥–∞–∂–∏ –ª—é–±–æ–π –≤–∞–ª—é—Ç—ã</li>
                        <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –û–î–ù–ê —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞</li>
                        <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ <code>cycle_start_state</code> –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç 0‚Üí1‚Üí2 –±–µ–∑ –¥—É–±–ª–µ–π</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</strong> 2024-12-05</p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ‚úÖ –ê–¢–û–ú–ê–†–ù–ê–Ø –ó–ê–©–ò–¢–ê –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê</p>
            <p><strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –ò–°–ü–†–ê–í–õ–ï–ù</p>
            <p style="margin-top: 15px; opacity: 0.8;">
                –§–∞–π–ª—ã: <code>autotrader.py</code> | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: <code>ATOMIC_LOCK_FIX_COMPLETE.md</code>
            </p>
        </div>
    </div>
</body>
</html>
