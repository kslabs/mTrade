<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞ —Ü–∏–∫–ª–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            margin: 10px 0;
        }
        button:hover {
            background: #e68900;
        }
        #log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞ —Ü–∏–∫–ª–∞</h1>
    
    <div>
        <label for="currency">–í–∞–ª—é—Ç–∞:</label>
        <input type="text" id="currency" value="DOGE" style="padding: 8px; margin: 0 10px;">
    </div>
    
    <button onclick="testResetCycle()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ü–∏–∫–ª</button>
    <button onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    
    <div id="log"></div>
    
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            const line = `[${timestamp}] ${message}\n`;
            const span = document.createElement('span');
            span.className = type;
            span.textContent = line;
            logDiv.appendChild(span);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testResetCycle() {
            const currency = document.getElementById('currency').value.trim().toUpperCase();
            
            if (!currency) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤–∞–ª—é—Ç—ã');
                return;
            }
            
            log(`–ü–æ–ø—ã—Ç–∫–∞ —Å–±—Ä–æ—Å–∞ —Ü–∏–∫–ª–∞ –¥–ª—è ${currency}...`, 'info');
            
            try {
                const url = '/api/autotrader/reset_cycle';
                log(`URL: ${url}`, 'info');
                log(`–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞: ${JSON.stringify({base_currency: currency})}`, 'info');
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base_currency: currency
                    })
                });
                
                log(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`–¢–µ–ª–æ –æ—à–∏–±–∫–∏: ${errorText}`, 'error');
                    alert(`‚ùå –û—à–∏–±–∫–∞ HTTP: ${response.status}\n${errorText}`);
                    return;
                }
                
                const data = await response.json();
                log(`–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(data, null, 2)}`, 'success');
                
                if (data.success) {
                    alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ!\n${data.message}`);
                    log(`‚úÖ –¶–∏–∫–ª —Å–±—Ä–æ—à–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                    log(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
                alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        // –õ–æ–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
        log(`–¢–µ–∫—É—â–∏–π URL: ${window.location.href}`, 'info');
    </script>
</body>
</html>
